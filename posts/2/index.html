
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="每个程序猿家里都有一堆技术书籍，偶也不例外，因此想写个Android应用来管理自己的藏书以及想买的书籍。在网上找到marshal的识别图书ISBN号并输出查询结果的示例和完善图书查询原型，增加收藏夹功能两篇文章，写的非常不错，还提供源代码。下载代码研究后发现已基本具备了想要的功能， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/posts/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!--script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script-->
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"-->
<!--link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"-->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:codemany.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/25/manage-library-by-scanning-isbn-barcode/">扫描ISBN条码实现藏书管理</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-25T12:17:14+08:00" pubdate data-updated="true">Apr 25<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>每个程序猿家里都有一堆技术书籍，偶也不例外，因此想写个Android应用来管理自己的藏书以及想买的书籍。在网上找到marshal的<a href="http://marshal.easymorse.com/archives/2745">识别图书ISBN号并输出查询结果的示例</a>和<a href="http://marshal.easymorse.com/archives/2756">完善图书查询原型，增加收藏夹功能</a>两篇文章，写的非常不错，还提供源代码。下载代码研究后发现已基本具备了想要的功能，决定在它的基础上做些修改供自己使用。</p>

<p>把原来uses-sdk的minSdkVersion改成了9，增加android:targetSdkVersion=&ldquo;17&#8221;。然后使用手机测试程序时发现，在连接网络时后台会抛出了android.os.NetworkOnMainThreadException异常，并且应用崩溃打不开。通过查阅相关资料了解到，自从Android 2.3之后，系统增加了一个类StrictMode。这个类对网络的访问方式进行了一定的改变。官方文档给出了这个类设置的目的：</p>

<blockquote><p>StrictMode is a developer tool which detects things you might be doing by accident and brings them to your attention so you can fix them.</p>

<p>StrictMode is most commonly used to catch accidental disk or network access on the application&rsquo;s main thread, where UI operations are received and animations take place. Keeping disk and network operations off the main thread makes for much smoother, more responsive applications. By keeping your application&rsquo;s main thread responsive, you also prevent ANR dialogs from being shown to users.</p>

<p>Note that even though an Android device&rsquo;s disk is often on flash memory, many devices run a filesystem on top of that memory with very limited concurrency. It&rsquo;s often the case that almost all disk accesses are fast, but may in individual cases be dramatically slower when certain I/O is happening in the background from other processes. If possible, it&rsquo;s best to assume that such things are not fast.</p></blockquote>

<p>因为marshal把访问网络的代码直接放到UI线程中，造成和主线程的首要工作UI交互相矛盾。解决这类问题很容易，把访问网络的代码放到AsyncTask中就行了。官方有个<a href="http://developer.android.com/training/basics/network-ops/index.html">NetworkUsage</a>例子是个不错的参考。</p>

<p>接着发现豆瓣API查询返回的是500错误，在浏览器上访问却又正常，后来给HttpClient加上Agent头就没问题了，不知道是不是期间豆瓣的API在实现上作了改变。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HttpClient client = new DefaultHttpClient();
</span><span class='line'>String agent = System.getProperty("http.agent");
</span><span class='line'>client.getParams().setParameter(CoreProtocolPNames.USER_AGENT, agent);</span></code></pre></td></tr></table></div></figure>


<p>解析豆瓣XML查询结果的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>XmlPullParserFactory factory = XmlPullParserFactory.newInstance();
</span><span class='line'>factory.setNamespaceAware(true);
</span><span class='line'>XmlPullParser parser = factory.newPullParser();
</span><span class='line'>parser.setInput(inputStream, "utf-8");
</span><span class='line'>Book book = new Book();
</span><span class='line'>
</span><span class='line'>int eventType = parser.getEventType();
</span><span class='line'>while (eventType != XmlPullParser.END_DOCUMENT) {
</span><span class='line'>    switch (eventType) {
</span><span class='line'>    case XmlPullParser.START_TAG:
</span><span class='line'>        if ("link".equals(parser.getName())
</span><span class='line'>                && "image".equals(parser.getAttributeValue(null, "rel"))) {
</span><span class='line'>            book.setImageUrl(parser.getAttributeValue(null, "href"));
</span><span class='line'>            eventType = parser.next();
</span><span class='line'>        } else if ("summary".equals(parser.getName())) {
</span><span class='line'>            book.setSummary(parser.nextText());
</span><span class='line'>        } else if ("attribute".equals(parser.getName())) {
</span><span class='line'>            String name = parser.getAttributeValue(null, "name");
</span><span class='line'>            if ("title".equals(name)) {
</span><span class='line'>                book.setTitle(parser.nextText());
</span><span class='line'>            } else if ("author".equals(name)) {
</span><span class='line'>                book.setAuthor(parser.nextText());
</span><span class='line'>            } else if ("isbn10".equals(name)) {
</span><span class='line'>                book.setIsbn10(parser.nextText());
</span><span class='line'>            } else if ("isbn13".equals(name)) {
</span><span class='line'>                book.setIsbn13(parser.nextText());
</span><span class='line'>            } else if ("publisher".equals(name)) {  
</span><span class='line'>                book.setPublisher(parser.getText());
</span><span class='line'>            }                 
</span><span class='line'>        }
</span><span class='line'>        break;
</span><span class='line'>    case XmlPullParser.END_TAG:
</span><span class='line'>        break;
</span><span class='line'>    }
</span><span class='line'>    eventType = parser.next();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>然后，然后就是结果页面不显示图书信息。想要找到原因，肿么办？看来要调试WebView了！<a href="http://developer.android.com/guide/webapps/debugging.html">http://developer.android.com/guide/webapps/debugging.html</a> 告诉了我们如何调试。</p>

<p>首先在WebView上设置setWebChromeClient方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>webView.setWebChromeClient(new WebChromeClient() {
</span><span class='line'>    public void onConsoleMessage(String message,
</span><span class='line'>            int lineNumber, String sourceID) {
</span><span class='line'>        Log.d(TAG, message + " -- From line "
</span><span class='line'>                + lineNumber + " of " + sourceID);
</span><span class='line'>    }
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>然后在JavaScript脚本中使用以下方法就可以在logcat中看到调试信息了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>console.log(String)
</span><span class='line'>console.info(String)
</span><span class='line'>console.warn(String)
</span><span class='line'>console.error(String)</span></code></pre></td></tr></table></div></figure>


<p>重新运行程序，果然在logcat中看到报如下错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Uncaught TypeError: Object [object Object] has no method...</span></code></pre></td></tr></table></div></figure>


<p>搜索后在Stack Overflow找到了<a href="http://stackoverflow.com/questions/14031635/android-4-2-1-webview-and-javascript-interface-breaks">问题的答案</a>（Stack Overflow真的非常不错，问题的回答都非常详尽）。<a href="http://developer.android.com/guide/webapps/webview.html#BindingJavaScript">这里</a>是Android官方文档的解释。</p>

<p>解决方法就是在要被JavaScript调用的方法上加@JavascriptInterface注解：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class Book {
</span><span class='line'>
</span><span class='line'>  @JavascriptInterface
</span><span class='line'>  public String getAuthor() {
</span><span class='line'>      return author;
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  public void setAuthor(String author) {
</span><span class='line'>      if (this.author != null) {
</span><span class='line'>          this.author += ", " + author;
</span><span class='line'>      } else {
</span><span class='line'>          this.author = author;
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/11/the-proper-way-to-draw-rounded-corners/">绘制圆角的正确方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-11T14:59:45+08:00" pubdate data-updated="true">Apr 11<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="http://www.usabilitypost.com/2009/01/26/the-proper-way-to-draw-rounded-corners/">http://www.usabilitypost.com/2009/01/26/the-proper-way-to-draw-rounded-corners/</a></p>

<p>在网络上，我已经注意到当人们在他们的设计中实现圆角时犯了很多同样的错误。因为某些原因，当有另外一个圆角在它里面的时候，这个圆角会带来一个问题—无论是有一个围绕周围的边界，还是另一个圆角形状坐落在一个圆角形状内。</p>

<p>这里是我要说的：
<img src="/uploads/bad-corner.png" title="bad-corner" ></p>

<p>我看到了很多这种类型的圆角。您可以看到圆角的半径和内圆角的是相同的。这是错误的，因为如果你保持相同半径，两个拐角之间的空间量不会自始至终相等。</p>

<p>下面是相等间距看起来的样子：
<img src="/uploads/good-corner.png" title="good-corner" ></p>

<p>这是正确的做法。有什么不同？内角的半径被减小了。好吧，但你怎么知道半径应该有多大？这很简单—如果你把外面的圆角想象成一个圆形，你可以看到它的圆心在哪里。
<img src="/uploads/corner-center.png" title="corner-center" ></p>

<p>把这个圆心同样地作为内角的圆心，你就会得到内角的半径。使用这种方法将确保两个形状之间的完美契合。
<img src="/uploads/good-corner-ruler.png" title="good-corner-ruler" ></p>

<p>“现在你知道了吧？这是做多个圆角彼此包含的正确办法。当然，不需要你使用精确的圆心—有时为了设计良好还需要你移动一点点。但请不要仅仅把相同的圆角向内移动—这是绝对错误的。
</p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/09/page-layout-using-sitemesh/">使用SiteMesh做网页布局</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-09T08:18:33+08:00" pubdate data-updated="true">Apr 9<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>SiteMesh是一个基于GoF的Decorator模式，用于页面布局的框架。能帮助我们在由大量页面构成的项目中创建一致的页面布局和外观。</p>

<p>这里我们将会把它整合到JBookShelf里去。要和Struts2整合，先在pom.xml添加以下插件，该插件会将依赖的SiteMesh也一并包含到项目中。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;dependency&gt;
</span><span class='line'>    &lt;groupId&gt;org.apache.struts&lt;/groupId&gt;
</span><span class='line'>    &lt;artifactId&gt;struts2-sitemesh-plugin&lt;/artifactId&gt;
</span><span class='line'>    &lt;version&gt;2.3.12&lt;/version&gt;
</span><span class='line'>&lt;/dependency&gt;</span></code></pre></td></tr></table></div></figure>


<p>将web.xml配置中原来的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;filter&gt;
</span><span class='line'>    &lt;filter-name&gt;struts2&lt;/filter-name&gt;
</span><span class='line'>    &lt;filter-class&gt;org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter&lt;/filter-class&gt;
</span><span class='line'>&lt;/filter&gt;
</span><span class='line'>
</span><span class='line'>&lt;filter-mapping&gt;
</span><span class='line'>    &lt;filter-name&gt;struts2&lt;/filter-name&gt;
</span><span class='line'>    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
</span><span class='line'>&lt;/filter-mapping&gt;</span></code></pre></td></tr></table></div></figure>


<p>改成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;filter&gt;
</span><span class='line'>    &lt;filter-name&gt;struts-prepare&lt;/filter-name&gt;
</span><span class='line'>    &lt;filter-class&gt;org.apache.struts2.dispatcher.ng.filter.StrutsPrepareFilter&lt;/filter-class&gt;
</span><span class='line'>&lt;/filter&gt;
</span><span class='line'>
</span><span class='line'>&lt;filter&gt;
</span><span class='line'>    &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
</span><span class='line'>    &lt;filter-class&gt;com.opensymphony.sitemesh.webapp.SiteMeshFilter&lt;/filter-class&gt;
</span><span class='line'>&lt;/filter&gt;
</span><span class='line'>
</span><span class='line'>&lt;filter&gt;
</span><span class='line'>    &lt;filter-name&gt;struts-execute&lt;/filter-name&gt;
</span><span class='line'>    &lt;filter-class&gt;org.apache.struts2.dispatcher.ng.filter.StrutsExecuteFilter&lt;/filter-class&gt;
</span><span class='line'>&lt;/filter&gt;
</span><span class='line'>
</span><span class='line'>&lt;filter-mapping&gt;
</span><span class='line'>    &lt;filter-name&gt;struts-prepare&lt;/filter-name&gt;
</span><span class='line'>    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
</span><span class='line'>&lt;/filter-mapping&gt;
</span><span class='line'>
</span><span class='line'>&lt;filter-mapping&gt;
</span><span class='line'>    &lt;filter-name&gt;sitemesh&lt;/filter-name&gt;
</span><span class='line'>    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
</span><span class='line'>&lt;/filter-mapping&gt;
</span><span class='line'>
</span><span class='line'>&lt;filter-mapping&gt;
</span><span class='line'>    &lt;filter-name&gt;struts-execute&lt;/filter-name&gt;
</span><span class='line'>    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
</span><span class='line'>&lt;/filter-mapping&gt;</span></code></pre></td></tr></table></div></figure>


<p>这里要注意过滤器的位置。SiteMesh过滤器必须在StrutsPrepareFilter之后和StrutsExecuteFilter之前，否则在SiteMesh的修饰器页面中将访问不到ActionContext。这是因为Struts2的所有值是保存在Stack Context或者ValueStack中的。默认情况下，某个过滤器一旦访问了该Stack Context或ValueStack，里面对应的值会被清洗掉。如果先使用Struts2的StrutsPrepareAndExecuteFilter来过滤用户请求，则SiteMesh的过滤器将无法取得Stack Context或者ValueStack中的数据。为了解决这个问题，Struts2提供了StrutsPrepareFilter和StrutsExecuteFilter类（在2.1.3版本前是ActionContextCleanUp和FilterDispatcher），通过它们协同来确保SiteMesh正常工作。</p>

<p>在WEB-INF下添加decorators.xml文档：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;decorators defaultdir="/layouts"&gt;
</span><span class='line'>    &lt;excludes&gt;
</span><span class='line'>        &lt;pattern&gt;/stylesheets/*&lt;/pattern&gt;
</span><span class='line'>        &lt;pattern&gt;/javascripts/*&lt;/pattern&gt;
</span><span class='line'>        &lt;pattern&gt;/images/*&lt;/pattern&gt;
</span><span class='line'>    &lt;/excludes&gt;
</span><span class='line'>
</span><span class='line'>    &lt;decorator name="application" page="application.jsp"&gt;
</span><span class='line'>        &lt;pattern&gt;/*&lt;/pattern&gt;
</span><span class='line'>    &lt;/decorator&gt;
</span><span class='line'>&lt;/decorators&gt;</span></code></pre></td></tr></table></div></figure>


<p>stylesheets、javascripts、images目录下的内容是不需要被修饰的，可以把它们放到execludes块中排除掉。</p>

<p>新建/layouts/application.jsp模版页：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%@ taglib uri="/struts-tags" prefix="s" %&gt;
</span><span class='line'>&lt;%@ taglib uri="http://www.opensymphony.com/sitemesh/decorator" prefix="decorator" %&gt;
</span><span class='line'>
</span><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>&lt;meta charset="utf-8"&gt;
</span><span class='line'>&lt;title&gt;&lt;decorator:title default="JBookShelf" /&gt;&lt;/title&gt;
</span><span class='line'>&lt;decorator:head /&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>
</span><span class='line'>&lt;body&gt;
</span><span class='line'>    &lt;div&gt;
</span><span class='line'>        &lt;s:if test="#session.user_session_key != null"&gt;
</span><span class='line'>        &lt;s:a action="listBook"&gt;All Books&lt;/s:a&gt;
</span><span class='line'>        Welcome, you have logined.
</span><span class='line'>        &lt;s:a action="logout"&gt;Logout&lt;/s:a&gt;
</span><span class='line'>        &lt;/s:if&gt;
</span><span class='line'>        &lt;s:else&gt;
</span><span class='line'>        &lt;s:a action="login!input"&gt;Login&lt;/s:a&gt; |
</span><span class='line'>        &lt;s:a action="register!input"&gt;Register&lt;/s:a&gt;
</span><span class='line'>        &lt;/s:else&gt;
</span><span class='line'>    &lt;/div&gt;
</span><span class='line'>    &lt;hr /&gt;
</span><span class='line'>    &lt;div&gt;Navigation&lt;/div&gt;
</span><span class='line'>    &lt;hr /&gt;
</span><span class='line'>    &lt;decorator:body /&gt;
</span><span class='line'>    &lt;hr /&gt;
</span><span class='line'>    &lt;div&gt;Footer&lt;/div&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>代码下载：<a href="https://github.com/dohkoos/JBookShelf">https://github.com/dohkoos/JBookShelf</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/29/tips-for-creating-executable-file-in-powerbuilder/">PowerBuilder生成可执行文件的小技巧</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-29T14:10:04+08:00" pubdate data-updated="true">Mar 29<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>使用资源文件（.pbr）引用资源</h3>

<p>在资源相同目录下建立.pbr文件，其中列出在应用中动态引用的资源文件，一行列出一个资源，格式如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>appico.ico
</span><span class='line'>appbmp1.bmp
</span><span class='line'>...
</span><span class='line'>appbmp9.bmp</span></code></pre></td></tr></table></div></figure>


<p>在.pbr文件中指定的文件名必须与在脚本中引用的资源匹配，若引用时包含路径，则在.pbr文件中也必须包含同一路径，否则因PowerBuilder在执行时只是简单地进行字符串比较而导致无法发现该资源。</p>

<h3>设置可执行文件图标</h3>

<p>应用 &ndash;> 属性 &ndash;> General &ndash;> Additional Properties按钮 &ndash;> Icon页签 &ndash;> Icon Name</p>

<h3>可执行文件所需的环境DLL</h3>

<p>最简便的方式是使用自带的打包程序PowerBuilder Runtime Packager。这个应用会自动把脱离环境运行所需的DLL等文件筛选出来。<br />
Sybase &ndash;> PowerBuilder 9.0 &ndash;> PowerBuilder Runtime Packager</p>

<p>运行后会生成一个MSI应用，执行下就可以解压出需要的DLL文件了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/27/draw-2d-bar-graph-using-ichartjs/">使用ichartjs画2D条形图</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-27T06:45:37+08:00" pubdate data-updated="true">Mar 27<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/blog/2011/09/23/in-rails-simple-to-use-open-flash-chart-ii-tutorial/">在Rails中使用Open Flash Chart II简单教程</a>中使用了OFC2来画2D条形图。现在Flash快要不行了，因为有了更好的HTML5。好的程序猿也要紧随潮流，使用新的技术来改进和增强他的代码。这里就尝试使用HTML5图形库来替换OFC2。比较已有的一些图形库，最后选定国产的<a href="http://www.ichartjs.com/">ichartjs</a>。</p>

<p>实现2D条形图真的很简单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;script type="text/javascript" src="ichart.1.1.min.js"&gt;&lt;/script&gt;
</span><span class='line'>&lt;script type="text/javascript"&gt;
</span><span class='line'>$(function() {
</span><span class='line'>  var data = [
</span><span class='line'>    {name: 'IE', value: 35.75, color: '#a5c2d5'},
</span><span class='line'>    {name: 'Chrome', value: 29.84, color: '#cbab4f'},
</span><span class='line'>    {name: 'Firefox', value: 24.88, color: '#76a871'},
</span><span class='line'>    {name: 'Safari',value: 6.77, color: '#9f7961'},
</span><span class='line'>    {name: 'Opera',value：2.02, color: '#a56f8f'},
</span><span class='line'>    {name: 'Other',value: 0.73, color: '#6f83a5'}
</span><span class='line'>  ];
</span><span class='line'>
</span><span class='line'>  new iChart.Bar2D({
</span><span class='line'>    render: 'canvasDiv',
</span><span class='line'>    data: data,
</span><span class='line'>    title: 'Top 5 Browsers from 1 to 29 Feb 2012',
</span><span class='line'>    showpercent: true,
</span><span class='line'>    decimalsnum: 2,
</span><span class='line'>    width: 800,
</span><span class='line'>    height: 400,
</span><span class='line'>    coordinate: {
</span><span class='line'>      scale: [{
</span><span class='line'>        position: 'bottom',
</span><span class='line'>        start_scale: 0,
</span><span class='line'>        end_scale: 40,
</span><span class='line'>        scale_space: 8,
</span><span class='line'>        listeners: {
</span><span class='line'>          parseText: function(t, x, y) {
</span><span class='line'>            return {text: t + "%"}
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>      }]
</span><span class='line'>    }
</span><span class='line'>  }).draw();
</span><span class='line'>}); 
</span><span class='line'>&lt;/script&gt;
</span><span class='line'>
</span><span class='line'>&lt;div id="canvasDiv"&gt;&lt;/div&gt;</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/13/logic-problems-the-teachers-birthday/">逻辑题-老师的生日</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-13T10:01:28+08:00" pubdate data-updated="true">Mar 13<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>小明和小强都是某老师的学生，老师的生日是M月N日，他们都知道老师的生日是以下十组中的一个。老师把M告诉了小明，把N告诉了小强，然后问他们是否知道自己的生日。小明说“如果我不知道小强也不知道”，小强说“本来我不知道，你说了这话我就知道了”，小明说“那我也知道了 ”。问老师的生日是以下的哪个？<br />
&frac34;, 3/5, 3/8, 6/4, 6/7, 9/1, 9/5, 12/1, 12/2, 12/8</p>

<p>按M排：<br />
&frac34;, 3/5, 3/8<br />
6/4, 6/7<br />
9/1, 9/5<br />
12/1, 12/2, 12/8</p>

<p>按N排：<br />
9/1, 12/1<br />
12/2<br />
&frac34;, 6/4<br />
3/5, 9/5<br />
6/7<br />
3/8, 12/8</p>

<p>条件一：小明说“如果我不知道小强也不知道”<br />
分析：因为M都是重复的，所以小明一定不知道。小明知道M以后肯定小强不知道，说明N肯定也是重复，可以剔除12/2和6/7这两个日期。另外，还可以排队N为2与7所对应的月份，因为当老师生日的M为6或12时，小强是有可能知道的，与已知条件相违背。<br />
结果：3/4, 3/5, 3/8, 9/1, 9/5</p>

<p>按M排：<br />
&frac34;, 3/5, 3/8<br />
9/1, 9/5</p>

<p>按N排：<br />
&frac34;<br />
3/5, 9/5<br />
3/8<br />
9/1</p>

<p>条件二：小强说“本来我不知道，你说了这话我就知道了”<br />
分析：根据上面的结果和条件二可以知道，现在N一定不能是重复的，可以把3/5和9/5排除。<br />
结果：3/4, 3/8, 9/1</p>

<p>按M排：<br />
&frac34;, 3/8<br />
9/1</p>

<p>按N排：<br />
&frac34;<br />
3/8<br />
9/1</p>

<p>条件三：小明说“那我也知道了”<br />
分析：综合条件二的结果和条件三可以判定现在M应该是单一的，所以只能是9。<br />
结果：9/1</p>

<p>老师的生日为9/1。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/10/htaccess-explanation-by-example/">.htaccess实例详解</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-10T12:01:35+08:00" pubdate data-updated="true">Mar 10<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>又一次迁移博客服务器。因为是迁移，就没有采取安装新的Wordpress，而是把以前的程序拷贝到服务器上。</p>

<p>打开首页的时候还好，访问具体文章时就出现问题了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Not Found
</span><span class='line'>The requested URL /sample-article.html was not found on this server.</span></code></pre></td></tr></table></div></figure>


<p>百思不得其解。后来试着去后台重新做设置，然后就发现在根目录下多了.htaccess文件，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># BEGIN WordPress
</span><span class='line'>&lt;IfModule mod_rewrite.c&gt;
</span><span class='line'>RewriteEngine On
</span><span class='line'>RewriteBase /
</span><span class='line'>RewriteRule ^index\.php$ - [L]
</span><span class='line'>RewriteCond %{REQUEST_FILENAME} !-f
</span><span class='line'>RewriteCond %{REQUEST_FILENAME} !-d
</span><span class='line'>RewriteRule . /index.php [L]
</span><span class='line'>&lt;/IfModule&gt;
</span><span class='line'># END WordPress</span></code></pre></td></tr></table></div></figure>


<p>以前也看过这个文件，总是模模糊糊不太明白。今天研究的时候发现一下子就清清楚楚了（这大概就是说的顿悟吧^_^不过它的发生应该还是建立在渐修的基础上）。</p>

<p>下面来说说这些内容的理解：</p>

<p>第1行就是打开重写引擎</p>

<p>第2行是设置URL前缀。</p>

<blockquote><p>Syntax:   RewriteRule Pattern Substitution [flags]</p>

<ul>
<li>(dash)
A dash indicates that no substitution should be performed (the existing path is passed through untouched). This is used when a flag (see below) needs to be applied without changing the path.</li>
</ul>


<p>last|L
 Stop the rewriting process immediately and don&rsquo;t apply any more rules. Especially note caveats for per-directory and .htaccess context.</p></blockquote>

<p>第3行是完全匹配index.php的URI，但不做替换，并且匹配成功后就停止执行重写过程。</p>

<p>第6行就是把所有的访问请求重写，指给index.php，然后停止执行重写过程。</p>

<blockquote><p>Syntax: RewriteCond TestString CondPattern</p>

<p>REQUEST_FILENAME
 The full local filesystem path to the file or script matching the request, if this has already been determined by the server at the time REQUEST_FILENAME is referenced. Otherwise, such as when used in virtual host context, the same value as REQUEST_URI.</p>

<p>You can prefix the pattern string with a &lsquo;!&rsquo; character (exclamation mark) to specify a non-matching pattern.</p>

<p>&lsquo;-d&rsquo; (is directory)
 Treats the TestString as a pathname and tests whether or not it exists, and is a directory.</p>

<p>&lsquo;-f&rsquo; (is regular file)
 Treats the TestString as a pathname and tests whether or not it exists, and is a regular file.</p></blockquote>

<p>第4和第5行是不去测试访问URI是否是目录或文件。其实有了第6行这两行基本就是摆设了。</p>

<p>最后再唠叨一句，有问题直接查官方文档应该是最好的选择。官方文档链接：<a href="http://httpd.apache.org/docs/current/mod/mod_rewrite.html">Apache Module mod_rewrite</a>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/24/do-we-really-need-naming-conventions-for-interfaces/">我们真的需要接口命名规范吗？</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-24T13:34:04+08:00" pubdate data-updated="true">Feb 24<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="http://www.adam-bien.com/roller/abien/entry/in_the_age_of_dryness">http://www.adam-bien.com/roller/abien/entry/in_the_age_of_dryness</a></p>

<p>译者：感觉这篇文章讲的不错，也不算太长，就翻译了过来。</p>

<p>在过去的项目/审查中我发现了如下的接口及其实现的命名规范：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IService service = new Service();
</span><span class='line'>
</span><span class='line'>Service service = new ServiceImpl();
</span><span class='line'>
</span><span class='line'>ServiceIF service = new Service();&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>每一条都含有多余信息。无论是强调接口或其实现，相关信息都已经包含在代码中，所以都是多余的。这种命名规范仅当你真的不知道如何命名实现的时候才需要，作为去思考一个名称的替代，它更容易依靠现有的模板。</p>

<p>实现名称的缺乏可能也是作为它的非充分责任的一个指标（an indicator for it&rsquo;s unsufficient responsibilities）。因此，如果你找不到一个适当的实现名称，考虑移除接口直接暴露实现可能是个好主意－没有奇怪的规范。实际上JDK中没有这样的规范，接口及其实现也经常称为不同（are often even called differently）：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Runnable r = new Thread();
</span><span class='line'>
</span><span class='line'>RootPaneContainer c = new JFrame();
</span><span class='line'>
</span><span class='line'>TableModel t = new DefaultTableModel();
</span><span class='line'>
</span><span class='line'>Remote remote = new UnicastRemoteObject();&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>接口的目的是抽象或从几个实现解耦。一个单一的实现并不需要通过接口来解耦。也有一些例外的规则，如需要使用动态代理等。</p>

<p><strong>通过单个的，有着奇怪命名规范的实现（implementation）来实现（realize）一个接口不应该被认为是一般的最佳实践……</strong>
</p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/24/logic-problems-100-lamps/">逻辑题-100盏电灯</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-24T08:56:21+08:00" pubdate data-updated="true">Feb 24<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>房间里有100盏电灯，编号为1，2，3&hellip;100，每盏灯上有一个按钮，初始时灯全都是关的。<br />
编好号的100位同学由房间外依次走进去，将自己编号的倍数的灯的按钮全部按一次，例如第一位同学把编号是1的倍数的灯的按钮按一下（此时100盏灯全亮），第二位同学把编号是2的倍数的灯的按钮按一下（此时只有50盏灯亮着，50盏被这个人按灭了）……第100位同学把编号是100的倍数的灯（即编号为100的灯）的按钮按一下，请问依次走完后，还有多少盏灯亮着？</p>

<p>解题思路：<br />
被按过奇数次的灯亮着，偶数次的灯关了。<br />
因为每个同学会把自己编号的倍数的灯全部按一次，所以：<br />
1号灯会被1号同学按下；<br />
2号灯会被1，2号同学按下；<br />
3号灯会被1，3号同学按下；<br />
4号灯会被1，2，4号同学按下；<br />
&hellip;<br />
10号灯会被1，2，5，10号同学按下。</p>

<p>从上面可以总结出n号灯会被以它所有约数为编号的同学按下。</p>

<p>这样，问题就变成了求每盏灯的编号有多少个约数的数学问题。如果约数个数为奇数，灯亮着；反之，灯关着。</p>

<p>Ruby代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Light state: ON/OFF = true/false
</span><span class='line'>lamps = Array.new(100, false)
</span><span class='line'>
</span><span class='line'>1.upto(lamps.length) do |lno|
</span><span class='line'>  1.upto(lno) do |fno|
</span><span class='line'>    lamps[lno - 1] = !lamps[lno - 1] if lno % fno == 0
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>lamps.each_index do |i|
</span><span class='line'>  print "Light #{i + 1} is "
</span><span class='line'>  puts lamps[i] ? "ON" : "OFF"
</span><span class='line'>end&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>再然后，我们会发现编号1，4，9，16，25&hellip;100的灯是亮着的，其它都是灭的。即编号值可以开出整数平方根的灯是亮的。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/01/interceptor-prohibit-users-from-accessing-unauthorized-books/">使用Interceptor禁止用户访问未授权的图书信息</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-01T02:50:02+08:00" pubdate data-updated="true">Feb 1<sup>st</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>现在的JBookShelf有两个问题：<br />
1. 未登录的用户可以访问图书信息；<br />
2. 登录后的用户可以访问其他用户的图书信息。</p>

<p>第一个问题可以使用Struts 2的Interceptor来解决：<br />
1. 创建一个实现了Interceptor接口的类；<br />
2. 在struts.xml配置中定义这个拦截器；<br />
3. 在struts.xml中定义一个使用了上面拦截器的拦截栈；<br />
4. 在struts.xml中定义一个全局转向配置。</p>

<p>实现自己的拦截器有点要注意的是，拦截器必须是无状态的，不要使用在API提供的ActionInvocation之外的任何东西。要求拦截器是无状态的原因是Struts 2不能保证为每一个请求或者action创建一个实例，所以如果拦截器带有状态，会引发并发问题。</p>

<p>创建AuthorizationInterceptor类，继承类AbstractInterceptor。为什么继承它呢？而不是直接实现接口Interceptor。这是因为AbstractInterceptor已经实现了Interceptor接口，并且实现了接口中的init和destroy方法。而在这个拦截器中，我们并不需要使用这两个方法。下面上代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.account.interceptor;
</span><span class='line'>
</span><span class='line'>import java.util.Collections;
</span><span class='line'>import java.util.Set;
</span><span class='line'>
</span><span class='line'>import com.codemany.account.model.User;
</span><span class='line'>
</span><span class='line'>import com.opensymphony.xwork2.Action;
</span><span class='line'>import com.opensymphony.xwork2.ActionInvocation;
</span><span class='line'>import com.opensymphony.xwork2.interceptor.AbstractInterceptor;
</span><span class='line'>import com.opensymphony.xwork2.util.TextParseUtil;
</span><span class='line'>
</span><span class='line'>public class AuthorizationInterceptor extends AbstractInterceptor {
</span><span class='line'>    private static final long serialVersionUID = -5140884040684756043L;
</span><span class='line'>
</span><span class='line'>    protected Set&lt;String&gt; skipActions = Collections.emptySet();
</span><span class='line'>
</span><span class='line'>    public void setSkipActions(String skipActions) {
</span><span class='line'>        this.skipActions = TextParseUtil.commaDelimitedStringToSet(skipActions);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public String intercept(ActionInvocation invocation) throws Exception {
</span><span class='line'>        User user = (User)invocation.getInvocationContext()
</span><span class='line'>                .getSession().get(User.SESSION_KEY);
</span><span class='line'>
</span><span class='line'>        boolean isLogined = user != null;
</span><span class='line'>        String action = invocation.getProxy().getActionName();
</span><span class='line'>        // 如果用户未登录，并且访问的是需要登录权限的Action，就跳转到全局转向配置login上
</span><span class='line'>        if (isLogined || skipActions.contains(action)) {
</span><span class='line'>            return invocation.invoke();
</span><span class='line'>        } else {
</span><span class='line'>            return Action.LOGIN;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这里的skipActions目的是为了跳过一些不需要拦截的Action。因为默认情况下，拦截器会拦截Action中的所有的方法。像login，register这类Action是任何用户在任何状态下都可以访问的，所以不需要拦截，这里就可以将这些Action放到skipActions中来跳过拦截。</p>

<p>实现了拦截类后还要在struts.xml进行配置使它起作用，以下是struts.xml的完整代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;!DOCTYPE struts PUBLIC
</span><span class='line'>    "-//Apache Software Foundation//DTD Struts Configuration 2.3//EN"
</span><span class='line'>    "http://struts.apache.org/dtds/struts-2.3.dtd"&gt;
</span><span class='line'>
</span><span class='line'>&lt;struts&gt;
</span><span class='line'>    &lt;constant name="struts.enable.DynamicMethodInvocation" value="true" /&gt;
</span><span class='line'>    &lt;constant name="struts.devMode" value="true" /&gt;
</span><span class='line'>
</span><span class='line'>    &lt;package name="default" extends="struts-default"&gt;
</span><span class='line'>        &lt;interceptors&gt;
</span><span class='line'>            &lt;interceptor name="authorization"
</span><span class='line'>                class="com.codemany.account.interceptor.AuthorizationInterceptor" /&gt;
</span><span class='line'>
</span><span class='line'>            &lt;interceptor-stack name="authorizationStack"&gt;
</span><span class='line'>                &lt;interceptor-ref name="authorization"&gt;
</span><span class='line'>                    &lt;param name="skipActions"&gt;login, logout, register&lt;/param&gt;
</span><span class='line'>                &lt;/interceptor-ref&gt;
</span><span class='line'>                &lt;interceptor-ref name="defaultStack" /&gt;
</span><span class='line'>            &lt;/interceptor-stack&gt;
</span><span class='line'>        &lt;/interceptors&gt;
</span><span class='line'>
</span><span class='line'>        &lt;default-interceptor-ref name="authorizationStack" /&gt;
</span><span class='line'>
</span><span class='line'>        &lt;!-- 全局转向配置 --&gt;
</span><span class='line'>        &lt;!-- 还记得拦截器里面的return Action.LOGIN这句吧，当程序执行完这一行后，--&gt;
</span><span class='line'>        &lt;!-- 就会到struts.xml文件的global-results中找name为login的全局转向配置。--&gt;
</span><span class='line'>        &lt;global-results&gt;
</span><span class='line'>            &lt;result name="login" type="redirectAction"&gt;login!input&lt;/result&gt;
</span><span class='line'>        &lt;/global-results&gt;
</span><span class='line'>    &lt;/package&gt;
</span><span class='line'>
</span><span class='line'>    &lt;include file="account.xml" /&gt;
</span><span class='line'>    &lt;include file="book.xml" /&gt;
</span><span class='line'>&lt;/struts&gt;</span></code></pre></td></tr></table></div></figure>


<p>然后将account.xml和book.xml中package继承的父包改成struts.xml配置中的default包：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;package name="xxx" extends="default"&gt;</span></code></pre></td></tr></table></div></figure>


<p>第二个问题的解决就是重写BookAction.java的代码，不再从数据库中读取Book数据，而是从当前登录用户的books属性中查找Book信息。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.book.action;
</span><span class='line'>
</span><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import com.codemany.account.model.User;
</span><span class='line'>import com.codemany.book.model.Book;
</span><span class='line'>import com.codemany.book.service.BookService;
</span><span class='line'>
</span><span class='line'>import com.opensymphony.xwork2.ActionContext;
</span><span class='line'>import com.opensymphony.xwork2.ActionSupport;
</span><span class='line'>
</span><span class='line'>public class BookAction extends ActionSupport {
</span><span class='line'>    private static final long serialVersionUID = 2538923417705852774L;
</span><span class='line'>
</span><span class='line'>    private Long bookId;
</span><span class='line'>    private Book book;
</span><span class='line'>    private List&lt;Book&gt; bookList;
</span><span class='line'>
</span><span class='line'>    private BookService bookService;
</span><span class='line'>
</span><span class='line'>    public String list() throws Exception {
</span><span class='line'>        if (bookList == null) {
</span><span class='line'>            bookList = new ArrayList&lt;Book&gt;();
</span><span class='line'>        }
</span><span class='line'>        bookList.addAll(getCurrentUser().getBooks());
</span><span class='line'>        return "list";
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String show() throws Exception {
</span><span class='line'>        book = getCurrentUser().getBook(bookId);
</span><span class='line'>        return "show";
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String input() throws Exception {
</span><span class='line'>        if (bookId != null) {
</span><span class='line'>            book = getCurrentUser().getBook(bookId);
</span><span class='line'>        }
</span><span class='line'>        return INPUT;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String saveOrUpdate() throws Exception {
</span><span class='line'>        book.setUser(getCurrentUser());
</span><span class='line'>        bookService.saveOrUpdateBook(book);
</span><span class='line'>        return SUCCESS;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String delete() throws Exception {
</span><span class='line'>        Book book = getCurrentUser().getBook(bookId);
</span><span class='line'>        if (book != null) {
</span><span class='line'>            bookService.deleteBook(bookId);
</span><span class='line'>            getCurrentUser().getBooks().remove(book);
</span><span class='line'>        }
</span><span class='line'>        return SUCCESS;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public List&lt;Book&gt; getBookList() {
</span><span class='line'>        return bookList;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public Book getBook() {
</span><span class='line'>        return book;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setBook(Book book) {
</span><span class='line'>        this.book = book;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setBookId(Long bookId) {
</span><span class='line'>        this.bookId = bookId;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setBookService(BookService bookService) {
</span><span class='line'>        this.bookService = bookService;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private User getCurrentUser() {
</span><span class='line'>        return (User)ActionContext.getContext()
</span><span class='line'>                .getSession().get(User.SESSION_KEY);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>上面的代码会产生异常，提示取出的Book数据为空，所以要在User.hbm.xml中set标签后添加属性lazy=“false”，这样Hibernate从数据库中读取User数据时会连带取出对应的Book数据：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;set name="books" inverse="true" lazy="false"&gt;</span></code></pre></td></tr></table></div></figure>


<p>下面是BookAction类中用到的User.getBook(bookId)代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class User {
</span><span class='line'>
</span><span class='line'>    public Book getBook(Long bookId) {
</span><span class='line'>        for (Book book : books) {
</span><span class='line'>            if (bookId != null && bookId.equals(book.getId())) {
</span><span class='line'>                return book;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        return null;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>代码下载：<a href="https://github.com/dohkoos/JBookShelf">https://github.com/dohkoos/JBookShelf</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/17/problem-with-nokogiri-when-url-containing-chinese-character/">Nokogiri抓取页面URL含有中文参数的问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/09/logic-problems-how-many-sick-dogs/">逻辑题-几条病狗</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/07/debugging-rails-with-pry/">使用Pry调试Rails项目</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/06/raspberry-pi-wifi-with-static-ip-address/">Raspberry Pi使用无线网卡</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/28/how-i-made-ruby-script-156x-faster/">我是如何让Ruby脚本速度提升156倍的</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://dohkoos.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 133%" href="/tags/android/">Android</a>
<a style="font-size: 111%" href="/tags/crack/">Crack</a>
<a style="font-size: 108%" href="/tags/database/">Database</a>
<a style="font-size: 105%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 132%" href="/tags/java/">Java</a>
<a style="font-size: 97%" href="/tags/listview/">ListView</a>
<a style="font-size: 108%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 97%" href="/tags/paperclip/">Paperclip</a>
<a style="font-size: 116%" href="/tags/powerbuilder/">PowerBuilder</a>
<a style="font-size: 120%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 101%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 101%" href="/tags/struts/">Struts</a>
<a style="font-size: 105%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 108%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://quake.iteye.com/">写程序的70后</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dohkoos';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
