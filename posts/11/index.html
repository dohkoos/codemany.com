
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="使用的是EDUP EP-N1556这款无线网卡，体积小巧，支持300M速率，买回来插在RPi上直接就能识别了。 输入lsusb命令，可以见到设备列表中有RTL8192CU 802.11n WLAN Adapter字样，说明网卡已经被系统识别，芯片是RTL8192。 下面就给无线网卡设置静态IP地址 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/posts/11/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46570161-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="codemany.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/using-wifi-on-raspberry-pi/">在Raspberry Pi上使用无线网卡</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-06T20:25:08+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:25 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>使用的是EDUP EP-N1556这款无线网卡，体积小巧，支持300M速率，买回来插在RPi上直接就能识别了。</p>

<p>输入lsusb命令，可以见到设备列表中有RTL8192CU 802.11n WLAN Adapter字样，说明网卡已经被系统识别，芯片是RTL8192。</p>

<p>下面就给无线网卡设置静态IP地址：</p>

<p>修改/etc/wpa_supplicant/wpa_supplicant.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
</span><span class='line'>update_config=1
</span><span class='line'>
</span><span class='line'>network={
</span><span class='line'>  ssid="NETGEAR"
</span><span class='line'>  psk="12345678"
</span><span class='line'>  proto=RSN  # 也可以写成WPA2
</span><span class='line'>  key_mgmt=WPA-PSK  # 一定不要写成WPA2-PSK
</span><span class='line'>  id_str="edup1556"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>修改/etc/network/interfaces</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'>iface eth0 inet static
</span><span class='line'>  address 192.168.0.100
</span><span class='line'>  netmask 255.255.255.0
</span><span class='line'>  gateway 192.168.0.1
</span><span class='line'>  dns-nameservers 8.8.8.8
</span><span class='line'>
</span><span class='line'>allow-hotplug wlan0
</span><span class='line'>iface wlan0 inet manual
</span><span class='line'>  wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</span><span class='line'>iface edup1556 inet static
</span><span class='line'>  address 192.168.0.200
</span><span class='line'>  netmask 255.255.255.0
</span><span class='line'>  gateway 192.168.0.1
</span><span class='line'>  dns-nameservers 8.8.8.8
</span><span class='line'>
</span><span class='line'>iface default inet dhcp</span></code></pre></td></tr></table></div></figure>

<p>然后用ifconfig命令列出所有的网络设备，可以看到wlan0的IP是192.168.0.200了。</p>

<p>你的树莓派自由了，不再需要网线拖着了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-i-made-ruby-script-156x-faster/">我是如何让Ruby脚本速度提升156倍的</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-28T13:04:08+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>以前写过<a href="/blog/using-ruby-to-batch-rename-filename-from-traditional-to-simplified/">使用Ruby批量修改繁体文件名为简体</a>，可惜脚本的性能很有问题，批量重命名时运行速度非常慢。这次准备优化下代码，提升脚本的执行效率。</p>

<p>profile.rb是为Ruby程序准备的profiler，它可以统计并输出各方法的运行时间，以便于找到程序执行的性能瓶颈。这次就用它来剖析脚本的运行时间。使用方法很简单，加上命令行选项-r profile就可以：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ruby -r profile rename.rb</span></code></pre></td></tr></table></div></figure>

<p>运行结束后，会把统计信息输出到标准错误输出中。如下图所示：</p>

<p><img src="/uploads/profile-before-tuning.png" title="profile-before-tuning" ></p>

<p>profile统计的是各方法的运行时间，分为两类。一类是计算的是从方法调用到方法返回之间的时间，称为整体时间；另一类则是从整体时间中扣除在该方法中调用其它方法所耗费时间之后得到的时间，称为实际时间。</p>

<p>上图输出信息每行中各字段含义如下（从左到右）：</p>

<ul>
<li>该方法执行时间占整体时间的百分比，比例越高越说明这行代码可能需要优化</li>
<li>整体时间的总和</li>
<li>实际时间的总和</li>
<li>被调用的次数</li>
<li>每次调用的平均实际时间（毫秒）</li>
<li>每次调用的平均整体时间（毫秒）</li>
<li>方法名</li>
</ul>

<p>由上图可以看出，脚本执行的时间大部分耗在了循环上。解决方法有两个：消除循环或减少循环次数。前者很难实现，暂且还没有想到办法，也许根本就没有可能。脚本中mapping的大小为2685，所以每修改一个文件名需要执行2685次循环，且循环中的encode和gsub!都是耗时操作。通常文件名的长度不超过30个字符，通过遍历文件名中每个字符的方式重命名就可以把循环次数缩减到不超过30次。</p>

<p>修改代码后重新执行分析命令，得到的结果是脚本运行时间从379395秒变成2418秒，性能整整提升了156倍，达到2个数量级的效果。</p>

<p><img src="/uploads/profile-after-tuning.png" title="profile-after-tuning" ></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/using-raspberry-pi-to-monitor-home-humiture/">使用Raspberry Pi监控室内温湿度</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-24T14:19:44+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>机房没有温湿度监控系统，只有温湿度计，还不是数字的，只能得到个大概的读数，不是非常精确。怎么办？自己动手DIY个在线的温湿度监控系统吧！</p>

<p>物品清单：</p>

<ul>
<li>金士顿16G的SDHC卡1张</li>
<li>SDHC读卡器1个（可选）</li>
<li>网线1条</li>
<li>手机充电器（5V/1A）1个</li>
<li>MicroUSB数据线1条</li>
<li>电脑1台</li>
<li>1P-1P双头母杜邦线3条</li>
<li>10K电位器一个</li>
<li>DHT11或DHT22温湿度传感器一个（可以购买已经焊好电阻的传感器模块）</li>
</ul>

<h3 id="让树莓派（raspberry-pi）工作起来">让树莓派（Raspberry Pi）工作起来</h3>

<p>从 <a href="http://www.raspberrypi.org/downloads">http://www.raspberrypi.org/downloads</a> 下载基于debian的wheezy镜像Raspbian。如果使用Windows系统，官方建议使用<a href="http://sourceforge.net/projects/win32diskimager/">Win32DiskImager</a>来复制image文件到SD卡（如果是Linux系统可以用工具dd）。写入系统后，把卡插到板子上，接上网线、电源，然后就启动了。等个20多秒，板上3个小灯都亮了，表明系统已经启动成功。</p>

<p>登录路由器后台找到raspberrypi设备分配到的IP。然后使用SSH或VNC（前者是命令行界面，后者是图形界面）连接刚才从路由器找到的IP地址。登录的默认账号是pi，密码是raspberry。登录RPi之后输入ping qq.com测试上网是否正常。</p>

<h3 id="使用固定的ip访问rpi">使用固定的IP访问RPi</h3>

<p>默认情况下RPi使用的是自动分配的IP地址，每次登录都需要在路由器中查找对应IP，实在太麻烦，可以把它设置成静态的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vi /etc/network/interfaces</span></code></pre></td></tr></table></div></figure>

<p>打开配置文件，看到如下内容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>
</span><span class='line'>iface lo inet loopback
</span><span class='line'>iface eth0 inet dhcp
</span><span class='line'>
</span><span class='line'>allow-hotplug wlan0
</span><span class='line'>iface wlan0 inet manual
</span><span class='line'>wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</span><span class='line'>iface default inet dhcp</span></code></pre></td></tr></table></div></figure>

<p>将之修改成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'>iface eth0 inet static
</span><span class='line'>  address 192.168.0.100
</span><span class='line'>  netmask 255.255.255.0
</span><span class='line'>  gateway 192.168.0.1
</span><span class='line'>  dns-nameservers 8.8.8.8
</span><span class='line'>
</span><span class='line'>allow-hotplug wlan0
</span><span class='line'>iface wlan0 inet manual
</span><span class='line'>  wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</span><span class='line'>
</span><span class='line'>iface default inet dhcp</span></code></pre></td></tr></table></div></figure>

<p>然后存盘退出。以后就可以通过192.168.0.100来登录RPi了。</p>

<h3 id="把温湿度传感器接到rpi上">把温湿度传感器接到RPi上</h3>

<p><img src="/uploads/rpi-dht22.png" title="rpi-dht22" ></p>

<p>DHT11/DHT22共有4根引脚：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1 -&gt; 3.3v 接左边第1个GPIO针脚
</span><span class='line'>2 -&gt; GPIO 数据接口，可随意连接1个GPIO针脚（第7个针脚对应的是GPIO Pin #4）
</span><span class='line'>3 -&gt; NC 不接
</span><span class='line'>4 -&gt; GND 接地（第14个针脚）</span></code></pre></td></tr></table></div></figure>

<p>注意：在1脚和2脚间还需要并联10K的电阻，以保持读数稳定。</p>

<p>安装好的样子：</p>

<p><img src="/uploads/rpi-actual.png" title="rpi-actual" ></p>

<h3 id="用c代码读取当前的温度和湿度值">用C代码读取当前的温度和湿度值</h3>

<p>用的是树莓派2红色B型，它采用Broadcom BCM2835 (CPU, GPU, DSP, and SDRAM)芯片。所以读取GPIO口需要到 <a href="http://www.open.com.au/mikem/bcm2835/index.html">http://www.open.com.au/mikem/bcm2835/index.html</a> 获取最新的BCM2835 C语言库，然后下载，编译和安装。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://www.open.com.au/mikem/bcm2835/bcm2835-1.36.tar.gz
</span><span class='line'>tar -zxvf bcm2835-1.36.tar.gz
</span><span class='line'>cd bcm2835-1.36
</span><span class='line'>./configure
</span><span class='line'>make
</span><span class='line'>sudo make install</span></code></pre></td></tr></table></div></figure>

<p>从GitHub库中获取DHT11/DHT22温湿度程序，编译测试。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /home/pi
</span><span class='line'>git clone https://github.com/dohkoos/Raspberry-Pi-Code.git
</span><span class='line'>cd Raspberry-Pi-Code/DHT22
</span><span class='line'>make
</span><span class='line'>sudo ./dht 22 4 # 数据接口接在第7针脚，所以这里是4</span></code></pre></td></tr></table></div></figure>

<h3 id="记录曲线图到云端">记录曲线图到云端</h3>

<p>这里使用<a href="http://www.yeelink.net/">Yeelink</a>的服务，Yeelink是国内比较知名的免费物联网数据平台。根据它的API规则，提交的数据必须为JSON格式：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{"timestamp": "2012-03-15 16:13:14", "value": 294.34}</span></code></pre></td></tr></table></div></figure>

<p>将温湿度值提交到Yeelink的Ruby代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Capture temperature & humidity value from the console
</span><span class='line'>output = `sudo ./dht 22 4`
</span><span class='line'>mt = /Temp =\s+([0-9.]+)/.match(output)
</span><span class='line'>temperature = mt[1]
</span><span class='line'>
</span><span class='line'>mt = /Hum =\s+([0-9.]+)/.match(output)
</span><span class='line'>humidity = mt[1]
</span><span class='line'>
</span><span class='line'># Combined temperature & humidity value into json format
</span><span class='line'>json_temperature = %Q[{\\"timestamp\\": \\"#{Time.now}\\", \\"value\\": #{temperature}}]
</span><span class='line'>json_humidity = %Q[{\\"timestamp\\": \\"#{Time.now}\\", \\"value\\": #{humidity}}]
</span><span class='line'>
</span><span class='line'># Post json data to Yeelink
</span><span class='line'>`curl -X POST -d "#{json_temperature}" -H "Content-Type: application/json" -H "U-ApiKey:XXXXXXXXXXXXXXXX" http://api.yeelink.net/v1.0/device/&lt;device_id&gt;/sensor/&lt;sensor_id&gt;/datapoints`
</span><span class='line'>`curl -X POST -d "#{json_humidity}" -H "Content-Type: application/json" -H "U-ApiKey:XXXXXXXXXXXXXXXX" http://api.yeelink.net/v1.0/device/&lt;device_id&gt;/sensor/&lt;sensor_id&gt;/datapoints`</span></code></pre></td></tr></table></div></figure>

<p>将U-ApiKey:XXXXXXXXXXXXXXXX替换为自已账户的API Key，后面的URL也需要替换为自己申请的传感器URL。</p>

<h3 id="添加到计划任务">添加到计划任务</h3>

<p>使用crontab命令将以下内容添加到计划任务中：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># m h dom mon dow command
</span><span class='line'>*/10 * * * * cd /home/pi/Raspberry-Pi-Code/DHT22/ && ruby yeelink.rb</span></code></pre></td></tr></table></div></figure>

<p>重启计划任务，然后每隔10分钟就会上传一次数据到云端。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo /etc/init.d/cron restart</span></code></pre></td></tr></table></div></figure>

<p>下面是我的曲线图：</p>

<p><img src="/uploads/rpi-yeelink.png" title="rpi-yeelink" ></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/rebuild-ebook-website-with-responsive-design/">使用响应式设计改造电子书网站</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-19T11:55:16+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:55 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>因为要在其它设备上测试响应式设计的效果，需要先对开发环境做些简单的配置。</p>

<p>启动服务器时需加上本机的IP地址和访问端口（通常是80）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails s -b 192.168.0.100 -p 80</span></code></pre></td></tr></table></div></figure>

<p>配置Windows系统的内置防火墙，开启80端口以供其它设备访问：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netsh advfirewall firewall add rule name="Open Port 80" dir=in action=allow protocol=TCP localport=80</span></code></pre></td></tr></table></div></figure>

<p>查看和删除防火墙规则的命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netsh advfirewall firewall delete rule name="Open Port 80" protocol=TCP localport=80
</span><span class='line'>netsh advfirewall firewall show rule name="Open Port 80"</span></code></pre></td></tr></table></div></figure>

<p>响应式设计的优缺点就不多说了，已经有太多的文章讲过这些。这里主要讲如何使用响应式设计改造现有的电子书网站。</p>

<p>首先，需要使用viewport标签设置屏幕宽度为设备宽度，使网站内容可以适应响应式变化。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;</span></code></pre></td></tr></table></div></figure>

<p>因为这是一个非常简陋，并且以内容为主的网站。在上述设置后几乎不用再修改就能适应不同屏幕分辨率下的信息呈现，除了导航栏因为导航选项较多，在手机等设备上打开会出现后面部分选项被挤下去。抽屉样式的导航是解决这个问题的好方法。在网上找到一个横向导航栏切换成抽屉式导航栏的库<a href="http://srobbin.github.io/jquery-pageslide/">jQuery PageSlide</a>，它使用图片实现三明治图标，所以对它做了些修改，用标签来实现：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;ul class="burger"&gt;
</span><span class='line'>  &lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;</span></code></pre></td></tr></table></div></figure>

<p>对应的CSS代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.burger {
</span><span class='line'>  li {
</span><span class='line'>    height: 4px;
</span><span class='line'>    width: 30px;
</span><span class='line'>    background: #000;
</span><span class='line'>    border-radius: 3px;
</span><span class='line'>    margin: 5px 0;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>要实现响应式的话，只要让它在正常情况下隐藏，屏幕变小时显现即可：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.burger {
</span><span class='line'>  display: none;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@media screen and (max-width: 480px) {
</span><span class='line'>  .burger {
</span><span class='line'>    display: block;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>还需要在application.html.erb的底部开启点击三明治图标时的响应事件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= javascript_include_tag "jquery.pageslide", "data-turbolinks-track" =&gt; true %&gt;
</span><span class='line'>&lt;script&gt;
</span><span class='line'>  $(".burger").pageslide();
</span><span class='line'>&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>

<p>导航条的CSS也需要做些修改，使之能在屏幕变小时转换成抽屉式导航条：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@media screen and (max-width: 480px) {
</span><span class='line'>  nav ul {
</span><span class='line'>    display: none;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>至此，网站的响应式改造就基本完成了。如果你觉得对你有所帮助，请将此文发送给你的朋友，如果你还有更好的建议也可以在下面的评论中分享你的经验。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/multiple-file-upload-with-jquery-rails-4-and-paperclip/">使用jQuery、Rails 4和Paperclip进行多文件上传</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-27T08:21:48+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>8:21 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="https://5minutenpause.com/blog/2013/09/04/multiple-file-upload-with-jquery-rails-4-and-paperclip/">https://5minutenpause.com/blog/2013/09/04/multiple-file-upload-with-jquery-rails-4-and-paperclip/</a></p>

<p>在最近的项目中，我需要一个方便的文件上传器。我想要多文件上传和进度条。我想要它们都能与<a href="http://getbootstrap.com/">Bootstrap</a>一起工作。<a href="http://blueimp.github.io/jQuery-File-Upload/">jQuery File Upload</a>能够满足这些需求。初看上去它似乎不容易使用，在研究后我发现Ryan Bates做过一个关于<a href="http://railscasts.com/episodes/381-jquery-file-upload">jQuery文件上传</a>的<a href="http://railscasts.com/">railscast</a>。不幸的是，这个railscast使用了Rails 3和旧的jQuery版本。所以我必须调整它。涉及这个主题的其它博文都开始于2012年甚至更早，在这里是新的Rails 4版本。</p>

<p>我们不是生活在真空中，所以会经常性地使用已有的想法（<a href="http://everythingisaremix.info/blog/everything-is-a-remix-the-ted-talk">一切都是混合</a>），因此我没有试图去提出一个完全原创的解决方案，下面我的实现是基于Ryans的工作。</p>

<p><strong>更新：</strong>我为这篇文章创建了一个<a href="https://github.com/5minpause/multiple-file-upload">GitHub仓库</a>。你可以将其用作本文中我使用的所有内容的完整工作副本。我使用这些提交来跟踪博客文章，以便你可以使用它们“重播”我的实现。如果有任何问题，请<a href="https://github.com/5minpause/multiple-file-upload/issues">在GitHub打开一个issue</a>，并在那里询问，或者就在本文后面发布你的评论。谢谢。</p>

<p><strong>更新2：</strong>Paul Walker在评论中指出了如何解决Turbolinks的问题。如果你也有这种情况，请看<a href="http://5minutenpause.com/blog/2013/09/04/multiple-file-upload-with-jquery-rails-4-and-paperclip/#comment-1595778720">他对Turbolinks的评论</a>。</p>

<p><strong>更新3：</strong>如果你想知道如何在后台完成图片处理，请参阅<a href="http://5minutenpause.com/blog/2014/10/24/comprehensive-guide-to-background-processing-of-uploads-with-activejob-and-rails-4-dot-2">我的这个主题的新帖子</a>。我会给你展示如何使用Rails 4.2的Active Job和Delayed Job来实现后台处理。</p>

<h3 id="gem和资源文件">Gem和资源文件</h3>

<p>我们从Gemfile开始，添加<code>jquery-fileupload-rails</code>这个gem。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'jquery-fileupload-rails'</span></code></pre></td></tr></table></div></figure>

<p>使用<code>bundle install</code>安装所有gem。</p>

<p>安装后，你需要在你的application.js中引入以下这些文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//= require jquery
</span><span class='line'>//= require jquery_ujs
</span><span class='line'>//= require jquery-fileupload/basic
</span><span class='line'>//= require jquery-fileupload/vendor/tmpl
</span><span class='line'>//= require_tree .</span></code></pre></td></tr></table></div></figure>

<p>我们在这里使用基本版本，并且包含<code>jquery-fileupload/vendor/tmpl</code>，所以我们可以选择渲染我们自己的模板。</p>

<h3 id="视图">视图</h3>

<p>我们有个表单用于上传文件，并将JavaScript模板包含在文件的底部。有件事要注意：模板脚本必须是没有换行或空格的单行程序。否则jQuery会抱怨：<code>Uncaught Syntax error, unrecognized expression: [object Object]</code>。另一个解决方案是使用<code>$.parseHTML();</code>。接下来我会给你展示如何在uploads.js.coffee中做到这点。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= form_for Upload.new, :url =&gt; uploads_path, html: { multipart: true } do |f| %&gt;
</span><span class='line'>  &lt;%= f.label :uploaded_file, t('.upload_new_file') %&gt;
</span><span class='line'>  &lt;%= f.file_field :uploaded_file, multiple: true, name: 'upload[uploaded_file]' %&gt;
</span><span class='line'>  &lt;%= f.submit t(:save), class: 'btn' %&gt;
</span><span class='line'>&lt;% end %&gt;
</span><span class='line'>
</span><span class='line'>&lt;% # jquery upload template # %&gt;
</span><span class='line'>&lt;script id="template-upload" type="text/x-tmpl"&gt;
</span><span class='line'>  &lt;div class="upload"&gt;
</span><span class='line'>    { %=o.name % }&lt;div class="progress"&gt;&lt;div class="bar" style="width: 0%"&gt;&lt;/div&gt;&lt;/div&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>

<p>因为要返回JavaScript脚本，所以:create成功后要渲染的文件如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% if @upload.new_record? %&gt;
</span><span class='line'>  alert('Failed');
</span><span class='line'>&lt;% else %&gt;
</span><span class='line'>  $('ul.thumbnails').append("&lt;%=j render partial: 'photosets/upload', locals: { upload: @upload } %&gt;");
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>

<p>当你点击提交以上传你的图片时，实际发生的是你上传的每张图片都有多次提交。现在我们需要处理这些提交。我们在CoffeeScript文件里面做这些：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jQuery -&gt;
</span><span class='line'>  $('#upload_uploaded_file').attr('name','upload[uploaded_file]')
</span><span class='line'>  $('#new_upload').fileupload
</span><span class='line'>    dataType: 'script'
</span><span class='line'>    add: (e, data) -&gt;
</span><span class='line'>      types = /(\.|\/)(gif|jpe?g|png|mov|mpeg|mpeg4|avi)$/i
</span><span class='line'>      file = data.files[0]
</span><span class='line'>      if types.test(file.type) || types.test(file.name)
</span><span class='line'>        data.context = $(tmpl("template-upload", file))
</span><span class='line'>        $('#new_upload').append(data.context)
</span><span class='line'>        data.submit()
</span><span class='line'>      else
</span><span class='line'>        alert("#{file.name} is not a gif, jpg or png image file")
</span><span class='line'>    progress: (e, data) -&gt;
</span><span class='line'>      if data.context
</span><span class='line'>        progress = parseInt(data.loaded / data.total * 100, 10)
</span><span class='line'>        data.context.find('.bar').css('width', progress + '%')</span></code></pre></td></tr></table></div></figure>

<p>这里我们检查文件的类型是图片还是电影。否则，我们将向用户显示不允许该文件的警告。如果文件被允许，我们使用文件的数据渲染模板，并将其附加到我们的图片列表中（这里没有显示代码——你可以很容易地弄明白）。然后我们提交文件进行实际上传并保存到数据库。此外，我们显示每个上传文件的进度条。</p>

<p>upload.js.coffee中的第2行用于将upload_file的名称从数组改为单个上传（从<code>upload[uploaded_file][]</code>到<code>upload[uploaded_file]</code>）。否则，上传数组会使Paperclip抛出错误<code>Paperclip::AdapterRegistry::NoHandlerError</code>。你可以使用file_field的name属性设置值，但那对我来说无法可靠地工作。</p>

<p>我在之前说过，你必须避免模板中的换行符。如果你将第9行改为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>data.context = $($.parseHTML($(tmpl("template-upload", file)))[1])</span></code></pre></td></tr></table></div></figure>

<p>应该可以保持你的换行。我在<a href="http://stackoverflow.com/a/15563364/299781">Stack Overflow</a>发现这个，但没有尝试过。但它看起来应该没问题。</p>

<p>控制器动作很简单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def create
</span><span class='line'>  @upload = Upload.create(upload_params)
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>这是个简单的实现。你可以做的更多。仔细看看<a href="http://blueimp.github.io/jQuery-File-Upload/">jQuery File Upload</a>的文档。如果你有任何问题，可以在twitter或app.net上询问我，我很乐意为你提供帮助。谢谢阅读。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/rails-insecure-defaults/">Rails的不安全默认配置——需要知道的13个安全陷阱</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-02T18:19:40+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2013</span></span> <span class='time'>6:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="http://blog.codeclimate.com/blog/2013/03/27/rails-insecure-defaults/">http://blog.codeclimate.com/blog/2013/03/27/rails-insecure-defaults/</a></p>

<p><a href="http://www.oschina.net/translate/rails-insecure-defaults">http://www.oschina.net/translate/rails-insecure-defaults</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/create-ebook-website-with-html5/">使用HTML5创建电子书网站</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-24T15:04:32+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>3:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在项目开始前，先要了解下HTML5规范包含的一些有用的新的语义标签，用于提供HTML页面的各个区域或部分的意义，例如页眉、页脚、导航栏、边栏等等。在以前的HTML版本中，这些部分通常使用<code>&lt;div&gt;</code>标签来创建，通过id或class属性来区分。</p>

<p>HTML5引入的主要标签包括：</p>

<table><thead>
<tr>
<th>标签</th>
<th>说明</th>
</tr>
</thead><tbody>
<tr>
<td>header</td>
<td>此标签用于定义页面某些部分的页眉，可以是整个页面、article标签或section标签</td>
</tr>
<tr>
<td>nav</td>
<td>这是页面上主要导航链接的容器。此标签不应用于所有链接组，而是应仅用于主要导航块。如果你有一个footer标签包含导航链接，不需要将这些链接封装在nav标签中，因为footer标签将可以独自包括这些链接</td>
</tr>
<tr>
<td>footer</td>
<td>此标签定义页面的某些部分的页脚。页脚不一定是在页面、文章或区域的结尾，但是它通常是在那个位置</td>
</tr>
<tr>
<td>article</td>
<td>定义文档或页面上的独立区块，例如新闻、杂志、博文或评论</td>
</tr>
<tr>
<td>section</td>
<td>此标签表示文档的一部分，例如，文章或教程的一章或一节。该标签通常具有一个页眉，虽然严格来说是不需要的</td>
</tr>
<tr>
<td>aside</td>
<td>用于标记边栏或一些将认为与其周围内容有点无关的内容。此项的一个例子就是广告块</td>
</tr>
<tr>
<td>hgroup</td>
<td>在某些情况下，页面、文章或区域可能需要多个标题，例如，你有一个标题和一个副标题。你可以在hgroup标签中封装这些标题，使用h1标签表示主标题，h2标签表示副标题</td>
</tr>
</tbody></table>

<p>这些标签的基础结构遵循以下大纲：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>header
</span><span class='line'>  hgroup
</span><span class='line'>nav
</span><span class='line'>article
</span><span class='line'>  header
</span><span class='line'>  section
</span><span class='line'>    header
</span><span class='line'>footer</span></code></pre></td></tr></table></div></figure>

<p><img src="/uploads/html5-ebook-layout.png" title="html5-ebook-layout" ></p>

<p>上面是网站的布局设计，主要有header、navigation、footer和main四个区块，实现代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!-- HTML5的DOCTYPE声明模式，它可以向后兼容，
</span><span class='line'>     再也不用记忆XHTML中复杂的DOCTYPE了！--&gt;
</span><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>  &lt;!-- 指定文档字符编码的写法，该写法在所有浏览器上都有效。--&gt;
</span><span class='line'>  &lt;meta charset="utf-8" /&gt;
</span><span class='line'>  &lt;title&gt;HTML5 Demo&lt;/title&gt;
</span><span class='line'>  &lt;!-- link和script标签也无需提供type属性（No More Types for Scripts and Links），
</span><span class='line'>       因为CSS和JavaScript是目前惟一受支持的样式表和脚本类型 --&gt;
</span><span class='line'>  &lt;link href="style.css" rel="stylesheet" /&gt;
</span><span class='line'>  &lt;!-- 因为IE浏览器（甚至版本8）不支持新的HTML5标签，处理此问题的一个已知方法是使用
</span><span class='line'>       JavaScript函数document.createElement()为每个标记创建虚拟标签。html5.js文件将
</span><span class='line'>       为每个新的HTML标签进行此操作 --&gt;
</span><span class='line'>  &lt;!--[if lt IE 9]&gt;
</span><span class='line'>    &lt;script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
</span><span class='line'>  &lt;![endif]--&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>
</span><span class='line'>&lt;body&gt;
</span><span class='line'>  &lt;header&gt;
</span><span class='line'>    &lt;hgroup&gt;
</span><span class='line'>      &lt;h1&gt;Logo&lt;/h1&gt;
</span><span class='line'>      &lt;h2&gt;Here is the slogan&lt;/h2&gt;
</span><span class='line'>    &lt;/hgroup&gt;
</span><span class='line'>  &lt;/header&gt;
</span><span class='line'>
</span><span class='line'>  &lt;nav&gt;
</span><span class='line'>    &lt;ul&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Home&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Business&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;History&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Religion&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Health&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Science&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>    &lt;/ul&gt;
</span><span class='line'>  &lt;/nav&gt;
</span><span class='line'>
</span><span class='line'>  &lt;!-- main block begin --&gt;
</span><span class='line'>  &lt;!-- main block end --&gt;
</span><span class='line'>
</span><span class='line'>  &lt;footer&gt;&copy; 2013&lt;/footer&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>

<p>对应的CSS文件内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* {
</span><span class='line'>  font-family: Lucida Sans, Arial, Helvetica, sans-serif;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>body {
</span><span class='line'>  width: 768px;
</span><span class='line'>  margin: 0px auto;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>header h1 {
</span><span class='line'>  font-size: 36px;
</span><span class='line'>  margin: 0px;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>header h2 {
</span><span class='line'>  font-size: 18px;
</span><span class='line'>  margin: 0px;
</span><span class='line'>  color: #888;
</span><span class='line'>  font-style: italic;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul {
</span><span class='line'>  list-style: none;
</span><span class='line'>  margin: 0;
</span><span class='line'>  padding: 0;
</span><span class='line'>  width: 100%;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul:after {
</span><span class='line'>  content: "\0020";
</span><span class='line'>  display: block;
</span><span class='line'>  height: 0;
</span><span class='line'>  clear: both;
</span><span class='line'>  visibility: hidden;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul  li {
</span><span class='line'>  float: left;
</span><span class='line'>  width: 16.66%;
</span><span class='line'>  text-align: center;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul li a {
</span><span class='line'>  display: block;
</span><span class='line'>  background: #000;
</span><span class='line'>  color: #fff;
</span><span class='line'>  font-weight: bold;
</span><span class='line'>  padding: 10px;
</span><span class='line'>  border-right: 1px solid #fff;
</span><span class='line'>  text-decoration: none;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul li a:hover {
</span><span class='line'>  background: #333;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>footer {
</span><span class='line'>  border-top: 1px solid #ccc;
</span><span class='line'>  text-align: center;
</span><span class='line'>  font-size: 12px;
</span><span class='line'>  color: #888;
</span><span class='line'>  margin-top: 24px;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>整个网站主要有这么几个页面：首页、分类页、书目页、内容页，这些页面共用一个布局，主要区别在于main区块的不同。首页、分类页和书目页相似，都是由列表组成。</p>

<p>首页中有多个无序列表，列出网站中最新、最多被访问、最多被分享等的图书：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h3&gt;Latest&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>&lt;h3&gt;Most Viewed&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>&lt;h3&gt;Most Shared&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;</span></code></pre></td></tr></table></div></figure>

<p>分类页是单个无序列表，列出当前被访问分类下所有的图书：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h3&gt;Business&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;</span></code></pre></td></tr></table></div></figure>

<p>书目页是单个有序列表，列出某本书所有的章节：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h3&gt;Book's title&lt;/h3&gt;
</span><span class='line'>&lt;ol&gt;
</span><span class='line'>  &lt;li&gt;Chapter 1&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Chapter 2&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Chapter 3&lt;/li&gt;
</span><span class='line'>&lt;/ol&gt;</span></code></pre></td></tr></table></div></figure>

<p>内容页，顾名思义就是显示具体内容的页面。文章内容用<code>&lt;article&gt;</code>标签表示，其中的标题、作者、发表时间等信息被包含在<code>&lt;header&gt;</code>标签中。主要代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;article&gt;
</span><span class='line'>  &lt;header&gt;
</span><span class='line'>    &lt;h1&gt;&lt;a href="#"&gt;Chapter 1&lt;/a&gt;&lt;/h1&gt;
</span><span class='line'>    &lt;p&gt;By &lt;a href="#"&gt;author&lt;/a&gt; on &lt;time&gt;2013-05-24 14:54&lt;/time&gt;&lt;/p&gt;
</span><span class='line'>  &lt;/header&gt;
</span><span class='line'>  &lt;p&gt;
</span><span class='line'>  Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed
</span><span class='line'>  diam nonummy nibh euismod tincidunt ut laoreet dolore magna
</span><span class='line'>  aliquam erat volutpat. Ut wisi enim ad minim veniam, quis
</span><span class='line'>  nostrud exerci tation ullamcorper suscipit lobortis nisl ut
</span><span class='line'>  aliquip ex ea commodo consequat.
</span><span class='line'>  &lt;/p&gt;
</span><span class='line'>  &lt;section&gt;
</span><span class='line'>    &lt;header&gt;
</span><span class='line'>      &lt;h1&gt;Section heading&lt;/h1&gt;
</span><span class='line'>    &lt;/header&gt;
</span><span class='line'>    &lt;p&gt;
</span><span class='line'>    Duis autem vel eum iriure dolor in hendrerit in vulputate velit
</span><span class='line'>    esse molestie consequat, vel illum dolore eu feugiat nulla
</span><span class='line'>    facilisis at vero eros et accumsan et iusto odio dignissim qui
</span><span class='line'>    blandit praesent luptatum zzril delenit augue duis dolore te
</span><span class='line'>    feugait nulla facilisi.
</span><span class='line'>    &lt;/p&gt;
</span><span class='line'>  &lt;/section&gt;
</span><span class='line'>  &lt;footer&gt;
</span><span class='line'>    &lt;a href="#"&gt;Back&lt;/a&gt;
</span><span class='line'>    &lt;a href="#"&gt;TOC&lt;/a&gt;
</span><span class='line'>    &lt;a href="#"&gt;Forward&lt;/a&gt;
</span><span class='line'>  &lt;/footer&gt;
</span><span class='line'>&lt;/article&gt;</span></code></pre></td></tr></table></div></figure>

<p>在上面的代码里，<code>&lt;header&gt;</code>标签中我们仅使用了<code>&lt;h1&gt;</code>标签，这是因为HTML5会根据上下文计算出heading元素的层级，因此会有：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;body&gt;&lt;h1&gt;  &lt;!-- 相当于heading 1 --&gt;
</span><span class='line'>&lt;body&gt;&lt;section&gt;&lt;h1&gt;  &lt;!-- 相当于heading 2 --&gt;
</span><span class='line'>&lt;body&gt;&lt;section&gt;&lt;section&gt;&lt;h1&gt;  &lt;!-- 相当于heading 3 --&gt;</span></code></pre></td></tr></table></div></figure>

<p>最后顺便说一句，HTML5支持已存在的各种写法：xhtml1.0、xhtml1.1和html4.0，但建议使用xhtml1.1规范，即：</p>

<ol>
<li>所有标签/属性都使用小写字母;</li>
<li>所有属性值都必须加引号;</li>
<li>使用闭合标签。</li>
</ol>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/problem-when-deploying-application-to-heroku/">部署应用到Heroku时的问题</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-21T06:25:33+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>6:25 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Heroku现在已经是纯粹的只读PaaS了，也就是说以前还支持的SQlite现在也不能使用了。因此部署到Heroku上的Rails应用需要把使用的数据库改成PostgreSQL，并且要关闭assets的预编译功能。</p>

<p>修改Gemfile，将SQLite换成PostgreSQL：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># gem 'sqlite3'
</span><span class='line'>gem 'pg'</span></code></pre></td></tr></table></div></figure>

<p>在config/application.rb中添加：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.assets.initialize_on_precompile = false</span></code></pre></td></tr></table></div></figure>

<p>股票功能需要导入交割单文件，因为导入后的文本文件不再使用，可以把上传路径由public/uploads改为tmp，这样就避免了Heroku不能写文件的问题。</p>

<p>应用上传后运行时出现异常，使用heroku logs -t查看日志发现有如下错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Error: column "stocks.share_name" must appear in the GROUP BY clause or be used in an aggregate function</span></code></pre></td></tr></table></div></figure>

<p>这是因为在controller中有这么一行代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>current_user.stocks.select("share_code, share_name, sum(actual_amount) as amount").group("share_code")</span></code></pre></td></tr></table></div></figure>

<p>在PostgreSQL中这会有问题。比如下面的数据表：</p>

<p><img src="/uploads/stocks-table.png" title="stocks-table" ></p>

<p>执行上面的SQL语句后，share_name的值到底是取Ruby呢还是ST Ruby？解决这个问题的方法是使用aggregate函数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>current_user.stocks.select("share_code, max(share_name) as share_name, sum(actual_amount) as amount").group("share_code")</span></code></pre></td></tr></table></div></figure>

<p>使用PostgreSQL还有个问题，就是decimal类型的字段，取出来的值是字符串类型。例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if stock.amount &lt; 0</span></code></pre></td></tr></table></div></figure>

<p>它会报错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ArgumentError (comparison of String with 0 failed)</span></code></pre></td></tr></table></div></figure>

<p>这个可以使用to_f函数解决：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if stock.amount.to_f &lt; 0</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/agile-development-going-downhill/">敏捷开发走下坡路了吗？</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-19T12:36:14+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="http://thatextramile.be/blog/2008/11/agile-development-going-downhill">http://thatextramile.be/blog/2008/11/agile-development-going-downhill</a></p>

<p>James Shore（非常精彩的书《<a href="http://thatextramile.be/blog/2008/05/the-art-of-agile-development/">The Art Of Agile Development</a>》的作者）在他的博客上写了一篇很有趣的帖子：<a href="http://jamesshore.com/Blog/The-Decline-and-Fall-of-Agile.html">The Decline And Fall Of Agile</a>。你绝对应该读读它。</p>

<p>我想我同意James的观点。在过去的几年里，我已经听到了很多的人说他们在做敏捷开发，实际上，他们几乎都不是。引用James的话：</p>

<blockquote>
<p>But guess which part people adopt? That&#39;s right--Sprints and Scrums. Rapid cycles, but none of the good stuff that makes rapid cycles sustainable.</p>
</blockquote>

<p>不幸的是，这是非常真实的。现在许多团队都在进行短迭代工作，很多团队也在做每日例会，或Scrum，或站立会议。但是，有多少人事实上致力于使敏捷开发成功的技术实践和原则呢？老实说，我一个也没见过。</p>

<p>我是一个真正的敏捷开发的铁杆迷，但即使在我现在的工作中，我最近的两个团队也没有完全正确地实现它。我们的研究结果虽然还不错，但我认为我们仍然可以做得更好。我逐渐尝试引入更多的原则和实践，但它确实需要一些时间。但是，所有这些关于敏捷开发的误解，所以很多人（开发人员，项目经理等）有没有真正帮助。在我当前的工作中，这些误解是非常小的，他们并不真正有不良影响。以前在客户那里，我确实注意到这些误解是如何导致异常低效的情况。其实这是非常伤心的，因为迟早经理可能会对敏捷方法持怀疑态度。如果这导致人们放弃一些技术实践和原则，对这个事业来说将会是一个相当大的损失。</p>

<p>我觉得有更多的理由去读James的那本出色的书。如果我可以合法地迫使人们去阅读这本书，我会的:)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/manage-books-by-scanning-isbn-barcode/">扫描ISBN条码实现藏书管理</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-25T12:17:14+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:17 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>每个程序猿家里都有一堆技术书籍，偶也不例外，因此想写个Android应用来管理自己的藏书以及想买的书籍。在网上找到marshal的<a href="http://marshal.easymorse.com/archives/2745">识别图书ISBN号并输出查询结果的示例</a>和<a href="http://marshal.easymorse.com/archives/2756">完善图书查询原型，增加收藏夹功能</a>两篇文章，写的非常不错，还提供源代码。下载代码研究后发现已基本具备了想要的功能，决定在它的基础上做些修改供自己使用。</p>

<p>把原来uses-sdk的minSdkVersion改成了9，增加android:targetSdkVersion=&quot;17&quot;。然后使用手机测试程序时发现，在连接网络时后台会抛出android.os.NetworkOnMainThreadException，并且应用崩溃打不开。通过查阅相关资料了解到，自从Android 2.3之后，系统增加了一个类StrictMode。这个类对网络的访问方式进行了一定的改变。官方文档给出了这个类设置的目的：</p>

<blockquote>
<p>StrictMode is a developer tool which detects things you might be doing by accident and brings them to your attention so you can fix them.</p>

<p>StrictMode is most commonly used to catch accidental disk or network access on the application&#39;s main thread, where UI operations are received and animations take place. Keeping disk and network operations off the main thread makes for much smoother, more responsive applications. By keeping your application&#39;s main thread responsive, you also prevent ANR dialogs from being shown to users.</p>

<p>Note that even though an Android device&#39;s disk is often on flash memory, many devices run a filesystem on top of that memory with very limited concurrency. It&#39;s often the case that almost all disk accesses are fast, but may in individual cases be dramatically slower when certain I/O is happening in the background from other processes. If possible, it&#39;s best to assume that such things are not fast.</p>
</blockquote>

<p>因为marshal把访问网络的代码直接放到UI线程中，造成和主线程的首要工作——UI交互——相矛盾。解决这类问题很容易，把访问网络的代码放到AsyncTask中就行了。</p>

<p>接着发现豆瓣API查询返回的是500错误，在浏览器上访问却又正常，后来给HttpClient加上Agent头就没问题了，不知道是不是期间豆瓣的API在实现上作了改变。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HttpClient client = new DefaultHttpClient();
</span><span class='line'>String agent = System.getProperty("http.agent");
</span><span class='line'>client.getParams().setParameter(CoreProtocolPNames.USER_AGENT, agent);</span></code></pre></td></tr></table></div></figure>

<p>解析豆瓣XML查询结果的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>XmlPullParserFactory factory = XmlPullParserFactory.newInstance();
</span><span class='line'>factory.setNamespaceAware(true);
</span><span class='line'>XmlPullParser parser = factory.newPullParser();
</span><span class='line'>parser.setInput(inputStream, "utf-8");
</span><span class='line'>
</span><span class='line'>Book book = new Book();
</span><span class='line'>book.setIsbn(getIntent().getExtras().getString("ISBN"));
</span><span class='line'>
</span><span class='line'>int eventType = parser.getEventType();
</span><span class='line'>while (eventType != XmlPullParser.END_DOCUMENT) {
</span><span class='line'>    switch (eventType) {
</span><span class='line'>    case XmlPullParser.START_TAG:
</span><span class='line'>        if ("link".equals(parser.getName())
</span><span class='line'>                && "image".equals(parser.getAttributeValue(null, "rel"))) {
</span><span class='line'>            book.setImageUrl(parser.getAttributeValue(null, "href"));
</span><span class='line'>            eventType = parser.next();
</span><span class='line'>        } else if ("summary".equals(parser.getName())) {
</span><span class='line'>            book.setSummary(parser.nextText());
</span><span class='line'>        } else if ("attribute".equals(parser.getName())) {
</span><span class='line'>            String name = parser.getAttributeValue(null, "name");
</span><span class='line'>            if ("title".equals(name)) {
</span><span class='line'>                book.setTitle(parser.nextText());
</span><span class='line'>            } else if ("author".equals(name)) {
</span><span class='line'>                book.setAuthor(parser.nextText());
</span><span class='line'>            } else if ("publisher".equals(name)) {
</span><span class='line'>                book.setPublisher(parser.nextText());
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        break;
</span><span class='line'>    case XmlPullParser.END_TAG:
</span><span class='line'>        break;
</span><span class='line'>    }
</span><span class='line'>    eventType = parser.next();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>然后，然后就是结果页面不显示图书信息。想要找到原因，肿么办？看来要调试WebView了！<a href="http://developer.android.com/guide/webapps/debugging.html">http://developer.android.com/guide/webapps/debugging.html</a> 告诉了我们如何调试。</p>

<p>首先在WebView上设置setWebChromeClient方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>webView.setWebChromeClient(new WebChromeClient() {
</span><span class='line'>    public void onConsoleMessage(String message,
</span><span class='line'>            int lineNumber, String sourceID) {
</span><span class='line'>        Log.d(TAG, message + " -- From line "
</span><span class='line'>                + lineNumber + " of " + sourceID);
</span><span class='line'>    }
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>

<p>然后在JavaScript脚本中使用以下方法就可以在logcat中看到调试信息了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>console.log(String)
</span><span class='line'>console.info(String)
</span><span class='line'>console.warn(String)
</span><span class='line'>console.error(String)</span></code></pre></td></tr></table></div></figure>

<p>重新运行程序，果然在logcat中看到报如下错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Uncaught TypeError: Object [object Object] has no method 'xxx'</span></code></pre></td></tr></table></div></figure>

<p>搜索后在Stack Overflow找到了<a href="http://stackoverflow.com/questions/14031635/android-4-2-1-webview-and-javascript-interface-breaks">问题的答案</a>（Stack Overflow真的非常不错，问题的回答都非常详尽）。<a href="http://developer.android.com/guide/webapps/webview.html#BindingJavaScript">http://developer.android.com/guide/webapps/webview.html#BindingJavaScript</a> 是官方文档的解释。</p>

<p>解决方法就是在要被JavaScript调用的方法上加@JavascriptInterface注解：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class Book {
</span><span class='line'>
</span><span class='line'>    @JavascriptInterface
</span><span class='line'>    public String getAuthor() {
</span><span class='line'>        return author;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setAuthor(String author) {
</span><span class='line'>        if (this.author != null) {
</span><span class='line'>            this.author += ", " + author;
</span><span class='line'>        } else {
</span><span class='line'>            this.author = author;
</span><span class='line'>        }
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>

<p>代码下载：<a href="https://github.com/dohkoos/Bookly">https://github.com/dohkoos/Bookly</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/12">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/10">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/test/">test</a>
      </li>
    
      <li class="post">
        <a href="/blog/test/">test</a>
      </li>
    
      <li class="post">
        <a href="/blog/test/">test</a>
      </li>
    
      <li class="post">
        <a href="/blog/test/">test</a>
      </li>
    
      <li class="post">
        <a href="/blog/the-mythical-10x-programmer/">神秘的10x程序员</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://codemany.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 145%" href="/tags/antlr/">ANTLR</a>
<a style="font-size: 106%" href="/tags/algorithm/">Algorithm</a>
<a style="font-size: 133%" href="/tags/android/">Android</a>
<a style="font-size: 103%" href="/tags/c-plus-plus/">C++</a>
<a style="font-size: 106%" href="/tags/css/">CSS</a>
<a style="font-size: 108%" href="/tags/crack/">Crack</a>
<a style="font-size: 106%" href="/tags/database/">Database</a>
<a style="font-size: 95%" href="/tags/eclipse/">Eclipse</a>
<a style="font-size: 113%" href="/tags/git/">Git</a>
<a style="font-size: 95%" href="/tags/html/">HTML</a>
<a style="font-size: 103%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 146%" href="/tags/java/">Java</a>
<a style="font-size: 99%" href="/tags/javascript/">JavaScript</a>
<a style="font-size: 95%" href="/tags/listview/">ListView</a>
<a style="font-size: 103%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 103%" href="/tags/paperclip/">Paperclip</a>
<a style="font-size: 117%" href="/tags/powerbuilder/">PowerBuilder</a>
<a style="font-size: 99%" href="/tags/powerscript/">PowerScript</a>
<a style="font-size: 115%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 117%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 95%" href="/tags/spring/">Spring</a>
<a style="font-size: 99%" href="/tags/struts/">Struts</a>
<a style="font-size: 143%" href="/tags/translation/">Translation</a>
<a style="font-size: 95%" href="/tags/ubuntu/">Ubuntu</a>
<a style="font-size: 106%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 106%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://www.importnew.com/">ImportNew</a></li>
    <li><a href="http://ifeve.com/">并发编程网</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://advdbg.org/">高端调试</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dohkoos">@dohkoos</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dohkoos',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
  <div>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</div>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemany';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
