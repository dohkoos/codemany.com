
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="修改list_item.xml文件，添加CheckBox控件： 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
&lt;?xml &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/posts/9/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46570161-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="codemany.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/adding-checkbox-to-the-listview/">向ListView中添加CheckBox</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-03T14:30:01+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2011</span></span> <span class='time'>2:30 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>修改list_item.xml文件，添加CheckBox控件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ImageView
</span><span class='line'>        android:id="@+id/app_icon"
</span><span class='line'>        android:layout_gravity="center_vertical"
</span><span class='line'>        android:layout_width="32.0dip"
</span><span class='line'>        android:layout_height="32.0dip"
</span><span class='line'>        android:layout_marginLeft="3.0dip"
</span><span class='line'>        android:layout_marginRight="3.0dip" /&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_title"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="16.0dip"
</span><span class='line'>            android:textStyle="bold" /&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_package"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="13.0dip" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>    &lt;CheckBox
</span><span class='line'>        android:id="@+id/app_select"
</span><span class='line'>        android:layout_width="wrap_content"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:focusable="false"
</span><span class='line'>        android:focusableInTouchMode="false"
</span><span class='line'>        android:clickable="false"
</span><span class='line'>        android:checkMark="?android:attr/listChoiceIndicatorMultiple" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>

<p>这三行代码很重要，如果不加会出现一些奇怪的错误。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>android:focusable="false"
</span><span class='line'>android:focusableInTouchMode="false"
</span><span class='line'>android:clickable="false"</span></code></pre></td></tr></table></div></figure>

<p>加入CheckBox后，在程序运行过程中会发现整个ListView无法响应onItemClick、onItemLongClick或onCreateContextMenu事件。原因在于CheckBox是拥有焦点的，它的优先级比ListItem的焦点优先级更高，于是ListItem的点击事件被屏蔽了。解决方法是让CheckBox不能获得焦点。android:focusable=&quot;false&quot;就是做这个的。</p>

<p>修改整个SimpleIconAdapter类为以下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class SimpleIconAdapter extends BaseAdapter {
</span><span class='line'>    private LayoutInflater mInflater;
</span><span class='line'>    private List&lt;? extends Map&lt;String, ?&gt;&gt; mData;
</span><span class='line'>
</span><span class='line'>    public SimpleIconAdapter(Context context, List&lt;? extends Map&lt;String, ?&gt;&gt; data) {
</span><span class='line'>        mInflater = LayoutInflater.from(context);
</span><span class='line'>        mData = data;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public int getCount() {
</span><span class='line'>        return mData.size();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public Object getItem(int position) {
</span><span class='line'>        return mData.get(position);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public long getItemId(int position) {
</span><span class='line'>        return position;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @SuppressWarnings({ "rawtypes", "unchecked" })
</span><span class='line'>    @Override
</span><span class='line'>    public View getView(int position, View convertView, ViewGroup parent) {
</span><span class='line'>        View view;
</span><span class='line'>        if (convertView != null) {
</span><span class='line'>            view = convertView;
</span><span class='line'>        } else {
</span><span class='line'>            view = mInflater.inflate(R.layout.list_item, parent, false);
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        Map map = (Map)getItem(position);
</span><span class='line'>        TextView tv = (TextView)view.findViewById(R.id.app_title);
</span><span class='line'>        tv.setText((String)map.get("app_title"));
</span><span class='line'>
</span><span class='line'>        tv = (TextView)view.findViewById(R.id.app_package);
</span><span class='line'>        tv.setText((String)map.get("app_package"));
</span><span class='line'>
</span><span class='line'>        ImageView iv = (ImageView)view.findViewById(R.id.app_icon);
</span><span class='line'>        iv.setImageDrawable((Drawable)map.get("app_icon"));
</span><span class='line'>
</span><span class='line'>        CheckBox cb = (CheckBox)view.findViewById(R.id.app_select);
</span><span class='line'>        if ((Boolean)map.get("app_select") ==  null) {
</span><span class='line'>            map.put("app_select", false);
</span><span class='line'>        }
</span><span class='line'>        cb.setChecked((Boolean)map.get("app_select"));
</span><span class='line'>
</span><span class='line'>        return view;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>再就是修改MainActivity类的onCreate()方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Override
</span><span class='line'>public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>    super.onCreate(savedInstanceState);
</span><span class='line'>    setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>    mListView = (ListView)findViewById(R.id.list_view);
</span><span class='line'>    mListData = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>    mAdapter = new SimpleIconAdapter(this, mListData);
</span><span class='line'>    mListView.setAdapter(mAdapter);
</span><span class='line'>    mListView.setItemsCanFocus(false);
</span><span class='line'>    mListView.setChoiceMode(ListView.CHOICE_MODE_MULTIPLE);
</span><span class='line'>    mListView.setOnItemClickListener(new OnItemClickListener() {
</span><span class='line'>        @SuppressWarnings({ "unchecked", "rawtypes" })
</span><span class='line'>        @Override
</span><span class='line'>        public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
</span><span class='line'>            // 这里如此处理是因为当选中CheckBox，滚动ListView的时候，会出现一些
</span><span class='line'>            // CheckBox选择错位的现象，所以在选择CheckBox时，记下其状态，然后在
</span><span class='line'>            // getView方法中进行设置。
</span><span class='line'>            //
</span><span class='line'>            // 原因：
</span><span class='line'>            // ListView中的getChildCount()并不总是等于Adapter中的数据行数。当手
</span><span class='line'>            // 机一屏显示不了所有数据时（需要翻页），getChildCount()就等于一屏
</span><span class='line'>            // 所显示的行数（一般为10），小于Adapter中的数据行数。而ListView的
</span><span class='line'>            // getCount()与Adapter中的数据行数相等。
</span><span class='line'>            // 当光标下移到屏幕最底部，新显示出来的View，在调用Adapter的getView
</span><span class='line'>            // 方法中，会判断convertView为null，而再有新的View显示就会发现
</span><span class='line'>            // convertView不为空，所以新显示的View其实使用了之前某个View的对象。
</span><span class='line'>            // 这就造成了状态可能混乱。比如第一行的CheckBox点选时，第11行的也同
</span><span class='line'>            // 时会被点选。
</span><span class='line'>            CheckBox cb = (CheckBox)view.findViewById(R.id.app_select);
</span><span class='line'>            cb.toggle();
</span><span class='line'>            ((Map)mListData.get(position)).put("app_select", cb.isChecked());
</span><span class='line'>        }
</span><span class='line'>    });
</span><span class='line'>
</span><span class='line'>    mProgressDialog = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>    new Thread() {
</span><span class='line'>        @Override
</span><span class='line'>        public void run() {
</span><span class='line'>            mListData.addAll(getInstalledApps(false));
</span><span class='line'>            mHandler.sendEmptyMessage(0);
</span><span class='line'>        }
</span><span class='line'>    }.start();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/implement-listview-with-icon-improved/">实现带Icon的ListView（改进版）</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-02T18:47:58+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2011</span></span> <span class='time'>6:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>带Icon的ListView工作起来还不错，但是如果手机里安装的软件比较多的话就有问题了。在程序启动时会黑屏一段时间，就好像程序挂起了一样。所以这时需要显示一个对话框，告诉用户正在加载数据，最好还能准确告诉用户加载的进度。</p>

<p>显示对话框用ProgressDialog，它有两种样式：HORIZONTAL和SPINNER。这里暂时选择SPINNER，等以后有机会再改成HORIZONTAL。</p>

<p>我们在加载数据前显示ProgressDialog，在之后关闭对话框。示例代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ProgressDialog pd = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>
</span><span class='line'>ListView lv = (ListView)findViewById(R.id.list_view);
</span><span class='line'>adapter = new SimpleIconAdapter(this,
</span><span class='line'>        getInstalledApps(false),
</span><span class='line'>        R.layout.list_item,
</span><span class='line'>        new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>        new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>lv.setAdapter(adapter);
</span><span class='line'>
</span><span class='line'>pd.dismiss();</span></code></pre></td></tr></table></div></figure>

<p>但结果ProgressDialog没有显示出来，因为加载数据的代码也执行在UI线程中，所以对话框的显示被阻塞了。怎么办呢？可以试着创建一个新线程，然后把加载数据这个耗时的操作放到这个非UI线程中去执行，这样不就可以了么：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ProgressDialog pd = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>
</span><span class='line'>new Thread() {
</span><span class='line'>    @Override
</span><span class='line'>    public void run() {
</span><span class='line'>        ListView lv = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        adapter = new SimpleIconAdapter(Main.this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>                new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>        lv.setAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>}.start();
</span><span class='line'>
</span><span class='line'>pd.dismiss();</span></code></pre></td></tr></table></div></figure>

<p>这下更惨了，直接报Runtime异常，连界面都打不开了。</p>

<p>深入研究一下Android的线程模型，看看Android到底是怎么处理UI线程和其它线程的交互的，为什么上面的代码会报异常?</p>

<blockquote>
<p>When an application is launched, the system creates a thread called &quot;main&quot; for the application. The main thread, also called the UI thread, is very important because it is in charge of dispatching the events to the appropriate widgets, including drawing events. It is also the thread where your application interacts with running components of the Android UI toolkit.</p>

<p>For instance, if you touch the a button on screen, the UI thread dispatches the touch event to the widget, which in turn sets its pressed state and posts an invalidate request to the event queue. The UI thread dequeues the request and notifies the widget to redraw itself.</p>

<p>This single-thread model can yield poor performance unless your application is implemented properly. Specifically, if everything is happening in a single thread, performing long operations such as network access or database queries on the UI thread will block the whole user interface. No event can be dispatched, including drawing events, while the long operation is underway. From the user&#39;s perspective, the application appears hung. Even worse, if the UI thread is blocked for more than a few seconds (about 5 seconds currently) the user is presented with the infamous &quot;application not responding&quot; (ANR) dialog.</p>
</blockquote>

<p>看了上面这段话可以知道为啥程序一打开就黑屏，像挂掉了一样。</p>

<p>那为什么用新建线程来执行耗时操作的代码也有问题呢？这是因为它虽然没有阻塞UI线程，但它违背了单线程模型，Android的UI操作并不是线程安全的，并且这些操作必须在UI线程中执行。在这段代码片段中，在另一个线程中执行数据加载绑定，这会引起一些古怪的问题。</p>

<p>Andriod提供了几种在其它线程中访问UI线程的方法：</p>

<ul>
<li><a href="http://developer.android.com/reference/android/app/Activity.html#runOnUiThread(java.lang.Runnable)">Activity.runOnUiThread(Runnable)</a></li>
<li><a href="http://developer.android.com/reference/android/view/View.html#post(java.lang.Runnable)">View.post(Runnable)</a></li>
<li><a href="http://developer.android.com/reference/android/view/View.html#postDelayed(java.lang.Runnable,%20long)">View.postDelayed(Runnable, long)</a></li>
<li><a href="http://developer.android.com/reference/android/os/Handler.html">Hanlder</a></li>
</ul>

<p>上面的任何一个类或方法都可以修复我们前面代码中遇到的问题，很不幸的是这些类或方法同样会使你的代码变的很复杂很难理解。而且当你需要实现一些很复杂的操作并需要频繁地更新UI时会变得更糟糕。为了解决这个问题，Android 1.5提供了一个工具类AsyncTask，它使创建需要与用户界面交互的长时间运行的任务变得更简单。在Android 1.0和1.1中具有与AsyncTask相同功能的类UserTask，它提供了完全一样的API，你需要做的只是把它的代码拷贝的你的程序中。</p>

<p>其实这些方案背后采用的都是Handler。所以这里仍然使用旧有的，复杂的Handler来修复上述问题。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.Activity;
</span><span class='line'>import android.app.ProgressDialog;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.graphics.drawable.Drawable;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.os.Handler;
</span><span class='line'>import android.os.Message;
</span><span class='line'>import android.widget.ListView;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends Activity {
</span><span class='line'>    private static final String APP_ICON = "app_icon";
</span><span class='line'>    private static final String APP_TITLE = "app_title";
</span><span class='line'>    private static final String APP_PACKAGE = "app_package";
</span><span class='line'>
</span><span class='line'>    private SimpleIconAdapter adapter;
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; listData;
</span><span class='line'>    private ProgressDialog pd;
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        ListView lv = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        listData = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>        adapter = new SimpleIconAdapter(this,
</span><span class='line'>                listData,
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>                new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>        lv.setAdapter(adapter);
</span><span class='line'>
</span><span class='line'>        pd = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>
</span><span class='line'>        new Thread() {
</span><span class='line'>            @Override
</span><span class='line'>            public void run() {
</span><span class='line'>                // 耗时操作，加载数据
</span><span class='line'>                listData.addAll(getInstalledApps(false));
</span><span class='line'>                handler.sendEmptyMessage(0);
</span><span class='line'>            }
</span><span class='line'>        }.start();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private Handler handler = new Handler() {
</span><span class='line'>        @Override
</span><span class='line'>        public void handleMessage(Message msg) {
</span><span class='line'>            // 通知UI更新。必须要放在这里
</span><span class='line'>            adapter.notifyDataSetChanged();
</span><span class='line'>
</span><span class='line'>            pd.dismiss();
</span><span class='line'>        }
</span><span class='line'>    };</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/no-such-file-to-load-xxx-missingsourcefile-on-heroku/">no such file to load -- xxx (MissingSourceFile) on Heroku</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-28T23:08:16+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>11:08 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>终于解决掉了困扰我多日的一个问题。</p>

<p>部署在Heroku上的项目，在controller中require某个文件时总是出现no such file to load -- calc (MissingSourceFile)。</p>

<p>本地机器上运行的好好的，在Heroku上就出现Application error，百思不得其解，网上也没有找到类似问题的解决方法。</p>

<p>咨询Heroku的技术支持，几封邮件交流下来对方也没有办法（感觉Heroku的技术支持不咋的）。</p>

<p>今天把问题解决掉后再回过头来看，发现这其实是个非常简单的问题，就是Linux和Windows对待文件名大小写的差异。因为在Windows上是不区分大小写的，所以在controller中用require &#39;calc&#39;来引入Calc.rb时是成功的，但是在Linux下就不可以。将文件名Calc.rb改成calc.rb再push到Heroku就把问题解决了。</p>

<p>就这么个问题竟然让我思考了几天，还真是郁闷啊！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/implement-listview-with-icon/">实现带Icon的ListView</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-26T08:26:55+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>8:26 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/uploads/listview-screenshot.png" title="listview-screenshot" ></p>

<p>main.xml不需要修改，还是用原来的那个：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:orientation="vertical"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ListView
</span><span class='line'>        android:id="@+id/list_view"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>

<p>在list_item.xml中添加ImageView控件，设置高度和宽度分别为32dip，这是因为有些应用Icon尺寸比较大的缘故，如果不设置的话有些行就会撑大：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ImageView
</span><span class='line'>        android:id="@+id/app_icon"
</span><span class='line'>        android:layout_gravity="center_vertical"
</span><span class='line'>        android:layout_width="32.0dip"
</span><span class='line'>        android:layout_height="32.0dip"
</span><span class='line'>        android:layout_marginLeft="3.0dip"
</span><span class='line'>        android:layout_marginRight="3.0dip" /&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_title"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="16.0dip"
</span><span class='line'>            android:textStyle="bold" /&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_package"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="13.0dip" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>

<p>新建SimpleIconAdapter类，继承SimpleAdapter适配器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.util.List;
</span><span class='line'>import java.util.Map;
</span><span class='line'>
</span><span class='line'>import android.content.Context;
</span><span class='line'>import android.graphics.drawable.Drawable;
</span><span class='line'>import android.view.View;
</span><span class='line'>import android.view.ViewGroup;
</span><span class='line'>import android.widget.ImageView;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class SimpleIconAdapter extends SimpleAdapter {
</span><span class='line'>
</span><span class='line'>    public SimpleIconAdapter(Context context, List&lt;? extends Map&lt;String, ?&gt;&gt; data,
</span><span class='line'>            int resource, String[] from, int[] to) {
</span><span class='line'>        super(context, data, resource, from, to);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @SuppressWarnings("rawtypes")
</span><span class='line'>    @Override
</span><span class='line'>    public View getView(int position, View convertView, ViewGroup parent) {
</span><span class='line'>        View view = super.getView(position, convertView, parent);
</span><span class='line'>        ImageView iv = (ImageView)view.findViewById(R.id.app_icon);
</span><span class='line'>        iv.setImageDrawable((Drawable)((Map)getItem(position)).get("app_icon"));
</span><span class='line'>        return view;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>修改MainActivity文件，更换绑定的适配器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.Activity;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.graphics.drawable.Drawable;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.widget.ListView;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends Activity {
</span><span class='line'>    private static final String APP_ICON = "app_icon";
</span><span class='line'>    private static final String APP_TITLE = "app_title";
</span><span class='line'>    private static final String APP_PACKAGE = "app_package";
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        ListView listView = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        SimpleAdapter adapter = new SimpleIconAdapter(this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>                new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>        listView.setAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; getInstalledApps(boolean getSysPackages) {
</span><span class='line'>        List&lt;HashMap&lt;String, Object&gt;&gt; listItem = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>
</span><span class='line'>        List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);
</span><span class='line'>        for (int i = 0; i&lt; pkgs.size(); i++) {
</span><span class='line'>            PackageInfo pkg = pkgs.get(i);
</span><span class='line'>            if (!getSysPackages && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) &gt; 0) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>            Drawable icon = pkg.applicationInfo.loadIcon(getPackageManager());
</span><span class='line'>            String label = pkg.applicationInfo.loadLabel(getPackageManager()).toString();
</span><span class='line'>            String version = pkg.versionName;
</span><span class='line'>            String pkgName = pkg.packageName;
</span><span class='line'>
</span><span class='line'>            HashMap&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
</span><span class='line'>            map.put(APP_ICON, icon);
</span><span class='line'>            map.put(APP_TITLE, label + " " + version);
</span><span class='line'>            map.put(APP_PACKAGE, pkgName);
</span><span class='line'>            listItem.add(map);
</span><span class='line'>        }
</span><span class='line'>        return listItem;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/implement-listview-without-listactivity/">不使用ListActivity实现ListView</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-25T21:29:57+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>9:29 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>main.xml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:orientation="vertical"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ListView
</span><span class='line'>        android:id="@+id/list_view"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>

<p>list_item.xml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_title"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="16dip" /&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_package"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>

<p>创建一个继承自Activitiy的类，重写onCreate方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.Activity;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.widget.ListView;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends Activity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        ListView listView = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        SimpleAdapter adapter = new SimpleAdapter(this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {"app_title", "app_package"},
</span><span class='line'>                new int[] {R.id.app_title, R.id.app_package});
</span><span class='line'>        listView.setAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; getInstalledApps(boolean getSysPackages) {
</span><span class='line'>        List&lt;HashMap&lt;String, Object&gt;&gt; listItem = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>
</span><span class='line'>        List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);
</span><span class='line'>        for (int i = 0; i&lt; pkgs.size(); i++) {
</span><span class='line'>            PackageInfo pkg = pkgs.get(i);
</span><span class='line'>            if (!getSysPackages && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) &gt; 0) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>            String label = pkg.applicationInfo.loadLabel(getPackageManager()).toString();
</span><span class='line'>            String version = pkg.versionName;
</span><span class='line'>            String pkgName = pkg.packageName;
</span><span class='line'>
</span><span class='line'>            HashMap&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
</span><span class='line'>            map.put("app_title", label + " " + version);
</span><span class='line'>            map.put("app_package", pkgName);
</span><span class='line'>            listItem.add(map);
</span><span class='line'>        }
</span><span class='line'>        return listItem;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>至此，一个不使用ListActivity的ListView就完成了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/display-name-and-package-of-installed-apps-in-listview/">在ListView中显示已安装应用的名字和包名</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-18T07:02:47+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>7:02 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>通过PackageManager获取手机中已安装应用的信息，具体代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PackageManager packageManager = this.getPackageManager();
</span><span class='line'>List&lt;PackageInfo&gt; packageInfoList = packageManager.getInstalledPackages(0);</span></code></pre></td></tr></table></div></figure>

<p>通过以上方法，可以得到所有已安装的应用程序，既包括了手动安装的应用程序的信息，也包括了系统预装的应用程序的信息。要区分这两类应用可使用以下方法:</p>

<ol>
<li>从packageInfoList获取的packageInfo，再通过packageInfo.applicationInfo获取applicationInfo；</li>
<li>判断applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM的值，该值大于0时，表示获取的应用为系统预装的应用，反之则为手动安装的应用。</li>
</ol>

<p>列表的显示需要三个元素：</p>

<ol>
<li>用来显示数据的ListView;</li>
<li>需要显示的数据;</li>
<li>绑定数据和ListView的Adapter。</li>
</ol>

<p>Adapter通常有ArrayAdapter、SimpleAdapter和CursorAdapter等。其中SimpleAdapter有最好的扩充性，可以自定义出各种效果。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SimpleAdapter(Context context, List&lt;? extends Map&lt;String, ?&gt;&gt; data, int resource, String[] from, int[] to)</span></code></pre></td></tr></table></div></figure>

<p>参数解释：</p>

<ol>
<li>context：上下文；</li>
<li>data：数据列表。列表里的每一项都是一个Map<String, ?>对象，都和ListView里的一项进行数据绑定；</li>
<li>resource：布局资源。可以引用系统提供的，也可以自定义；</li>
<li>from：名字数组。每个名字都是用来索引数据列表中每个Map<String, Object>里的Object；</li>
<li>to：资源索引数组，以R.id.xxx的形式表示。</li>
</ol>

<p>main.xml布局代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:orientation="vertical"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;TextView
</span><span class='line'>        android:id="@+id/app_title"
</span><span class='line'>        android:layout_width="wrap_content"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:textSize="22px" /&gt;
</span><span class='line'>    &lt;TextView
</span><span class='line'>        android:id="@+id/app_package"
</span><span class='line'>        android:layout_width="wrap_content"
</span><span class='line'>        android:layout_height="wrap_content" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>

<p>上面代码中的android:orientation=&quot;vertical&quot;很重要，没有它两个TextView就不会显示成两行。</p>

<p>继承了ListActivity的MainActivity代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.ListActivity;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends ListActivity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>
</span><span class='line'>        SimpleAdapter adapter = new SimpleAdapter(this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.main,
</span><span class='line'>                new String[] {"app_title", "app_package"},
</span><span class='line'>                new int[] {R.id.app_title, R.id.app_package});
</span><span class='line'>        setListAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; getInstalledApps(boolean getSysPackages) {
</span><span class='line'>        List&lt;HashMap&lt;String, Object&gt;&gt; list = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>
</span><span class='line'>        List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);
</span><span class='line'>        for (int i = 0; i&lt; pkgs.size(); i++) {
</span><span class='line'>            PackageInfo pkg = pkgs.get(i);
</span><span class='line'>            if (!getSysPackages && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) &gt; 0) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>            String label = pkg.applicationInfo.loadLabel(getPackageManager()).toString();
</span><span class='line'>            String version = pkg.versionName;
</span><span class='line'>            String pkgName = pkg.packageName;
</span><span class='line'>
</span><span class='line'>            HashMap&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
</span><span class='line'>            map.put("app_title", label + " " + version);
</span><span class='line'>            map.put("app_package", pkgName);
</span><span class='line'>            list.add(map);
</span><span class='line'>        }
</span><span class='line'>        return list;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/build-oauth-enabled-sina-weibo-desktop-client/">构建支持OAuth的新浪微博桌面客户端</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-08T15:22:11+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>3:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>要使用OAuth，首先要去新浪微博注册一个自己的微博应用。注册之后，会得到微博应用的Consumer key和Consumer secret，都是一个字符串。之后就可以进行OAuth的认证过程了。</p>

<p>从 <a href="https://code.google.com/p/sina-weibo4j/">https://code.google.com/p/sina-weibo4j/</a> 下载新浪微博的Java SDK包，当然也可以在 <a href="http://open.weibo.com/wiki/index.php/SDK">http://open.weibo.com/wiki/index.php/SDK</a> 下载。推荐使用前者，已经打好包了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.io.BufferedReader;
</span><span class='line'>import java.io.File;
</span><span class='line'>import java.io.FileInputStream;
</span><span class='line'>import java.io.FileOutputStream;
</span><span class='line'>import java.io.IOException;
</span><span class='line'>import java.io.InputStream;
</span><span class='line'>import java.io.InputStreamReader;
</span><span class='line'>import java.io.OutputStream;
</span><span class='line'>import java.util.Properties;
</span><span class='line'>import java.util.PropertyResourceBundle;
</span><span class='line'>
</span><span class='line'>import weibo4j.Weibo;
</span><span class='line'>import weibo4j.WeiboException;
</span><span class='line'>import weibo4j.http.AccessToken;
</span><span class='line'>import weibo4j.http.RequestToken;
</span><span class='line'>
</span><span class='line'>public class UpdateStatus {
</span><span class='line'>  private static final String ACCESS_SECRET = "access_secret";
</span><span class='line'>  private static final String ACCESS_TOKEN = "access_token";
</span><span class='line'>  private static final String FILE_NAME = "sina_token.properties";
</span><span class='line'>
</span><span class='line'>  public static void main(String[] args) {
</span><span class='line'>    // 在这里填写在应用申请中得到的App Key和App Secret
</span><span class='line'>    System.setProperty("weibo4j.oauth.consumerKey", YOUR_CONSUMER_KEY);
</span><span class='line'>    System.setProperty("weibo4j.oauth.consumerSecret", YOUR_CONSUMER_SECRET);
</span><span class='line'>
</span><span class='line'>    Weibo weibo = new Weibo();
</span><span class='line'>
</span><span class='line'>    try {
</span><span class='line'>      // 读取存储起来的Access Token
</span><span class='line'>      AccessToken accessToken = loadAccessToken();
</span><span class='line'>      if (accessToken == null) {
</span><span class='line'>        String backUrl = "http://zhubabo.appspot.com";
</span><span class='line'>
</span><span class='line'>        // 请求Request Token（未授权令牌）
</span><span class='line'>        RequestToken requestToken = weibo.getOAuthRequestToken(backUrl);
</span><span class='line'>        System.out.println("Got request token...");
</span><span class='line'>        System.out.println("Request token: " + requestToken.getToken());
</span><span class='line'>        System.out.println("Request token secret: " + requestToken.getTokenSecret());
</span><span class='line'>
</span><span class='line'>        // 将以下打印出的授权链接在浏览器中打开，完成应用授权，会自动跳转到
</span><span class='line'>        // 指定的callback url，并将oauth_verifier一起返回
</span><span class='line'>        System.out.println("Open the following url in a browser");
</span><span class='line'>        System.out.println(" http://api.t.sina.com.cn/oauth/authorize?oauth_token=" + requestToken.getToken());
</span><span class='line'>
</span><span class='line'>        // 输入上面得到的oauth_verifier的值，取得Access Token，这个Token是长期有效的
</span><span class='line'>        System.out.println("please input verifier:");
</span><span class='line'>        String verifier = readLine();
</span><span class='line'>        accessToken = weibo.getOAuthAccessToken(
</span><span class='line'>            requestToken.getToken(),
</span><span class='line'>            requestToken.getTokenSecret(),
</span><span class='line'>            verifier);
</span><span class='line'>
</span><span class='line'>        // 将Access Token保存下来，以后就可以直接通过此Token向新浪围脖发消息了
</span><span class='line'>        storeAccessToken(accessToken.getToken(), accessToken.getTokenSecret());
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      weibo.setToken(accessToken.getToken(), accessToken.getTokenSecret());
</span><span class='line'>
</span><span class='line'>      System.out.println("Input message to sina:");
</span><span class='line'>      String message = readLine();
</span><span class='line'>      while (!"exit".equals(message.trim())) {
</span><span class='line'>        weibo.updateStatus(message);
</span><span class='line'>        System.out.println("Input message to sina:");
</span><span class='line'>        message = readLine();
</span><span class='line'>      }
</span><span class='line'>    } catch (WeiboException e) {
</span><span class='line'>      e.printStackTrace();
</span><span class='line'>    } catch (IOException e) {
</span><span class='line'>      e.printStackTrace();
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  private static void storeAccessToken(String token, String tokenSecret) throws IOException {
</span><span class='line'>    OutputStream out = new FileOutputStream(new File(FILE_NAME));
</span><span class='line'>    Properties p = new Properties();
</span><span class='line'>    p.setProperty(ACCESS_TOKEN, token);
</span><span class='line'>    p.setProperty(ACCESS_SECRET, tokenSecret);
</span><span class='line'>    p.store(out, "sina access token");
</span><span class='line'>    out.flush();
</span><span class='line'>    out.close();
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  private static AccessToken loadAccessToken() throws IOException {
</span><span class='line'>    File f = new File(FILE_NAME);
</span><span class='line'>    if (!f.exists()) {
</span><span class='line'>      return null;
</span><span class='line'>    }
</span><span class='line'>    InputStream in = new FileInputStream(f);
</span><span class='line'>    PropertyResourceBundle bundle = new PropertyResourceBundle(in);
</span><span class='line'>    in.close();
</span><span class='line'>    return new AccessToken(bundle.getString(ACCESS_TOKEN), bundle.getString(ACCESS_SECRET));
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  private static String readLine() throws IOException {
</span><span class='line'>    BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));
</span><span class='line'>    byte[] bs = reader.readLine().getBytes("gbk");
</span><span class='line'>    return new String(bs);
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/upload-multiple-images-with-paperclip-rails-23-improved/">Rails 2.3和Paperclip实现多图片上传（改进版）</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-04-28T06:48:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>6:48 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>从Rails 2.3开始，有了新的方法来处理多模型表单，这就是accepts_nested_attributes_for，它允许直接赋值到子对象上，对于标准的属性使用相同的哈希格式。</p>

<p>例如，一个parent有多个children，包含所有类的POST数据将会是下面这样：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>params =&gt;
</span><span class='line'>  action =&gt; update
</span><span class='line'>  id =&gt; 1
</span><span class='line'>  controller =&gt; parents
</span><span class='line'>  parent =&gt;
</span><span class='line'>    first_name =&gt; John
</span><span class='line'>    last_name =&gt; Doe
</span><span class='line'>    age =&gt; 40
</span><span class='line'>    children_attributes =&gt;
</span><span class='line'>      1 =&gt; { id =&gt; 16, :name =&gt; Jack }
</span><span class='line'>      2 =&gt; { id =&gt; 18, :name =&gt; Mary }</span></code></pre></td></tr></table></div></figure>

<p>注意，那个children_attributes元素在parent的元素中。fields_for命令会生成必要的语法去生成POST数据，这些数据会被转换成方便accepts_nested_attributes_for解释的哈希。children_attributes不是数组而是哈希，它的键是一个简单的索引（不是模型的ID），被用来从一个单一的实体聚合属性。</p>

<p>不用ID的理由是简单的：正在被编辑的模型可能不会被保存，发送到了客户端，这时它的ID为nil。因此为每个被显示的children的id关联一个隐藏字段是个好的实践。</p>

<p>下面我们就用accepts_nested_attributes_for来改写上传多图片的代码。</p>

<p>修改albums_controller.rb中的new方法，删除下面的这句代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1.upto(3) { @album.photos.build }</span></code></pre></td></tr></table></div></figure>

<p>将album.rb中的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def photo_attributes=(photo_attributes)
</span><span class='line'>  photo_attributes.each do |attributes|
</span><span class='line'>    photos.build(attributes)
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>代码改成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>accepts_nested_attributes_for :photos</span></code></pre></td></tr></table></div></figure>

<p>修改_form.html.erb中的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div id="photos"&gt;
</span><span class='line'>  &lt;% if @album.new_record? %&gt;
</span><span class='line'>    &lt;%= render :partial =&gt; 'photo', :collection =&gt; @album.photos %&gt;
</span><span class='line'>  &lt;% end %&gt;
</span><span class='line'>&lt;/div&gt;
</span><span class='line'>
</span><span class='line'>&lt;%= link_to_function "Add Photo" do |page| page.insert_html :bottom, :photos, :partial =&gt; 'photo', :object =&gt; Photo.new end %&gt;</span></code></pre></td></tr></table></div></figure>

<p>为下面的代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div id="photos"&gt;
</span><span class='line'>  &lt;% if @album.new_record? %&gt;
</span><span class='line'>    &lt;%= render :partial =&gt; 'photo', :locals =&gt; { :form =&gt; f, :photo =&gt; @album.photos.build } %&gt;
</span><span class='line'>  &lt;% end %&gt;
</span><span class='line'>&lt;/div&gt;
</span><span class='line'>
</span><span class='line'>&lt;%= add_object_link("Add Photo", f, @album.photos.build, "photo", "#photos") %&gt;</span></code></pre></td></tr></table></div></figure>

<p>再将_photo.html.erb中的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% fields_for "album[photo_attributes][]", photo do |p| %&gt;
</span><span class='line'>  &lt;%= p.label :photo %&gt;&lt;br /&gt;
</span><span class='line'>  &lt;%= p.file_field :data, :index =&gt; nil %&gt;
</span><span class='line'>  &lt;%= link_to_function "delete", "remove_field($(this), ('.photo'))" %&gt;
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>

<p>改为</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% form.fields_for :photos, photo, :child_index =&gt; (photo.new_record? ? "index_to_replace_with_js" : nil) do |p| %&gt;
</span><span class='line'>  &lt;%= p.label :photo %&gt;&lt;br /&gt;
</span><span class='line'>  &lt;%= p.file_field :data %&gt;
</span><span class='line'>  &lt;%= link_to_function "delete", "remove_field($(this), ('.photo'))" %&gt;
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>

<p>在albums_helper中添加两个方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def add_object_link(name, form, object, partial, where)
</span><span class='line'>  html = render(:partial =&gt; partial, :locals =&gt; { :form =&gt; form }, :object =&gt; object)
</span><span class='line'>  link_to_function name, %{
</span><span class='line'>    var new_object_id = new Date().getTime();
</span><span class='line'>    var html = jQuery(#{js html}.replace(/index_to_replace_with_js/g, new_object_id)).hide();
</span><span class='line'>    html.appendTo(jQuery("#{where}")).slideDown('slow');
</span><span class='line'>  }
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>def js(data)
</span><span class='line'>  if data.respond_to? :to_json
</span><span class='line'>    data.to_json
</span><span class='line'>  else
</span><span class='line'>    data.inspect.to_json
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>到这里就修改完成了。试试看，是不是和原来的效果一样。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/upload-multiple-images-with-paperclip-rails-23/">Rails 2.3和Paperclip实现多图片上传</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-04-24T12:12:29+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:12 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails upload
</span><span class='line'>cd upload
</span><span class='line'>script/plugin install git://github.com/thoughtbot/paperclip.git
</span><span class='line'>script/plugin install git://github.com/aaronchi/jrails.git
</span><span class='line'>script/generate scaffold album name:string
</span><span class='line'>script/generate model photo album:references
</span><span class='line'>script/generate paperclip photo data
</span><span class='line'>rake db:migrate
</span><span class='line'>script/server</span></code></pre></td></tr></table></div></figure>

<p>修改album.rb添加photo_attributes属性：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Album &lt; ActiveRecord::Base
</span><span class='line'>  has_many :photos
</span><span class='line'>  validates_presence_of :name
</span><span class='line'>
</span><span class='line'>  def photo_attributes=(photo_attributes)
</span><span class='line'>    photo_attributes.each do |attributes|
</span><span class='line'>      photos.build(attributes)
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>修改photo.rb添加附件相关属性：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Photo &lt; ActiveRecord::Base
</span><span class='line'>  belongs_to :album
</span><span class='line'>
</span><span class='line'>  has_attached_file :data,
</span><span class='line'>    :url =&gt; "/uploads/:style_:basename.:extension",
</span><span class='line'>    :styles =&gt; { :thumb =&gt; "50x50#", :large =&gt; "640x480#" }
</span><span class='line'>  validates_attachment_presence :data
</span><span class='line'>  validates_attachment_content_type :data,
</span><span class='line'>    :content_type =&gt; ['image/jpeg', 'image/jpg', 'image/png']
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>修改new.html.erb为以下代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h1&gt;New album&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;% form_for @album, :html =&gt; { :multipart =&gt; true } do |f| %&gt;
</span><span class='line'>  &lt;%= render :partial =&gt; 'form', :locals =&gt; { :f =&gt; f } %&gt;
</span><span class='line'>  &lt;p&gt;&lt;%= f.submit "Create" %&gt;&lt;/p&gt;
</span><span class='line'>&lt;% end %&gt;
</span><span class='line'>
</span><span class='line'>&lt;%= link_to 'Back', albums_path %&gt;</span></code></pre></td></tr></table></div></figure>

<p>对edit.html.erb做同样的修改：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h1&gt;Editing album&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;% form_for @album, :html =&gt; { :multipart =&gt; true } do |f| %&gt;
</span><span class='line'>  &lt;%= render :partial =&gt; 'form', :locals =&gt; { :f =&gt; f } %&gt;
</span><span class='line'>  &lt;p&gt;&lt;%= f.submit "Update" %&gt;&lt;/p&gt;
</span><span class='line'>&lt;% end %&gt;
</span><span class='line'>
</span><span class='line'>&lt;%= link_to 'Show', @album %&gt; |
</span><span class='line'>&lt;%= link_to 'Back', albums_path %&gt;</span></code></pre></td></tr></table></div></figure>

<p>把从new.html.erb和edit.html.erb中抽取出来的代码保存为_form.html.erb文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= f.error_messages %&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span><span class='line'>  &lt;%= f.label :name %&gt;
</span><span class='line'>  &lt;%= f.text_field :name %&gt;
</span><span class='line'>&lt;/p&gt;</span></code></pre></td></tr></table></div></figure>

<p>然后在后面添加如下代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div id="photos"&gt;
</span><span class='line'>  &lt;% if @album.new_record? %&gt;
</span><span class='line'>    &lt;%= render :partial =&gt; 'photo', :collection =&gt; @album.photos %&gt;
</span><span class='line'>  &lt;% end %&gt;
</span><span class='line'>&lt;/div&gt;
</span><span class='line'>
</span><span class='line'>&lt;%= link_to_function "Add Photo" do |page| page.insert_html :bottom, :photos, :partial =&gt; 'photo', :object =&gt; Photo.new end %&gt;</span></code></pre></td></tr></table></div></figure>

<p>创建_photo.html.erb文件，代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div class="photo"&gt;
</span><span class='line'>  &lt;p&gt;
</span><span class='line'>  &lt;% fields_for "album[photo_attributes][]", photo do |p| %&gt;
</span><span class='line'>    &lt;%= p.label :photo %&gt;&lt;br /&gt;
</span><span class='line'>    &lt;%= p.file_field :data, :index =&gt; nil %&gt;
</span><span class='line'>    &lt;%= link_to_function "delete", "remove_field($(this), ('.photo'))" %&gt;
</span><span class='line'>  &lt;% end %&gt;
</span><span class='line'>  &lt;/p&gt;
</span><span class='line'>&lt;/div&gt;</span></code></pre></td></tr></table></div></figure>

<p>再在application.js中添加下列代码，这样就可以删除file字段了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function remove_field(element, item) {
</span><span class='line'>  element.up(item).remove();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>然后修改albums_controller.rb中的new方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def new
</span><span class='line'>  @album = Album.new
</span><span class='line'>  1.upto(3) { @album.photos.build }
</span><span class='line'>
</span><span class='line'>  respond_to do |format|
</span><span class='line'>    format.html # new.html.erb
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>这样，上传多文件的功能基本就完成了。下面就来实现显示和修改的功能。</p>

<p>在show.html.erb的末尾添加下列代码，上传成功后用来显示图片：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#loop through the albums photos
</span><span class='line'>&lt;% for photo in @album.photos %&gt;
</span><span class='line'>  &lt;%= image_tag photo.data.url(:thumb) %&gt;
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>

<p>修改albums_controller.rb中的edit和update方法，用来删除图片：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def edit
</span><span class='line'>  @album = Album.find(params[:id])
</span><span class='line'>  if @album.photos.first.nil?
</span><span class='line'>    1.upto(3) { @album.photos.build }
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>def update
</span><span class='line'>  params[:photo_ids] ||= []
</span><span class='line'>  @album = Album.find(params[:id])
</span><span class='line'>  unless params[:photo_ids].empty?
</span><span class='line'>    Photo.destroy_pics(params[:id], params[:photo_ids])
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  respond_to do |format|
</span><span class='line'>    if @album.update_attributes(params[:album])
</span><span class='line'>      flash[:notice] = 'Album was successfully updated.'
</span><span class='line'>      format.html { redirect_to(@album) }
</span><span class='line'>    else
</span><span class='line'>      format.html { render :action =&gt; "edit" }
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>en</span></code></pre></td></tr></table></div></figure>

<p>在photo.rb中加上下面的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def self.destroy_pics(album, photos)
</span><span class='line'>  Photo.find(photos, :conditions =&gt; { :album_id =&gt; album }).each(:destroy)
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>然后新建_album_photo.html.erb，代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% unless album_photo.new_record? %&gt;
</span><span class='line'>  &lt;%= image_tag album_photo.data.url(:thumb) %&gt;
</span><span class='line'>  &lt;%= check_box_tag "photo_ids[]", album_photo.id %&gt;
</span><span class='line'>&lt;% end rescue nil %&gt;</span></code></pre></td></tr></table></div></figure>

<p>接着在_form.html.erb中加入下面的代码就可以删除图片了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div class="album_photos"&gt;
</span><span class='line'>  &lt;%= render :partial =&gt; 'album_photo', :collection =&gt; @album.photos %&gt;
</span><span class='line'>&lt;/div&gt;</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/integrate-alipay-into-rails-application/">在Rails应用中集成支付宝</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-03-18T06:28:29+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>6:28 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>注意：notify_url为服务器通知，支付宝可以保证99.9999%的通知到达率，前提是你的网络通畅，在notify_url中可以做对数据库的业务操作。return_url中可以做数据库的更新也可以做显示。第一次交易状态改变（即时到帐中的交易完成的交易状态）时，支付宝发起的通知的时间与返回页自动跳转回的时间近乎同时。</p>

<p>支付处理代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class OrdersController &lt; ApplicationController
</span><span class='line'>  before_filter :login_required
</span><span class='line'>
</span><span class='line'>  # place order
</span><span class='line'>  def place_order
</span><span class='line'>    parameters = {
</span><span class='line'>      'service' =&gt; 'create_direct_pay_by_user',
</span><span class='line'>      'partner' =&gt; ALIPAY_ACCOUNT,
</span><span class='line'>      'seller_email' =&gt; ALIPAY_EMAIL,
</span><span class='line'>      'out_trade_no' =&gt; @order.out_trade_no,
</span><span class='line'>      'subject' =&gt; 'payment subject',
</span><span class='line'>      'body' =&gt; 'payment body',
</span><span class='line'>      'price' =&gt; @order.price.to_s,
</span><span class='line'>      'quantity' =&gt; @order.quantity.to_s,
</span><span class='line'>      'payment_type' =&gt; '1',
</span><span class='line'>      '_input_charset' =&gt; 'utf-8',
</span><span class='line'>      'notify_url' =&gt; url_for(:only_path =&gt; false, :action =&gt; 'notify'),
</span><span class='line'>      'return_url' =&gt; url_for(:only_path =&gt; false, :action =&gt; 'done')
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    # 即时到帐中交易状态为“等待买家付款”的状态默认是不会发送通知的，自己手动设置一下
</span><span class='line'>    @order.status = 'WAIT_BUYER_PAY'
</span><span class='line'>    @order.user = current_user
</span><span class='line'>    @order.save
</span><span class='line'>
</span><span class='line'>    values = {}
</span><span class='line'>    # 支付宝要求传递的参数必须要按照首字母的顺序传递，所以这里要sort
</span><span class='line'>    parameters.keys.sort.each do |k|
</span><span class='line'>      values[k] = parameters[k];
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    # 一定要先unescape后再生成sign，否则支付宝会报ILLEGAL SIGN
</span><span class='line'>    sign = Digest::MD5.hexdigest(CGI.unescape(values.to_query) + ALIPAY_KEY)
</span><span class='line'>    gateway = 'https://www.alipay.com/cooperate/gateway.do?'
</span><span class='line'>    redirect_to gateway + values.to_query + '&sign=' + sign + '&sign_type=MD5'
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  # 返回success或fail。如果返回fail，支付宝会每隔一段时间就自动调用notify_url通信接口
</span><span class='line'>  def notify
</span><span class='line'>    render :text =&gt; 'success'
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def done
</span><span class='line'>    if verify_sign
</span><span class='line'>      order = Order.find_by_out_trade_no(params[:out_trade_no])
</span><span class='line'>      # 支付宝即时到帐接口只有一种交易状态，就是“交易成功”，更新一下
</span><span class='line'>      order.update_attributes(params[:trade_status])
</span><span class='line'>      render :text =&gt; 'Payment successful'
</span><span class='line'>    else
</span><span class='line'>      render :text =&gt; 'Alipay Error: ILLEGAL_SIGN'
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>protected
</span><span class='line'>  def verify_sign
</span><span class='line'>    params.delete("sign_type")
</span><span class='line'>    sign = params.delete("sign")
</span><span class='line'>
</span><span class='line'>    values = {}
</span><span class='line'>    params.keys.sort.each do |k|
</span><span class='line'>      values[k] = params[k];
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    sign.downcase == Digest::MD5.hexdigest(CGI.unescape(values.to_query) + ALIPAY_KEY)
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/10">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/8">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/reading-notes-the-definitive-antlr4-reference-part3/">ANTLR 4权威参考读书笔记（3）</a>
      </li>
    
      <li class="post">
        <a href="/blog/reading-notes-the-definitive-antlr4-reference-part2/">ANTLR 4权威参考读书笔记（2）</a>
      </li>
    
      <li class="post">
        <a href="/blog/reading-notes-the-definitive-antlr4-reference-part1/">ANTLR 4权威参考读书笔记（1）</a>
      </li>
    
      <li class="post">
        <a href="/blog/pbl-file-format-analysis/">PBL文件格式解析</a>
      </li>
    
      <li class="post">
        <a href="/blog/random-with-weight-function/">带权随机函数</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://codemany.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 105%" href="/tags/antlr/">ANTLR</a>
<a style="font-size: 105%" href="/tags/algorithm/">Algorithm</a>
<a style="font-size: 133%" href="/tags/android/">Android</a>
<a style="font-size: 93%" href="/tags/ant/">Ant</a>
<a style="font-size: 111%" href="/tags/crack/">Crack</a>
<a style="font-size: 105%" href="/tags/database/">Database</a>
<a style="font-size: 97%" href="/tags/eclipse/">Eclipse</a>
<a style="font-size: 87%" href="/tags/git/">Git</a>
<a style="font-size: 105%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 142%" href="/tags/java/">Java</a>
<a style="font-size: 93%" href="/tags/javascript/">JavaScript</a>
<a style="font-size: 97%" href="/tags/listview/">ListView</a>
<a style="font-size: 87%" href="/tags/maven/">Maven</a>
<a style="font-size: 105%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 93%" href="/tags/other/">Other</a>
<a style="font-size: 97%" href="/tags/paperclip/">Paperclip</a>
<a style="font-size: 116%" href="/tags/powerbuilder/">PowerBuilder</a>
<a style="font-size: 93%" href="/tags/powerscript/">PowerScript</a>
<a style="font-size: 118%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 111%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 93%" href="/tags/spring/">Spring</a>
<a style="font-size: 101%" href="/tags/struts/">Struts</a>
<a style="font-size: 111%" href="/tags/translation/">Translation</a>
<a style="font-size: 97%" href="/tags/ubuntu/">Ubuntu</a>
<a style="font-size: 108%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 108%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://www.importnew.com/">ImportNew</a></li>
    <li><a href="http://ifeve.com/">并发编程网</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://advdbg.org/">高端调试</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dohkoos">@dohkoos</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dohkoos',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemany';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
