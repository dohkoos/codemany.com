
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="调试Rails程序有更好的工具了，这就是Pry，它是一套全新的IRB替代方案，最闪亮点是它的语法高亮功能。 首先，在Gemfile中添加以下代码： 1
gem 'pry', group: :development 然后执行 1
bundle install 在需要设置断点的地方添加binding. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/posts/9/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46570161-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="codemany.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/debugging-rails-application-with-pry/">使用Pry调试Rails应用</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-07T23:26:08+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:26 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>调试Rails程序有更好的工具了，这就是<a href="https://github.com/pry/pry">Pry</a>，它是一套全新的IRB替代方案，最闪亮点是它的语法高亮功能。</p>

<p>首先，在Gemfile中添加以下代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'pry', group: :development</span></code></pre></td></tr></table></div></figure>

<p>然后执行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle install</span></code></pre></td></tr></table></div></figure>

<p>在需要设置断点的地方添加binding.pry，当程序运行到这行代码时会打开一个窗口，可以在这里操作当前代码的上下文变量。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def index
</span><span class='line'>  @articles = Article.all
</span><span class='line'>  binding.pry
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>退出调试用exit-all，但如果在循环中会遭遇失败，这时可以使用exit-program无条件地退出。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(1..100).each do |i|
</span><span class='line'>  binding.pry
</span><span class='line'>  puts i
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>Pry默认是没有调试中经常用到的上一步，下一步等命令的，可以安装<a href="https://github.com/nixme/pry-nav">pry-nav</a>，然后就可以使用step, next, continue跳来跳去了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/using-wifi-on-raspberry-pi/">在Raspberry Pi上使用无线网卡</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-06T20:25:08+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:25 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>使用的是EDUP EP-N1556这款无线网卡，体积小巧，支持300M速率，买回来插在RPi上直接就能识别了。</p>

<p>输入lsusb命令，可以见到设备列表中有RTL8192CU 802.11n WLAN Adapter字样，说明网卡已经被系统识别，芯片是RTL8192。</p>

<p>下面就给无线网卡设置静态IP地址：</p>

<p>修改/etc/wpa_supplicant/wpa_supplicant.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
</span><span class='line'>update_config=1
</span><span class='line'>
</span><span class='line'>network={
</span><span class='line'>  ssid="NETGEAR"
</span><span class='line'>  psk="12345678"
</span><span class='line'>  proto=RSN  # 也可以写成WPA2
</span><span class='line'>  key_mgmt=WPA-PSK  # 一定不要写成WPA2-PSK
</span><span class='line'>  id_str="edup1556"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>修改/etc/network/interfaces</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'>iface eth0 inet static
</span><span class='line'>  address 192.168.0.100
</span><span class='line'>  netmask 255.255.255.0
</span><span class='line'>  gateway 192.168.0.1
</span><span class='line'>  dns-nameservers 8.8.8.8
</span><span class='line'>
</span><span class='line'>allow-hotplug wlan0
</span><span class='line'>iface wlan0 inet manual
</span><span class='line'>  wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</span><span class='line'>iface edup1556 inet static
</span><span class='line'>  address 192.168.0.200
</span><span class='line'>  netmask 255.255.255.0
</span><span class='line'>  gateway 192.168.0.1
</span><span class='line'>  dns-nameservers 8.8.8.8
</span><span class='line'>
</span><span class='line'>iface default inet dhcp</span></code></pre></td></tr></table></div></figure>

<p>然后用ifconfig命令列出所有的网络设备，可以看到wlan0的IP是192.168.0.200了。</p>

<p>你的树莓派自由了，不再需要网线拖着了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-i-made-ruby-script-156x-faster/">我是如何让Ruby脚本速度提升156倍的</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-28T13:04:08+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>以前写过<a href="/blog/using-ruby-to-batch-rename-filename-from-traditional-to-simplified/">使用Ruby批量修改繁体文件名为简体</a>，可惜脚本的性能很有问题，批量重命名时运行速度非常慢。这次准备优化下代码，提升脚本的执行效率。</p>

<p>profile.rb是为Ruby程序准备的profiler，它可以统计并输出各方法的运行时间，以便于找到程序执行的性能瓶颈。这次就用它来剖析脚本的运行时间。使用方法很简单，加上命令行选项-r profile就可以：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ruby -r profile rename.rb</span></code></pre></td></tr></table></div></figure>

<p>运行结束后，会把统计信息输出到标准错误输出中。如下图所示：</p>

<p><img src="/uploads/profile-before-tuning.png" alt="profile-before-tuning"></p>

<p>profile统计的是各方法的运行时间，分为两类。一类是计算的是从方法调用到方法返回之间的时间，称为整体时间；另一类则是从整体时间中扣除在该方法中调用其它方法所耗费时间之后得到的时间，称为实际时间。</p>

<p>上图输出信息每行中各字段含义如下（从左到右）：</p>

<ul>
<li>该方法执行时间占整体时间的百分比，比例越高越说明这行代码可能需要优化</li>
<li>整体时间的总和</li>
<li>实际时间的总和</li>
<li>被调用的次数</li>
<li>每次调用的平均实际时间（毫秒）</li>
<li>每次调用的平均整体时间（毫秒）</li>
<li>方法名</li>
</ul>

<p>由上图可以看出，脚本执行的时间大部分耗在了循环上。解决方法有两个：消除循环或减少循环次数。前者很难实现，暂且还没有想到办法，也许根本就没有可能。脚本中mapping的大小为2685，所以每修改一个文件名需要执行2685次循环，且循环中的encode和gsub!都是耗时操作。通常文件名的长度不超过30个字符，通过遍历文件名中每个字符的方式重命名就可以把循环次数缩减到不超过30次。</p>

<p>修改代码后重新执行分析命令，得到的结果是脚本运行时间从379395秒变成2418秒，性能整整提升了156倍，达到2个数量级的效果。</p>

<p><img src="/uploads/profile-after-tuning.png" alt="profile-after-tuning"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/using-raspberry-pi-to-monitor-home-humiture/">使用Raspberry Pi监控室内温湿度</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-24T14:19:44+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>机房没有温湿度监控系统，只有温湿度计，还不是数字的，只能得到个大概的读数，不是非常精确。怎么办？自己动手DIY个在线的温湿度监控系统吧！</p>

<p>物品清单：</p>

<ul>
<li>金士顿16G的SDHC卡1张</li>
<li>SDHC读卡器1个（可选）</li>
<li>网线1条</li>
<li>手机充电器（5V/1A）1个</li>
<li>MicroUSB数据线1条</li>
<li>电脑1台</li>
<li>1P-1P双头母杜邦线3条</li>
<li>10K电位器一个</li>
<li>DHT11或DHT22温湿度传感器一个（可以购买已经焊好电阻的传感器模块）</li>
</ul>

<h3 id="让树莓派（raspberry-pi）工作起来">让树莓派（Raspberry Pi）工作起来</h3>

<p>从 <a href="http://www.raspberrypi.org/downloads">http://www.raspberrypi.org/downloads</a> 下载基于debian的wheezy镜像Raspbian。如果使用Windows系统，官方建议使用<a href="http://sourceforge.net/projects/win32diskimager/">Win32DiskImager</a>来复制image文件到SD卡（如果是Linux系统可以用工具dd）。写入系统后，把卡插到板子上，接上网线、电源，然后就启动了。等个20多秒，板上3个小灯都亮了，表明系统已经启动成功。</p>

<p>登录路由器后台找到raspberrypi设备分配到的IP。然后使用SSH或VNC（前者是命令行界面，后者是图形界面）连接刚才从路由器找到的IP地址。登录的默认账号是pi，密码是raspberry。登录RPi之后输入ping qq.com测试上网是否正常。</p>

<h3 id="使用固定的ip访问rpi">使用固定的IP访问RPi</h3>

<p>默认情况下RPi使用的是自动分配的IP地址，每次登录都需要在路由器中查找对应IP，实在太麻烦，可以把它设置成静态的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vi /etc/network/interfaces</span></code></pre></td></tr></table></div></figure>

<p>打开配置文件，看到如下内容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>
</span><span class='line'>iface lo inet loopback
</span><span class='line'>iface eth0 inet dhcp
</span><span class='line'>
</span><span class='line'>allow-hotplug wlan0
</span><span class='line'>iface wlan0 inet manual
</span><span class='line'>wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</span><span class='line'>iface default inet dhcp</span></code></pre></td></tr></table></div></figure>

<p>将之修改成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'>iface eth0 inet static
</span><span class='line'>  address 192.168.0.100
</span><span class='line'>  netmask 255.255.255.0
</span><span class='line'>  gateway 192.168.0.1
</span><span class='line'>  dns-nameservers 8.8.8.8
</span><span class='line'>
</span><span class='line'>allow-hotplug wlan0
</span><span class='line'>iface wlan0 inet manual
</span><span class='line'>  wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</span><span class='line'>
</span><span class='line'>iface default inet dhcp</span></code></pre></td></tr></table></div></figure>

<p>然后存盘退出。以后就可以通过192.168.0.100来登录RPi了。</p>

<h3 id="把温湿度传感器接到rpi上">把温湿度传感器接到RPi上</h3>

<p><img src="/uploads/rpi-dht22.png" alt="rpi-dht22"></p>

<p>DHT11/DHT22共有4根引脚：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1 -&gt; 3.3v 接左边第1个GPIO针脚
</span><span class='line'>2 -&gt; GPIO 数据接口，可随意连接1个GPIO针脚（第7个针脚对应的是GPIO Pin #4）
</span><span class='line'>3 -&gt; NC 不接
</span><span class='line'>4 -&gt; GND 接地（第14个针脚）</span></code></pre></td></tr></table></div></figure>

<p>注意：在1脚和2脚间还需要并联10K的电阻，以保持读数稳定。</p>

<p>安装好的样子：</p>

<p><img src="/uploads/rpi-actual.png" alt="rpi-actual"></p>

<h3 id="用c代码读取当前的温度和湿度值">用C代码读取当前的温度和湿度值</h3>

<p>用的是树莓派2红色B型，它采用Broadcom BCM2835 (CPU, GPU, DSP, and SDRAM)芯片。所以读取GPIO口需要到 <a href="http://www.open.com.au/mikem/bcm2835/index.html">http://www.open.com.au/mikem/bcm2835/index.html</a> 获取最新的BCM2835 C语言库，然后下载，编译和安装。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://www.open.com.au/mikem/bcm2835/bcm2835-1.36.tar.gz
</span><span class='line'>tar -zxvf bcm2835-1.36.tar.gz
</span><span class='line'>cd bcm2835-1.36
</span><span class='line'>./configure
</span><span class='line'>make
</span><span class='line'>sudo make install</span></code></pre></td></tr></table></div></figure>

<p>从GitHub库中获取DHT11/DHT22温湿度程序，编译测试。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /home/pi
</span><span class='line'>git clone https://github.com/dohkoos/Raspberry-Pi-Code.git
</span><span class='line'>cd Raspberry-Pi-Code/DHT22
</span><span class='line'>make
</span><span class='line'>sudo ./dht 22 4 # 数据接口接在第7针脚，所以这里是4</span></code></pre></td></tr></table></div></figure>

<h3 id="记录曲线图到云端">记录曲线图到云端</h3>

<p>这里使用<a href="http://www.yeelink.net/">Yeelink</a>的服务，Yeelink是国内比较知名的免费物联网数据平台。根据它的API规则，提交的数据必须为JSON格式：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{"timestamp": "2012-03-15 16:13:14", "value": 294.34}</span></code></pre></td></tr></table></div></figure>

<p>将温湿度值提交到Yeelink的Ruby代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Capture temperature & humidity value from the console
</span><span class='line'>output = `sudo ./dht 22 4`
</span><span class='line'>mt = /Temp =\s+([0-9.]+)/.match(output)
</span><span class='line'>temperature = mt[1]
</span><span class='line'>
</span><span class='line'>mt = /Hum =\s+([0-9.]+)/.match(output)
</span><span class='line'>humidity = mt[1]
</span><span class='line'>
</span><span class='line'># Combined temperature & humidity value into json format
</span><span class='line'>json_temperature = %Q[{\\"timestamp\\": \\"#{Time.now}\\", \\"value\\": #{temperature}}]
</span><span class='line'>json_humidity = %Q[{\\"timestamp\\": \\"#{Time.now}\\", \\"value\\": #{humidity}}]
</span><span class='line'>
</span><span class='line'># Post json data to Yeelink
</span><span class='line'>`curl -X POST -d "#{json_temperature}" -H "Content-Type: application/json" -H "U-ApiKey:XXXXXXXXXXXXXXXX" http://api.yeelink.net/v1.0/device/&lt;device_id&gt;/sensor/&lt;sensor_id&gt;/datapoints`
</span><span class='line'>`curl -X POST -d "#{json_humidity}" -H "Content-Type: application/json" -H "U-ApiKey:XXXXXXXXXXXXXXXX" http://api.yeelink.net/v1.0/device/&lt;device_id&gt;/sensor/&lt;sensor_id&gt;/datapoints`</span></code></pre></td></tr></table></div></figure>

<p>将U-ApiKey:XXXXXXXXXXXXXXXX替换为自已账户的API Key，后面的URL也需要替换为自己申请的传感器URL。</p>

<h3 id="添加到计划任务">添加到计划任务</h3>

<p>使用crontab命令将以下内容添加到计划任务中：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># m h dom mon dow command
</span><span class='line'>*/10 * * * * cd /home/pi/Raspberry-Pi-Code/DHT22/ && ruby yeelink.rb</span></code></pre></td></tr></table></div></figure>

<p>重启计划任务，然后每隔10分钟就会上传一次数据到云端。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo /etc/init.d/cron restart</span></code></pre></td></tr></table></div></figure>

<p>下面是我的曲线图：</p>

<p><img src="/uploads/rpi-yeelink.png" alt="rpi-yeelink"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/rebuild-ebook-website-with-responsive-design/">使用响应式设计改造电子书网站</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-19T11:55:16+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:55 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>因为要在其它设备上测试响应式设计的效果，需要先对开发环境做些简单的配置。</p>

<p>启动服务器时需加上本机的IP地址和访问端口（通常是80）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails s -b 192.168.0.100 -p 80</span></code></pre></td></tr></table></div></figure>

<p>配置Windows系统的内置防火墙，开启80端口以供其它设备访问：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netsh advfirewall firewall add rule name="Open Port 80" dir=in action=allow protocol=TCP localport=80</span></code></pre></td></tr></table></div></figure>

<p>查看和删除防火墙规则的命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netsh advfirewall firewall delete rule name="Open Port 80" protocol=TCP localport=80
</span><span class='line'>netsh advfirewall firewall show rule name="Open Port 80"</span></code></pre></td></tr></table></div></figure>

<p>响应式设计的优缺点就不多说了，已经有太多的文章讲过这些。这里主要讲如何使用响应式设计改造现有的电子书网站。</p>

<p>首先，需要使用viewport标签设置屏幕宽度为设备宽度，使网站内容可以适应响应式变化。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;</span></code></pre></td></tr></table></div></figure>

<p>因为这是一个非常简陋，并且以内容为主的网站。在上述设置后几乎不用再修改就能适应不同屏幕分辨率下的信息呈现，除了导航栏因为导航选项较多，在手机等设备上打开会出现后面部分选项被挤下去。抽屉样式的导航是解决这个问题的好方法。在网上找到一个横向导航栏切换成抽屉式导航栏的库<a href="http://srobbin.github.io/jquery-pageslide/">jQuery PageSlide</a>，它使用图片实现三明治图标，所以对它做了些修改，用标签来实现：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;ul class="burger"&gt;
</span><span class='line'>  &lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;</span></code></pre></td></tr></table></div></figure>

<p>对应的CSS代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.burger {
</span><span class='line'>  li {
</span><span class='line'>    height: 4px;
</span><span class='line'>    width: 30px;
</span><span class='line'>    background: #000;
</span><span class='line'>    border-radius: 3px;
</span><span class='line'>    margin: 5px 0;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>要实现响应式的话，只要让它在正常情况下隐藏，屏幕变小时显现即可：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.burger {
</span><span class='line'>  display: none;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@media screen and (max-width: 480px) {
</span><span class='line'>  .burger {
</span><span class='line'>    display: block;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>还需要在application.html.erb的底部开启点击三明治图标时的响应事件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= javascript_include_tag "jquery.pageslide", "data-turbolinks-track" =&gt; true %&gt;
</span><span class='line'>&lt;script&gt;
</span><span class='line'>  $(".burger").pageslide();
</span><span class='line'>&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>

<p>导航条的CSS也需要做些修改，使之能在屏幕变小时转换成抽屉式导航条：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@media screen and (max-width: 480px) {
</span><span class='line'>  nav ul {
</span><span class='line'>    display: none;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>至此，网站的响应式改造就基本完成了。如果你觉得对你有所帮助，请将此文发送给你的朋友，如果你还有更好的建议也可以在下面的评论中分享你的经验。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/mobifying-your-html5-site/">移动化你的HTML5网站</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-24T23:46:59+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:46 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="https://www.html5rocks.com/en/mobile/mobifying/">https://www.html5rocks.com/en/mobile/mobifying/</a></p>

<h3 id="简介">简介</h3>

<p>现在开发移动Web是一个热门话题。今年以来，智能手机的销售量首次超过PC。越来越多的用户正在使用移动设备来访问Web，这意味着为移动浏览器优化网站变得至关重要。</p>

<p>对于大量开发者来说，“移动”战场仍是未知的领域。许多现有的遗留网站完全忽视移动用户。相反，这些网站主要为桌面浏览设计，因而在移动浏览器中效果不佳。本网站（html5rocks.com）也不例外。在推出时，我们只在该网站的移动版本上投入少许精力。</p>

<h3 id="创建移动友好的html5rocks-com">创建移动友好的html5rocks.com</h3>

<p>作为一项练习，我认为给现有的html5rocks增加移动友好的版本将会很有趣。我主要关注针对目标智能手机所需的最低工作量。我的练习目标不是创建一个全新的移动网站并维护两个代码库。这是巨大的时间浪费且将永远消失。我们已经定义网站的结构（HTML）。我们有一个外观和感觉（CSS）。核心功能（JavaScript）也已存在。重点是，很多网站都以相同的方式存在。</p>

<p>本文将探讨如何创建针对Android和iOS设备进行优化的移动版html5rocks。只需在支持这些操作系统的设备上加载html5rocks.com即可查看其差异。没有重定向到m.html5rocks.com或其它这种性质的蠢事。你可以像使用html5rocks那样获得更多的好处，并且在移动设备上运行良好。</p>

<p><img src="/uploads/html5rocks-home.png" alt="html5rocks-home"></p>

<p><em>桌面（左边）和手机（右边）上的html5rocks.com</em></p>

<h3 id="css媒体查询">CSS媒体查询</h3>

<p>HTML4和CSS2支持<a href="http://www.w3.org/TR/CSS2/media.html">媒体相关的样式表</a>已经有段时间了。例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;link rel="stylesheet" media="print" href="printer.css"&gt;</span></code></pre></td></tr></table></div></figure>

<p>将针对打印设备并在打印时为页面内容提供特定的样式。CSS3将媒体类型的想法更进一步，并通过媒体查询增强其功能。<a href="http://www.w3.org/TR/css3-mediaqueries/">媒体查询</a>通过允许更精确地标记样式表来扩展媒体类型的有用性。这使得内容的显示可以针对特定范围的输出设备进行定制，而无需更改内容本身。听起来非常适合需要修改的现有布局！</p>

<p>您可以在外部样式表的media属性中使用媒体查询来定位屏幕宽度、设备宽度、方向等。有关完整列表，请参阅<a href="http://www.w3.org/TR/css3-mediaqueries/">W3C媒体查询规范</a>。</p>

<h4 id="目标屏幕大小">目标屏幕大小</h4>

<p>在以下的示例中，phone.css将应用于那些浏览器认为是“手持式”的设备或屏幕宽度&lt;=320px的设备。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;link rel="stylesheet"
</span><span class='line'>  media="handheld, only screen and (max-device-width: 320px)" href="phone.css"&gt;</span></code></pre></td></tr></table></div></figure>

<p>给媒体查询加上前缀“only”关键词将导致非CSS3兼容浏览器忽略该规则。</p>

<p>以下内容将针对641px到800px之间的屏幕尺寸：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;link rel="stylesheet"
</span><span class='line'>  media="only screen and (min-width: 641px) and (max-width: 800px)" href="ipad.css"&gt;</span></code></pre></td></tr></table></div></figure>

<p>媒体查询也可以出现在内联的<code>&lt;style&gt;</code>标签中。当纵向显示时，以下内容针对all媒体类型：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;style&gt;
</span><span class='line'>  @media only all and (orientation: portrait) { ... }
</span><span class='line'>&lt;/style&gt;</span></code></pre></td></tr></table></div></figure>

<h4 id="media-quot-handheld-quot">media=&quot;handheld&quot;</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/multiple-file-upload-with-jquery-rails-4-and-paperclip/">使用jQuery、Rails 4和Paperclip进行多文件上传</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-27T08:21:48+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>8:21 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="https://5minutenpause.com/blog/2013/09/04/multiple-file-upload-with-jquery-rails-4-and-paperclip/">https://5minutenpause.com/blog/2013/09/04/multiple-file-upload-with-jquery-rails-4-and-paperclip/</a></p>

<p>在最近的项目中，我需要一个方便的文件上传器。我想要多文件上传和进度条。我想要它们都能与<a href="http://getbootstrap.com/">Bootstrap</a>一起工作。<a href="http://blueimp.github.io/jQuery-File-Upload/">jQuery File Upload</a>能够满足这些需求。初看上去它似乎不容易使用，在研究后我发现Ryan Bates做过一个关于<a href="http://railscasts.com/episodes/381-jquery-file-upload">jQuery文件上传</a>的<a href="http://railscasts.com/">railscast</a>。不幸的是，这个railscast使用了Rails 3和旧的jQuery版本。所以我必须调整它。涉及这个主题的其它博文都开始于2012年甚至更早，在这里是新的Rails 4版本。</p>

<p>我们不是生活在真空中，所以会经常性地使用已有的想法（<a href="http://everythingisaremix.info/blog/everything-is-a-remix-the-ted-talk">一切都是混合</a>），因此我没有试图去提出一个完全原创的解决方案，下面我的实现是基于Ryans的工作。</p>

<p><strong>更新：</strong>我为这篇文章创建了一个<a href="https://github.com/5minpause/multiple-file-upload">GitHub仓库</a>。你可以将其用作本文中我使用的所有内容的完整工作副本。我使用这些提交来跟踪博客文章，以便你可以使用它们“重播”我的实现。如果有任何问题，请<a href="https://github.com/5minpause/multiple-file-upload/issues">在GitHub打开一个issue</a>，并在那里询问，或者就在本文后面发布你的评论。谢谢。</p>

<p><strong>更新2：</strong>Paul Walker在评论中指出了如何解决Turbolinks的问题。如果你也有这种情况，请看<a href="http://5minutenpause.com/blog/2013/09/04/multiple-file-upload-with-jquery-rails-4-and-paperclip/#comment-1595778720">他对Turbolinks的评论</a>。</p>

<p><strong>更新3：</strong>如果你想知道如何在后台完成图片处理，请参阅<a href="http://5minutenpause.com/blog/2014/10/24/comprehensive-guide-to-background-processing-of-uploads-with-activejob-and-rails-4-dot-2">我的这个主题的新帖子</a>。我会给你展示如何使用Rails 4.2的Active Job和Delayed Job来实现后台处理。</p>

<h3 id="gem和资源文件">Gem和资源文件</h3>

<p>我们从Gemfile开始，添加<code>jquery-fileupload-rails</code>这个gem。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'jquery-fileupload-rails'</span></code></pre></td></tr></table></div></figure>

<p>使用<code>bundle install</code>安装所有gem。</p>

<p>安装后，你需要在你的application.js中引入以下这些文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//= require jquery
</span><span class='line'>//= require jquery_ujs
</span><span class='line'>//= require jquery-fileupload/basic
</span><span class='line'>//= require jquery-fileupload/vendor/tmpl
</span><span class='line'>//= require_tree .</span></code></pre></td></tr></table></div></figure>

<p>我们在这里使用基本版本，并且包含<code>jquery-fileupload/vendor/tmpl</code>，所以我们可以选择渲染我们自己的模板。</p>

<h3 id="视图">视图</h3>

<p>我们有个表单用于上传文件，并将JavaScript模板包含在文件的底部。有件事要注意：模板脚本必须是没有换行或空格的单行程序。否则jQuery会抱怨：<code>Uncaught Syntax error, unrecognized expression: [object Object]</code>。另一个解决方案是使用<code>$.parseHTML();</code>。接下来我会给你展示如何在uploads.js.coffee中做到这点。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= form_for Upload.new, :url =&gt; uploads_path, html: { multipart: true } do |f| %&gt;
</span><span class='line'>  &lt;%= f.label :uploaded_file, t('.upload_new_file') %&gt;
</span><span class='line'>  &lt;%= f.file_field :uploaded_file, multiple: true, name: 'upload[uploaded_file]' %&gt;
</span><span class='line'>  &lt;%= f.submit t(:save), class: 'btn' %&gt;
</span><span class='line'>&lt;% end %&gt;
</span><span class='line'>
</span><span class='line'>&lt;% # jquery upload template # %&gt;
</span><span class='line'>&lt;script id="template-upload" type="text/x-tmpl"&gt;
</span><span class='line'>  &lt;div class="upload"&gt;
</span><span class='line'>    { %=o.name % }&lt;div class="progress"&gt;&lt;div class="bar" style="width: 0%"&gt;&lt;/div&gt;&lt;/div&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>

<p>因为要返回JavaScript脚本，所以:create成功后要渲染的文件如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% if @upload.new_record? %&gt;
</span><span class='line'>  alert('Failed');
</span><span class='line'>&lt;% else %&gt;
</span><span class='line'>  $('ul.thumbnails').append("&lt;%=j render partial: 'photosets/upload', locals: { upload: @upload } %&gt;");
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>

<p>当你点击提交以上传你的图片时，实际发生的是你上传的每张图片都有多次提交。现在我们需要处理这些提交。我们在CoffeeScript文件里面做这些：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jQuery -&gt;
</span><span class='line'>  $('#upload_uploaded_file').attr('name','upload[uploaded_file]')
</span><span class='line'>  $('#new_upload').fileupload
</span><span class='line'>    dataType: 'script'
</span><span class='line'>    add: (e, data) -&gt;
</span><span class='line'>      types = /(\.|\/)(gif|jpe?g|png|mov|mpeg|mpeg4|avi)$/i
</span><span class='line'>      file = data.files[0]
</span><span class='line'>      if types.test(file.type) || types.test(file.name)
</span><span class='line'>        data.context = $(tmpl("template-upload", file))
</span><span class='line'>        $('#new_upload').append(data.context)
</span><span class='line'>        data.submit()
</span><span class='line'>      else
</span><span class='line'>        alert("#{file.name} is not a gif, jpg or png image file")
</span><span class='line'>    progress: (e, data) -&gt;
</span><span class='line'>      if data.context
</span><span class='line'>        progress = parseInt(data.loaded / data.total * 100, 10)
</span><span class='line'>        data.context.find('.bar').css('width', progress + '%')</span></code></pre></td></tr></table></div></figure>

<p>这里我们检查文件的类型是图片还是电影。否则，我们将向用户显示不允许该文件的警告。如果文件被允许，我们使用文件的数据渲染模板，并将其附加到我们的图片列表中（这里没有显示代码——你可以很容易地弄明白）。然后我们提交文件进行实际上传并保存到数据库。此外，我们显示每个上传文件的进度条。</p>

<p>upload.js.coffee中的第2行用于将upload_file的名称从数组改为单个上传（从<code>upload[uploaded_file][]</code>到<code>upload[uploaded_file]</code>）。否则，上传数组会使Paperclip抛出错误<code>Paperclip::AdapterRegistry::NoHandlerError</code>。你可以使用file_field的name属性设置值，但那对我来说无法可靠地工作。</p>

<p>我在之前说过，你必须避免模板中的换行符。如果你将第9行改为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>data.context = $($.parseHTML($(tmpl("template-upload", file)))[1])</span></code></pre></td></tr></table></div></figure>

<p>应该可以保持你的换行。我在<a href="http://stackoverflow.com/a/15563364/299781">Stack Overflow</a>发现这个，但没有尝试过。但它看起来应该没问题。</p>

<p>控制器动作很简单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def create
</span><span class='line'>  @upload = Upload.create(upload_params)
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>这是个简单的实现。你可以做的更多。仔细看看<a href="http://blueimp.github.io/jQuery-File-Upload/">jQuery File Upload</a>的文档。如果你有任何问题，可以在twitter或app.net上询问我，我很乐意为你提供帮助。谢谢阅读。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/rails-insecure-defaults/">Rails的不安全默认配置——需要知道的13个安全陷阱</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-02T18:19:40+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2013</span></span> <span class='time'>6:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="http://blog.codeclimate.com/blog/2013/03/27/rails-insecure-defaults/">http://blog.codeclimate.com/blog/2013/03/27/rails-insecure-defaults/</a></p>

<p>安全的默认配置是构建安全系统的关键。如果开发者必须采取明确的行动来执行安全行为，即使是有经验的开发者最终也会忘记这样做。为此，安全专家说：</p>

<blockquote>
<p>不安全的默认配置是不安全的。</p>
</blockquote>

<p>Rails作为相对安全的Web框架实至名归。对于许多常见的攻击它都有开箱即用的防护：跨站脚本（XSS）、跨站请求伪造（CSRF）和SQL注入。Rails的核心成员知识渊博，真正关心安全。</p>

<p>然而，有些地方的默认行为可以做得更安全。这篇文章探讨了在Rails 4中修复的Rails 3中的潜在安全性问题，以及那些仍存在危险的安全性问题。我希望这篇文章可以帮助你保护自己的应用程序，同时启发Rails本身的修改。</p>

<h3 id="rails-3的问题">Rails 3的问题</h3>

<p>让我们从主干中已修复的某些Rails 3的问题开始。对于这些问题的解决，Rails团队值得称赞，但它们却毫无价值，因为许多应用程序在未来很多年里仍将运行在Rails 2和3上。</p>

<h4 id="1-通过有漏洞的-match路由进行csrf攻击">1. 通过有漏洞的#match路由进行CSRF攻击</h4>

<p>这里是直接取自于Rails 3生成的config/routes.rb文件的一个示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>WebStore::Application.routes.draw do
</span><span class='line'>  # Sample of named route:
</span><span class='line'>  match 'products/:id/purchase' =&gt; 'catalog#purchase',
</span><span class='line'>    :as =&gt; :purchase
</span><span class='line'>  # This route can be invoked with
</span><span class='line'>  # purchase_url(:id =&gt; product.id)
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>这样做的后果是，对于任何HTTP动词（GET、POST等），/products/:id/purchase路径都将路由到CatalogController#purchase方法。问题是Rails的跨站请求伪造（CSRF）防护不适用于GET请求。你可以在实施CSRF防护的方法中看到这点：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def verified_request?
</span><span class='line'>  !protect_against_forgery? ||
</span><span class='line'>  request.get? ||
</span><span class='line'>  form_authenticity_token ==
</span><span class='line'>    params[request_forgery_protection_token] ||
</span><span class='line'>  form_authenticity_token ==
</span><span class='line'>    request.headers['X-CSRF-Token']
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>第2行短路CSRF检查：这意味着如果request.get?为true，请求会被认为是“验证过的”，并且CSRF检查将被跳过。事实上，在Rails的源代码中，该方法前面就有注释说：</p>

<blockquote>
<p>Get应该是安全和幂等的。</p>
</blockquote>

<p>在你的应用程序中，你可能总是使用POST向/products/:id/purchase提出请求。但是由于路由器允许GET请求，对于通过#match帮助器路由的任何方法，攻击者都可以轻松地绕过CSRF防护。如果你的应用程序使用旧的通配符路由（不推荐），则CSRF防护完全无效。</p>

<p><strong>最佳实践：</strong>不要对不安全的动作使用GET。不要使用#match来添加路由（而是使用#post、#put等）。确保没有通配符路由。</p>

<p><strong>修复：</strong>当使用#match添加路由时，Rails现在需要你指定明确的HTTP动词或via: :all。生成的config/routes.rb不再包含已注释掉的#match路由。（通配符路由也已被删除。）</p>

<h4 id="2-格式验证中的正则表达式锚点">2. 格式验证中的正则表达式锚点</h4>

<p>考虑以下验证：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>validates_format_of :name, with: /^[a-z ]+$/i</span></code></pre></td></tr></table></div></figure>

<p>这段代码有个不易察觉的缺陷。开发者可能想强制整个名字属性仅由字母和空格组成。然而相反的是，这只会强制名字中至少有一行由字母和空格组成。正则表达式匹配的一些示例可以使这个缺陷更加清晰：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt; /^[a-z ]+$/i =~ "Joe User"
</span><span class='line'>=&gt; 0 # Match
</span><span class='line'>
</span><span class='line'>&gt;&gt; /^[a-z ]+$/i =~ " '); -- foo"
</span><span class='line'>=&gt; nil # No match
</span><span class='line'>
</span><span class='line'>&gt;&gt; /^[a-z ]+$/i =~ "a\n '); -- foo"
</span><span class='line'>=&gt; 0 # Match</span></code></pre></td></tr></table></div></figure>

<p>开发者应该使用\A（字符串的开始）和\z（字符串的结尾）锚点替代&Hat;（行的开始）和$（行的结尾）。正确的代码是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>validates_format_of :name, with: /\A[a-z ]+\z/i</span></code></pre></td></tr></table></div></figure>

<p>你可以认为开发者有错，而你是对的。然而，正则表达式锚点的行为不一定是明显的，特别是对于没有考虑多行值的开发者。（可能该属性仅被暴露在文本输入字段，而不是文本区域。）</p>

<p>Rails在拯救开发者方面做得不错，这正是Rails 4所做的工作。</p>

<p><strong>最佳实践：</strong>尽可能使用\A和\z来锚定正则表达式，而不是&Hat;和$。</p>

<p><strong>修复：</strong>Rails 4为validates_format_of引入了一个多行选项。如果你的正则表达式使用&Hat;和$而不是\A和\z进行锚定，并且没有传递multiline: true，则Rails将引发异常。这是创建更安全的默认行为的一个很好的示例，同时仍然提供控制以在必要的地方覆盖它。</p>

<h4 id="3-点击劫持">3. 点击劫持</h4>

<p>点击劫持或“用户界面伪装攻击”涉及在不可见的页帧中呈现目标站点，并诱骗受害者在点击时执行出乎意料的动作。如果一个站点很容易被点击劫持攻击，攻击者可能会诱骗用户执行不必要的动作，例如单击购买，在Twitter上跟随某人，或更改他们的隐私设置。</p>

<p>为防御点击劫持攻击，站点必须阻止自己被呈现在frame或不受控制的站点的iframe中。较老的浏览器需要丑陋的“页帧破解”JavaScript，但现代浏览器支持<a href="https://developer.mozilla.org/en-US/docs/HTTP/X-Frame-Options">X-Frame-Options HTTP报头</a>，它告知浏览器是否允许站点被页帧。这个报头很容易包含，也不可能破坏大多数的网站，所以Rails应该默认包含它。</p>

<p><strong>最佳实践：</strong>使用Twitter的<a href="https://github.com/twitter/secureheaders">secure_headers</a>添加一个X-Frame-Options报头，其值为SAMEORIGIN或DENY。</p>

<p><strong>修复：</strong>默认情况下，Rails 4现在发送带有SAMEORIGIN值的X-Frame-Options报头：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>X-Frame-Options: SAMEORIGIN</span></code></pre></td></tr></table></div></figure>

<p>这告诉浏览器你的应用程序只能由源自同一个域的页面构成。</p>

<h4 id="4-用户可读的会话">4. 用户可读的会话</h4>

<p>默认的Rails 3会话存储使用已签名的未加密Cookie。虽然这样可以保护会话免遭篡改，但攻击者可以很容易对会话Cookie的内容进行解码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>session_cookie = &lt;&lt;-STR.strip.gsub(/\n/, '')
</span><span class='line'>BAh7CEkiD3Nlc3Npb25faWQGOgZFRkkiJTkwYThmZmQ3Zm
</span><span class='line'>dAY7AEZJIgtzZWtyaXQGO…--4c50026d340abf222…
</span><span class='line'>STR
</span><span class='line'>
</span><span class='line'>Marshal.load(Base64.decode64(session_cookie.split("--")[0]))
</span><span class='line'># =&gt; {
</span><span class='line'>#   "session_id"  =&gt; "90a8f...",
</span><span class='line'>#   "_csrf_token" =&gt; "iUoXA...",
</span><span class='line'>#   "secret"      =&gt; "sekrit"
</span><span class='line'># }</span></code></pre></td></tr></table></div></figure>

<p>在会话中存储任何敏感信息是不安全的。希望这是众所周知的，但即使用户的会话不包含敏感数据，它仍然可能会产生风险。通过解码会话数据，攻击者可以获得在攻击中可以利用的有关应用程序内部的有用信息。例如，可以得知哪个认证系统正在使用（Authlogic、Devise等）。</p>

<p>虽然这不会自行创建漏洞，但它可以帮助攻击者。关于应用程序如何工作的任何信息都可以被用于磨蚀攻击，并且在某些情况下，可以避免触发那些会给开发者提供正在被攻击的早期警告的异常或者绊网。</p>

<p>用户可读会话违反了最低权限原则，因为即使会话数据必须传递给访问者的浏览器，访问者也无需能够读取数据。</p>

<p><strong>最佳实践：</strong>不要将任何你不希望攻击者访问的信息放入会话中。</p>

<p><strong>修复：</strong>Rails 4将默认会话存储更改为加密的。没有解密密钥，用户在客户端将不再能够解码会话的内容。</p>

<h3 id="尚未解决的问题">尚未解决的问题</h3>

<p>这篇文章的剩余部分讨论Rails在发布时仍然存在的安全风险。希望至少有些会被修复，如果是这样，我将更新这篇文章。</p>

<h4 id="1-详细的服务器报头">1. 详细的服务器报头</h4>

<p>默认的Rails服务器是WEBrick（Ruby标准库的一部分），即使在生产中很少运行WEBrick。默认情况下，WEBrick对每个HTTP响应都返回一个详细的服务器报头：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HTTP/1.1 200 OK
</span><span class='line'># ...
</span><span class='line'>Server: WEBrick/1.3.1 (Ruby/1.9.3/2012-04-20)</span></code></pre></td></tr></table></div></figure>

<p>看看WEBrick的源代码，你可以看到报头是由几个关键信息组成的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"WEBrick/#{WEBrick::VERSION} " +
</span><span class='line'>"(Ruby/#{RUBY_VERSION}/#{RUBY_RELEASE_DATE})",</span></code></pre></td></tr></table></div></figure>

<p>这暴露了WEBrick的版本，以及正在运行的特定的Ruby补丁级别（因为发布日期对应补丁级别）。有了这些信息，扫描工具可以更有效地针对你的服务器，攻击者可以定制其攻击有效载荷。</p>

<p><strong>最佳实践：</strong>避免在生产中运行WEBrick。外面有更好的服务器，像Passenger、Unicorn、Thin和Puma。</p>

<p><strong>修复：</strong>虽然此问题的根源在于WEBrick的源代码，但Rails应该将WEBrick配置为使用不那么详细的服务器报头。只打印“Ruby”似乎是个不错的选择。</p>

<h4 id="2-绑定到0-0-0-0">2. 绑定到0.0.0.0</h4>

<p>如果你启动一个Rails服务器，你将看到如下信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./script/rails server -e production
</span><span class='line'>=&gt; Booting WEBrick
</span><span class='line'>=&gt; Rails 3.2.12 application starting in production on http://0.0.0.0:3000</span></code></pre></td></tr></table></div></figure>

<p>Rails绑定在0.0.0.0（所有网络接口）而不是127.0.0.1（仅限本地接口）。这可能在开发和生产环境中产生安全风险。</p>

<p>在开发模式下，Rails不是安全的（例如，它呈现用于诊断的500页面）。另外，开发者可以加载生产数据和测试数据的混合（例如，username:admin/password:admin）。在旧金山咖啡店扫描Web服务器的端口3000可能会得到很好的目标。</p>

<p>在生产中，Rails应该运行在代理后面。没有代理，IP欺骗攻击就会经常发生。但是如果Rails绑定在0.0.0.0上，根据部署配置可以通过直接攻击Rails来轻松绕过代理。</p>

<p>因此，在所有Rails环境中，绑定到127.0.0.1是比0.0.0.0更安全的默认配置。</p>

<p><strong>最佳实践：</strong>确保你的Web服务器进程在生产中绑定最小的接口集。避免在笔记本电脑上加载生产数据进行调试。如果你必须这样做，请加载最小的数据集，并在不需要时立即将其删除。</p>

<p><strong>修复：</strong>Rails已经提供了--binding选项来更改服务器侦听的IP地址。默认值应该从0.0.0.0更改为127.0.0.1。需要在生产中绑定到其它接口的开发者可以在部署配置中进行更改。</p>

<h4 id="3-版本化的保密令牌">3. 版本化的保密令牌</h4>

<p>当使用rails new创建时，每个Rails应用程序都会在config/initializers/secret_token.rb中获取一个长的、随机生成的保密令牌。它看起来像这样：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>WebStore::Application.config.secret_token = '4f06a7a…72489780f'</span></code></pre></td></tr></table></div></figure>

<p>由于保密令牌是Rails自动创建的，所以大多数开发者不会去考虑它。但这个保密令牌就像你的应用程序的根密钥。如果你有保密令牌，伪造会话和提升权限就非常简单。它是要保护的敏感数据最关键的部分之一。加密其实就是你的密钥管理最佳实践。</p>

<p>不幸的是，Rails在处理这些保密令牌时没有达到预期效果。secret_token.rb文件最后会被检入到版本控制中，然后复制到GitHub、CI服务器和每个开发者的笔记本电脑。</p>

<p><strong>最佳实践：</strong>在每个环境中使用不同的保密令牌。通过ENV变量注入应用程序。或者，在部署期间符号链接生产保密令牌。</p>

<p><strong>修复：</strong>Rails至少应该默认使用.gitignore忽略config/initializers/secret_token.rb文件。当部署或更改初始化程序以使用ENV变量（例如Heroku）时，开发者可以符号链接生产令牌。</p>

<p>我会进一步提出Rails为保密令牌创建的存储机制。有许多库提供涉及将保密令牌检入到初始化程序的安装指令，这是个坏的实践。与此同时，至少有两个流行的策略来处理这个问题：ENV变量和符号链接的初始化程序。</p>

<p>Rails给开发者提供了一个简单的API来管理保密令牌，并且具有可交换的后端（如缓存存储和会话存储）。</p>

<h4 id="4-在sql语句中记录值">4. 在SQL语句中记录值</h4>

<p>Rails提供的config.filter_parameters是用来防止像密码这样的敏感信息累积在生产日志文件中的一种有用的方法。但它并不影响在SQL语句中值的记录：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Started POST "/users" for 127.0.0.1 at 2013-03-12 14:26:28 -0400
</span><span class='line'>Processing by UsersController#create as HTML
</span><span class='line'>  Parameters: {"utf8"=&gt;"✓œ“", "authenticity_token"=&gt;"...",
</span><span class='line'>  "user"=&gt;{"name"=&gt;"Name", "password"=&gt;"[FILTERED]"}, "commit"=&gt;"Create User"}
</span><span class='line'>  SQL (7.2ms)  INSERT INTO "users" ("created_at", "name", "password_digest",
</span><span class='line'>  "updated_at") VALUES (?, ?, ?, ?)  [["created_at",
</span><span class='line'>  Tue, 12 Mar 2013 18:26:28 UTC +00:00], ["name", "Name"], ["password_digest",
</span><span class='line'>  "$2a$10$r/XGSY9zJr62IpedC1m4Jes8slRRNn8tkikn5.0kE2izKNMlPsqvC"], ["updated_at",
</span><span class='line'>  Tue, 12 Mar 2013 18:26:28 UTC +00:00]]
</span><span class='line'>Completed 302 Found in 91ms (ActiveRecord: 8.8ms)</span></code></pre></td></tr></table></div></figure>

<p>在生产模式（info）中的默认Rails日志级别不会记录SQL语句。这里的风险在于，有时开发者会在调试时暂时提高生产中的日志级别。在这期间，应用程序可能会将敏感数据写入日志文件，然后保存在服务器上很长时间。获得读取服务器上的文件的访问权限的攻击者可以使用简单的grep查找数据。</p>

<p><strong>最佳实践：</strong>知道在生产日志级别什么被记录。如果临时增加日志级别，导致敏感数据被记录，在不需要时要立即删除该数据。</p>

<p><strong>修复：</strong>Rails可以将config.filter_parameters选项改成类似于config.filter_logs，并将其应用于参数和SQL语句。在所有情况下都正确过滤SQL语句是不可能的（因为它需要一个SQL解析器），但对于标准的插入和更新它可能是个80/20解决方案。</p>

<p>或者，如果包含对过滤值的引用，则Rails可以修改整个SQL语句（例如，修改包含“password”的所有语句），至少在生产模式下。</p>

<h4 id="5-离线重定向">5. 离线重定向</h4>

<p>许多应用程序包含需要根据上下文将用户发送到不同位置的控制器动作。最常见的示例是SessionsController，它将新验证的用户引导到其预期的目标网址或者默认的目标网址：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class SignupsController &lt; ApplicationController
</span><span class='line'>  def create
</span><span class='line'>    # ...
</span><span class='line'>    if params[:destination].present?
</span><span class='line'>      redirect_to params[:destination]
</span><span class='line'>    else
</span><span class='line'>      redirect_to dashboard_path
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>这会产生风险，攻击者可以构建一个URL，导致不知情的用户在登录后被发送到恶意站点：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://example.com/sessions/new?destination=http://evil.com/</span></code></pre></td></tr></table></div></figure>

<p>无效的重定向可用于钓鱼式攻击，或者可能会损害用户对你的信任，因为你似乎将他们发送到恶意网站。即使是警惕的用户也可能不会在首个页面加载后检查网址栏以确保他们不被钓鱼。这个问题是足够严重的，已经成为最新版的OWASP十大应用安全威胁。</p>

<p><strong>最佳实践：</strong>将散列传递到#redirect_to时，使用only_path: true选项将重定向限制为当前主机：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redirect_to params.merge(only_path: true)</span></code></pre></td></tr></table></div></figure>

<p>当传递字符串时，你可以解析它来提取路径：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redirect_to URI.parse(params[:destination]).path</span></code></pre></td></tr></table></div></figure>

<p><strong>修复：</strong>默认情况下，Rails应该只允许同个域内（或白名单）的重定向。对于需要外部重定向的罕见情况，应该要求开发者将external: true选项传递给redirect_to，以便选择更危险的行为。</p>

<h4 id="6-利用link_to的跨站脚本（xss）">6. 利用link_to的跨站脚本（XSS）</h4>

<p>许多开发者没有意识到link_to帮助器的HREF属性可被用于注入JavaScript。这里是不安全代码的示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= link_to "Homepage", user.homepage_url %&gt;</span></code></pre></td></tr></table></div></figure>

<p>假设用户可以通过更新其画像来设置他们的homepage_url的值，这会产生XSS的风险。如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user.homepage_url = "javascript:alert('hello')"</span></code></pre></td></tr></table></div></figure>

<p>将生成这样的HTML：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;a href="javascript:alert('hello')"&gt;Homepage&lt;/a&gt;</span></code></pre></td></tr></table></div></figure>

<p>单击链接将执行攻击者提供的脚本。Rails的XSS保护不会阻止这种情况。在社区迁移到更不唐突的JavaScript技术之前，这曾经是无法避免且常见的，但现在是个残留的弱点。</p>

<p><strong>最佳实践：</strong>避免在HREF中使用不受信任的输入。当你必须允许用户控制HREF时，首先通过URI.parse分析输入，然后对协议和主机做完整性检测。</p>

<p><strong>修复：</strong>默认情况下，Rails应该只允许路径、HTTP、HTTPS和mailto:href等值在link_to帮助器中。开发者必须通过传递选项给link_to帮助器以选择不安全的行为，或者link_to可能直接不支持这些，开发者需要手工制作他们的链接。</p>

<h4 id="7-sql注入">7. SQL注入</h4>

<p>Rails在防止常见的SQL注入（SQLi）攻击方面做得比较好，所以开发者可能会认为Rails对SQLi是免疫的。当然不是这样。假设开发者需要根据参数完成orders表中的小计或总计。他们可能写：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Order.pluck(params[:column])</span></code></pre></td></tr></table></div></figure>

<p>这样做是不安全的。显然，用户现在可以操纵应用程序从他们希望的orders表中检索任何数据列。然而，不太明显的是，攻击者还可以从其它表中提取值。例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>params[:column] = "password FROM users--"
</span><span class='line'>Order.pluck(params[:column])</span></code></pre></td></tr></table></div></figure>

<p>将会变成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT password FROM users-- FROM "orders"</span></code></pre></td></tr></table></div></figure>

<p>同样，#calculate的column_name属性实际上接受任意SQL：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>params[:column] = "age) FROM users WHERE name = 'Bob'; --"
</span><span class='line'>Order.calculate(:sum, params[:column])</span></code></pre></td></tr></table></div></figure>

<p>将会变成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT SUM(age) FROM users WHERE name = 'Bob'; --) AS sum_id FROM "orders"</span></code></pre></td></tr></table></div></figure>

<p>控制#calculate方法的column_name属性允许攻击者从任意表中的任意列中提取特定值。</p>

<p><a href="http://rails-sqli.org/">rails-sqli.org</a>详细介绍了哪些ActiveRecord方法和选项允许SQL，且带有它们如何被攻击的示例。</p>

<p><strong>最佳实践：</strong>了解你使用的API以及它们在什么情况下可能允许比你预期的更危险的操作。使用最安全的API，和预期输入的白名单。</p>

<p><strong>修复：</strong>这个问题难以批量解决，因为正确的解决方案因语境而异。一般来说，ActiveRecord API应该只允许常用的SQL片段。名为column_name的方法参数只能接受列名。可以为需要更多控制的开发者提供替代API。</p>

<p><em>感谢Twitter的Justin Collins撰写<a href="http://rails-sqli.org/">rails-sqli.org</a>，它使我意识到了这个问题。</em></p>

<h4 id="8-yaml反序列化">8. YAML反序列化</h4>

<p>如同许多Ruby开发者在早期学到的，使用YAML反序列化不可信数据与eval一样不安全。已经有很多基于YAML攻击的文章，所以我不会在这里炒冷饭，但总而言之，如果攻击者可以注入一个YAML有效载荷，他们可以在服务器上执行任意代码。应用程序不需要做任何事情，只要加载YAML就容易易受攻击。</p>

<p>尽管Rails已经打过补丁，以避免解析在HTTP请求中发送给服务器的YAML，但它仍然使用YAML作为#serialize功能的默认序列化格式，就像新的#store功能（它本身就是围绕#serialize的简单包装）那样。危险代码看起来像这样：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  # ...
</span><span class='line'>  serialize :preferences
</span><span class='line'>
</span><span class='line'>  store :theme, accessors: [ :color, :bgcolor ]
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p>大多数Rails开发者不会喜欢在数据库中存储任意Ruby代码，然后在加载记录时对其进行解释执行，按照这种方法，它与使用YAML反序列化功能相当。当存储的数据不包含任意Ruby对象时，它违反了最低权限原则。允许编写数据库中的值的漏洞可以被作为跳板以控制整个服务器。</p>

<p>我特别担心YAML的使用，因为它看起来安全但实际上危险。在远程代码执行（RCE）漏洞暴露之前，YAML格式已经被数以百计的熟练开发者查看多年。虽然这是Ruby社区的头等大事，但明年接手Rails的新开发者将不会经历YAML RCE的惨败。</p>

<p><strong>最佳实践：</strong>使用JSON序列化格式而不是因为#serialize和#store使用YAML：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  serialize :preferences, JSON
</span><span class='line'>  store :theme, accessors: [ :color, :bgcolor ], coder: JSON
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

<p><strong>修复：</strong>Rails应该将ActiveRecord的默认序列化格式从YAML切换到JSON。YAML行为应该通过选择加入或者提取到可选的Gem中。</p>

<h4 id="9-批量赋值">9. 批量赋值</h4>

<p>Rails 4从使用attr_accessible处理批量赋值漏洞切换到strong_parameters方法。params对象现在是ActionController::Parameters的实例。strong_parameters检查批量赋值中被使用的Parameters实例是否是“permitted”——开发者已经具体指出了哪些键（和值类型）是预期的。</p>

<p>一般来说，这是个积极的变化，但它确实引入了attr_accessible世界中不存在的一个新的攻击方向。考虑这个示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>params = { user: { admin: true }.to_json }
</span><span class='line'># =&gt; {:user=&gt;"{\"admin\":true}"}
</span><span class='line'>
</span><span class='line'>@user = User.new(JSON.parse(params[:user]))</span></code></pre></td></tr></table></div></figure>

<p>JSON.parse返回一个普通的Ruby Hash，而不是ActionController::Parameters的一个实例。使用strong_parameters的默认行为是允许Hash的实例通过批量赋值来设置任何模型属性。如果在访问ActiveRecord模型时使用Sinatra应用程序中的params会发生同样的问题——Sinatra不会把Hash包装成ActionController::Parameters的实例。</p>

<p><strong>最佳实践：</strong>当把ActiveRecord模型与其它Web框架（或从缓存、队列等反序列化数据）结合起来包装ActionController::Parameters中的输入以使strong_parameters工作时，尽可能依赖Rails的开箱即用解析。</p>

<p><strong>修复：</strong>目前还不清楚Rails应对这个问题的最佳方法是什么。Rails可以覆盖诸如JSON.parse之类的反序列化方法来返回ActionController::Parameters的实例，但这相对有侵入性，并且可能导致兼容性问题。</p>

<p>担心的开发者可以将strong_parameters与attr_accessible结合起来用于高度敏感的字段（如User#admin）以进行额外的保护，但这在大多数情况下可能会过犹不及。最后，这可能只是我们需要意识到和留心的行为。</p>

<p>感谢Brendon Murphy让我意识到这个问题。</p>

<p>感谢Adam Baldwin、Justin Collins、Neil Matatell、Noah Davis和Aaron Patterson对这篇文章的审阅。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/create-ebook-website-with-html5/">使用HTML5创建电子书网站</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-24T15:04:32+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>3:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在项目开始前，先要了解下HTML5规范包含的一些有用的新的语义标签，用于提供HTML页面的各个区域或部分的意义，例如页眉、页脚、导航栏、边栏等等。在以前的HTML版本中，这些部分通常使用<code>&lt;div&gt;</code>标签来创建，通过id或class属性来区分。</p>

<p>HTML5引入的主要标签包括：</p>

<table><thead>
<tr>
<th>标签</th>
<th>说明</th>
</tr>
</thead><tbody>
<tr>
<td>header</td>
<td>此标签用于定义页面某些部分的页眉，可以是整个页面、article标签或section标签</td>
</tr>
<tr>
<td>nav</td>
<td>这是页面上主要导航链接的容器。此标签不应用于所有链接组，而是应仅用于主要导航块。如果你有一个footer标签包含导航链接，不需要将这些链接封装在nav标签中，因为footer标签将可以独自包括这些链接</td>
</tr>
<tr>
<td>footer</td>
<td>此标签定义页面的某些部分的页脚。页脚不一定是在页面、文章或区域的结尾，但是它通常是在那个位置</td>
</tr>
<tr>
<td>article</td>
<td>定义文档或页面上的独立区块，例如新闻、杂志、博文或评论</td>
</tr>
<tr>
<td>section</td>
<td>此标签表示文档的一部分，例如，文章或教程的一章或一节。该标签通常具有一个页眉，虽然严格来说是不需要的</td>
</tr>
<tr>
<td>aside</td>
<td>用于标记边栏或一些将认为与其周围内容有点无关的内容。此项的一个例子就是广告块</td>
</tr>
<tr>
<td>hgroup</td>
<td>在某些情况下，页面、文章或区域可能需要多个标题，例如，你有一个标题和一个副标题。你可以在hgroup标签中封装这些标题，使用h1标签表示主标题，h2标签表示副标题</td>
</tr>
</tbody></table>

<p>这些标签的基础结构遵循以下大纲：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>header
</span><span class='line'>  hgroup
</span><span class='line'>nav
</span><span class='line'>article
</span><span class='line'>  header
</span><span class='line'>  section
</span><span class='line'>    header
</span><span class='line'>footer</span></code></pre></td></tr></table></div></figure>

<p><img src="/uploads/html5-ebook-layout.png" alt="html5-ebook-layout"></p>

<p>上面是网站的布局设计，主要有header、navigation、footer和main四个区块，实现代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!-- HTML5的DOCTYPE声明模式，它可以向后兼容，
</span><span class='line'>     再也不用记忆XHTML中复杂的DOCTYPE了！--&gt;
</span><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>  &lt;!-- 指定文档字符编码的写法，该写法在所有浏览器上都有效。--&gt;
</span><span class='line'>  &lt;meta charset="utf-8" /&gt;
</span><span class='line'>  &lt;title&gt;HTML5 Demo&lt;/title&gt;
</span><span class='line'>  &lt;!-- link和script标签也无需提供type属性（No More Types for Scripts and Links），
</span><span class='line'>       因为CSS和JavaScript是目前惟一受支持的样式表和脚本类型 --&gt;
</span><span class='line'>  &lt;link href="style.css" rel="stylesheet" /&gt;
</span><span class='line'>  &lt;!-- 因为IE浏览器（甚至版本8）不支持新的HTML5标签，处理此问题的一个已知方法是使用
</span><span class='line'>       JavaScript函数document.createElement()为每个标记创建虚拟标签。html5.js文件将
</span><span class='line'>       为每个新的HTML标签进行此操作 --&gt;
</span><span class='line'>  &lt;!--[if lt IE 9]&gt;
</span><span class='line'>    &lt;script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
</span><span class='line'>  &lt;![endif]--&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>
</span><span class='line'>&lt;body&gt;
</span><span class='line'>  &lt;header&gt;
</span><span class='line'>    &lt;hgroup&gt;
</span><span class='line'>      &lt;h1&gt;Logo&lt;/h1&gt;
</span><span class='line'>      &lt;h2&gt;Here is the slogan&lt;/h2&gt;
</span><span class='line'>    &lt;/hgroup&gt;
</span><span class='line'>  &lt;/header&gt;
</span><span class='line'>
</span><span class='line'>  &lt;nav&gt;
</span><span class='line'>    &lt;ul&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Home&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Business&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;History&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Religion&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Health&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>      &lt;li&gt;&lt;a href="#"&gt;Science&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>    &lt;/ul&gt;
</span><span class='line'>  &lt;/nav&gt;
</span><span class='line'>
</span><span class='line'>  &lt;!-- main block begin --&gt;
</span><span class='line'>  &lt;!-- main block end --&gt;
</span><span class='line'>
</span><span class='line'>  &lt;footer&gt;&copy; 2013&lt;/footer&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>

<p>对应的CSS文件内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* {
</span><span class='line'>  font-family: Lucida Sans, Arial, Helvetica, sans-serif;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>body {
</span><span class='line'>  width: 768px;
</span><span class='line'>  margin: 0px auto;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>header h1 {
</span><span class='line'>  font-size: 36px;
</span><span class='line'>  margin: 0px;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>header h2 {
</span><span class='line'>  font-size: 18px;
</span><span class='line'>  margin: 0px;
</span><span class='line'>  color: #888;
</span><span class='line'>  font-style: italic;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul {
</span><span class='line'>  list-style: none;
</span><span class='line'>  margin: 0;
</span><span class='line'>  padding: 0;
</span><span class='line'>  width: 100%;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul:after {
</span><span class='line'>  content: "\0020";
</span><span class='line'>  display: block;
</span><span class='line'>  height: 0;
</span><span class='line'>  clear: both;
</span><span class='line'>  visibility: hidden;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul  li {
</span><span class='line'>  float: left;
</span><span class='line'>  width: 16.66%;
</span><span class='line'>  text-align: center;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul li a {
</span><span class='line'>  display: block;
</span><span class='line'>  background: #000;
</span><span class='line'>  color: #fff;
</span><span class='line'>  font-weight: bold;
</span><span class='line'>  padding: 10px;
</span><span class='line'>  border-right: 1px solid #fff;
</span><span class='line'>  text-decoration: none;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>nav ul li a:hover {
</span><span class='line'>  background: #333;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>footer {
</span><span class='line'>  border-top: 1px solid #ccc;
</span><span class='line'>  text-align: center;
</span><span class='line'>  font-size: 12px;
</span><span class='line'>  color: #888;
</span><span class='line'>  margin-top: 24px;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>整个网站主要有这么几个页面：首页、分类页、书目页、内容页，这些页面共用一个布局，主要区别在于main区块的不同。首页、分类页和书目页相似，都是由列表组成。</p>

<p>首页中有多个无序列表，列出网站中最新、最多被访问、最多被分享等的图书：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h3&gt;Latest&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>&lt;h3&gt;Most Viewed&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>&lt;h3&gt;Most Shared&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;</span></code></pre></td></tr></table></div></figure>

<p>分类页是单个无序列表，列出当前被访问分类下所有的图书：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h3&gt;Business&lt;/h3&gt;
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Book's title&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;</span></code></pre></td></tr></table></div></figure>

<p>书目页是单个有序列表，列出某本书所有的章节：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h3&gt;Book's title&lt;/h3&gt;
</span><span class='line'>&lt;ol&gt;
</span><span class='line'>  &lt;li&gt;Chapter 1&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Chapter 2&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;Chapter 3&lt;/li&gt;
</span><span class='line'>&lt;/ol&gt;</span></code></pre></td></tr></table></div></figure>

<p>内容页，顾名思义就是显示具体内容的页面。文章内容用<code>&lt;article&gt;</code>标签表示，其中的标题、作者、发表时间等信息被包含在<code>&lt;header&gt;</code>标签中。主要代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;article&gt;
</span><span class='line'>  &lt;header&gt;
</span><span class='line'>    &lt;h1&gt;&lt;a href="#"&gt;Chapter 1&lt;/a&gt;&lt;/h1&gt;
</span><span class='line'>    &lt;p&gt;By &lt;a href="#"&gt;author&lt;/a&gt; on &lt;time&gt;2013-05-24 14:54&lt;/time&gt;&lt;/p&gt;
</span><span class='line'>  &lt;/header&gt;
</span><span class='line'>  &lt;p&gt;
</span><span class='line'>  Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed
</span><span class='line'>  diam nonummy nibh euismod tincidunt ut laoreet dolore magna
</span><span class='line'>  aliquam erat volutpat. Ut wisi enim ad minim veniam, quis
</span><span class='line'>  nostrud exerci tation ullamcorper suscipit lobortis nisl ut
</span><span class='line'>  aliquip ex ea commodo consequat.
</span><span class='line'>  &lt;/p&gt;
</span><span class='line'>  &lt;section&gt;
</span><span class='line'>    &lt;header&gt;
</span><span class='line'>      &lt;h1&gt;Section heading&lt;/h1&gt;
</span><span class='line'>    &lt;/header&gt;
</span><span class='line'>    &lt;p&gt;
</span><span class='line'>    Duis autem vel eum iriure dolor in hendrerit in vulputate velit
</span><span class='line'>    esse molestie consequat, vel illum dolore eu feugiat nulla
</span><span class='line'>    facilisis at vero eros et accumsan et iusto odio dignissim qui
</span><span class='line'>    blandit praesent luptatum zzril delenit augue duis dolore te
</span><span class='line'>    feugait nulla facilisi.
</span><span class='line'>    &lt;/p&gt;
</span><span class='line'>  &lt;/section&gt;
</span><span class='line'>  &lt;footer&gt;
</span><span class='line'>    &lt;a href="#"&gt;Back&lt;/a&gt;
</span><span class='line'>    &lt;a href="#"&gt;TOC&lt;/a&gt;
</span><span class='line'>    &lt;a href="#"&gt;Forward&lt;/a&gt;
</span><span class='line'>  &lt;/footer&gt;
</span><span class='line'>&lt;/article&gt;</span></code></pre></td></tr></table></div></figure>

<p>在上面的代码里，<code>&lt;header&gt;</code>标签中我们仅使用了<code>&lt;h1&gt;</code>标签，这是因为HTML5会根据上下文计算出heading元素的层级，因此会有：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;body&gt;&lt;h1&gt;  &lt;!-- 相当于heading 1 --&gt;
</span><span class='line'>&lt;body&gt;&lt;section&gt;&lt;h1&gt;  &lt;!-- 相当于heading 2 --&gt;
</span><span class='line'>&lt;body&gt;&lt;section&gt;&lt;section&gt;&lt;h1&gt;  &lt;!-- 相当于heading 3 --&gt;</span></code></pre></td></tr></table></div></figure>

<p>最后顺便说一句，HTML5支持已存在的各种写法：xhtml1.0、xhtml1.1和html4.0，但建议使用xhtml1.1规范，即：</p>

<ol>
<li>所有标签/属性都使用小写字母;</li>
<li>所有属性值都必须加引号;</li>
<li>使用闭合标签。</li>
</ol>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/problem-when-deploying-application-to-heroku/">部署应用到Heroku时的问题</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-21T06:25:33+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>6:25 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Heroku现在已经是纯粹的只读PaaS了，也就是说以前还支持的SQlite现在也不能使用了。因此部署到Heroku上的Rails应用需要把使用的数据库改成PostgreSQL，并且要关闭assets的预编译功能。</p>

<p>修改Gemfile，将SQLite换成PostgreSQL：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># gem 'sqlite3'
</span><span class='line'>gem 'pg'</span></code></pre></td></tr></table></div></figure>

<p>在config/application.rb中添加：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.assets.initialize_on_precompile = false</span></code></pre></td></tr></table></div></figure>

<p>股票功能需要导入交割单文件，因为导入后的文本文件不再使用，可以把上传路径由public/uploads改为tmp，这样就避免了Heroku不能写文件的问题。</p>

<p>应用上传后运行时出现异常，使用heroku logs -t查看日志发现有如下错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Error: column "stocks.share_name" must appear in the GROUP BY clause or be used in an aggregate function</span></code></pre></td></tr></table></div></figure>

<p>这是因为在控制器中有这么一行代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>current_user.stocks.select("share_code, share_name, sum(actual_amount) as amount").group("share_code")</span></code></pre></td></tr></table></div></figure>

<p>在PostgreSQL中这会有问题。比如下面的数据表：</p>

<p><img src="/uploads/stocks-table.png" alt="stocks-table"></p>

<p>执行上面的SQL语句后，share_name的值到底是取Ruby呢还是ST Ruby？解决这个问题的方法是使用aggregate函数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>current_user.stocks.select("share_code, max(share_name) as share_name, sum(actual_amount) as amount").group("share_code")</span></code></pre></td></tr></table></div></figure>

<p>使用PostgreSQL还有个问题，就是decimal类型的字段，取出来的值是字符串类型。例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if stock.amount &lt; 0</span></code></pre></td></tr></table></div></figure>

<p>它会报错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ArgumentError (comparison of String with 0 failed)</span></code></pre></td></tr></table></div></figure>

<p>这个可以使用to_f函数解决：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if stock.amount.to_f &lt; 0</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/10">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/8">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/rnn-effectiveness/">循环神经网络不可思议的效用</a>
      </li>
    
      <li class="post">
        <a href="/blog/how-to-verify-mailbox-exist/">如何验证邮箱是否存在？</a>
      </li>
    
      <li class="post">
        <a href="/blog/crawl-novel-with-scrapy-part6/">使用Scrapy爬取小说（6）</a>
      </li>
    
      <li class="post">
        <a href="/blog/crawl-novel-with-scrapy-part5/">使用Scrapy爬取小说（5）</a>
      </li>
    
      <li class="post">
        <a href="/blog/crawl-novel-with-scrapy-part4/">使用Scrapy爬取小说（4）</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://codemany.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 139%" href="/tags/antlr/">ANTLR</a>
<a style="font-size: 106%" href="/tags/algorithm/">Algorithm</a>
<a style="font-size: 131%" href="/tags/android/">Android</a>
<a style="font-size: 96%" href="/tags/c-plus-plus/">C++</a>
<a style="font-size: 106%" href="/tags/css/">CSS</a>
<a style="font-size: 91%" href="/tags/crack/">Crack</a>
<a style="font-size: 96%" href="/tags/crawler/">Crawler</a>
<a style="font-size: 96%" href="/tags/database/">Database</a>
<a style="font-size: 114%" href="/tags/git/">Git</a>
<a style="font-size: 100%" href="/tags/html/">HTML</a>
<a style="font-size: 103%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 137%" href="/tags/java/">Java</a>
<a style="font-size: 100%" href="/tags/javascript/">JavaScript</a>
<a style="font-size: 96%" href="/tags/listview/">ListView</a>
<a style="font-size: 96%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 103%" href="/tags/paperclip/">Paperclip</a>
<a style="font-size: 96%" href="/tags/python/">Python</a>
<a style="font-size: 116%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 117%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 96%" href="/tags/scrapy/">Scrapy</a>
<a style="font-size: 91%" href="/tags/spring/">Spring</a>
<a style="font-size: 100%" href="/tags/struts/">Struts</a>
<a style="font-size: 146%" href="/tags/translation/">Translation</a>
<a style="font-size: 96%" href="/tags/ubuntu/">Ubuntu</a>
<a style="font-size: 103%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 106%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://www.importnew.com/">ImportNew</a></li>
    <li><a href="http://ifeve.com/">并发编程网</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://advdbg.org/">高端调试</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dohkoos">@dohkoos</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dohkoos',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
  <div>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</div>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemany';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
