
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="classes.dex是Java源码编译后生成的字节码文件。由于Android使用的Dalvik虚拟机与标准的Java虚拟机是不兼容的，dex文件与class文件相比，不论是文件结构还是opcode都不一样。 目前有下面这几种反编译的工具: dexdump
Dedexer
AXMLPrinter2 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/posts/8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46570161-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="codemany.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/decompile-android-apk-file/">反编译Android APK文件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-30T22:07:07+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>10:07 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>classes.dex是Java源码编译后生成的字节码文件。由于Android使用的Dalvik虚拟机与标准的Java虚拟机是不兼容的，dex文件与class文件相比，不论是文件结构还是opcode都不一样。</p>

<p>目前有下面这几种反编译的工具:</p>

<ul>
<li>dexdump</li>
<li><a href="http://dedexer.sourceforge.net/">Dedexer</a></li>
<li><a href="http://code.google.com/p/android4me/">AXMLPrinter2</a></li>
<li><a href="http://code.google.com/p/android-apktool/">apktool</a></li>
<li><a href="http://code.google.com/p/dex2jar/">dex2jar</a> + <a href="http://jd.benow.ca/">JD-GUI</a></li>
<li><a href="http://code.google.com/p/smali/">smali</a></li>
</ul>

<p>dexdump是Android开发包提供的反编译工具。用法为首先启动Android模拟器，把要反编译的dex文件用adb push上传到模拟器中，然后通过adb shell登录，找到该dex文件，执行dexdump example.dex。总的来说dexdump功能比较弱，且用起来麻烦，反编译的结果可读性也很差。</p>

<p>另一个反编译工具是Dedexer，反编译的效果比较好。它可以读取dex格式的文件，生成一种类似于汇编语言的输出。这种输出与Jasmin的输出相似，但包含的是Dalvik的字节码。与dexdump相比它至少有3个优点：</p>

<ol>
<li>不需要在Android模拟器中运行；</li>
<li>反编译后的文件目录结构和源代码结构相近，每个class文件对应一个ddx文件。不像dexdump那样把所有的结果都放在一起；</li>
<li>可以作为反编译引擎。目前好多强大的反编译工具都是以Jasmin作为反编译引擎的。</li>
</ol>

<p>可以下载已经编译好的ddx1.11.jar文件（对应Java 1.6版本）。用法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -jar ddx1.11.jar -o -D -r -d src classes.dex
</span></code></pre></td></tr></table></div></figure>

<p>APK中的资源通常是压缩过的，用文本工具看都是乱码，可以用AXMLPrinter2将其转换成可读的XML文件。具体命令为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -jar AXMLPrinter2.jar example.xml output.xml
</span></code></pre></td></tr></table></div></figure>

<p>目前最好的反编译工具是apktool。可以帮助我们把APK文件反编译，输出smali格式的代码、图片和资源等文件，还可以在修改后重新打包。将下载下来的apktool和apktool-install-windows解压到同一目录，有三个文件：aapt.exe，apktool.bat和apktool.jar。使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apktool d example.apk
</span><span class='line'>apktool b example
</span></code></pre></td></tr></table></div></figure>

<p>dex2jar是一个将dex文件转换成jar文件的工具：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dex2jar example.apk  # 生成的jar文件可以用JD GUI工具直接打开查看
</span></code></pre></td></tr></table></div></figure>

<p>smali可以反编译dex文件，也可以把你修改过的代码重新编译成dex：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -jar baksmali.jar classes.dex -o classes
</span><span class='line'>java -jar smali.jar classes -o classes.dex
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/transfer-sms-from-nokia-6670-to-htc-hero-g3/">将Nokia 6670的短信导入HTC Hero G3</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-21T00:43:10+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2011</span></span> <span class='time'>12:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这事本该N久前就该干了（09年末把手机从Nokia 6670换到HTC Hero G3），却一直拖着没有做，今天终于把这事作了一个了结。</p>

<p>Nokia下导出的短信是如Messages_Nokia 6670_20091215.xml这样的一个XML文件，文件内容的编码是unicode，格式就像下面这样：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="unicode"?&gt;
</span><span class='line'>&lt;SMS PhoneModel="Nokia 6670"&gt;
</span><span class='line'>  &lt;Message DateTime="2011-06-21 10:10:10"&gt;
</span><span class='line'>    &lt;Sender&gt;路人甲&lt;/Sender&gt;
</span><span class='line'>    &lt;PhoneNumber&gt;+8613988888888&lt;/PhoneNumber&gt;
</span><span class='line'>    &lt;Location&gt;Inbox&lt;/Location&gt;
</span><span class='line'>    &lt;Text&gt;我是路人甲&lt;/Text&gt;
</span><span class='line'>  &lt;/Message&gt;
</span><span class='line'>
</span><span class='line'>  &lt;Message DateTime="2011-06-21 11:11:11"&gt;
</span><span class='line'>    &lt;Sender&gt;路人乙&lt;/Sender&gt;
</span><span class='line'>    &lt;PhoneNumber&gt;+8613966666666&lt;/PhoneNumber&gt;
</span><span class='line'>    &lt;Location&gt;Outbox&lt;/Location&gt;
</span><span class='line'>    &lt;Text&gt;我是路人乙&lt;/Text&gt;
</span><span class='line'>  &lt;/Message&gt;
</span><span class='line'>&lt;/SMS&gt;
</span></code></pre></td></tr></table></div></figure>

<p>本来是想写个Android应用来直接导入这些备份短信的，不过在实现的过程中发现了SMS Backup&amp;Restore应用导出的备份文件和Nokia的备份文件类似，产生了做个将Nokia备份文件转换成SMS Backup&amp;Restore备份文件的念头，又在网上发现了nicholashan的<a href="http://bbs.hiapk.com/thread-140564-1-1.html">将Nokia的短信导入Hero（可能适用所有Android机型）</a>，坚定了我的这个想法。</p>

<p>分析了一下SMS Backup&amp;Restore备份文件的格式，文件内容的编码是utf-8的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt;
</span><span class='line'>&lt;smses count="3"&gt;
</span><span class='line'>  &lt;sms protocol="0" address="10658658" date="1308629532000"
</span><span class='line'>    type="1" subject="null" body="我是内容" toa="null"
</span><span class='line'>    sc_toa="null" service_center="null" read="1"
</span><span class='line'>    status="-1" locked="0" /&gt;
</span><span class='line'>  &lt;sms protocol="0" address="13566666666" date="1308633733000"
</span><span class='line'>    type="2" subject="null" body="我也是内容" toa="null"
</span><span class='line'>    sc_toa="null" service_center="null" read="1"
</span><span class='line'>    status="-1" locked="0" /&gt;
</span><span class='line'>  &lt;sms protocol="0" address="+8613588888888" date="1308641377000"
</span><span class='line'>    type="1" subject="null" body="我还是内容" toa="null"
</span><span class='line'>    sc_toa="null" service_center="null" read="1"
</span><span class='line'>    status="-1" locked="0" /&gt;
</span><span class='line'>&lt;/smses&gt;
</span></code></pre></td></tr></table></div></figure>

<p>与转换相关的就address、date、type和body四个属性。address是发信人的号码；date是短信发送日期的timestamp。这点nicholashan的确说错了，后面不需要加什么0的（实际上nicholashan自己也怀疑自己的说法）；type等于1表示别人发给你的短信，如果是2的话就是你发给其他人的短信；body就是短信内容了。</p>

<p>将Nokia中的时间转换到SMS Backup&amp;Restore的时间可以使用下面的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DateFormat dt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
</span><span class='line'>long value = 1355296332000L;    // 2012-12-12 12:12:12
</span><span class='line'>Element e = (Element)iter.next();
</span><span class='line'>Attribute attr = e.attribute("DateTime");
</span><span class='line'>try {
</span><span class='line'>    value = dt.parse(attr.getValue()).getTime();
</span><span class='line'>} catch (ParseException ex) {
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>

<p>完整的代码如下（使用dom4j实现XML解析）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.io.File;
</span><span class='line'>import java.io.FileWriter;
</span><span class='line'>import java.io.IOException;
</span><span class='line'>import java.text.DateFormat;
</span><span class='line'>import java.text.ParseException;
</span><span class='line'>import java.text.SimpleDateFormat;
</span><span class='line'>import java.util.Iterator;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import org.dom4j.Attribute;
</span><span class='line'>import org.dom4j.Document;
</span><span class='line'>import org.dom4j.DocumentException;
</span><span class='line'>import org.dom4j.DocumentHelper;
</span><span class='line'>import org.dom4j.Element;
</span><span class='line'>import org.dom4j.Node;
</span><span class='line'>import org.dom4j.io.SAXReader;
</span><span class='line'>import org.dom4j.io.XMLWriter;
</span><span class='line'>
</span><span class='line'>public class Main {
</span><span class='line'>
</span><span class='line'>    public static void main(String[] args) {
</span><span class='line'>        try {
</span><span class='line'>            SAXReader sr = new SAXReader();
</span><span class='line'>            Document doc = sr.read(new File(args[0]));
</span><span class='line'>
</span><span class='line'>            generateDocument(doc);
</span><span class='line'>        } catch (DocumentException e) {
</span><span class='line'>            e.printStackTrace();
</span><span class='line'>        } catch (IOException e) {
</span><span class='line'>            e.printStackTrace();
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private static void generateDocument(Document doc) {
</span><span class='line'>        List list = doc.selectNodes("//Message");
</span><span class='line'>
</span><span class='line'>        Document document = DocumentHelper.createDocument();
</span><span class='line'>        Element smses = document.addElement("smses");
</span><span class='line'>        smses.addAttribute("count", String.valueOf(list.size()));
</span><span class='line'>
</span><span class='line'>        DateFormat dt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
</span><span class='line'>        long value = 1355296332000L;    // 2012-12-12 12:12:12
</span><span class='line'>        Iterator iter = list.iterator();
</span><span class='line'>        while (iter.hasNext()) {
</span><span class='line'>            Element e = (Element)iter.next();
</span><span class='line'>            Attribute attr = e.attribute("DateTime");
</span><span class='line'>            try {
</span><span class='line'>                value = dt.parse(attr.getValue()).getTime();
</span><span class='line'>            } catch (ParseException e) {
</span><span class='line'>                System.out.println(e.getMessage());
</span><span class='line'>            }
</span><span class='line'>            Node phone = e.selectSingleNode("PhoneNumber");
</span><span class='line'>            Node location = e.selectSingleNode("Location");
</span><span class='line'>            Node text = e.selectSingleNode("Text");
</span><span class='line'>
</span><span class='line'>            Element sms = smses.addElement("sms");
</span><span class='line'>            sms.addAttribute("protocol", "0");
</span><span class='line'>            sms.addAttribute("address", phone.getText());
</span><span class='line'>            sms.addAttribute("date", String.valueOf(value));
</span><span class='line'>            if ("Inbox".equals(location.getText())) {
</span><span class='line'>                sms.addAttribute("type", "1");
</span><span class='line'>            } else if ("Outbox".equals(location.getText())) {
</span><span class='line'>                sms.addAttribute("type", "2");
</span><span class='line'>            }
</span><span class='line'>            sms.addAttribute("subject", "null");
</span><span class='line'>            sms.addAttribute("body", text.getText());
</span><span class='line'>            sms.addAttribute("toa", "null");
</span><span class='line'>            sms.addAttribute("sc_toa", "null");
</span><span class='line'>            sms.addAttribute("service_center", "null");
</span><span class='line'>            sms.addAttribute("read", "1");
</span><span class='line'>            sms.addAttribute("status", "-1");
</span><span class='line'>            sms.addAttribute("locked", "0");
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        File f = new File("output.xml");
</span><span class='line'>        XMLWriter output = new XMLWriter(new FileWriter(f));
</span><span class='line'>        output.write(document);
</span><span class='line'>        output.close();
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>

<p>代码下载：<a href="https://github.com/dohkoos/N6670Conv">https://github.com/dohkoos/N6670Conv</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-to-obtain-install-time-and-space-of-installed-apps/">如何获得已安装应用的安装时间和占用空间</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-18T01:59:11+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>1:59 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>可以通过ApplicationInfo类中sourceDir取得应用的文件路径，再使用File类读取文件的相关属性实现。不过这可能导致:</p>

<ol>
<li>无法获取原始的创建时间，可能很早就被创建了，之后被替换了；</li>
<li>如果这个应用在一个私有的位置，比如app-private目录（使用Market付费购买的应用在这个位置），没有ROOT权限的手机会导致读取失败。</li>
</ol>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);
</span><span class='line'>for (int i = 0; i &lt; pkgs.size(); i++) {
</span><span class='line'>    PackageInfo pkg = pkgs.get(i);
</span><span class='line'>
</span><span class='line'>    File file = new File(pkg.applicationInfo.sourceDir);
</span><span class='line'>    System.out.println("file size: " + file.length());
</span><span class='line'>    System.out.println("file last modified: " + file.lastModified());
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>

<p>不过File类中文件大小和文件最后修改时间的值是long型，不是用户友好的，在显示前需要格式化一下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>String size = Formatter.formatFileSize(context, file.length())
</span><span class='line'>
</span><span class='line'>Date date = new Date(file.lastModified())
</span><span class='line'>String lastModified = new SimpleDateFormat("yyyy-MM-dd").format(date)
</span><span class='line'>
</span><span class='line'>System.out.println("file size: " + size);
</span><span class='line'>System.out.println("file last modified: " + lastModified);
</span></code></pre></td></tr></table></div></figure>

<p>从Android 2.3 API Level为9开始，ApplicationInfo类新增了firstInstallTime和lastUpdateTime两个字段，可以直接获取应用的创建和最后修改时间，即使是付费软件也能正常获取。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/adding-uninstall-button-to-the-listview/">给ListView添加卸载功能的Button</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-06T01:25:43+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>1:25 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>修改main.xml，添加Button控件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:orientation="vertical"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;ListView
</span><span class='line'>            android:id="@+id/list_view"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"&gt;
</span><span class='line'>        &lt;Button
</span><span class='line'>            android:id="@+id/uninstall_button"
</span><span class='line'>            android:text="Uninstall Selected Apps"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/LinearLayout&gt;
</span></code></pre></td></tr></table></div></figure>

<p>然后在MainActivity类中添加卸载应用的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private UninstallReceiver mUninstallReceiver;
</span><span class='line'>
</span><span class='line'>@Override
</span><span class='line'>public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>  Button btn = (Button)findViewById(R.id.uninstall_button);
</span><span class='line'>  btn.setOnClickListener(new OnClickListener() {
</span><span class='line'>      @Override
</span><span class='line'>      public void onClick(View v) {
</span><span class='line'>          for (int i = 0; i &lt; mListData.size(); i++) {
</span><span class='line'>              HashMap&lt;String, Object&gt; map = mListData.get(i);
</span><span class='line'>              boolean isSelected = (Boolean)map.get("app_select");
</span><span class='line'>              if (isSelected) {
</span><span class='line'>                  Uri packageUri = Uri.parse("package:" + map.get("app_package"));
</span><span class='line'>                  Intent intent = new Intent(Intent.ACTION_DELETE, packageUri);
</span><span class='line'>                  startActivity(intent);
</span><span class='line'>              }
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>  });
</span><span class='line'>
</span><span class='line'>    // 监听卸载广播
</span><span class='line'>  mUninstallReceiver = new UninstallReceiver();
</span><span class='line'>  IntentFilter filter = new IntentFilter(Intent.ACTION_PACKAGE_REMOVED);
</span><span class='line'>  filter.addDataScheme("package");
</span><span class='line'>  registerReceiver(mUninstallReceiver, filter);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// 有时选择移除的程序在确认时被取消了，因此要用BroadcastReceiver监听应用是否被真正地卸载
</span><span class='line'>private class UninstallReceiver extends BroadcastReceiver {
</span><span class='line'>  @Override
</span><span class='line'>  public void onReceive(Context ctx, Intent intent) {
</span><span class='line'>      Log.d("UninstallReceiver.onReceive()", intent.getDataString());
</span><span class='line'>
</span><span class='line'>      for (int i = 0; i &lt; mListData.size(); i++) {
</span><span class='line'>          HashMap&lt;String, Object&gt; map = mListData.get(i);
</span><span class='line'>          String packageUri = "package:" + map.get("app_package");
</span><span class='line'>          if (packageUri.equals(intent.getDataString())) {
</span><span class='line'>              mListData.remove(map);
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>      mHandler.sendEmptyMessage(0);
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@Override
</span><span class='line'>public void onDestroy() {
</span><span class='line'>  super.onDestroy();
</span><span class='line'>  unregisterReceiver(mUninstallReceiver);
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/adding-checkbox-to-the-listview/">向ListView中添加CheckBox</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-03T06:30:01+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2011</span></span> <span class='time'>6:30 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>修改list_item.xml文件，添加CheckBox控件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ImageView
</span><span class='line'>        android:id="@+id/app_icon"
</span><span class='line'>        android:layout_gravity="center_vertical"
</span><span class='line'>        android:layout_width="32.0dip"
</span><span class='line'>        android:layout_height="32.0dip"
</span><span class='line'>        android:layout_marginLeft="3.0dip"
</span><span class='line'>        android:layout_marginRight="3.0dip" /&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_title"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="16.0dip"
</span><span class='line'>            android:textStyle="bold" /&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_package"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="13.0dip" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>    &lt;CheckBox
</span><span class='line'>        android:id="@+id/app_select"
</span><span class='line'>        android:layout_width="wrap_content"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:focusable="false"
</span><span class='line'>        android:focusableInTouchMode="false"
</span><span class='line'>        android:clickable="false"
</span><span class='line'>        android:checkMark="?android:attr/listChoiceIndicatorMultiple" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;
</span></code></pre></td></tr></table></div></figure>

<p>这三行代码很重要，如果不加会出现一些奇怪的错误。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>android:focusable="false"
</span><span class='line'>android:focusableInTouchMode="false"
</span><span class='line'>android:clickable="false"
</span></code></pre></td></tr></table></div></figure>

<p>加入CheckBox后，在程序运行过程中会发现整个ListView无法响应onItemClick、onItemLongClick或onCreateContextMenu事件。原因在于CheckBox是拥有焦点的，它的优先级比ListItem的焦点优先级更高，于是ListItem的点击事件被屏蔽了。解决方法是让CheckBox不能获得焦点。android:focusable=&quot;false&quot;就是做这个的。</p>

<p>修改整个SimpleIconAdapter类为以下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class SimpleIconAdapter extends BaseAdapter {
</span><span class='line'>    private LayoutInflater mInflater;
</span><span class='line'>    private List&lt;? extends Map&lt;String, ?&gt;&gt; mData;
</span><span class='line'>
</span><span class='line'>    public SimpleIconAdapter(Context context, List&lt;? extends Map&lt;String, ?&gt;&gt; data) {
</span><span class='line'>        mInflater = LayoutInflater.from(context);
</span><span class='line'>        mData = data;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public int getCount() {
</span><span class='line'>        return mData.size();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public Object getItem(int position) {
</span><span class='line'>        return mData.get(position);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public long getItemId(int position) {
</span><span class='line'>        return position;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @SuppressWarnings({ "rawtypes", "unchecked" })
</span><span class='line'>    @Override
</span><span class='line'>    public View getView(int position, View convertView, ViewGroup parent) {
</span><span class='line'>        View view;
</span><span class='line'>        if (convertView != null) {
</span><span class='line'>            view = convertView;
</span><span class='line'>        } else {
</span><span class='line'>            view = mInflater.inflate(R.layout.list_item, parent, false);
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        Map map = (Map)getItem(position);
</span><span class='line'>        TextView tv = (TextView)view.findViewById(R.id.app_title);
</span><span class='line'>        tv.setText((String)map.get("app_title"));
</span><span class='line'>
</span><span class='line'>        tv = (TextView)view.findViewById(R.id.app_package);
</span><span class='line'>        tv.setText((String)map.get("app_package"));
</span><span class='line'>
</span><span class='line'>        ImageView iv = (ImageView)view.findViewById(R.id.app_icon);
</span><span class='line'>        iv.setImageDrawable((Drawable)map.get("app_icon"));
</span><span class='line'>
</span><span class='line'>        CheckBox cb = (CheckBox)view.findViewById(R.id.app_select);
</span><span class='line'>        if ((Boolean)map.get("app_select") ==  null) {
</span><span class='line'>            map.put("app_select", false);
</span><span class='line'>        }
</span><span class='line'>        cb.setChecked((Boolean)map.get("app_select"));
</span><span class='line'>
</span><span class='line'>        return view;
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>

<p>再就是修改MainActivity类的onCreate()方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Override
</span><span class='line'>public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>    super.onCreate(savedInstanceState);
</span><span class='line'>    setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>    mListView = (ListView)findViewById(R.id.list_view);
</span><span class='line'>    mListData = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>    mAdapter = new SimpleIconAdapter(this, mListData);
</span><span class='line'>    mListView.setAdapter(mAdapter);
</span><span class='line'>    mListView.setItemsCanFocus(false);
</span><span class='line'>    mListView.setChoiceMode(ListView.CHOICE_MODE_MULTIPLE);
</span><span class='line'>    mListView.setOnItemClickListener(new OnItemClickListener() {
</span><span class='line'>        @SuppressWarnings({ "unchecked", "rawtypes" })
</span><span class='line'>        @Override
</span><span class='line'>        public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
</span><span class='line'>            // 这里如此处理是因为当选中CheckBox，滚动ListView的时候，会出现一些
</span><span class='line'>            // CheckBox选择错位的现象，所以在选择CheckBox时，记下其状态，然后在
</span><span class='line'>            // getView方法中进行设置。
</span><span class='line'>            //
</span><span class='line'>            // 原因：
</span><span class='line'>            // ListView中的getChildCount()并不总是等于Adapter中的数据行数。当手
</span><span class='line'>            // 机一屏显示不了所有数据时（需要翻页），getChildCount()就等于一屏
</span><span class='line'>            // 所显示的行数（一般为10），小于Adapter中的数据行数。而ListView的
</span><span class='line'>            // getCount()与Adapter中的数据行数相等。
</span><span class='line'>            // 当光标下移到屏幕最底部，新显示出来的View，在调用Adapter的getView
</span><span class='line'>            // 方法中，会判断convertView为null，而再有新的View显示就会发现
</span><span class='line'>            // convertView不为空，所以新显示的View其实使用了之前某个View的对象。
</span><span class='line'>            // 这就造成了状态可能混乱。比如第一行的CheckBox点选时，第11行的也同
</span><span class='line'>            // 时会被点选。
</span><span class='line'>            CheckBox cb = (CheckBox)view.findViewById(R.id.app_select);
</span><span class='line'>            cb.toggle();
</span><span class='line'>            ((Map)mListData.get(position)).put("app_select", cb.isChecked());
</span><span class='line'>        }
</span><span class='line'>    });
</span><span class='line'>
</span><span class='line'>    mProgressDialog = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>    new Thread() {
</span><span class='line'>        @Override
</span><span class='line'>        public void run() {
</span><span class='line'>            mListData.addAll(getInstalledApps(false));
</span><span class='line'>            mHandler.sendEmptyMessage(0);
</span><span class='line'>        }
</span><span class='line'>    }.start();
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/implement-listview-with-icon-improved/">实现带Icon的ListView（改进版）</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-02T10:47:58+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2011</span></span> <span class='time'>10:47 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>带Icon的ListView工作起来还不错，但是如果手机里安装的软件比较多的话就有问题了。在程序启动时会黑屏一段时间，就好像程序挂起了一样。所以这时需要显示一个对话框，告诉用户正在加载数据，最好还能准确告诉用户加载的进度。</p>

<p>显示对话框用ProgressDialog，它有两种样式：HORIZONTAL和SPINNER。这里暂时选择SPINNER，等以后有机会再改成HORIZONTAL。</p>

<p>我们在加载数据前显示ProgressDialog，在之后关闭对话框。示例代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ProgressDialog pd = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>
</span><span class='line'>ListView lv = (ListView)findViewById(R.id.list_view);
</span><span class='line'>adapter = new SimpleIconAdapter(this,
</span><span class='line'>        getInstalledApps(false),
</span><span class='line'>        R.layout.list_item,
</span><span class='line'>        new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>        new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>lv.setAdapter(adapter);
</span><span class='line'>
</span><span class='line'>pd.dismiss();
</span></code></pre></td></tr></table></div></figure>

<p>但结果ProgressDialog没有显示出来，因为加载数据的代码也执行在UI线程中，所以对话框的显示被阻塞了。怎么办呢？可以试着创建一个新线程，然后把加载数据这个耗时的操作放到这个非UI线程中去执行，这样不就可以了么：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ProgressDialog pd = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>
</span><span class='line'>new Thread() {
</span><span class='line'>    @Override
</span><span class='line'>    public void run() {
</span><span class='line'>        ListView lv = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        adapter = new SimpleIconAdapter(Main.this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>                new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>        lv.setAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>}.start();
</span><span class='line'>
</span><span class='line'>pd.dismiss();
</span></code></pre></td></tr></table></div></figure>

<p>这下更惨了，直接报Runtime异常，连界面都打不开了。</p>

<p>深入研究一下Android的线程模型，看看Android到底是怎么处理UI线程和其它线程的交互的，为什么上面的代码会报异常?</p>

<blockquote>
<p>When an application is launched, the system creates a thread called &quot;main&quot; for the application. The main thread, also called the UI thread, is very important because it is in charge of dispatching the events to the appropriate widgets, including drawing events. It is also the thread where your application interacts with running components of the Android UI toolkit.</p>

<p>For instance, if you touch the a button on screen, the UI thread dispatches the touch event to the widget, which in turn sets its pressed state and posts an invalidate request to the event queue. The UI thread dequeues the request and notifies the widget to redraw itself.</p>

<p>This single-thread model can yield poor performance unless your application is implemented properly. Specifically, if everything is happening in a single thread, performing long operations such as network access or database queries on the UI thread will block the whole user interface. No event can be dispatched, including drawing events, while the long operation is underway. From the user&#39;s perspective, the application appears hung. Even worse, if the UI thread is blocked for more than a few seconds (about 5 seconds currently) the user is presented with the infamous &quot;application not responding&quot; (ANR) dialog.</p>
</blockquote>

<p>看了上面这段话可以知道为啥程序一打开就黑屏，像挂掉了一样。</p>

<p>那为什么用新建线程来执行耗时操作的代码也有问题呢？这是因为它虽然没有阻塞UI线程，但它违背了单线程模型，Android的UI操作并不是线程安全的，并且这些操作必须在UI线程中执行。在这段代码片段中，在另一个线程中执行数据加载绑定，这会引起一些古怪的问题。</p>

<p>Andriod提供了几种在其它线程中访问UI线程的方法：</p>

<ul>
<li><a href="http://developer.android.com/reference/android/app/Activity.html#runOnUiThread(java.lang.Runnable)">Activity.runOnUiThread(Runnable)</a></li>
<li><a href="http://developer.android.com/reference/android/view/View.html#post(java.lang.Runnable)">View.post(Runnable)</a></li>
<li><a href="http://developer.android.com/reference/android/view/View.html#postDelayed(java.lang.Runnable,%20long)">View.postDelayed(Runnable, long)</a></li>
<li><a href="http://developer.android.com/reference/android/os/Handler.html">Hanlder</a></li>
</ul>

<p>上面的任何一个类或方法都可以修复我们前面代码中遇到的问题，很不幸的是这些类或方法同样会使你的代码变的很复杂很难理解。而且当你需要实现一些很复杂的操作并需要频繁地更新UI时会变得更糟糕。为了解决这个问题，Android 1.5提供了一个工具类AsyncTask，它使创建需要与用户界面交互的长时间运行的任务变得更简单。在Android 1.0和1.1中具有与AsyncTask相同功能的类UserTask，它提供了完全一样的API，你需要做的只是把它的代码拷贝的你的程序中。</p>

<p>其实这些方案背后采用的都是Handler。所以这里仍然使用旧有的，复杂的Handler来修复上述问题。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.apkmgt;
</span><span class='line'>
</span><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.Activity;
</span><span class='line'>import android.app.ProgressDialog;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.graphics.drawable.Drawable;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.os.Handler;
</span><span class='line'>import android.os.Message;
</span><span class='line'>import android.widget.ListView;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends Activity {
</span><span class='line'>    private static final String APP_ICON = "app_icon";
</span><span class='line'>    private static final String APP_TITLE = "app_title";
</span><span class='line'>    private static final String APP_PACKAGE = "app_package";
</span><span class='line'>
</span><span class='line'>    private SimpleIconAdapter adapter;
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; listData;
</span><span class='line'>    private ProgressDialog pd;
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        ListView lv = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        listData = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>        adapter = new SimpleIconAdapter(this,
</span><span class='line'>                listData,
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>                new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>        lv.setAdapter(adapter);
</span><span class='line'>
</span><span class='line'>        pd = ProgressDialog.show(this, "Wait", "loading...");
</span><span class='line'>
</span><span class='line'>        new Thread() {
</span><span class='line'>            @Override
</span><span class='line'>            public void run() {
</span><span class='line'>                // 耗时操作，加载数据
</span><span class='line'>                listData.addAll(getInstalledApps(false));
</span><span class='line'>                handler.sendEmptyMessage(0);
</span><span class='line'>            }
</span><span class='line'>        }.start();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private Handler handler = new Handler() {
</span><span class='line'>        @Override
</span><span class='line'>        public void handleMessage(Message msg) {
</span><span class='line'>            // 通知UI更新。必须要放在这里
</span><span class='line'>            adapter.notifyDataSetChanged();
</span><span class='line'>
</span><span class='line'>            pd.dismiss();
</span><span class='line'>        }
</span><span class='line'>    };
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/no-such-file-to-load-xxx-missingsourcefile-on-heroku/">no such file to load -- xxx (MissingSourceFile) on Heroku</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-28T15:08:16+00:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>3:08 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>终于解决掉了困扰我多日的一个问题。</p>

<p>部署在Heroku上的项目，在controller中require某个文件时总是出现no such file to load -- calc (MissingSourceFile)。</p>

<p>本地机器上运行的好好的，在Heroku上就出现Application error，百思不得其解，网上也没有找到类似问题的解决方法。</p>

<p>咨询Heroku的技术支持，几封邮件交流下来对方也没有办法（感觉Heroku的技术支持不咋的）。</p>

<p>今天把问题解决掉后再回过头来看，发现这其实是个非常简单的问题，就是Linux和Windows对待文件名大小写的差异。因为在Windows上是不区分大小写的，所以在controller中用require &#39;calc&#39;来引入Calc.rb时是成功的，但是在Linux下就不可以。将文件名Calc.rb改成calc.rb再push到Heroku就把问题解决了。</p>

<p>就这么个问题竟然让我思考了几天，还真是郁闷啊！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/implement-listview-with-icon/">实现带Icon的ListView</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-26T00:26:55+00:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:26 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/uploads/apkmgt-screenshot.png" title="apkmgt-screenshot" ></p>

<p>main.xml不需要修改，还是用原来的那个：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:orientation="vertical"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ListView
</span><span class='line'>        android:id="@+id/list_view"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;
</span></code></pre></td></tr></table></div></figure>

<p>在list_item.xml中添加ImageView控件，设置高度和宽度分别为32dip，这是因为有些应用Icon尺寸比较大的缘故，如果不设置的话有些行就会撑大：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ImageView
</span><span class='line'>        android:id="@+id/app_icon"
</span><span class='line'>        android:layout_gravity="center_vertical"
</span><span class='line'>        android:layout_width="32.0dip"
</span><span class='line'>        android:layout_height="32.0dip"
</span><span class='line'>        android:layout_marginLeft="3.0dip"
</span><span class='line'>        android:layout_marginRight="3.0dip" /&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_title"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="16.0dip"
</span><span class='line'>            android:textStyle="bold" /&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_package"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="13.0dip" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/LinearLayout&gt;
</span></code></pre></td></tr></table></div></figure>

<p>新建SimpleIconAdapter类，继承SimpleAdapter适配器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.apkmgt;
</span><span class='line'>
</span><span class='line'>import java.util.List;
</span><span class='line'>import java.util.Map;
</span><span class='line'>
</span><span class='line'>import android.content.Context;
</span><span class='line'>import android.graphics.drawable.Drawable;
</span><span class='line'>import android.view.View;
</span><span class='line'>import android.view.ViewGroup;
</span><span class='line'>import android.widget.ImageView;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class SimpleIconAdapter extends SimpleAdapter {
</span><span class='line'>
</span><span class='line'>    public SimpleIconAdapter(Context context, List&lt;? extends Map&lt;String, ?&gt;&gt; data,
</span><span class='line'>            int resource, String[] from, int[] to) {
</span><span class='line'>        super(context, data, resource, from, to);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @SuppressWarnings("rawtypes")
</span><span class='line'>    @Override
</span><span class='line'>    public View getView(int position, View convertView, ViewGroup parent) {
</span><span class='line'>        View view = super.getView(position, convertView, parent);
</span><span class='line'>        ImageView iv = (ImageView)view.findViewById(R.id.app_icon);
</span><span class='line'>        iv.setImageDrawable((Drawable)((Map)getItem(position)).get("app_icon"));
</span><span class='line'>        return view;
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>

<p>修改MainActivity文件，更换绑定的适配器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.apkmgt;
</span><span class='line'>
</span><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.Activity;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.graphics.drawable.Drawable;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.widget.ListView;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends Activity {
</span><span class='line'>    private static final String APP_ICON = "app_icon";
</span><span class='line'>    private static final String APP_TITLE = "app_title";
</span><span class='line'>    private static final String APP_PACKAGE = "app_package";
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        ListView listView = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        SimpleAdapter adapter = new SimpleIconAdapter(this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {APP_ICON, APP_TITLE, APP_PACKAGE},
</span><span class='line'>                new int[] {R.id.app_icon, R.id.app_title, R.id.app_package});
</span><span class='line'>        listView.setAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; getInstalledApps(boolean getSysPackages) {
</span><span class='line'>        List&lt;HashMap&lt;String, Object&gt;&gt; listItem = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>
</span><span class='line'>        List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);
</span><span class='line'>        for (int i = 0; i&lt; pkgs.size(); i++) {
</span><span class='line'>            PackageInfo pkg = pkgs.get(i);
</span><span class='line'>            if (!getSysPackages && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) &gt; 0) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>            Drawable icon = pkg.applicationInfo.loadIcon(getPackageManager());
</span><span class='line'>            String label = pkg.applicationInfo.loadLabel(getPackageManager()).toString();
</span><span class='line'>            String version = pkg.versionName;
</span><span class='line'>            String pkgName = pkg.packageName;
</span><span class='line'>
</span><span class='line'>            HashMap&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
</span><span class='line'>            map.put(APP_ICON, icon);
</span><span class='line'>            map.put(APP_TITLE, label + " " + version);
</span><span class='line'>            map.put(APP_PACKAGE, pkgName);
</span><span class='line'>            listItem.add(map);
</span><span class='line'>        }
</span><span class='line'>        return listItem;
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/implement-listview-without-listactivity/">不使用ListActivity实现ListView</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-25T13:29:57+00:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>1:29 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>main.xml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:orientation="vertical"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ListView
</span><span class='line'>        android:id="@+id/list_view"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;
</span></code></pre></td></tr></table></div></figure>

<p>list_item.xml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_title"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content"
</span><span class='line'>            android:textSize="16dip" /&gt;
</span><span class='line'>        &lt;TextView
</span><span class='line'>            android:id="@+id/app_package"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/LinearLayout&gt;
</span></code></pre></td></tr></table></div></figure>

<p>创建一个继承自Activitiy的类，重写onCreate方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.apkmgt;
</span><span class='line'>
</span><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.Activity;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.widget.ListView;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends Activity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        ListView listView = (ListView)findViewById(R.id.list_view);
</span><span class='line'>        SimpleAdapter adapter = new SimpleAdapter(this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.list_item,
</span><span class='line'>                new String[] {"app_title", "app_package"},
</span><span class='line'>                new int[] {R.id.app_title, R.id.app_package});
</span><span class='line'>        listView.setAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; getInstalledApps(boolean getSysPackages) {
</span><span class='line'>        List&lt;HashMap&lt;String, Object&gt;&gt; listItem = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>
</span><span class='line'>        List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);
</span><span class='line'>        for (int i = 0; i&lt; pkgs.size(); i++) {
</span><span class='line'>            PackageInfo pkg = pkgs.get(i);
</span><span class='line'>            if (!getSysPackages && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) &gt; 0) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>            String label = pkg.applicationInfo.loadLabel(getPackageManager()).toString();
</span><span class='line'>            String version = pkg.versionName;
</span><span class='line'>            String pkgName = pkg.packageName;
</span><span class='line'>
</span><span class='line'>            HashMap&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
</span><span class='line'>            map.put("app_title", label + " " + version);
</span><span class='line'>            map.put("app_package", pkgName);
</span><span class='line'>            listItem.add(map);
</span><span class='line'>        }
</span><span class='line'>        return listItem;
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>

<p>至此，一个不使用ListActivity的ListView就完成了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/display-name-and-package-of-installed-apps-in-listview/">在ListView中显示已安装应用的名字和包名</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-17T23:02:47+00:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>11:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>通过PackageManager获取手机中已安装应用的信息，具体代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PackageManager packageManager = this.getPackageManager();
</span><span class='line'>List&lt;PackageInfo&gt; packageInfoList = packageManager.getInstalledPackages(0);
</span></code></pre></td></tr></table></div></figure>

<p>通过以上方法，可以得到所有已安装的应用程序，既包括了手动安装的应用程序的信息，也包括了系统预装的应用程序的信息。要区分这两类应用可使用以下方法:</p>

<ol>
<li>从packageInfoList获取的packageInfo，再通过packageInfo.applicationInfo获取applicationInfo；</li>
<li>判断applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM的值，该值大于0时，表示获取的应用为系统预装的应用，反之则为手动安装的应用。</li>
</ol>

<p>列表的显示需要三个元素：</p>

<ol>
<li>用来显示数据的ListView;</li>
<li>需要显示的数据;</li>
<li>绑定数据和ListView的Adapter。</li>
</ol>

<p>Adapter通常有ArrayAdapter、SimpleAdapter和CursorAdapter等。其中SimpleAdapter有最好的扩充性，可以自定义出各种效果。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SimpleAdapter(Context context, List&lt;? extends Map&lt;String, ?&gt;&gt; data, int resource, String[] from, int[] to)
</span></code></pre></td></tr></table></div></figure>

<p>参数解释：</p>

<ol>
<li>context：上下文；</li>
<li>data：数据列表。列表里的每一项都是一个Map<String, ?>对象，都和ListView里的一项进行数据绑定；</li>
<li>resource：布局资源。可以引用系统提供的，也可以自定义；</li>
<li>from：名字数组。每个名字都是用来索引数据列表中每个Map<String, Object>里的Object；</li>
<li>to：资源索引数组，以R.id.xxx的形式表示。</li>
</ol>

<p>main.xml布局代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:orientation="vertical"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;TextView
</span><span class='line'>        android:id="@+id/app_title"
</span><span class='line'>        android:layout_width="wrap_content"
</span><span class='line'>        android:layout_height="wrap_content"
</span><span class='line'>        android:textSize="22px" /&gt;
</span><span class='line'>    &lt;TextView
</span><span class='line'>        android:id="@+id/app_package"
</span><span class='line'>        android:layout_width="wrap_content"
</span><span class='line'>        android:layout_height="wrap_content" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;
</span></code></pre></td></tr></table></div></figure>

<p>上面代码中的android:orientation=&quot;vertical&quot;很重要，没有它两个TextView就不会显示成两行。</p>

<p>继承了ListActivity的MainActivity代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.apkmgt;
</span><span class='line'>
</span><span class='line'>import java.util.ArrayList;
</span><span class='line'>import java.util.HashMap;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import android.app.ListActivity;
</span><span class='line'>import android.content.pm.ApplicationInfo;
</span><span class='line'>import android.content.pm.PackageInfo;
</span><span class='line'>import android.os.Bundle;
</span><span class='line'>import android.widget.SimpleAdapter;
</span><span class='line'>
</span><span class='line'>public class MainActivity extends ListActivity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>
</span><span class='line'>        SimpleAdapter adapter = new SimpleAdapter(this,
</span><span class='line'>                getInstalledApps(false),
</span><span class='line'>                R.layout.main,
</span><span class='line'>                new String[] {"app_title", "app_package"},
</span><span class='line'>                new int[] {R.id.app_title, R.id.app_package});
</span><span class='line'>        setListAdapter(adapter);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private List&lt;HashMap&lt;String, Object&gt;&gt; getInstalledApps(boolean getSysPackages) {
</span><span class='line'>        List&lt;HashMap&lt;String, Object&gt;&gt; list = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();
</span><span class='line'>
</span><span class='line'>        List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);
</span><span class='line'>        for (int i = 0; i&lt; pkgs.size(); i++) {
</span><span class='line'>            PackageInfo pkg = pkgs.get(i);
</span><span class='line'>            if (!getSysPackages && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) &gt; 0) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>            String label = pkg.applicationInfo.loadLabel(getPackageManager()).toString();
</span><span class='line'>            String version = pkg.versionName;
</span><span class='line'>            String pkgName = pkg.packageName;
</span><span class='line'>
</span><span class='line'>            HashMap&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
</span><span class='line'>            map.put("app_title", label + " " + version);
</span><span class='line'>            map.put("app_package", pkgName);
</span><span class='line'>            list.add(map);
</span><span class='line'>        }
</span><span class='line'>        return list;
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/9">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/7">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/ruby-debugger-overview/">Ruby调试工具概览</a>
      </li>
    
      <li class="post">
        <a href="/blog/how-to-detect-java-memory-leak-using-visualvm/">如何使用VisualVM检测Java内存泄漏</a>
      </li>
    
      <li class="post">
        <a href="/blog/fighting-perfection/">对抗完美</a>
      </li>
    
      <li class="post">
        <a href="/blog/elasticsearch-restful-api/">Elasticsearch的RESTful API</a>
      </li>
    
      <li class="post">
        <a href="/blog/elasticsearch-installation/">Elasticsearch安装</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://codemany.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 93%" href="/tags/antlr/">ANTLR</a>
<a style="font-size: 97%" href="/tags/algorithm/">Algorithm</a>
<a style="font-size: 134%" href="/tags/android/">Android</a>
<a style="font-size: 93%" href="/tags/ant/">Ant</a>
<a style="font-size: 111%" href="/tags/crack/">Crack</a>
<a style="font-size: 108%" href="/tags/database/">Database</a>
<a style="font-size: 97%" href="/tags/eclipse/">Eclipse</a>
<a style="font-size: 105%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 142%" href="/tags/java/">Java</a>
<a style="font-size: 93%" href="/tags/javascript/">JavaScript</a>
<a style="font-size: 97%" href="/tags/listview/">ListView</a>
<a style="font-size: 93%" href="/tags/misc/">Misc</a>
<a style="font-size: 105%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 87%" href="/tags/osdev/">OSDev</a>
<a style="font-size: 97%" href="/tags/paperclip/">Paperclip</a>
<a style="font-size: 116%" href="/tags/powerbuilder/">PowerBuilder</a>
<a style="font-size: 93%" href="/tags/powerscript/">PowerScript</a>
<a style="font-size: 118%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 111%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 93%" href="/tags/spring/">Spring</a>
<a style="font-size: 101%" href="/tags/struts/">Struts</a>
<a style="font-size: 105%" href="/tags/translation/">Translation</a>
<a style="font-size: 97%" href="/tags/ubuntu/">Ubuntu</a>
<a style="font-size: 87%" href="/tags/w32dasm/">W32Dasm</a>
<a style="font-size: 108%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 108%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://quake.iteye.com/">写程序的70后</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dohkoos">@dohkoos</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dohkoos',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemany';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
