
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="这次破解的版本是0.8.011.4。 中国游戏中心退出时弹出的IE窗口很烦人，决定做个补丁把它去除掉。 省略无数次尝试……确定退出中国游戏中心后打开的网页地址是 http://www.chinagames.net/PlazaJump/open 。用W32Dasm反汇编iGame.exe， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/posts/24/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46570161-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="codemany.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/remove-popup-ie-window-at-china-games-exit/">去除退出中国游戏中心时弹出的IE窗口</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-11-02T23:23:57+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2005</span></span> <span class='time'>11:23 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这次破解的版本是0.8.011.4。</p>

<p>中国游戏中心退出时弹出的IE窗口很烦人，决定做个补丁把它去除掉。</p>

<p>省略无数次尝试……确定退出中国游戏中心后打开的网页地址是 <a href="http://www.chinagames.net/PlazaJump/open">http://www.chinagames.net/PlazaJump/open</a> 。用W32Dasm反汇编iGame.exe，通过String Data References找到网址字符串，双击该字符串，看到以下程序：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:0043397A 90                nop
</span><span class='line'>:0043397B 90                nop
</span><span class='line'>:0043397C 90                nop
</span><span class='line'>:0043397D 90                nop
</span><span class='line'>:0043397E 90                nop
</span><span class='line'>:0043397F 90                nop
</span><span class='line'>:00433980 A1A2034800        mov eax, dword ptr [004803A2]
</span><span class='line'>:00433985 56                push esi
</span><span class='line'>:00433986 85C0              test eax, eax
</span><span class='line'>:00433988 8BF1              mov esi, ecx
</span><span class='line'>:0043398A 7411              je 0043399D               -&gt; 判断是否要打开IE窗口
</span><span class='line'>:0043398C 6A00              push 00000000
</span><span class='line'>
</span><span class='line'>* Possible StringData Ref from Data Obj -&gt;"http://www.chinagames.net/PlazaJump/open/"
</span><span class='line'>|
</span><span class='line'>:0043398E 6860D84700        push 0047D860
</span><span class='line'>:00433993 B9D0FC4700        mov ecx, 0047FCD0
</span><span class='line'>:00433998 E8B3D2FFFF        call 00430C50             -&gt; 打开IE窗口
</span><span class='line'>
</span><span class='line'>* Referenced by a (U)nconditional or (C)onditional Jump at Address:
</span><span class='line'>|:0043398A(C)
</span><span class='line'>|
</span><span class='line'>:0043399D 8BCE              mov ecx, esi</span></code></pre></td></tr></table></div></figure>

<p>从上面可以知道，只要将0043398A处的je指令改成jmp指令就可以避免退出时弹出的IE窗口了。</p>

<p>现在使用CodeFusion来制作一个文件补丁。它有三种制作补丁的方案，这里使用Find&amp;Replace方法。将0043397A到00433998段的数据作为查找匹配数据，并将0043398A处的74（je指令）改成eb（jmp指令），然后按照步骤生成补丁文件就可以了。</p>

<p>2008/3/19更新</p>

<p>应ls的要求制作了一个针对最新版本（0.8.011.10）的补丁，和原来的补丁放在一起提供下载。</p>

<p><a href="/uploads/chinagames-patch.zip" title="chinagames-patch.zip">补丁文件</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/webwork-and-spring-integration-step-by-step/">一步一步整合WebWork和Spring</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-09-26T10:50:27+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2005</span></span> <span class='time'>10:50 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>拷贝webwork-2.1.7.jar、spring-1.2.1.jar以及webwork2-srping.jar到WEB-INF/lib目录下。</p>

<p>添加以下内容到web.xml文件中：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;listener&gt;
</span><span class='line'>    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
</span><span class='line'>&lt;/listener&gt;
</span><span class='line'>
</span><span class='line'>&lt;listener&gt;
</span><span class='line'>    &lt;listener-class&gt;com.atlassian.xwork.ext.ResolverSetupServletContextListener&lt;/listener-class&gt;
</span><span class='line'>&lt;/listener&gt;</span></code></pre></td></tr></table></div></figure>

<p>applicationContext.xml中的内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;beans&gt;
</span><span class='line'>    &lt;bean id="dataSource" class="org.springframework.jdbc.datasource.SingleConnectionDataSource"&gt;
</span><span class='line'>        &lt;property name="driverClassName" value="${driver}" /&gt;
</span><span class='line'>        &lt;property name="url" value="${url}" /&gt;
</span><span class='line'>        &lt;property name="username" value="${username}" /&gt;
</span><span class='line'>        &lt;property name="password" value="${password}" /&gt;
</span><span class='line'>    &lt;/bean&gt;
</span><span class='line'>
</span><span class='line'>    &lt;bean id="sqlMapClient" class="org.springframework.orm.ibatis.SqlMapClientFactoryBean"&gt;
</span><span class='line'>        &lt;property name="configLocation" value="/WEB-INF/sql-map-config.xml" /&gt;
</span><span class='line'>        &lt;property name="dataSource" ref="dataSource" /&gt;
</span><span class='line'>    &lt;/bean&gt;
</span><span class='line'>
</span><span class='line'>    &lt;bean id="userManager" class="com.codemany.netlink.service.impl.UserManagerImpl" singleton="true"&gt;
</span><span class='line'>        &lt;property name="sqlMapClient" ref="sqlMapClient" /&gt;
</span><span class='line'>    &lt;/bean&gt;
</span><span class='line'>&lt;/beans&gt;</span></code></pre></td></tr></table></div></figure>

<p>配置文件sql-map-config.xml中的内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;sqlMapConfig&gt;
</span><span class='line'>    &lt;sqlMap resource="com/codemany/netlink/dao/impl/User.xml" /&gt;
</span><span class='line'>&lt;/sqlMapConfig&gt;</span></code></pre></td></tr></table></div></figure>

<p>在xwork.xml中添加以下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;package name="default" extends="webwork-default"
</span><span class='line'>        externalReferenceResolver="com.atlassian.xwork.ext.SpringServletContextReferenceResolver"&gt;
</span><span class='line'>
</span><span class='line'>    &lt;interceptors&gt;
</span><span class='line'>        &lt;interceptor name="reference-resolver"
</span><span class='line'>                class="com.opensymphony.xwork.interceptor.ExternalReferencesInterceptor" /&gt;
</span><span class='line'>
</span><span class='line'>        &lt;interceptor-stack name="interceptors"&gt;
</span><span class='line'>            &lt;interceptor-ref name="params" /&gt;
</span><span class='line'>            &lt;interceptor-ref name="reference-resolver" /&gt;
</span><span class='line'>        &lt;/interceptor-stack&gt;
</span><span class='line'>    &lt;/interceptors&gt;
</span><span class='line'>
</span><span class='line'>    &lt;default-interceptor-ref name="default-interceptor" /&gt;
</span><span class='line'>
</span><span class='line'>    &lt;action name="login" class="com.codemany.netlink.action.LoginAction"&gt;
</span><span class='line'>        &lt;external-ref name="userManager"&gt;userManager&lt;/external-ref&gt;
</span><span class='line'>        &lt;result name="success" type="dispatcher"&gt;/success.jsp&lt;/result&gt;
</span><span class='line'>        &lt;result name="error" type="dispatcher"&gt;/error.jsp&lt;/result&gt;
</span><span class='line'>    &lt;/action&gt;
</span><span class='line'>&lt;/package&gt;</span></code></pre></td></tr></table></div></figure>

<p>在LoginAction.java中添加代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private UserManager userManager = null;
</span><span class='line'>
</span><span class='line'>public void setUserManager(UserManager userManager) {
</span><span class='line'>    this.userManager = userManager;</span></code></pre></td></tr></table></div></figure>

<p>建立UserManager.java接口文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public interface UserManager {
</span><span class='line'>    public User login(String username, String password) throws UserLoginException;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>UserManagerImpl.java实现代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class UserManagerImpl extends SqlMapClientDaoSupport implements UserManager {
</span><span class='line'>
</span><span class='line'>    public User login(String username, String password) throws UserLoginException {
</span><span class='line'>        // do something
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/system-io-address-table/">系统I/O地址表</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-09-13T19:00:03+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2005</span></span> <span class='time'>7:00 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>PC机中仅使用A[0]-A[9]地址位来表示I/O地址，即可有1024个地址。前512个供系统电路使用，后512个供扩充插槽使用。当A[9]=0时表示为系统板上的I/O地址；A[9]=1时表示为扩充插槽接口卡上的地址。</p>

<p>系统I/O地址使用情况：</p>

<table><thead>
<tr>
<th style="text-align: center">I/O地址范围</th>
<th>用途</th>
<th style="text-align: center">I/O地址范围</th>
<th>用途</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: center">0000-001F</td>
<td>8237A DMA控制器1</td>
<td style="text-align: center">00E0-00EF</td>
<td></td>
</tr>
<tr>
<td style="text-align: center">0020-003F</td>
<td>8259A中断控制器1</td>
<td style="text-align: center">00F0</td>
<td>重置协处理器总线</td>
</tr>
<tr>
<td style="text-align: center">0040-005F</td>
<td>8253/8254定时/计数器（PIT）</td>
<td style="text-align: center">00F1</td>
<td>设置协处理器总线</td>
</tr>
<tr>
<td style="text-align: center">0060-006F</td>
<td>8042键盘控制器（AT）</td>
<td style="text-align: center">00F2-00F7</td>
<td></td>
</tr>
<tr>
<td style="text-align: center">0070-007F</td>
<td>CMOS RAM与NMI屏蔽寄存器（AT）</td>
<td style="text-align: center">00F8-00FF</td>
<td>协处理器</td>
</tr>
<tr>
<td style="text-align: center">0080-009F</td>
<td>DMA页寄存器</td>
<td style="text-align: center">0100-01EF</td>
<td></td>
</tr>
<tr>
<td style="text-align: center">00A0-00BF</td>
<td>8259A中断控制器2</td>
<td style="text-align: center">01F0-01F7</td>
<td>硬盘</td>
</tr>
<tr>
<td style="text-align: center">00C0-00DF</td>
<td>8237A DMA控制器2</td>
<td style="text-align: center">01F8-01FF</td>
<td></td>
</tr>
</tbody></table>

<p>扩充插槽I/O地址使用情况：</p>

<table><thead>
<tr>
<th style="text-align: center">I/O地址范围</th>
<th>用途</th>
<th style="text-align: center">I/O地址范围</th>
<th>用途</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: center">0200-0207</td>
<td>游戏卡I/O</td>
<td style="text-align: center">0360-036F</td>
<td>保留</td>
</tr>
<tr>
<td style="text-align: center">0208-020F</td>
<td></td>
<td style="text-align: center">0370-0377</td>
<td></td>
</tr>
<tr>
<td style="text-align: center">0210-0217</td>
<td>扩展部件（仅XT用）</td>
<td style="text-align: center">0378-037F</td>
<td>并行口打印机1</td>
</tr>
<tr>
<td style="text-align: center">0218-021F</td>
<td></td>
<td style="text-align: center">0380-038F</td>
<td>SDLC 通信及同步通信1</td>
</tr>
<tr>
<td style="text-align: center">0220-024F</td>
<td>保留</td>
<td style="text-align: center">0390-039F</td>
<td></td>
</tr>
<tr>
<td style="text-align: center">0250-0277</td>
<td></td>
<td style="text-align: center">03A0-03AF</td>
<td>同步通信2</td>
</tr>
<tr>
<td style="text-align: center">0278-027F</td>
<td>并行口打印机2</td>
<td style="text-align: center">03B0-03BF</td>
<td>MDA 单色显示器</td>
</tr>
<tr>
<td style="text-align: center">0280-02EF</td>
<td></td>
<td style="text-align: center">03C0-03CF</td>
<td>保留</td>
</tr>
<tr>
<td style="text-align: center">02F0-02F7</td>
<td>保留</td>
<td style="text-align: center">03D0-03DF</td>
<td>彩色图形适配器</td>
</tr>
<tr>
<td style="text-align: center">02F8-02FF</td>
<td>串行口2</td>
<td style="text-align: center">03E0-03EF</td>
<td></td>
</tr>
<tr>
<td style="text-align: center">0300-031F</td>
<td>试验卡</td>
<td style="text-align: center">03F0-03F7</td>
<td>软盘适配器</td>
</tr>
<tr>
<td style="text-align: center">0320-032F</td>
<td>硬盘适配器</td>
<td style="text-align: center">03F8-03FF</td>
<td>串行口1</td>
</tr>
<tr>
<td style="text-align: center">0330-035F</td>
<td></td>
<td style="text-align: center"></td>
<td></td>
</tr>
</tbody></table>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/posix-conventions-for-command-line-arguments/">POSIX Conventions for Command Line Arguments</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-09-10T00:03:07+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2005</span></span> <span class='time'>12:03 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ol>
<li>An option is a hyphen followed by a single alphanumeric character, like this: -o.</li>
<li>An option may require an argument (which must appear immediately after the option); for example, -oargument or -o argument.</li>
<li>Options that do not require arguments can be grouped after a hyphen, so, for example, -lst is equivalent to -t -l -s.</li>
<li>Options can appear in any order; thus -lst is equivalent to -tls.</li>
<li>Options can appear multiple times.</li>
<li>Options precede other nonoption arguments: -lst nonoption.</li>
<li>The -- argument terminates options.</li>
<li>The - option is typically used to represent one of the standard input streams.</li>
</ol>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-to-write-perfect-equals-method/">如何编写完美的equals方法</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-09-07T17:47:41+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2005</span></span> <span class='time'>5:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Java语言规范要求equals方法具有下面的特点：</p>

<ol>
<li>自反性（reflexive）：对于任意非空引用x，x.equals(x)应返回true；</li>
<li>对称性（symmetric）：对于任意引用x、y，当且仅当y.equals(x)返回true时，x.equals(y)返回true；</li>
<li>传递性（transitive）：对于任意引用x、y、z，如果x.equals(y)返回true，且y.equals(z)也返回true，那么x.equals(z)应返回true；</li>
<li>一致性（consistent）：如果x和y引用的对象没有改变，那么对x.equals(y)的重复调用应返回同一结果；</li>
<li>对任意非空引用x，x.equals(null)应返回false。</li>
</ol>

<p>下面是编写完美equals方法的建议：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 测试this和other是否是同一个对象
</span><span class='line'>if (this == other) return true;
</span><span class='line'>// 测试other是否为null，如果是就返回false
</span><span class='line'>if (other == null) return false;
</span><span class='line'>// 测试this和other是否属于同一个类
</span><span class='line'>if (getClass() != other.getClass()) {
</span><span class='line'>    return false;
</span><span class='line'>}
</span><span class='line'>// 将other对象的类型转换为你的类所属的类型
</span><span class='line'>ClassName obj = (ClassName)other;
</span><span class='line'>// 最后测试需要比较的字段。使用==比较基本类型字段，使用equals比较对象类型字段</span></code></pre></td></tr></table></div></figure>

<p>如果遵循以上的规则定义了一个类的equals方法，定义其子类的equals方法时，首先调用父类的equals方法，如果这项测试能通过，那么再比较子类的字段。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (!super.equals(other)) return false;</span></code></pre></td></tr></table></div></figure>

<p>这里有个问题是如果this和other两个对象不是同一个类，equals方法该如何工作？有些程序员可能会使用instanceof代替getClass()来做判断，但这种方法是错误的，因为它违反了规则2所要求的对称性。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/best-practices-for-exception-handling/">异常处理最佳实践</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-08-12T10:02:48+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2005</span></span> <span class='time'>10:02 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>英文原文：<a href="http://www.onjava.com/pub/a/onjava/2003/11/19/exceptions.html">http://www.onjava.com/pub/a/onjava/2003/11/19/exceptions.html</a></p>

<p>One of the problems with exception handling is knowing when and how to use it. In this article, I will cover some of the best practices for exception handling. I will also summarize the recent debate about the use of checked exceptions.</p>

<p>We as programmers want to write quality code that solves problems. Unfortunately, exceptions come as side effects of our code. No one likes side effects, so we soon find our own ways to get around them. I have seen some smart programmers deal with exceptions the following way:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public void consumeAndForgetAllExceptions(){
</span><span class='line'>    try {
</span><span class='line'>        ...some code that throws exceptions
</span><span class='line'>    } catch (Exception ex){
</span><span class='line'>        ex.printStacktrace();
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>What is wrong with the code above?</p>

<p>Once an exception is thrown, normal program execution is suspended and control is transferred to the catch block. The catch block catches the exception and just suppresses it. Execution of the program continues after the catch block, as if nothing had happened.</p>

<p>How about the following?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public void someMethod() throws Exception{
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>This method is a blank one; it does not have any code in it. How can a blank method throw exceptions? Java does not stop you from doing this. Recently, I came across similar code where the method was declared to throw exceptions, but there was no code that actually generated that exception. When I asked the programmer, he replied &quot;I know, it is corrupting the API, but I am used to doing it and it works.&quot; </p>

<p>It took the C++ community several years to decide on how to use exceptions. This debate has just started in the Java community. I have seen several Java programmers struggle with the use of exceptions. If not used correctly, exceptions can slow down your program, as it takes memory and CPU power to create, throw, and catch exceptions. If overused, they make the code difficult to read and frustrating for the programmers using the API. We all know frustrations lead to hacks and code smells. The client code may circumvent the issue by just ignoring exceptions or throwing them, as in the previous two examples.</p>

<h3 id="the-nature-of-exceptions">The Nature of Exceptions</h3>

<p>Broadly speaking, there are three different situations that cause exceptions to be thrown:</p>

<ul>
<li><strong>Exceptions due to programming errors:</strong> In this category, exceptions are generated due to programming errors (e.g., NullPointerException and IllegalArgumentException). The client code usually cannot do anything about programming errors.</li>
<li><strong>Exceptions due to client code errors:</strong> Client code attempts something not allowed by the API, and thereby violates its contract. The client can take some alternative course of action, if there is useful information provided in the exception. For example: an exception is thrown while parsing an XML document that is not well-formed. The exception contains useful information about the location in the XML document that causes the problem. The client can use this information to take recovery steps.</li>
<li><strong>Exceptions due to resource failures:</strong> Exceptions that get generated when resources fail. For example: the system runs out of memory or a network connection fails. The client&#39;s response to resource failures is context-driven. The client can retry the operation after some time or just log the resource failure and bring the application to a halt.</li>
</ul>

<h3 id="types-of-exceptions-in-java">Types of Exceptions in Java</h3>

<p>Java defines two kinds of exceptions:</p>

<ul>
<li><strong>Checked exceptions:</strong> Exceptions that inherit from the Exception class are checked exceptions. Client code has to handle the checked exceptions thrown by the API, either in a catch clause or by forwarding it outward with the throws clause.</li>
<li><strong>Unchecked exceptions:</strong> RuntimeException also extends from Exception. However, all of the exceptions that inherit from RuntimeException get special treatment. There is no requirement for the client code to deal with them, and hence they are called unchecked exceptions.</li>
</ul>

<p>By way of example, Figure 1 shows the hierarchy for NullPointerException.</p>

<p><img src="/uploads/exception-hierarchy.gif" title="exception-hierarchy" ></p>

<p>Figure 1. Sample exception hierarchy</p>

<p>In this diagram, NullPointerException extends from RuntimeException and hence is an unchecked exception.</p>

<p>I have seen heavy use of checked exceptions and minimal use of unchecked exceptions. Recently, there has been a hot debate in the Java community regarding checked exceptions and their true value. The debate stems from fact that Java seems to be the first mainstream OO language with checked exceptions. C++ and C# do not have checked exceptions at all; all exceptions in these languages are unchecked.</p>

<p>A checked exception thrown by a lower layer is a forced contract on the invoking layer to catch or throw it. The checked exception contract between the API and its client soon changes into an unwanted burden if the client code is unable to deal with the exception effectively. Programmers of the client code may start taking shortcuts by suppressing the exception in an empty catch block or just throwing it and, in effect, placing the burden on the client&#39;s invoker.</p>

<p>Checked exceptions are also accused of breaking encapsulation. Consider the following: </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public List getAllAccounts() throws
</span><span class='line'>    FileNotFoundException, SQLException{
</span><span class='line'>    ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>The method getAllAccounts() throws two checked exceptions. The client of this method has to explicitly deal with the implementation-specific exceptions, even if it has no idea what file or database call has failed within getAllAccounts(), or has no business providing filesystem or database logic. Thus, the exception handling forces an inappropriately tight coupling between the method and its callers. </p>

<h3 id="best-practices-for-designing-the-api">Best Practices for Designing the API</h3>

<p>Having said all of this, let us now talk about how to design an API that throws exceptions properly.</p>

<h4 id="1-when-deciding-on-checked-exceptions-vs-unchecked-exceptions-ask-yourself-quot-what-action-can-the-client-code-take-when-the-exception-occurs-quot">1. When deciding on checked exceptions vs. unchecked exceptions, ask yourself, &quot;What action can the client code take when the exception occurs?&quot;</h4>

<p>If the client can take some alternate action to recover from the exception, make it a checked exception. If the client cannot do anything useful, then make the exception unchecked. By useful, I mean taking steps to recover from the exception and not just logging the exception. To summarize:</p>

<table><thead>
<tr>
<th>Client&#39;s reaction when exception happens</th>
<th>Exception type</th>
</tr>
</thead><tbody>
<tr>
<td>Client code cannot do anything</td>
<td>Make it an unchecked exception</td>
</tr>
<tr>
<td>Client code will take some useful recovery action based on information in exception</td>
<td>Make it a checked exception</td>
</tr>
</tbody></table>

<p>Moreover, prefer unchecked exceptions for all programming errors: unchecked exceptions have the benefit of not forcing the client API to explicitly deal with them. They propagate to where you want to catch them, or they go all the way out and get reported. The Java API has many unchecked exceptions, such as NullPointerException, IllegalArgumentException, and IllegalStateException. I prefer working with standard exceptions provided in Java rather than creating my own. They make my code easy to understand and avoid increasing the memory footprint of code. </p>

<h4 id="2-preserve-encapsulation">2. Preserve encapsulation.</h4>

<p>Never let implementation-specific checked exceptions escalate to the higher layers. For example, do not propagate SQLException from data access code to the business objects layer. Business objects layer do not need to know about SQLException. You have two options:</p>

<ul>
<li>Convert SQLException into another checked exception, if the client code is expected to recuperate from the exception.</li>
<li>Convert SQLException into an unchecked exception, if the client code cannot do anything about it.</li>
</ul>

<p>Most of the time, client code cannot do anything about SQLExceptions. Do not hesitate to convert them into unchecked exceptions. Consider the following piece of code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public void dataAccessCode(){
</span><span class='line'>    try{
</span><span class='line'>        ..some code that throws SQLException
</span><span class='line'>    }catch(SQLException ex){
</span><span class='line'>        ex.printStacktrace();
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>This catch block just suppresses the exception and does nothing. The justification is that there is nothing my client could do about an SQLException. How about dealing with it in the following manner? </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public void dataAccessCode(){
</span><span class='line'>    try{
</span><span class='line'>        ..some code that throws SQLException
</span><span class='line'>    }catch(SQLException ex){
</span><span class='line'>        throw new RuntimeException(ex);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>This converts SQLException to RuntimeException. If SQLException occurs, the catch clause throws a new RuntimeException. The execution thread is suspended and the exception gets reported. However, I am not corrupting my business object layer with unnecessary exception handling, especially since it cannot do anything about an SQLException. If my catch needs the root exception cause, I can make use of the getCause() method available in all exception classes as of JDK1.4.</p>

<p>If you are confident that the business layer can take some recovery action when SQLException occurs, you can convert it into a more meaningful checked exception. But I have found that just throwing RuntimeException suffices most of the time. </p>

<h4 id="3-try-not-to-create-new-custom-exceptions-if-they-do-not-have-useful-information-for-client-code">3. Try not to create new custom exceptions if they do not have useful information for client code.</h4>

<p>What is wrong with following code?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class DuplicateUsernameException extends Exception {}</span></code></pre></td></tr></table></div></figure>

<p>It is not giving any useful information to the client code, other than an indicative exception name. Do not forget that Java Exception classes are like other classes, wherein you can add methods that you think the client code will invoke to get more information.</p>

<p>We could add useful methods to DuplicateUsernameException, such as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class DuplicateUsernameException
</span><span class='line'>    extends Exception {
</span><span class='line'>    public DuplicateUsernameException 
</span><span class='line'>        (String username){....}
</span><span class='line'>    public String requestedUsername(){...}
</span><span class='line'>    public String[] availableNames(){...}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>The new version provides two useful methods: requestedUsername(), which returns the requested name, and availableNames(), which returns an array of available usernames similar to the one requested. The client could use these methods to inform that the requested username is not available and that other usernames are available. But if you are not going to add extra information, then just throw a standard exception:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>throw new Exception("Username already taken");</span></code></pre></td></tr></table></div></figure>

<p>Even better, if you think the client code is not going to take any action other than logging if the username is already taken, throw a unchecked exception:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>throw new RuntimeException("Username already taken");</span></code></pre></td></tr></table></div></figure>

<p>Alternatively, you can even provide a method that checks if the username is already taken.</p>

<p>It is worth repeating that checked exceptions are to be used in situations where the client API can take some productive action based on the information in the exception. Prefer unchecked exceptions for all programmatic errors. They make your code more readable.</p>

<h4 id="4-document-exceptions">4. Document exceptions.</h4>

<p>You can use Javadoc&#39;s @throws tag to document both checked and unchecked exceptions that your API throws. However, I prefer to write unit tests to document exceptions. Tests allow me to see the exceptions in action and hence serve as documentation that can be executed. Whatever you do, have some way by which the client code can learn of the exceptions that your API throws. Here is a sample unit test that tests for IndexOutOfBoundsException:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public void testIndexOutOfBoundsException() {
</span><span class='line'>    ArrayList blankList = new ArrayList();
</span><span class='line'>    try {
</span><span class='line'>        blankList.get(10);
</span><span class='line'>        fail("Should raise an IndexOutOfBoundsException");
</span><span class='line'>    } catch (IndexOutOfBoundsException success) {}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>The code above should throw an IndexOutOfBoundsException when blankList.get(10) is invoked. If it does not, the fail(&quot;Should raise an IndexOutOfBoundsException&quot;) statement explicitly fails the test. By writing unit tests for exceptions, you not only document how the exceptions work, but also make your code robust by testing for exceptional scenarios.</p>

<h3 id="best-practices-for-using-exceptions">Best Practices for Using Exceptions</h3>

<p>The next set of best practices show how the client code should deal with an API that throws checked exceptions.</p>

<h4 id="1-always-clean-up-after-yourself">1. Always clean up after yourself</h4>

<p>If you are using resources like database connections or network connections, make sure you clean them up. If the API you are invoking uses only unchecked exceptions, you should still clean up resources after use, with try - finally blocks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public void dataAccessCode(){
</span><span class='line'>    Connection conn = null;
</span><span class='line'>    try{
</span><span class='line'>        conn = getConnection();
</span><span class='line'>        ..some code that throws SQLException
</span><span class='line'>    }catch(SQLException ex){
</span><span class='line'>        ex.printStacktrace();
</span><span class='line'>    } finally{
</span><span class='line'>        DBUtil.closeConnection(conn);
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>class DBUtil{
</span><span class='line'>    public static void closeConnection
</span><span class='line'>        (Connection conn){
</span><span class='line'>        try{
</span><span class='line'>            conn.close();
</span><span class='line'>        } catch(SQLException ex){
</span><span class='line'>            logger.error("Cannot close connection");
</span><span class='line'>            throw new RuntimeException(ex);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>DBUtil is a utility class that closes the Connection. The important point is the use of finally block, which executes whether or not an exception is caught. In this example, the finally closes the connection and throws a RuntimeException if there is problem with closing the connection.</p>

<h4 id="2-never-use-exceptions-for-flow-control">2. Never use exceptions for flow control</h4>

<p>Generating stack traces is expensive and the value of a stack trace is in debugging. In a flow-control situation, the stack trace would be ignored, since the client just wants to know how to proceed.</p>

<p>In the code below, a custom exception, MaximumCountReachedException, is used to control the flow.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public void useExceptionsForFlowControl() {
</span><span class='line'>    try {
</span><span class='line'>        while (true) {
</span><span class='line'>            increaseCount();
</span><span class='line'>        }
</span><span class='line'>    } catch (MaximumCountReachedException ex) {
</span><span class='line'>    }
</span><span class='line'>    //Continue execution
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>public void increaseCount()
</span><span class='line'>    throws MaximumCountReachedException {
</span><span class='line'>    if (count &gt;= 5000)
</span><span class='line'>        throw new MaximumCountReachedException();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>The useExceptionsForFlowControl() uses an infinite loop to increase the count until the exception is thrown. This not only makes the code difficult to read, but also makes it slower. Use exception handling only in exceptional situations.</p>

<h4 id="3-do-not-suppress-or-ignore-exceptions">3. Do not suppress or ignore exceptions</h4>

<p>When a method from an API throws a checked exception, it is trying to tell you that you should take some counter action. If the checked exception does not make sense to you, do not hesitate to convert it into an unchecked exception and throw it again, but do not ignore it by catching it with {} and then continue as if nothing had happened.</p>

<h4 id="4-do-not-catch-top-level-exceptions">4. Do not catch top-level exceptions</h4>

<p>Unchecked exceptions inherit from the RuntimeException class, which in turn inherits from Exception. By catching the Exception class, you are also catching RuntimeException as in the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>try{
</span><span class='line'>..
</span><span class='line'>}catch(Exception ex){
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>The code above ignores unchecked exceptions, as well.</p>

<h4 id="5-log-exceptions-just-once">5. Log exceptions just once</h4>

<p>Logging the same exception stack trace more than once can confuse the programmer examining the stack trace about the original source of exception. So just log it once. </p>

<h3 id="summary">Summary</h3>

<p>These are some suggestions for exception-handling best practices. I have no intention of staring a religious war on checked exceptions vs. unchecked exceptions. You will have to customize the design and usage according to your requirements. I am confident that over time, we will find better ways to code with exceptions.</p>

<p>I would like to thank Bruce Eckel, Joshua Kerievsky, and Somik Raha for their support in writing this article.</p>

<h3 id="related-resources">Related Resources</h3>

<ul>
<li><a href="http://www.mindview.net/Etc/Discussions/CheckedExceptions">&quot;Does Java need Checked Exceptions?&quot;</a> by Bruce Eckel</li>
<li><a href="http://www.octopull.demon.co.uk/java/ExceptionalJava.html">&quot;Exceptional Java,&quot;</a> by Alan Griffiths</li>
<li><a href="http://www.artima.com/intv/handcuffs.html">&quot;The trouble with checked exceptions: A conversation with Anders Hejlsberg, Part II&quot;</a> on Artima.com</li>
<li><a href="http://www.c2.com/cgi/wiki?CheckedExceptionsAreOfDubiousValue">&quot;Checked exceptions are of dubious value,&quot;</a> on C2.com</li>
<li><a href="http://www.artima.com/intv/solid.html">Conversation with James Gosling</a> by Bill Venners</li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-to-solve-sitemesh-truncate-the-page-containing-chinese-character/">如何解决含有中文的页面末尾内容会被SiteMesh截掉的问题</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-07-22T14:33:59+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2005</span></span> <span class='time'>2:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首先，我们要了解一下ServletResponse.setContentLength(int len)的含义。setContentLength是设置返回内容体长度的方法，len是内容体的长度。由于网络上传输内容是以字节（byte）为单位的，所以len就是指内容体有多少个字节。假设现在有长度为100个字节的数据，在输出数据到客户端前我们用setContentLength(90)设置内容体的长度为90个字节。那么在客户端接收到的数据长度就是90个字节而不是100。下面我们来做个试验：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class PageTruncateFilter implements Filter {
</span><span class='line'>
</span><span class='line'>    public void init(FilterConfig config) throws ServletException {
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
</span><span class='line'>                        throws IOException, ServletException {
</span><span class='line'>        HttpServletRequest request = (HttpServletRequest)req;
</span><span class='line'>        HttpServletResponse response = (HttpServletResponse)res;
</span><span class='line'>
</span><span class='line'>        String content = "&lt;html&gt;&lt;head&gt;&lt;title&gt;Truncated Page&lt;/title&gt;&lt;/head&gt;";
</span><span class='line'>               content += "&lt;body&gt;这个页面的内容will be truncated.&lt;/body&gt;&lt;/html&gt;";
</span><span class='line'>        response.setCharacterEncoding("gbk");
</span><span class='line'>        response.setContentLength(content.length());
</span><span class='line'>        PrintWriter out = response.getWriter();
</span><span class='line'>        out.println(content);
</span><span class='line'>        out.close();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void destroy() {
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>由于content字符串含有两个中文字符，每一个中文字符又是由两个字节组成，所以content.length()的值比content的字节数要少2。在客户端显示的内容也会因此少2个字节，即缺少“l&gt;”这两个字符。</p>

<p>现在我们来浏览SiteMesh的源代码找出问题的原因。首先从PageFilter.java的doFilter方法开始。由于页面没有在decorators.xml中注册修饰，所以writeOriginal方法会被调用。下面是writeOriginal方法的源代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/** Write the original page data to the response. */
</span><span class='line'>private void writeOriginal(HttpServletRequest request, HttpServletResponse response,
</span><span class='line'>                          Page page) throws IOException {
</span><span class='line'>    response.setContentLength(page.getContentLength());
</span><span class='line'>
</span><span class='line'>    if (request.getAttribute(USING_STREAM).equals(Boolean.TRUE)) {
</span><span class='line'>        PrintWriter writer = new PrintWriter(response.getOutputStream());
</span><span class='line'>        page.writePage(writer);
</span><span class='line'>        // flush writer to underlying outputStream
</span><span class='line'>        writer.flush();
</span><span class='line'>        response.getOutputStream().flush();
</span><span class='line'>    } else {
</span><span class='line'>        page.writePage(response.getWriter());
</span><span class='line'>        response.getWriter().flush();
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>首行代码就是设置内容体长度的，让我们追到page.getContentLength()里面去看看（Page接口的getContentLength方法是由AbstractPage.java实现的）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public int getContentLength() {
</span><span class='line'>    return pageData.length;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>它返回pageData数组的长度。但是pageData数组是char类型的，假如pageData中有中文内容时，设置的内容体长度就会小于pageData的字节数。这时就会出现输出到客户端的数据截掉的问题。所以只要修改getContentLength方法返回的值就可以了，下面是修改后的getContentLength方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public int getContentLength() {
</span><span class='line'>    String content = new String(pageData);
</span><span class='line'>    return content.getBytes().length;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/using-ssh2-to-access-gro-clinux-org-cvs-server-in-eclipse3/">在Eclipse 3中使用SSH2访问gro.clinux.org的CVS服务器</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-07-07T19:48:08+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2005</span></span> <span class='time'>7:48 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在Eclipse中生成公钥和私钥</p>

<p>打开Eclipse，进入Window -&gt; Preferences -&gt; Team -&gt; CVS -&gt; SSH2 Connection Method -&gt; Key Management，点击“Generate RSA Key...”，然后填写Passphrase和Confirm Passphrase，接着点击“Save Private Key...”保存公钥和私钥（公钥和私钥文件保存在~/.ssh/目录下，id_rsa是私钥文件，id_rsa.pub 是公钥文件）。</p>

<p>将公钥上传至gro.clinux.org服务器</p>

<p>登陆gro服务器，进入[帐号维护]，在页面底部你可以看到如下信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Shell帐号信息
</span><span class='line'>
</span><span class='line'>Shell box：
</span><span class='line'>CVS/SSH 共享认证Key：0 [编辑Keys]</span></code></pre></td></tr></table></div></figure>

<p>点击[编辑Keys]，然后把刚才生成的文件id_rsa.pub中的内容粘贴到文本框中（看看是不是符合它上面的要求，千万要仔细看看），如果没有问题的话，就更新吧。大约6个小时后Cron会自动更新，在服务器上你的目录下会自动添加文件夹/.ssh/，里面包含了名为authorized_keys2的文件，你的公钥就保存在这里。</p>

<p>在Eclipse中建立CVS连接</p>

<p>打开CVS Repository Exploring Perspective，进入New -&gt; Repository Location，填入以下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host：cvs.unixname.gro.clinux.org
</span><span class='line'>Repository Path：/cvsroot/unixname
</span><span class='line'>User：你在gro.clinux.org上注册的帐户
</span><span class='line'>Password：先前保存公钥和私钥时输入的Passphrase
</span><span class='line'>Connection Type：extssh</span></code></pre></td></tr></table></div></figure>

<p>点击Finish。如果你是第一次登录的话，将会弹出一个对话框，不用看那么仔细，直接点击OK就好了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-to-generate-executable-jar-file/">如何生成可执行的jar文件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-06-21T21:16:56+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2005</span></span> <span class='time'>9:16 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首先用jar cvf executable.jar *.class命令生成jar文件，然后编辑jar文件中META-INF目录下的MAINFEST文件。在其尾部加上main-class: main-class-name就可以让它变成可执行的了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/why-should-software-modeling/">为什么要软件建模</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2005-05-16T06:23:07+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2005</span></span> <span class='time'>6:23 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>模型是对现实的简化。需要进行建模的原因有以下几点：</p>

<ol>
<li>人们对复杂问题的理解能力是有限的；</li>
<li>我们要开发的软件系统是复杂的；</li>
<li>对系统的完整的理解有助于正确地实施工作（但不一定能使开发工作进展的更快）；</li>
<li>我们不能完整的理解一个复杂的系统，为了能够更好地理解正在开发的系统，因此要对它进行建模。</li>
</ol>

<p>那么，是不是任何情况下都要建模呢？未必尽然。是否要进行软件建模是由系统的复杂程度决定的。如果系统的复杂性在我们的控制范围之内，那么就不需要建模。不过，有一个自然趋势：随着时间的推移，几乎所有的应用系统变得越来越复杂。因此要记住的是：狗窝总有一天会膨胀成大厦，并且因为不堪承受其自身的重量而倒塌。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/25">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/23">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/developers-are-blinded-by-the-light/">开发者被灯光蒙蔽了双眼</a>
      </li>
    
      <li class="post">
        <a href="/blog/books-not-recommended/">哪些书不要读</a>
      </li>
    
      <li class="post">
        <a href="/blog/economic-inequality-the-short-version/">贫富差距精简版</a>
      </li>
    
      <li class="post">
        <a href="/blog/reading-notes-the-definitive-antlr4-reference-part7/">ANTLR 4权威参考读书笔记（7）</a>
      </li>
    
      <li class="post">
        <a href="/blog/how-to-detect-and-prevent-spam-traffic-in-ga/">Google Analytics中如何检测并防止垃圾流量</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://codemany.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 119%" href="/tags/antlr/">ANTLR</a>
<a style="font-size: 104%" href="/tags/algorithm/">Algorithm</a>
<a style="font-size: 132%" href="/tags/android/">Android</a>
<a style="font-size: 92%" href="/tags/ant/">Ant</a>
<a style="font-size: 104%" href="/tags/c-plus-plus/">C++</a>
<a style="font-size: 110%" href="/tags/crack/">Crack</a>
<a style="font-size: 107%" href="/tags/database/">Database</a>
<a style="font-size: 97%" href="/tags/eclipse/">Eclipse</a>
<a style="font-size: 113%" href="/tags/git/">Git</a>
<a style="font-size: 104%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 148%" href="/tags/java/">Java</a>
<a style="font-size: 101%" href="/tags/javascript/">JavaScript</a>
<a style="font-size: 97%" href="/tags/listview/">ListView</a>
<a style="font-size: 104%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 97%" href="/tags/paperclip/">Paperclip</a>
<a style="font-size: 119%" href="/tags/powerbuilder/">PowerBuilder</a>
<a style="font-size: 101%" href="/tags/powerscript/">PowerScript</a>
<a style="font-size: 117%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 119%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 97%" href="/tags/spring/">Spring</a>
<a style="font-size: 101%" href="/tags/struts/">Struts</a>
<a style="font-size: 125%" href="/tags/translation/">Translation</a>
<a style="font-size: 97%" href="/tags/ubuntu/">Ubuntu</a>
<a style="font-size: 92%" href="/tags/w32dasm/">W32Dasm</a>
<a style="font-size: 107%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 107%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://www.importnew.com/">ImportNew</a></li>
    <li><a href="http://ifeve.com/">并发编程网</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://advdbg.org/">高端调试</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dohkoos">@dohkoos</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dohkoos',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
  <div>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</div>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemany';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
