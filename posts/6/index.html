
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="TabHost是整个Tab的容器，包括TabWidget和FrameLayout两部分：TabWidget用于展示标签页，FrameLayout用于展示隶属于各个标签页的具体内容。一个带有TabHost的Activity看起来就像这样： 如果Activity是继承自TabAcitivty， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/posts/6">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!--script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script-->
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"-->
<!--link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"-->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:codemany.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/09/android-tab-using-summary/">Android Tab使用总结</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-09T08:55:45+08:00" pubdate data-updated="true">Sep 9<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>TabHost是整个Tab的容器，包括TabWidget和FrameLayout两部分：TabWidget用于展示标签页，FrameLayout用于展示隶属于各个标签页的具体内容。一个带有TabHost的Activity看起来就像这样：
<img src="/uploads/android-tabs.jpg" title="android-tabs" ></p>

<p>如果Activity是继承自TabAcitivty，那么TabHost的id必须设置为@android:id/tabhost，TabWidget必须设置为@android:id/tabs，FrameLayout需要设置为@android:id/tabcontent。</p>

<p>创建一个简单的Tab应用</p>

<p>废话不多说，直接上代码。以下就是main.xml的布局代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;TabHost xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:id="@android:id/tabhost"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="fill_parent"&gt;
</span><span class='line'>        &lt;TabWidget
</span><span class='line'>            android:id="@android:id/tabs"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>        &lt;FrameLayout
</span><span class='line'>            android:id="@android:id/tabcontent"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="fill_parent"&gt;
</span><span class='line'>            &lt;include android:id="@+id/left" layout="@layout/tab_left" /&gt;
</span><span class='line'>            &lt;include android:id="@+id/right" layout="@layout/tab_right" /&gt;
</span><span class='line'>        &lt;/FrameLayout&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/TabHost&gt;</span></code></pre></td></tr></table></div></figure>


<p>左边标签页tab_left.xml的内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;TextView
</span><span class='line'>        android:text="left"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="fill_parent" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>


<p>右边标签页tab_right.xml的内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;TextView
</span><span class='line'>        android:text="right"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="fill_parent" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>


<p>修改MainActivity，改成从TabActivity继承：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class MainActivity extends TabActivity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        TabHost tabHost = getTabHost();
</span><span class='line'>        tabHost.addTab(tabHost.newTabSpec("left")
</span><span class='line'>                .setIndicator("Left")
</span><span class='line'>                .setContent(R.id.left));
</span><span class='line'>        tabHost.addTab(tabHost.newTabSpec("right")
</span><span class='line'>                .setIndicator("Right")
</span><span class='line'>                .setContent(R.id.right));
</span><span class='line'>        tabHost.setCurrentTab(0);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>到这里，一个简单至极的Tab应用已经完成了。不过在实际情况中，每个Tab页会有多个控件，并且有很多业务逻辑在其中。如果使用上述代码，将所有控件和逻辑放在一个类中，那么这个类将变的极度臃肿，以后维护也会变的非常困难。需要找个简单且优雅的方案解决这个问题。</p>

<p>简单优雅且容易维护的Tab应用</p>

<p>删除main.xml中的include语句：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;TabHost xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:id="@android:id/tabhost"
</span><span class='line'>    android:layout_width="fill_parent"
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;LinearLayout
</span><span class='line'>        android:orientation="vertical"
</span><span class='line'>        android:layout_width="fill_parent"
</span><span class='line'>        android:layout_height="fill_parent"&gt;
</span><span class='line'>        &lt;TabWidget
</span><span class='line'>            android:id="@android:id/tabs"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>        &lt;FrameLayout
</span><span class='line'>            android:id="@android:id/tabcontent"
</span><span class='line'>            android:layout_width="fill_parent"
</span><span class='line'>            android:layout_height="fill_parent" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/TabHost&gt;</span></code></pre></td></tr></table></div></figure>


<p>新建TabLeftActivity和TabRightActivity类：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class TabLeftActivity extends Activity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.tab_left);
</span><span class='line'>
</span><span class='line'>        // do something
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class TabRightActivity extends Activity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.tab_right);
</span><span class='line'>
</span><span class='line'>        // do something
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>修改MainAcvitity为如下代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class MainActivity extends TabActivity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        TabHost tabHost = getTabHost();
</span><span class='line'>        tabHost.addTab(tabHost.newTabSpec("left")
</span><span class='line'>                .setIndicator("Left")
</span><span class='line'>                .setContent(new Intent(this, TabLeftActivity.class)));
</span><span class='line'>        tabHost.addTab(tabHost.newTabSpec("right")
</span><span class='line'>                .setIndicator("Right")
</span><span class='line'>                .setContent(new Intent(this, TabRightActivity.class)));
</span><span class='line'>        tabHost.setCurrentTab(0);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>最后，不要忘记在AndroidManifest.xml中注册TabLeftActivity和TabRightAcvitity这两个Activity。</p>

<p>如何将Tab显示在下方</p>

<p>这个非常简单，只要将main.xml中的LinearLayout改成RelativeLayout，然后给TagWidget添加android:layout_alignParentBottom=&ldquo;true&#8221;属性即可。当然也可以在main.xml中把TabWidget放在FrameLayout下面。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/30/creating-custom-keyboard-android/">创建Android自定义键盘</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-30T02:10:05+08:00" pubdate data-updated="true">Aug 30<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在使用股票应用时，我们会发现这些应用使用的是特殊的软键盘，这是如何实现的呢？下面就来做个实例详解。</p>

<p>注意，这篇文章不是教你如何创建输入法，如果你想创建自己的输入法，可以研究文章<a href="http://developer.android.com/resources/articles/creating-input-method.html">Creating an Input Method</a>和Android Sample中的SoftKeyboard项目。</p>

<p><img src="/uploads/android-custom-keyboard.png" title="android-custom-keyboard" ></p>

<p>软键盘实现：在Android中软键盘是很容易实现的，通过android.inputmethodservice.Keyboard类来创建软键盘，该类从XML文件中读取软键盘信息。有多少行，每行有多少按键，每个按键代表什么内容等。下面是软键盘的XML代码：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;Keyboard xmlns:android="http://schemas.android.com/apk/res/android"&lt;br /&gt;
</span><span class='line'>    android:keyWidth="25%p"&lt;br /&gt;
</span><span class='line'>    android:horizontalGap="0px"&lt;br /&gt;
</span><span class='line'>    android:verticalGap="0px"&lt;br /&gt;
</span><span class='line'>    android:keyHeight="@dimen/key_height"&gt;
</span><span class='line'>    &lt;Row&gt;
</span><span class='line'>        &lt;Key android:codes="49" android:keyLabel="1" /&gt;
</span><span class='line'>        &lt;Key android:codes="50" android:keyLabel="2" /&gt;
</span><span class='line'>        &lt;Key android:codes="51" android:keyLabel="3" /&gt;
</span><span class='line'>        &lt;Key android:codes="57419"&lt;br /&gt;
</span><span class='line'>            android:keyEdgeFlags="right"&lt;br /&gt;
</span><span class='line'>            android:keyIcon="@drawable/sym_keyboard_left" /&gt;
</span><span class='line'>    &lt;/Row&gt;
</span><span class='line'>    &lt;Row&gt;
</span><span class='line'>        &lt;Key android:codes="52" android:keyLabel="4" /&gt;
</span><span class='line'>        &lt;Key android:codes="53" android:keyLabel="5" /&gt;
</span><span class='line'>        &lt;Key android:codes="54" android:keyLabel="6" /&gt;
</span><span class='line'>        &lt;Key android:codes="57421"&lt;br /&gt;
</span><span class='line'>            android:keyEdgeFlags="right"&lt;br /&gt;
</span><span class='line'>            android:keyIcon="@drawable/sym_keyboard_right" /&gt;
</span><span class='line'>    &lt;/Row&gt;
</span><span class='line'>    &lt;Row&gt;
</span><span class='line'>        &lt;Key android:codes="55" android:keyLabel="7" /&gt;
</span><span class='line'>        &lt;Key android:codes="56" android:keyLabel="8" /&gt;
</span><span class='line'>        &lt;Key android:codes="57" android:keyLabel="9" /&gt;
</span><span class='line'>        &lt;Key android:codes="-5"&lt;br /&gt;
</span><span class='line'>            android:keyHeight="@dimen/key_height_large"&lt;br /&gt;
</span><span class='line'>            android:keyEdgeFlags="right"&lt;br /&gt;
</span><span class='line'>            android:isRepeatable="true"&lt;br /&gt;
</span><span class='line'>            android:keyIcon="@drawable/sym_keyboard_delete" /&gt;
</span><span class='line'>    &lt;/Row&gt;
</span><span class='line'>    &lt;Row&gt;
</span><span class='line'>        &lt;Key android:codes="-3" android:keyIcon="@drawable/sym_keyboard_done" /&gt;
</span><span class='line'>        &lt;Key android:codes="48" android:keyLabel="0" /&gt;
</span><span class='line'>        &lt;Key android:codes="88" android:keyLabel="X" /&gt;
</span><span class='line'>    &lt;/Row&gt;
</span><span class='line'>&lt;/Keyboard&gt;</span></code></pre></td></tr></table></div></figure>


<p>在上面的键盘定义中，Row元素说明这是一行按键的定义，Key元素说明这是一个按键的定义。Key元素通过一些属性来定义每个按键，下面是一些常用的属性介绍：</p>

<blockquote>
codes：代表按键对应的输出值，可以为unicode值或则逗号(,)分割的多个值，也可以为一个字符串。在字符串中通过“&#92;”来转义特殊字符，例如&#8217;&#92;n&#8217;或则&#8217;&#92;uxxxx&#8217;。Codes通常用来定义该键的键码，例如上图中的数字按键1对应的为49；如果提供的是逗号分割的多个值则和普通手机输入键盘一样在多个值之间切换。<br />
keyLabel：代表按键显示的文本内容。<br />
keyIcon：代表按键显示的图标内容，如果指定了该值则在显示的时候显示为图片不显示文本。<br />
keyWidth：代表按键的宽度，可以为精确值或则相对值，对于精确值支持多种单位，例如：像素，英寸等；相对值为相对于基础取值的百分比，为以%或则%p结尾，其中%p表示相对于父容器。<br />
keyHeight：代表按键的高度，取值同上。<br />
horizontalGap：代表按键前的间隙（水平方向），取值同上。<br />
isSticky：指定按键是否为sticky的。例如Shift大小写切换按键，具有两种状态，按下状态和正常状态，取值为true或则false。<br />
isModifier：指定按键是否为功能键(modifier key)，例如Alt或则Shift，取值为true或则false。<br />
keyOutputText：指定按键输出的文本内容，取值为字符串。<br />
isRepeatable：指定按键是否是可重复的，如果长按该键可以触发重复按键事件则为true，否则为false。<br />
keyEdgeFlags：指定按键的对齐指令，取值为left或则right。
</blockquote>


<p>然后在main.xml文件末尾加入以下代码：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;RelativeLayout&lt;br /&gt;
</span><span class='line'>    android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;android.inputmethodservice.KeyboardView&lt;br /&gt;
</span><span class='line'>        android:id="@+id/keyboard_view"&lt;br /&gt;
</span><span class='line'>        android:visibility="gone"&lt;br /&gt;
</span><span class='line'>        android:focusable="true"&lt;br /&gt;
</span><span class='line'>        android:focusableInTouchMode="true"&lt;br /&gt;
</span><span class='line'>        android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>        android:layout_height="wrap_content"&lt;br /&gt;
</span><span class='line'>        android:layout_alignParentBottom="true" /&gt;
</span><span class='line'>&lt;/RelativeLayout&gt;</span></code></pre></td></tr></table></div></figure>


<p>下面是主要的处理代码：<br />
&#8220;`
public class MainActivity extends Activity {<br /></p>

<pre><code>@Override&lt;br /&gt;
public void onCreate(Bundle savedInstanceState) {&lt;br /&gt;
    super.onCreate(savedInstanceState);&lt;br /&gt;
    setContentView(R.layout.main);

    EditText edit = (EditText)findViewById(R.id.edit);&lt;br /&gt;
    edit.setInputType(InputType.TYPE_NULL);&lt;br /&gt;
    edit.setOnClickListener(new OnClickListener() {&lt;br /&gt;
        @Override&lt;br /&gt;
        public void onClick(View v) {&lt;br /&gt;
            showKeyboard();&lt;br /&gt;
        }&lt;br /&gt;
    });

    KeyboardView keyboardView = (KeyboardView)findViewById(R.id.keyboard_view);&lt;br /&gt;
    keyboardView.setKeyboard(new Keyboard(this, R.xml.qwerty));&lt;br /&gt;
    keyboardView.setEnabled(true);&lt;br /&gt;
    keyboardView.setPreviewEnabled(true);&lt;br /&gt;
    keyboardView.setOnKeyboardActionListener(new OnKeyboardActionListener() {&lt;br /&gt;
        @Override&lt;br /&gt;
        public void onKey(int primaryCode, int[] keyCodes) {&lt;br /&gt;
            Editable editable = edit.getText();&lt;br /&gt;
            int start = edit.getSelectionStart();&lt;br /&gt;
            if (primaryCode == Keyboard.KEYCODE_CANCEL) {&lt;br /&gt;
                hideKeyboard();&lt;br /&gt;
            } else if (primaryCode == Keyboard.KEYCODE_DELETE) {&lt;br /&gt;
                if (editable != null &amp;&amp; editable.length() &gt; 0) {&lt;br /&gt;
                    editable.delete(start - 1, start);&lt;br /&gt;
                }&lt;br /&gt;
            } else if (primaryCode == 57419) { // go left&lt;br /&gt;
                if (start &gt; 0) {&lt;br /&gt;
                    edit.setSelection(start - 1);&lt;br /&gt;
                }&lt;br /&gt;
            } else if (primaryCode == 57421) { // go right&lt;br /&gt;
                if (start &lt; edit.length()) {&lt;br /&gt;
                    edit.setSelection(start + 1);&lt;br /&gt;
                }&lt;br /&gt;
            } else {&lt;br /&gt;
                editable.insert(start, Character.toString((char)primaryCode));&lt;br /&gt;
            }&lt;br /&gt;
        }&lt;br /&gt;
        ...&lt;br /&gt;
    });&lt;br /&gt;
}

private void showKeyboard() {&lt;br /&gt;
    int visibility = keyboardView.getVisibility();&lt;br /&gt;
    if (visibility == View.GONE || visibility == View.INVISIBLE) {&lt;br /&gt;
        keyboardView.setVisibility(View.VISIBLE);&lt;br /&gt;
    }&lt;br /&gt;
}

private void hideKeyboard() {&lt;br /&gt;
    int visibility = keyboardView.getVisibility();&lt;br /&gt;
    if (visibility == View.VISIBLE) {&lt;br /&gt;
        keyboardView.setVisibility(View.INVISIBLE);&lt;br /&gt;
    }&lt;br /&gt;
}&lt;br /&gt;
</code></pre>

<p>}
[/code]
</p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/05/git-uses-notes-of-the-branch-merge-and-rebase/">Git使用笔记之branch，merge和rebase</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-05T05:05:02+08:00" pubdate data-updated="true">Aug 5<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git branch &lt;branch_name&gt; # 建立branch
</span><span class='line'>git branch -m &lt;old_branch_name&gt; &lt;new_branch_name&gt; # 修改branch名字
</span><span class='line'>git branch # 列出所有branch以及当前在哪个branch
</span><span class='line'>git checkout &lt;branch_name&gt; # 切换branch
</span><span class='line'>git checkout -b &lt;branch_name&gt; # 新建branch并切换过去
</span><span class='line'>git branch -d &lt;branch_name&gt; # 刪除branch
</span><span class='line'>git merge &lt;branch_name&gt; # 合并分支到当前分支上
</span><span class='line'>git rebase &lt;branch_name&gt; # 将以往的变更迁移到最新的上游版本库的状态中</span></code></pre></td></tr></table></div></figure>


<p>在merge/rebase的过程中，也许会出现冲突（conflict）。在这种情况，Git会停止merge/rebase并让你去解决冲突，冲突内容以下列形式存在：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
</span><span class='line'>=======
</span><span class='line'>&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></code></pre></td></tr></table></div></figure>


<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD下面的是当前版本里的内容；=======和>>>>>>>之间的则表示分支里与之对应的有冲突的内容。修复冲突要做的就是把&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD和>>>>>>>之间的改成我们想要的内容。在解决完冲突后，用git add命令去更新这些内容的索引（index），如果是rebase，那么你无需执行git commit，只要执行git rebase &mdash;continue命令，这样Git会继续应用（apply）余下的补丁。</p>

<p>rebase是将目前branch的commits，一个个重新apply（或者叫patch）到要被rebase的branch上。例如，当前branch是A，然后执行git rebase B，就会把原本分支点之后所有A的commits记录，重新在B分支上再commit一遍，这时新分支点变成B分支的最新的commit。</p>

<p>fast-forward在Git中是一种merge术语，当B分支是从A分支的最新版（HEAD）分出来的，那么当A要把B merge进来时，因为B的parent commit是A的HEAD，所以这两个分支唯一的差异就是B后来的commit而已，而不会有任何conflict。所以实际上的动作只是把A的HEAD改成B的HEAD而已，线图上来看两个分支根本是同一条线。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/01/how-to-create-a-splash-screen-splash-screen-android/">如何创建Android启动界面Splash Screen</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-01T15:47:50+08:00" pubdate data-updated="true">Aug 1<sup>st</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ol>
<li><p>制作一张启动图片splash.jpg，放置在res/drawable文件夹中。</p></li>
<li><p>新建布局文件splash.xml：<br /></p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"&lt;br /&gt;
</span><span class='line'>    android:orientation="vertical"&lt;br /&gt;
</span><span class='line'>    android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;ImageView&lt;br /&gt;
</span><span class='line'>        android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>        android:layout_height="fill_parent"&lt;br /&gt;
</span><span class='line'>        android:scaleType="fitXY"&lt;br /&gt;
</span><span class='line'>        android:src="@drawable/splash" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>


<ol>
<li>新建SplashActivity，代码如下：<br /></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.splash;
</span><span class='line'>
</span><span class='line'>import android.app.Activity;&lt;br /&gt;
</span><span class='line'>import android.content.Intent;&lt;br /&gt;
</span><span class='line'>import android.os.Bundle;&lt;br /&gt;
</span><span class='line'>import android.view.MotionEvent;
</span><span class='line'>
</span><span class='line'>public class SplashActivity extends Activity {&lt;br /&gt;
</span><span class='line'>    private boolean active = true;&lt;br /&gt;
</span><span class='line'>    private int splashTime = 5000; // time to display the splash screen in ms
</span><span class='line'>
</span><span class='line'>    @Override&lt;br /&gt;
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {&lt;br /&gt;
</span><span class='line'>        super.onCreate(savedInstanceState);&lt;br /&gt;
</span><span class='line'>        setContentView(R.layout.splash);
</span><span class='line'>
</span><span class='line'>        Thread splashTread = new Thread() {&lt;br /&gt;
</span><span class='line'>            @Override&lt;br /&gt;
</span><span class='line'>            public void run() {&lt;br /&gt;
</span><span class='line'>                try {&lt;br /&gt;
</span><span class='line'>                    int waited = 0;&lt;br /&gt;
</span><span class='line'>                    while (active && (waited &lt; splashTime)) {&lt;br /&gt;
</span><span class='line'>                        sleep(100);&lt;br /&gt;
</span><span class='line'>                        if (active) {&lt;br /&gt;
</span><span class='line'>                            waited += 100;&lt;br /&gt;
</span><span class='line'>                        }&lt;br /&gt;
</span><span class='line'>                    }&lt;br /&gt;
</span><span class='line'>                } catch(InterruptedException e) {&lt;br /&gt;
</span><span class='line'>                } finally {&lt;br /&gt;
</span><span class='line'>                    finish();&lt;br /&gt;
</span><span class='line'>                    Intent intent = new Intent(SplashActivity.this, MainActivity.class);&lt;br /&gt;
</span><span class='line'>                    startActivity(intent);&lt;br /&gt;
</span><span class='line'>                    //stop();&lt;br /&gt;
</span><span class='line'>                }&lt;br /&gt;
</span><span class='line'>            }&lt;br /&gt;
</span><span class='line'>        };&lt;br /&gt;
</span><span class='line'>        splashTread.start();&lt;br /&gt;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override&lt;br /&gt;
</span><span class='line'>    public boolean onTouchEvent(MotionEvent event) {&lt;br /&gt;
</span><span class='line'>        if (event.getAction() == MotionEvent.ACTION_DOWN) {&lt;br /&gt;
</span><span class='line'>            active = false;&lt;br /&gt;
</span><span class='line'>        }&lt;br /&gt;
</span><span class='line'>        return true;&lt;br /&gt;
</span><span class='line'>    }&lt;br /&gt;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>修改AndroidManifest.xml文件，将启动界面Activity改为默认启动，并且设置标题栏不可见。<br />
&#8220;`
&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;utf-8&rdquo;?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"<br />
 package=&ldquo;com.codemany.splash&rdquo;<br />
 android:versionCode=&ldquo;1&rdquo;<br />
 android:versionName=&ldquo;1.0&rdquo;></p>

<p> <application android:icon="@drawable/icon" android:label="@string/app_name">
     <activity android:name=".SplashActivity" android:theme="@android:style/Theme.NoTitleBar">
         &lt;intent-filter>
             <action android:name="android.intent.action.MAIN" />
             <category android:name="android.intent.category.LAUNCHER" />
         &lt;/intent-filter>
     </activity></p>

<pre><code> &lt;activity android:name="MainActivity" /&gt;
</code></pre>

<p> </application></p>

<p> &lt;uses-sdk android:minSdkVersion=&ldquo;4&rdquo; />
</manifest>
[/code]
</p></p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/07/02/import-bookmarks-into-firefox-uc-browser/">导入UC Browser书签到Firefox中</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-02T16:03:41+08:00" pubdate data-updated="true">Jul 2<sup>nd</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>UC Browser保存的书签后缀名是aucf，不能直接导入到Firefox中，必须要把aucf格式转成Firefox的html格式才行。</p>

<p>先把UC Browser和Firefox的书签格式都分析了一下。Firefox的是纯html文本格式，非常简单。UC的是二进制格式，文件以字符串android开头，接着是n个byte的信息，没有分析出来是啥，然后4个byte是书签的数目，再接着的n个byte没去分析，再下来就是每个书签的信息了。书签信息分两部分：名称和地址。都是第1个byte说明后面字符串的长度，字符串以00结尾。<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>android &lt;- 文件头&lt;br /&gt;
</span><span class='line'>xxx...   &lt;- n个byte&lt;br /&gt;
</span><span class='line'>xxxx    &lt;- 保存的书签数目&lt;br /&gt;
</span><span class='line'>xxx...   &lt;- n个byte&lt;br /&gt;
</span><span class='line'>xx       &lt;- 书签名称长度&lt;br /&gt;
</span><span class='line'>xxx...   &lt;- 书签名称&lt;br /&gt;
</span><span class='line'>xx       &lt;- 书签地址长度&lt;br /&gt;
</span><span class='line'>xxx...   &lt;- 书签地址&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>用文本文件打开时可以查看英文字符。书签的地址通常由英文字母组成，所以我们不需要再去分析整个aucf文件的格式，只要把所有书签地址提取出来就行了。下面就是完整的Ruby代码：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># aucf2ff.rb&lt;br /&gt;
</span><span class='line'>if ARGV.length != 1 then&lt;br /&gt;
</span><span class='line'>  puts "USAGE: ruby aucf2ff.rb ucfavorite"&lt;br /&gt;
</span><span class='line'>  exit&lt;br /&gt;
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>ucfavorite = ARGV[0]&lt;br /&gt;
</span><span class='line'>if !FileTest.exist?(ucfavorite) then&lt;br /&gt;
</span><span class='line'>  puts "File #{ucfavorite} was not found"&lt;br /&gt;
</span><span class='line'>  exit&lt;br /&gt;
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>ff = File.new(ucfavorite.gsub(".aucf", "_ff.html"), "w")&lt;br /&gt;
</span><span class='line'>ff.puts '&lt;!DOCTYPE NETSCAPE-Bookmark-file-1&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts '&lt;!-- This is an automatically generated file.'&lt;br /&gt;
</span><span class='line'>ff.puts '     It will be read and overwritten.'&lt;br /&gt;
</span><span class='line'>ff.puts '     DO NOT EDIT! --&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts '&lt;META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts '&lt;TITLE&gt;Bookmarks&lt;/TITLE&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts '&lt;H1&gt;Bookmarks Menu&lt;/H1&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts&lt;br /&gt;
</span><span class='line'>ff.puts '&lt;DL&gt;&lt;p&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts '    &lt;DT&gt;&lt;H3&gt;UC Bookmarks&lt;/H3&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts '    &lt;DL&gt;&lt;p&gt;'
</span><span class='line'>
</span><span class='line'>buffer = IO.read(ucfavorite)&lt;br /&gt;
</span><span class='line'>index = buffer.index("http://")&lt;br /&gt;
</span><span class='line'>favorites = buffer.slice(index, buffer.length - index)&lt;br /&gt;
</span><span class='line'>favorites.split("http://").each do |fav|&lt;br /&gt;
</span><span class='line'>  uri = ''&lt;br /&gt;
</span><span class='line'>  fav.each_byte do |c|&lt;br /&gt;
</span><span class='line'>    break if c == 00&lt;br /&gt;
</span><span class='line'>    uri += c.chr&lt;br /&gt;
</span><span class='line'>  end&lt;br /&gt;
</span><span class='line'>  if (!uri.empty?) then&lt;br /&gt;
</span><span class='line'>    ff.puts '&lt;DT&gt;&lt;A HREF="http://' + uri + '" LAST_CHARSET="utf-8"&gt;' + uri + '&lt;/A&gt;'&lt;br /&gt;
</span><span class='line'>  end&lt;br /&gt;
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>ff.puts '    &lt;/DL&gt;&lt;p&gt;'&lt;br /&gt;
</span><span class='line'>ff.puts '&lt;/DL&gt;&lt;p&gt;'&lt;br /&gt;
</span><span class='line'>ff.close&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>通过上面的程序就可以将UC Browser的书签转成Firefox格式，然后在Firefox中导入书签就可以了。</p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/07/01/decompile-android-apk-file/">反编译Android Apk文件</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-01T06:07:07+08:00" pubdate data-updated="true">Jul 1<sup>st</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>classes.dex是Java源码编译后生成的字节码文件。由于Android使用的dalvik虚拟机与标准的Java虚拟机是不兼容的，dex文件与class文件相比，不论是文件结构还是opcode都不一样。</p>

<p>目前有下面这几种反编译的工具:<br />
dexdump
<a href="http://dedexer.sourceforge.net/">Dedexer</a>
<a href="http://code.google.com/p/android4me/">AXMLPrinter2</a>
<a href="http://code.google.com/p/android-apktool/">apktool</a>
<a href="http://code.google.com/p/dex2jar/">dex2jar</a> + <a href="http://java.decompiler.free.fr/?q=jdgui">JD-GUI</a>
<a href="http://code.google.com/p/smali/">smali</a></p>

<p>Android开发包提供了一个dex的反编译工具dexdump。用法为首先启动Android模拟器，把要反编译的dex文件用adb push上传到模拟器中，然后通过adb shell登录，找到该dex文件，执行dexdump xxx.dex。总的来说dexdump功能比较弱，且用起来麻烦，另外反编译的结果可读性也很差。</p>

<p>另一个dex文件的反编译工具是Dedexer，且反编译的效果比较好。它可以读取dex格式的文件，生成一种类似于汇编语言的输出。这种输出与Jasmin的输出相似，但包含的是Dalvik的字节码。Dedexer与dexdump相比至少有3个优点：<br />
1. 不需要在Android模拟器中运行；<br />
2. 反编译后的文件目录结构和源代码结构相近，每个class文件对应一个ddx文件。不像dexdump那样把所有的结果都放在一起；<br />
3. 可以作为反编译引擎。目前好多强大的反编译工具都是以Jasmin作为反编译引擎的。<br />
可以下载已经编译好的jar文件ddx1.11.jar，对应Java 1.6版本。用法：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -jar ddx1.11.jar -o -D -r -d src classes.dex //在src目录下生成ddx文件&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>在apk中的资源是经过压缩的，用文本工具看都是乱码，可以通过AXMLPrinter2将其转换为可读的xml文件。具体命令为：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -jar AXMLPrinter2.jar xxx.xml output.xml&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>目前最好的dex反编译工具是apktool。可以帮助我们把apk文件反编译，输出smali格式的代码和图片和资源等文件，还可以在修改后重新打包。将下载下来的apktool和apktool-install-windows解压到同一目录下，有三个文件：aapt.exe，apktool.bat和apktool.jar。使用方法：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apktool d xxx.apk zzz //反编译xxx.apk到zzz目录，得到apk的图片和配置资源文件等&lt;br /&gt;
</span><span class='line'>apktool b zzz //从文件夹zzz重建apk，输出到zzz/dist/out.apk&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>dex2jar是一个将Dalvik虚拟机的dex文件转换回标准Java的class文件的工具：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dex2jar xxx.apk //生成jar文件，可以用JD GUI工具直接打开查看&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>smali可以反编译dex文件，也可以把你修改过的代码重新编译成dex：<br />
&#8220;`
java -jar baksmali.jar classes.dex -o classes<br />
java -jar smali.jar classes -o classes.dex<br />
[/code]
</p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/21/nokia-6670-sms-into-the-hero/">将Nokia 6670的短信导入Hero</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-21T08:43:10+08:00" pubdate data-updated="true">Jun 21<sup>st</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这事本该N久前就该干了（09年末把手机从Nokia 6670换到HTC Hero），却一直拖着没有做，今天终于把这事作了一个了结。</p>

<p>Nokia下导出的短信是如Messages_Nokia 6670_20091215.xml这样的一个XML文件，文件内容的编码是unicode，格式就像下面这样：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="unicode"?&gt;
</span><span class='line'>&lt;SMS PhoneModel="Nokia 6670"&gt;
</span><span class='line'>  &lt;Message DateTime="2006-09-07 09:32:22"&gt;
</span><span class='line'>    &lt;Sender&gt;牛金星&lt;/Sender&gt;
</span><span class='line'>    &lt;PhoneNumber&gt;+8613988888888&lt;/PhoneNumber&gt;
</span><span class='line'>   &lt;Location&gt;Inbox&lt;/Location&gt;
</span><span class='line'>    &lt;Text&gt;This is a test!&lt;/Text&gt;
</span><span class='line'>  &lt;/Message&gt;
</span><span class='line'>  ...
</span><span class='line'>  &lt;Message DateTime="2006-09-07 09:32:22"&gt;
</span><span class='line'>    &lt;Sender&gt;马尔科&lt;/Sender&gt;
</span><span class='line'>    &lt;PhoneNumber&gt;+8613966666666&lt;/PhoneNumber&gt;
</span><span class='line'>    &lt;Location&gt;Outbox&lt;/Location&gt;
</span><span class='line'>    &lt;Text&gt;Hello, world!&lt;/Text&gt;
</span><span class='line'>  &lt;/Message&gt;
</span><span class='line'>&lt;/SMS&gt;</span></code></pre></td></tr></table></div></figure>


<p>本来是想写个Android app来直接导入这些备份短信的，不过在实现的过程中发现了SMS Backup&amp;Restore到备份文件和Nokia的备份文件类似产生了做个将Nokia备份文件转换成SMS Backup&amp;Restore的备份文件，又在网上发现了nicholashan的教程<a href="http://bbs.hiapk.com/thread-140564-1-1.html">《将Nokia的短信导入Hero(可能适用所有Android机型)》</a>，坚定了我的这个想法。</p>

<p>分析了一下SMS Backup&amp;Restore备份文件的格式，文件内容的编码是utf-8的：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt;
</span><span class='line'>&lt;smses count="1138"&gt;
</span><span class='line'>  &lt;sms protocol="0" address="10658601" date="1260675608871"
</span><span class='line'>    type="1" subject="null" body="This is a test!" toa="null"
</span><span class='line'>    sc_toa="null" service_center="+8613800510543" read="1"
</span><span class='line'>    status="-1" locked="0" /&gt;
</span><span class='line'>  &lt;sms protocol="0" address="13566666666" date="1260887183844"
</span><span class='line'>    type="2" subject="null" body="Hello, Hero." toa="null"
</span><span class='line'>    sc_toa="null" service_center="null" read="1"
</span><span class='line'>    status="-1" locked="0" /&gt;
</span><span class='line'>  &lt;sms protocol="0" address="+8613588888888" date="1260887553000"
</span><span class='line'>    type="1" subject="null" body="ooops!" toa="null"
</span><span class='line'>    sc_toa="null" service_center="null" read="1"
</span><span class='line'>    status="-1" locked="0" /&gt;
</span><span class='line'>&lt;/smses&gt;</span></code></pre></td></tr></table></div></figure>


<p>与转换相关的就address、date、type和body四个属性。address是发信人的号码；date是短信发送日期的timestamp。这点nicholashan的确说错了，后面不需要加什么0的（实际上nicholashan自己也怀疑自己的说法）；type等于1表示别人发给你的短信，如果是2的话就是你发给其他人的短信；<br />
body就是短信内容了。</p>

<p>将Nokia中的时间转换到SMS Backup&amp;Restore的时间可以使用下面的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DateFormat dt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
</span><span class='line'>long value = 1355296332000L; // 2012-12-12 12:12:12
</span><span class='line'>Element e = ...
</span><span class='line'>Attribute attr = e.attribute("DateTime");
</span><span class='line'>try {
</span><span class='line'>    value = dt.parse(attr.getValue()).getTime();
</span><span class='line'>} catch (ParseException ex) {
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>完整的代码如下（使用dom4j实现XML解析）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.codemany.n6670conv;
</span><span class='line'>
</span><span class='line'>import java.io.File;
</span><span class='line'>import java.io.FileWriter;
</span><span class='line'>import java.io.IOException;
</span><span class='line'>import java.text.DateFormat;
</span><span class='line'>import java.text.ParseException;
</span><span class='line'>import java.text.SimpleDateFormat;
</span><span class='line'>import java.util.Iterator;
</span><span class='line'>import java.util.List;
</span><span class='line'>
</span><span class='line'>import org.dom4j.Attribute;
</span><span class='line'>import org.dom4j.Document;
</span><span class='line'>import org.dom4j.DocumentException;
</span><span class='line'>import org.dom4j.DocumentHelper;
</span><span class='line'>import org.dom4j.Element;
</span><span class='line'>import org.dom4j.Node;
</span><span class='line'>import org.dom4j.io.SAXReader;
</span><span class='line'>import org.dom4j.io.XMLWriter;
</span><span class='line'>
</span><span class='line'>public class Main {
</span><span class='line'>
</span><span class='line'>    public static void main(String[] args) {
</span><span class='line'>        try {
</span><span class='line'>            SAXReader sr = new SAXReader();
</span><span class='line'>            Document doc = sr.read(new File(args[0]));
</span><span class='line'>
</span><span class='line'>            generateDocument(doc);
</span><span class='line'>        } catch (DocumentException e) {
</span><span class='line'>            e.printStackTrace();
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private static void generateDocument(Document doc) {
</span><span class='line'>        List list = doc.selectNodes("//Message");
</span><span class='line'>
</span><span class='line'>        Document document = DocumentHelper.createDocument();
</span><span class='line'>        Element smses = document.addElement("smses");
</span><span class='line'>        smses.addAttribute("count", String.valueOf(list.size()));
</span><span class='line'>
</span><span class='line'>        DateFormat dt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
</span><span class='line'>        long value = 1355296332000L; // 2012-12-12 12:12:12
</span><span class='line'>        Iterator iter = list.iterator();
</span><span class='line'>        while (iter.hasNext()) {
</span><span class='line'>            Element e = (Element)iter.next();
</span><span class='line'>            Attribute attr = e.attribute("DateTime");
</span><span class='line'>            try {
</span><span class='line'>                value = dt.parse(attr.getValue()).getTime();
</span><span class='line'>            } catch (ParseException ex) {
</span><span class='line'>            }
</span><span class='line'>            Node phone = e.selectSingleNode("PhoneNumber");
</span><span class='line'>            Node location = e.selectSingleNode("Location");
</span><span class='line'>            Node text = e.selectSingleNode("Text");
</span><span class='line'>
</span><span class='line'>            Element sms = smses.addElement("sms");
</span><span class='line'>            sms.addAttribute("protocol", "0");
</span><span class='line'>            sms.addAttribute("address", phone.getText());
</span><span class='line'>            sms.addAttribute("date", String.valueOf(value));
</span><span class='line'>            if ("Inbox".equals(location.getText())) {
</span><span class='line'>                sms.addAttribute("type", "1");
</span><span class='line'>            } else if ("Outbox".equals(location.getText())) {
</span><span class='line'>                sms.addAttribute("type", "2");
</span><span class='line'>            }
</span><span class='line'>            sms.addAttribute("subject", "null");
</span><span class='line'>            sms.addAttribute("body", text.getText());
</span><span class='line'>            sms.addAttribute("toa", "null");
</span><span class='line'>            sms.addAttribute("sc_toa", "null");
</span><span class='line'>            sms.addAttribute("service_center", "null");
</span><span class='line'>            sms.addAttribute("read", "1");
</span><span class='line'>            sms.addAttribute("status", "-1");
</span><span class='line'>            sms.addAttribute("locked", "0");
</span><span class='line'>        }
</span><span class='line'>        try {
</span><span class='line'>            File f = new File("output.xml");
</span><span class='line'>            XMLWriter output = new XMLWriter(new FileWriter(f));
</span><span class='line'>            output.write(document);
</span><span class='line'>            output.close();
</span><span class='line'>        } catch (IOException e) {
</span><span class='line'>            System.out.println(e.getMessage());
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>代码下载：<a href="https://github.com/dohkoos/N6670Conv">https://github.com/dohkoos/N6670Conv</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/18/how-to-install-apk-installed-to-obtain-time-and-space-size/">如何获得已安装apk的安装时间和占用空间大小</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-18T09:59:11+08:00" pubdate data-updated="true">Jun 18<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>可以通过ApplicationInfo类中sourceDir取得apk的文件路径，再使用File类读取文件的相关属性实现。不过这可能导致:<br />
1. 无法获取原始的创建时间，可能很早就被创建了，之后被替换了；<br />
2. 如果这个apk在一个私有的位置，比如app-private目录（使用Market付费购买的应用在这个位置），没有root的手机是没有权限读取的，会导致读取失败。<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>List&lt;PackageInfo&gt; pkgs = getPackageManager().getInstalledPackages(0);&lt;br /&gt;
</span><span class='line'>for (int i = 0; i &lt; pkgs.size(); i++) {&lt;br /&gt;
</span><span class='line'>    PackageInfo pkg = pkgs.get(i);
</span><span class='line'>
</span><span class='line'>    File file = new File(pkg.applicationInfo.sourceDir);&lt;br /&gt;
</span><span class='line'>    System.out.println("file size: " + file.length());&lt;br /&gt;
</span><span class='line'>    System.out.println("file last modified: " + file.lastModified());&lt;br /&gt;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>不过File类中文件大小和文件最后修改时间的值是long型，不是用户友好的，在显示前需要格式化一下：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>String size = Formatter.formatFileSize(context, file.length())
</span><span class='line'>
</span><span class='line'>Date date = new Date(file.lastModified())&lt;br /&gt;
</span><span class='line'>String lastModified = new SimpleDateFormat("yyyy-MM-dd").format(date)
</span><span class='line'>
</span><span class='line'>System.out.println("file size: " + size);&lt;br /&gt;
</span><span class='line'>System.out.println("file last modified: " + lastModified);&lt;br /&gt;</span></code></pre></td></tr></table></div></figure>


<p>从Android 2.3 API Level为9开始，ApplicationInfo类新增了firstInstallTime和lastUpdateTime两个字段，可以直接获取apk的创建和最后修改时间，即使是付费软件也能正常获取。</p>

<p>参考资料：<br />
<a href="http://www.android123.com.cn/androidkaifa/719.html">http://www.android123.com.cn/androidkaifa/719.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/06/add-uninstall-functionality-to-the-listview-button/">给ListView添加卸载功能的button</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-06T09:25:43+08:00" pubdate data-updated="true">Jun 6<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>修改main.xml，添加button控件：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"&lt;br /&gt;
</span><span class='line'>    android:orientation="vertical"&lt;br /&gt;
</span><span class='line'>    android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>    android:layout_height="fill_parent"&gt;
</span><span class='line'>    &lt;LinearLayout&lt;br /&gt;
</span><span class='line'>        android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>        android:layout_height="wrap_content"&lt;br /&gt;
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;ListView&lt;br /&gt;
</span><span class='line'>            android:id="@+id/list_view"&lt;br /&gt;
</span><span class='line'>            android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>    &lt;LinearLayout&lt;br /&gt;
</span><span class='line'>        android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>        android:layout_height="wrap_content"&gt;
</span><span class='line'>        &lt;Button&lt;br /&gt;
</span><span class='line'>            android:id="@+id/uninstall_button"&lt;br /&gt;
</span><span class='line'>            android:text="Uninstall Selected Apps"&lt;br /&gt;
</span><span class='line'>            android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>            android:layout_height="wrap_content" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>


<p>然后在主Activity类Main.java中添加卸载应用的功能代码：<br />
&#8220;`
private UninstallReceiver mUninstallReceiver;</p>

<p>@Override<br />
public void onCreate(Bundle savedInstanceState) {<br /></p>

<pre><code>...

Button btn = (Button)findViewById(R.id.uninstall_button);&lt;br /&gt;
btn.setOnClickListener(new OnClickListener() {&lt;br /&gt;
    @Override&lt;br /&gt;
    public void onClick(View v) {&lt;br /&gt;
        for (int i = 0; i &lt; mListData.size(); i++) {&lt;br /&gt;
            HashMap&lt;String, Object&gt; map = mListData.get(i);&lt;br /&gt;
            boolean isSelected = (Boolean)map.get("app_select");&lt;br /&gt;
            if (isSelected) {&lt;br /&gt;
                Uri packageUri = Uri.parse("package:" + map.get("app_package"));&lt;br /&gt;
                Intent intent = new Intent(Intent.ACTION_DELETE, packageUri);&lt;br /&gt;
                startActivity(intent);&lt;br /&gt;
            }&lt;br /&gt;
        }&lt;br /&gt;
    }&lt;br /&gt;
});

    // 监听卸载广播&lt;br /&gt;
mUninstallReceiver = new UninstallReceiver();&lt;br /&gt;
IntentFilter filter = new IntentFilter(Intent.ACTION_PACKAGE_REMOVED);&lt;br /&gt;
filter.addDataScheme("package");&lt;br /&gt;
registerReceiver(mUninstallReceiver, filter);&lt;br /&gt;
</code></pre>

<p>}</p>

<p>// 有时选择移除的程序在确认时被取消了，因此要用BroadcastReceiver监听应用是否被真正地卸载<br />
private class UninstallReceiver extends BroadcastReceiver {<br /></p>

<pre><code>@Override&lt;br /&gt;
public void onReceive(Context ctx, Intent intent) {&lt;br /&gt;
    Log.d("UninstallReceiver.onReceive()", intent.getDataString());

    for (int i = 0; i &lt; mListData.size(); i++) {&lt;br /&gt;
        HashMap&lt;String, Object&gt; map = mListData.get(i);&lt;br /&gt;
        String packageUri = "package:" + map.get("app_package");&lt;br /&gt;
        if (packageUri.equals(intent.getDataString())) {&lt;br /&gt;
            mListData.remove(map);&lt;br /&gt;
        }&lt;br /&gt;
    }&lt;br /&gt;
    mHandler.sendEmptyMessage(0);&lt;br /&gt;
}&lt;br /&gt;
</code></pre>

<p>}</p>

<p>@Override<br />
public void onDestroy() {<br /></p>

<pre><code>super.onDestroy();&lt;br /&gt;
unregisterReceiver(mUninstallReceiver);&lt;br /&gt;
</code></pre>

<p>}
[/code]
</p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/03/adding-checkbox-to-the-listview/">向ListView中添加CheckBox</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-03T14:30:01+08:00" pubdate data-updated="true">Jun 3<sup>rd</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>修改list_item.xml文件，添加CheckBox控件：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"&lt;br /&gt;
</span><span class='line'>    android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>    android:layout_height="wrap_content"&gt;
</span><span class='line'>    &lt;ImageView&lt;br /&gt;
</span><span class='line'>        android:id="@+id/app_icon"&lt;br /&gt;
</span><span class='line'>        android:layout_gravity="center_vertical"&lt;br /&gt;
</span><span class='line'>        android:layout_width="32.0dip"&lt;br /&gt;
</span><span class='line'>        android:layout_height="32.0dip"&lt;br /&gt;
</span><span class='line'>        android:layout_marginLeft="3.0dip"&lt;br /&gt;
</span><span class='line'>        android:layout_marginRight="3.0dip" /&gt;
</span><span class='line'>    &lt;LinearLayout&lt;br /&gt;
</span><span class='line'>        android:orientation="vertical"&lt;br /&gt;
</span><span class='line'>        android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>        android:layout_height="wrap_content"&lt;br /&gt;
</span><span class='line'>        android:layout_weight="1.0"&gt;
</span><span class='line'>        &lt;TextView&lt;br /&gt;
</span><span class='line'>            android:id="@+id/app_title"&lt;br /&gt;
</span><span class='line'>            android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>            android:layout_height="wrap_content"&lt;br /&gt;
</span><span class='line'>            android:textSize="16.0dip"&lt;br /&gt;
</span><span class='line'>            android:textStyle="bold" /&gt;
</span><span class='line'>        &lt;TextView&lt;br /&gt;
</span><span class='line'>            android:id="@+id/app_package"&lt;br /&gt;
</span><span class='line'>            android:layout_width="fill_parent"&lt;br /&gt;
</span><span class='line'>            android:layout_height="wrap_content"&lt;br /&gt;
</span><span class='line'>            android:textSize="13.0dip" /&gt;
</span><span class='line'>    &lt;/LinearLayout&gt;
</span><span class='line'>    &lt;CheckBox&lt;br /&gt;
</span><span class='line'>        android:id="@+id/app_select"&lt;br /&gt;
</span><span class='line'>        android:layout_width="wrap_content"&lt;br /&gt;
</span><span class='line'>        android:layout_height="wrap_content"&lt;br /&gt;
</span><span class='line'>        android:focusable="false"&lt;br /&gt;
</span><span class='line'>        android:focusableInTouchMode="false"&lt;br /&gt;
</span><span class='line'>        android:clickable="false"&lt;br /&gt;
</span><span class='line'>        android:checkMark="?android:attr/listChoiceIndicatorMultiple" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>


<p>android:focusable=&ldquo;false&rdquo;<br />
android:focusableInTouchMode=&ldquo;false&rdquo;<br />
android:clickable=&ldquo;false&rdquo;<br />
上面三句话很重要，如果不加会出现一些奇怪的错误。</p>

<p>原因：加入CheckBox后，在程序运行过程中会发现整个ListView无法响应onItemClick，onItemLongClick或是onCreateContextMenu事件。原因在于CheckBox是拥有焦点的，它的优先级比ListItem的焦点优先级更高，于是屏蔽了ListItem的点击事件。解决方法是让CheckBox不能获得焦点。android:focusable=&ldquo;false&#8221;就是做这个的。</p>

<p>修改整个SimpleIconAdapter类为以下内容：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class SimpleIconAdapter extends BaseAdapter {&lt;br /&gt;
</span><span class='line'>    private LayoutInflater mInflater;&lt;br /&gt;
</span><span class='line'>    private List&lt;? extends Map&lt;String, ?&gt;&gt; mData;
</span><span class='line'>
</span><span class='line'>    public SimpleIconAdapter(Context context, List&lt;? extends Map&lt;String, ?&gt;&gt; data) {&lt;br /&gt;
</span><span class='line'>        mInflater = LayoutInflater.from(context);&lt;br /&gt;
</span><span class='line'>        mData = data;&lt;br /&gt;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override&lt;br /&gt;
</span><span class='line'>    public int getCount() {&lt;br /&gt;
</span><span class='line'>        return mData.size();&lt;br /&gt;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override&lt;br /&gt;
</span><span class='line'>    public Object getItem(int position) {&lt;br /&gt;
</span><span class='line'>        return mData.get(position);&lt;br /&gt;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override&lt;br /&gt;
</span><span class='line'>    public long getItemId(int position) {&lt;br /&gt;
</span><span class='line'>        return position;&lt;br /&gt;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @SuppressWarnings({ "rawtypes", "unchecked" })&lt;br /&gt;
</span><span class='line'>    @Override&lt;br /&gt;
</span><span class='line'>    public View getView(int position, View convertView, ViewGroup parent) {&lt;br /&gt;
</span><span class='line'>        View view;&lt;br /&gt;
</span><span class='line'>        if (convertView != null) {&lt;br /&gt;
</span><span class='line'>            view = convertView;&lt;br /&gt;
</span><span class='line'>        } else {&lt;br /&gt;
</span><span class='line'>            view = mInflater.inflate(R.layout.list_item, parent, false);&lt;br /&gt;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        Map map = (Map)getItem(position);&lt;br /&gt;
</span><span class='line'>        TextView tv = (TextView)view.findViewById(R.id.app_title);&lt;br /&gt;
</span><span class='line'>        tv.setText((String)map.get("app_title"));
</span><span class='line'>
</span><span class='line'>        tv = (TextView)view.findViewById(R.id.app_package);&lt;br /&gt;
</span><span class='line'>        tv.setText((String)map.get("app_package"));
</span><span class='line'>
</span><span class='line'>        ImageView iv = (ImageView)view.findViewById(R.id.app_icon);&lt;br /&gt;
</span><span class='line'>        iv.setImageDrawable((Drawable)map.get("app_icon"));
</span><span class='line'>
</span><span class='line'>        CheckBox cb = (CheckBox)view.findViewById(R.id.app_select);&lt;br /&gt;
</span><span class='line'>        if ((Boolean)map.get("app_select") ==  null) {&lt;br /&gt;
</span><span class='line'>            map.put("app_select", false);&lt;br /&gt;
</span><span class='line'>        }&lt;br /&gt;
</span><span class='line'>        cb.setChecked((Boolean)map.get("app_select"));
</span><span class='line'>
</span><span class='line'>        return view;&lt;br /&gt;
</span><span class='line'>    }&lt;br /&gt;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>再就是修改主文件：<br /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class Main extends Activity {&lt;br /&gt;
</span><span class='line'>    ...
</span><span class='line'>
</span><span class='line'>    @Override&lt;br /&gt;
</span><span class='line'>    public void onCreate(Bundle savedInstanceState) {&lt;br /&gt;
</span><span class='line'>        super.onCreate(savedInstanceState);&lt;br /&gt;
</span><span class='line'>        setContentView(R.layout.main);
</span><span class='line'>
</span><span class='line'>        mListView = (ListView)findViewById(R.id.list_view);&lt;br /&gt;
</span><span class='line'>        mListData = new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;();&lt;br /&gt;
</span><span class='line'>        mAdapter = new SimpleIconAdapter(this, mListData);&lt;br /&gt;
</span><span class='line'>        mListView.setAdapter(mAdapter);&lt;br /&gt;
</span><span class='line'>        mListView.setItemsCanFocus(false);&lt;br /&gt;
</span><span class='line'>        mListView.setChoiceMode(ListView.CHOICE_MODE_MULTIPLE);&lt;br /&gt;
</span><span class='line'>        mListView.setOnItemClickListener(new OnItemClickListener() {&lt;br /&gt;
</span><span class='line'>            @SuppressWarnings({ "unchecked", "rawtypes" })&lt;br /&gt;
</span><span class='line'>            @Override&lt;br /&gt;
</span><span class='line'>            public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {&lt;br /&gt;
</span><span class='line'>                // 这里如此处理是因为当选中CheckBox，滚动ListView的时候，会出现一些&lt;br /&gt;
</span><span class='line'>                // CheckBox选择错位的现象，所以在选择CheckBox时，记下其状态，然后在&lt;br /&gt;
</span><span class='line'>                // getView方法中进行设置。&lt;br /&gt;
</span><span class='line'>                // 原因：&lt;br /&gt;
</span><span class='line'>                // ListView中的getChildCount()并不总是等于Adapter中的数据行数。当手&lt;br /&gt;
</span><span class='line'>                // 机一屏显示不了所有数据时（需要翻页），getChildCount()就等于一屏&lt;br /&gt;
</span><span class='line'>                // 所显示的行数（一般为10），小于Adapter中的数据行数。而ListView的&lt;br /&gt;
</span><span class='line'>                // getCount()与Adapter中的数据行数相等。&lt;br /&gt;
</span><span class='line'>                // 当光标下移到屏幕最底部，新显示出来的View，在调用Adapter的getView&lt;br /&gt;
</span><span class='line'>                // 方法中，会判断convertView为null，而再有新的View显示就会发现&lt;br /&gt;
</span><span class='line'>                // convertView不为空，所以新显示的View其实使用了之前某个View的对象。&lt;br /&gt;
</span><span class='line'>                // 这就造成了状态可能混乱。比如第一行的CheckBox点选时，第11行的也同&lt;br /&gt;
</span><span class='line'>                // 时会被点选。&lt;br /&gt;
</span><span class='line'>                CheckBox cb = (CheckBox)view.findViewById(R.id.app_select);&lt;br /&gt;
</span><span class='line'>                cb.toggle();&lt;br /&gt;
</span><span class='line'>                ((Map)mListData.get(position)).put("app_select", cb.isChecked());&lt;br /&gt;
</span><span class='line'>            }&lt;br /&gt;
</span><span class='line'>        });
</span><span class='line'>
</span><span class='line'>        mProgressDialog = ProgressDialog.show(this, "Wait", "loading...");&lt;br /&gt;
</span><span class='line'>        new Thread() {&lt;br /&gt;
</span><span class='line'>            @Override&lt;br /&gt;
</span><span class='line'>            public void run() {&lt;br /&gt;
</span><span class='line'>                mListData.addAll(getInstalledApps(false));&lt;br /&gt;
</span><span class='line'>                mHandler.sendEmptyMessage(0);&lt;br /&gt;
</span><span class='line'>            }&lt;br /&gt;
</span><span class='line'>        }.start();&lt;br /&gt;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    ...&lt;br /&gt;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/17/problem-with-nokogiri-when-url-containing-chinese-character/">Nokogiri抓取页面URL含有中文参数的问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/09/logic-problems-how-many-sick-dogs/">逻辑题-几条病狗</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/07/debugging-rails-with-pry/">使用Pry调试Rails项目</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/06/raspberry-pi-wifi-with-static-ip-address/">Raspberry Pi使用无线网卡</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/28/how-i-made-ruby-script-156x-faster/">我是如何让Ruby脚本速度提升156倍的</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://dohkoos.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 133%" href="/tags/android/">Android</a>
<a style="font-size: 111%" href="/tags/crack/">Crack</a>
<a style="font-size: 108%" href="/tags/database/">Database</a>
<a style="font-size: 105%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 132%" href="/tags/java/">Java</a>
<a style="font-size: 97%" href="/tags/listview/">ListView</a>
<a style="font-size: 108%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 116%" href="/tags/powerbuilder/">PowerBuilder</a>
<a style="font-size: 120%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 101%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 101%" href="/tags/struts/">Struts</a>
<a style="font-size: 97%" href="/tags/ubuntu/">Ubuntu</a>
<a style="font-size: 105%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 108%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://quake.iteye.com/">写程序的70后</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dohkoos';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
