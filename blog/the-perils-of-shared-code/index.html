
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>共享代码的风险 - 乐者为王</title>
  <meta name="author" content="dohkoos">

  
  <meta name="description" content="英文原文：https://www.innoq.com/en/blog/the-perils-of-shared-code/
https://gold.xitu.io/entry/58491d3b8e450a006aae7b4f 通往地狱的道路往往是由良好的意愿铺就。在各种软件项目中， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://codemany.com/blog/the-perils-of-shared-code/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="乐者为王" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46570161-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">乐者为王</a></h1>
  
    <h2>Do one thing, and do it well.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="codemany.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">共享代码的风险</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-25T18:51:10+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:51 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>英文原文：<a href="https://www.innoq.com/en/blog/the-perils-of-shared-code/">https://www.innoq.com/en/blog/the-perils-of-shared-code/</a>
<a href="https://gold.xitu.io/entry/58491d3b8e450a006aae7b4f">https://gold.xitu.io/entry/58491d3b8e450a006aae7b4f</a></p>

<p>通往地狱的道路往往是由良好的意愿铺就。在各种软件项目中，我看到人们走在这样的道路上，他们在微服务间借助于库共享代码。在几乎每个组织支持微服务架构的项目中，各个团队和开发者都期望以某些核心库为基础构建他们的微服务。显然，即使可能带来的问题已经被知道很长时间了，很多人仍然不知道它们。在这篇博文中，我想研究为什么使用这样的库可能起初听起来有吸引力，为什么可能会出现问题，以及如何能够减轻这些问题。</p>

<h3 id="共享代码的目的">共享代码的目的</h3>

<p>通过库来共享代码有两个主要目的：共享领域逻辑和共享基础设施层中的抽象。</p>

<ol>
<li><p><em>共享的领域模型：</em> A specific part of the domain model is common between two or more Bounded Contexts, so instead of implementing it again and again, you eliminate the need for repetition and the possibility of introducing inconsistent implementations of this domain logic. Usually, the parts of the domain model that people want to share like that are the core domain or one or more generic subdomains. In domain-driven design lingo, this is also called a Shared Kernel. Often, you would find concepts like a Session, and authentication logic, in here, but it’s not limited to that. A related approach is the Canonical Data Model.</p></li>
<li><p><em>基础设施层抽象：</em> 你想避免一次又一次地实现基础设施层的有用抽象，因此你把它们放进一个库里。通常，这些库在数据库访问、消息传递和序列化等方面提供一套统一的方法。</p></li>
</ol>

<p>两者的动机是相同的——避免重复，也就是说，遵循DRY原则（Don’t repeat yourself!）。一旦实现这些逻辑有几个好处：</p>

<blockquote>
<p>你不需要花费宝贵的时间致力于那些已经被解决的问题。</p>

<p>有一套统一的方式做消息传递、数据库访问等。这意味着，当开发者需要去阅读和修改其他开发者最初创建的微服务中的代码时，他们很容易找到他们的方式。</p>

<p>关于彼此行为略有不同的业务逻辑或基础设施关注点，你不想有不同的实现。取而代之的是，有一套做正确事情的规范实现。</p>
</blockquote>

<h3 id="共享代码的问题">共享代码的问题</h3>

<p>What may sound great in theory doesn’t come without its own problems, and those problems are probably more painful than the ones you are trying to solve with your library. Stefan Tilkov has already explained in detail <a href="https://www.innoq.com/en/blog/thoughts-on-a-canonical-data-model/">why you should avoid a canonical data model</a>. In addition to that, let me point out a few other issues.</p>

<h4 id="分布式单体">分布式单体</h4>

<p>Often, there seems to be an implicit assumption that putting things into a library means that you never have to worry about services using a wrong or outdated implementation, because they simply need to update their dependency on the library to the latest version.</p>

<p>Whenever you rely on being able to change some behaviour consistently across all your microservices by updating them all to the same new version of your library, you introduce a strong coupling between them. You lose one major benefit of microservices, the ability to have them evolve and to deploy them independently from each other.</p>

<p>I have seen cases where all the services had to be deployed together in order for things to still work properly. If you reach this state, there is no denying that you have actually built a distributed monolith.</p>

<p>A popular example is to use code generation based, for instance, on a Swagger description of your service API, in order to provide a client library for your service. More often than you may think, developers are tempted to abuse this for making breaking changes, because dependent services “just” need to use a new version of their client library. This is not how you <a href="http://olivergierke.de/2016/10/evolving-distributed-systems/">evolve a distributed system</a>.</p>

<h4 id="依赖地狱">依赖地狱</h4>

<p>Libraries, especially those that are designed to provide a common solution to infrastructure concerns, often have an additional problem: They come with a whole bag of additional libraries they depend on. The bigger the transitive dependency tree of your library, the higher the probability that it will lead to the nightmare commonly known as dependency hell. Since your microservices will likely need their own additional dependencies, which again have transitive dependencies, it is only a matter of time until some of them transitively pull in conflicting versions of some library, and simply choosing between the different versions will be impossible, because they are binary incompatible.</p>

<p>Of course, your solution might be to simply provide all the libraries your microservices could possibly need as dependencies of your core library. That still means that your microservices cannot evolve independently, for example by upgrading to a later version of only a specific library they depend on – they are all in lockstep with the release cycle of your core library. Apart from that, why would you force a whole bunch of dependencies on every service when in fact they probably only need a few of them?</p>

<h4 id="自上而下的库设计">自上而下的库设计</h4>

<p>More often than not, the libraries I have seen were forced upon the developers by one or more architects, taking a top-down approach to library design.</p>

<p>Usually, what happens in this case is that the APIs that are exposed by the library are too restrictive and inflexible, or use the wrong level of abstraction, because they are designed by people who are not familiar enough with the wide spectrum of different real-world use cases. Such a library often leads to frustration among the developers that have to live with it, and to people trying to work around the limitations of the library.</p>

<h4 id="单语言解决一切">单语言解决一切</h4>

<p>One of the most obvious drawbacks that come with enforcing libraries is that this makes it even harder to switch to a different programming language (or platform, like the JVM or .NET), again losing one advantage of a microservices architecture, the ability to choose the technology that fits best for a given problem. If you later on realise that you need this kind of language or platform diversity after all, you have to do invent all kinds of weird crutches. For instance, Netflix came up with <a href="https://github.com/Netflix/Prana">Prana</a>, a sidecar that runs along side non-JVM services, providing them an HTTP API to the Netflix technology stack.</p>

<h3 id="我们能不能做得更好？">我们能不能做得更好？</h3>

<p>With all the problems introduced by sharing code via libraries, the most extreme solution is to simply have no such library at all. If you do that, you will have to do some copy-and-paste or provide a template project for new microservices in order to liberate your services from the lockstep described above. This can be done both for infrastructure code as well as for the shared kernel of your domain model. In fact, in his classic blue book on domain-driven design, Eric Evans mentioned that usually, “teams make changes on separate copies of the KERNEL, integrating with the other team at intervals”[1]. The shared kernel does not necessarily have to be a library.</p>

<p>If you don’t like the idea of copy and paste, that’s fine as well. After all, as mentioned above, there are definite advantages to sharing code through libraries. Here are some important things to consider in this case:</p>

<h4 id="最少依赖的小型库">最少依赖的小型库</h4>

<p>Try to split up your big shared library into a set of very small, highly focussed libraries, each of them solving one specific problem. Try to make these libraries zero-dependency libraries, only relying on the language’s standard library. Yes, it’s not always enjoyable to program only against your languge’s standard library, but the tremendous benefits for all the teams in your company (or even beyond your company, if your library is open source) clearly outweigh this minor inconvenience.</p>

<p>Of course, zero dependencies is not always possible, especially for infrastructure concerns. For these, minimize the dependencies required by each of your small libraries. Also, sometimes it can make sense to provide a binding or integration with another library as a separate artifact, independently from the core of your library.</p>

<h4 id="留下选择余地">留下选择余地</h4>

<p>Never rely on the fact that services will update to the latest version of your shared library at a specific point in time. In other words, don’t force library updates on teams, but give them the freedom to update at their own pace. This may require you to change your library in backward and forward compatible ways, but it decouples your services, giving you not only the operational costs of a microservices architecture, but also some of the benefits.</p>

<p>If possible, avoid not only forced library upates, but make the usage of your library itself optional.</p>

<h4 id="自下而上的库设计">自下而上的库设计</h4>

<p>Finally, if you want to have shared libraries, successful projects I have seen were using a bottom-up approach. Instead of having ivory tower architects design libraries that are hardly usable in the real-world, have your teams implement their microservices, and when some common patterns emerge that have proven themselves in production in multiple services, extract them into a library.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">dohkoos</span></span>

      




<time class='entry-date' datetime='2016-11-25T18:51:10+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:51 pm</span></time>
      


      

<span class="tags">
  
    <a class='tag' href='/tags/software-engineering/'>Software Engineering</a>, <a class='tag' href='/tags/translation/'>Translation</a>
  
</span>


    </p>
    
  <h3>Related Posts</h3>
  <ul class="posts">
  
    <li class="related">
      <a href="/blog/why-we-cant-estimate-software-project-the-same-way-we-estimate-houses/">为什么我们不能用估算房屋同样的方法估算软件项目</a>
    </li>
  
    <li class="related">
      <a href="/blog/how-to-avoid-the-project-is-always-90-percent-done/">如何避免项目总是完成90%</a>
    </li>
  
    <li class="related">
      <a href="/blog/why-should-software-modeling/">为什么要软件建模</a>
    </li>
  
    <li class="related">
      <a href="/blog/the-power-of-protocol-analyzers/">协议分析器的威力</a>
    </li>
  
    <li class="related">
      <a href="/blog/how-to-create-effective-icons/">如何创建有效的图标</a>
    </li>
  
  </ul>


    
      <div id="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share/" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v2.jiathis.com/code/jia.js" charset="utf-8"></script>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/reading-notes-the-definitive-antlr4-reference-part30/" title="Previous Post: ANTLR 4权威参考读书笔记（30）">&laquo; ANTLR 4权威参考读书笔记（30）</a>
      
      
        <a class="basic-alignment right" href="/blog/chess-mess-master-development-record-part1/" title="Next Post: 象棋残局大师开发实录（1）">象棋残局大师开发实录（1） &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/how-to-modify-hosts-in-android/">如何修改Android的hosts文件</a>
      </li>
    
      <li class="post">
        <a href="/blog/chess-mess-master-development-record-part2/">象棋残局大师开发实录（2）</a>
      </li>
    
      <li class="post">
        <a href="/blog/chess-mess-master-development-record-part1/">象棋残局大师开发实录（1）</a>
      </li>
    
      <li class="post">
        <a href="/blog/the-perils-of-shared-code/">共享代码的风险</a>
      </li>
    
      <li class="post">
        <a href="/blog/reading-notes-the-definitive-antlr4-reference-part30/">ANTLR 4权威参考读书笔记（30）</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Recent Comments</h1>
  <div class="dsq-widget">
    <script type="text/javascript" src="http://codemany.disqus.com/recent_comments_widget.js"></script>
  </div>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 144%" href="/tags/antlr/">ANTLR</a>
<a style="font-size: 107%" href="/tags/algorithm/">Algorithm</a>
<a style="font-size: 135%" href="/tags/android/">Android</a>
<a style="font-size: 104%" href="/tags/c-plus-plus/">C++</a>
<a style="font-size: 107%" href="/tags/css/">CSS</a>
<a style="font-size: 110%" href="/tags/crack/">Crack</a>
<a style="font-size: 107%" href="/tags/database/">Database</a>
<a style="font-size: 97%" href="/tags/eclipse/">Eclipse</a>
<a style="font-size: 115%" href="/tags/git/">Git</a>
<a style="font-size: 97%" href="/tags/html/">HTML</a>
<a style="font-size: 104%" href="/tags/jbookshelf/">JBookShelf</a>
<a style="font-size: 148%" href="/tags/java/">Java</a>
<a style="font-size: 101%" href="/tags/javascript/">JavaScript</a>
<a style="font-size: 97%" href="/tags/listview/">ListView</a>
<a style="font-size: 104%" href="/tags/mysql/">MySQL</a>
<a style="font-size: 97%" href="/tags/paperclip/">Paperclip</a>
<a style="font-size: 119%" href="/tags/powerbuilder/">PowerBuilder</a>
<a style="font-size: 101%" href="/tags/powerscript/">PowerScript</a>
<a style="font-size: 117%" href="/tags/qianbao/">Qianbao</a>
<a style="font-size: 150%" href="/tags/rails/">Rails</a>
<a style="font-size: 119%" href="/tags/ruby/">Ruby</a>
<a style="font-size: 97%" href="/tags/spring/">Spring</a>
<a style="font-size: 101%" href="/tags/struts/">Struts</a>
<a style="font-size: 137%" href="/tags/translation/">Translation</a>
<a style="font-size: 97%" href="/tags/ubuntu/">Ubuntu</a>
<a style="font-size: 107%" href="/tags/windows-server-2008/">Windows Server 2008</a>
<a style="font-size: 107%" href="/tags/wxwidgets/">wxWidgets</a>

  </ul>
</section>
<section>
  <h1>Blogroll</h1>
  <ul>
    <li><a href="http://mindhacks.cn/">刘未鹏MIND HACKS</a></li>
    <li><a href="http://www.importnew.com/">ImportNew</a></li>
    <li><a href="http://ifeve.com/">并发编程网</a></li>
    <li><a href="http://codingnow.com/">云风的 BLOG</a></li>
    <li><a href="http://dbanotes.net/">DBA Notes</a></li>
    <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
    <li><a href="http://advdbg.org/">高端调试</a></li>
    <li><a href="http://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualization</a></li>
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dohkoos">@dohkoos</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dohkoos',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
  <div>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</div>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - dohkoos -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemany';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://codemany.com/blog/the-perils-of-shared-code/';
        var disqus_url = 'http://codemany.com/blog/the-perils-of-shared-code/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
