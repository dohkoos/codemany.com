<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Ajax | 乐者为王]]></title>
  <link href="http://codemany.com/tags/ajax/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2014-08-25T12:59:46+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails无刷新异步上传文件]]></title>
    <link href="http://codemany.com/blog/2011/03/08/rails-to-upload-files-asynchronously-without-refreshing/"/>
    <updated>2011-03-08T16:09:31+08:00</updated>
    <id>http://codemany.com/blog/2011/03/08/rails-to-upload-files-asynchronously-without-refreshing</id>
    <content type="html"><![CDATA[<p><code>
rails upload&lt;br /&gt;
cd upload&lt;br /&gt;
script/plugin install git://github.com/thoughtbot/paperclip.git&lt;br /&gt;
script/plugin install git://github.com/markcatley/responds_to_parent.git&lt;br /&gt;
script/generate scaffold user name:string&lt;br /&gt;
script/generate paperclip user avatar&lt;br /&gt;
rake db:migrate&lt;br /&gt;
</code></p>

<p>在user.rb中增加：<br />
```
  has_attached_file :avatar, :url => "/uploads/:basename.:extension"<br />
  validates_attachment_presence :avatar<br />
  validates_attachment_content_type :avatar,<br /></p>

<pre><code>:content_type =&gt; ['image/jpeg', 'image/jpg', 'image/png']&lt;br /&gt;
</code></pre>

<p>  validates_attachment_size :avatar, :less_than => 1.megabytes<br />
```</p>

<p>修改views/users/new.html.erb文件：<br />
```
&lt;% form_for(@user, :url => users_path(:format => 'js'),<br />
  :html => {:id => 'upload_form', :multipart => true, :target => 'upload_frame'}) do |f| %>
  &lt;%= f.error_messages %></p>

<p>  <p></p>

<pre><code>&lt;%= f.label :name %&gt;&lt;br /&gt;
&lt;%= f.text_field :name %&gt;
</code></pre>

<p>  </p>
  <p></p>

<pre><code>&lt;%= f.label :avatar %&gt;&lt;br /&gt;
&lt;%= f.file_field :avatar %&gt;
&lt;div id="avatar"&gt;
&lt;% if @user.avatar.exists? %&gt;
  &lt;%= image_tag @user.avatar.url(:medium) %&gt;
&lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<p>  </p>
  <p></p>

<pre><code>&lt;%= f.submit 'Create' %&gt;
</code></pre>

<p>  </p>
&lt;% end %></p>

<iframe id="upload_frame" name="upload_frame" style="display: none;"></iframe>


<p>```</p>

<p>当点击submit按钮后，表单被提交到隐藏的iframe，相应的action被执行，执行结果会被返回给隐藏的iframe，我们需要上传后结果能返回到母窗口，这就是responds_to_parent插件提供的功能。</p>

<p>在views/layouts/user.html.erb中增加：<br />
<code>
&lt;%= javascript_include_tag :defaults %&gt;
</code></p>

<p>修改users_controller.rb中的create方法，增加：<br />
```
format.js do<br />
  flash[:notice] = 'avatar created'<br />
  responds_to_parent do<br /></p>

<pre><code>render :update do |page|&lt;br /&gt;
  page.replace_html :avatar, image_tag(@user.avatar.url(:medium))&lt;br /&gt;
  page['upload_form'].reset&lt;br /&gt;
end&lt;br /&gt;
</code></pre>

<p>  end<br />
end<br />
```</p>
]]></content>
  </entry>
  
</feed>
