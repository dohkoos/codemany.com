<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Ajax | 乐者为王]]></title>
  <link href="http://codemany.com/tags/ajax/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2015-01-10T13:42:41+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails 2.3和Paperclip实现无刷新异步上传文件]]></title>
    <link href="http://codemany.com/blog/upload-file-asynchronously-without-refresh-with-paperclip-rails-23/"/>
    <updated>2011-03-08T16:09:31+08:00</updated>
    <id>http://codemany.com/blog/upload-file-asynchronously-without-refresh-with-paperclip-rails-23</id>
    <content type="html"><![CDATA[<pre><code>rails upload
cd upload
script/plugin install git://github.com/thoughtbot/paperclip.git
script/plugin install git://github.com/markcatley/responds_to_parent.git
script/generate scaffold user name:string
script/generate paperclip user avatar
rake db:migrate
</code></pre>

<p>在user.rb中增加：</p>

<pre><code>  has_attached_file :avatar, :url =&gt; "/uploads/:basename.:extension"
  validates_attachment_presence :avatar
  validates_attachment_content_type :avatar,
    :content_type =&gt; ['image/jpeg', 'image/jpg', 'image/png']
  validates_attachment_size :avatar, :less_than =&gt; 1.megabytes
</code></pre>

<p>修改views/users/new.html.erb文件：</p>

<p>&#8220;`
&lt;% form_for(@user, :url => users_path(:format => &lsquo;js&rsquo;),
      :html => { :id => &lsquo;upload_form&rsquo;, :multipart => true, :target => &lsquo;uframe&rsquo; }) do |f| %>
  &lt;%= f.error_messages %></p>

<p>  <p>
    &lt;%= f.label :name %><br />
    &lt;%= f.text_field :name %>
  </p>
  <p>
    &lt;%= f.label :avatar %><br />
    &lt;%= f.file_field :avatar %>
    <div id="avatar">
    &lt;% if @user.avatar.exists? %>
      &lt;%= image_tag @user.avatar.url(:medium) %>
    &lt;% end %>
    </div>
  </p>
  <p>
    &lt;%= f.submit &lsquo;Create&rsquo; %>
  </p>
&lt;% end %></p>

<iframe id="uframe" name="uframe" style="display: none;"></iframe>


<pre><code>
当点击submit按钮后，表单被提交到隐藏的iframe，相应的action被执行，执行结果会被返回给隐藏的iframe，我们需要上传后结果能返回到母窗口，这就是responds_to_parent插件提供的功能。

在views/layouts/user.html.erb中增加：
</code></pre>

<p>&lt;%= javascript_include_tag :defaults %>
&#8220;`</p>

<p>修改users_controller.rb中的create方法，增加：</p>

<pre><code>format.js do
  flash[:notice] = 'avatar created'
  responds_to_parent do
    render :update do |page|
      page.replace_html :avatar, image_tag(@user.avatar.url(:medium))
      page['upload_form'].reset
    end
  end
end
</code></pre>
]]></content>
  </entry>
  
</feed>
