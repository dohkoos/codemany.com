<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Ajax | 乐者为王]]></title>
  <link href="http://codemany.com/tags/ajax/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2014-11-01T15:23:01+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails 2.3和Paperclip实现无刷新异步上传文件]]></title>
    <link href="http://codemany.com/blog/upload-file-asynchronously-without-refresh-with-paperclip-rails-23/"/>
    <updated>2011-03-08T16:09:31+08:00</updated>
    <id>http://codemany.com/blog/upload-file-asynchronously-without-refresh-with-paperclip-rails-23</id>
    <content type="html"><![CDATA[<p><code>
rails upload
cd upload
script/plugin install git://github.com/thoughtbot/paperclip.git
script/plugin install git://github.com/markcatley/responds_to_parent.git
script/generate scaffold user name:string
script/generate paperclip user avatar
rake db:migrate
</code></p>

<p>在user.rb中增加：</p>

<p>```
  has_attached_file :avatar, :url => "/uploads/:basename.:extension"
  validates_attachment_presence :avatar
  validates_attachment_content_type :avatar,</p>

<pre><code>:content_type =&gt; ['image/jpeg', 'image/jpg', 'image/png']
</code></pre>

<p>  validates_attachment_size :avatar, :less_than => 1.megabytes
```</p>

<p>修改views/users/new.html.erb文件：</p>

<p>```
&lt;% form_for(@user, :url => users_path(:format => 'js'),</p>

<pre><code>  :html =&gt; {:id =&gt; 'upload_form', :multipart =&gt; true, :target =&gt; 'uframe'}) do |f| %&gt;
</code></pre>

<p>  &lt;%= f.error_messages %></p>

<p>  <p></p>

<pre><code>&lt;%= f.label :name %&gt;&lt;br /&gt;
&lt;%= f.text_field :name %&gt;
</code></pre>

<p>  </p>
  <p></p>

<pre><code>&lt;%= f.label :avatar %&gt;&lt;br /&gt;
&lt;%= f.file_field :avatar %&gt;
&lt;div id="avatar"&gt;
&lt;% if @user.avatar.exists? %&gt;
  &lt;%= image_tag @user.avatar.url(:medium) %&gt;
&lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<p>  </p>
  <p></p>

<pre><code>&lt;%= f.submit 'Create' %&gt;
</code></pre>

<p>  </p>
&lt;% end %></p>

<iframe id="uframe" name="uframe" style="display: none;"></iframe>


<p>```</p>

<p>当点击submit按钮后，表单被提交到隐藏的iframe，相应的action被执行，执行结果会被返回给隐藏的iframe，我们需要上传后结果能返回到母窗口，这就是responds_to_parent插件提供的功能。</p>

<p>在views/layouts/user.html.erb中增加：</p>

<p><code>
&lt;%= javascript_include_tag :defaults %&gt;
</code></p>

<p>修改users_controller.rb中的create方法，增加：</p>

<p>```
format.js do
  flash[:notice] = 'avatar created'
  responds_to_parent do</p>

<pre><code>render :update do |page|
  page.replace_html :avatar, image_tag(@user.avatar.url(:medium))
  page['upload_form'].reset
end
</code></pre>

<p>  end
end
```</p>
]]></content>
  </entry>
  
</feed>
