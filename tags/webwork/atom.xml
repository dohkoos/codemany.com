<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: WebWork | 乐者为王]]></title>
  <link href="http://codemany.com/tags/webwork/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2014-11-11T13:54:53+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[如何在WebWork的资源文件中获取验证字段的值]]></title>
    <link href="http://codemany.com/blog/how-to-obtain-verification-field-value-in-resource-file-of-webwork/"/>
    <updated>2006-03-30T14:56:37+08:00</updated>
    <id>http://codemany.com/blog/how-to-obtain-verification-field-value-in-resource-file-of-webwork</id>
    <content type="html"><![CDATA[<p>WebWork是一个非常不错的MVC框架，有着众多的优点，也有着细微的缺陷。在实现一个用户注册验证的例子时，发现在资源文件中不能获取验证字段的值，只能每个字段一个message。</p>

<pre><code>class User {
    private String username;
    private String password;
</code></pre>

<pre><code>&lt;field name="username"&gt;
    &lt;field-validator type="stringlength" short-circuit="true"&gt;
        &lt;param name="minLength"&gt;5&lt;/param&gt;
        &lt;param name="maxLength"&gt;15&lt;/param&gt;
        &lt;message key="errors.username.range" /&gt;
    &lt;/field-validator&gt;
&lt;/field&gt;

&lt;field name="password"&gt;
    &lt;field-validator type="stringlength" short-circuit="true"&gt;
        &lt;param name="minLength"&gt;5&lt;/param&gt;
        &lt;param name="maxLength"&gt;15&lt;/param&gt;
        &lt;message key="errors.password.range" /&gt;
    &lt;/field-validator&gt;
&lt;/field&gt;
</code></pre>

<p>资源文件中的消息内容：</p>

<pre><code>errors.username.range=${username} is not in the range ${minLength} through ${maxLength}.
errors.password.range=${password} is not in the range ${minLength} through ${maxLength}.
</code></pre>

<p>到xwork的站点上去查找解决方法，在Issue Tracker里看到有人提交了一个<a href="http://jira.opensymphony.com/browse/XW-184">Feature</a>，采用的办法是给message传递参数，看了xwork的代码后，发现这样子的做法要修改的代码量非常大，所以只能另外想办法解决。</p>

<p>在资源文件中可以用${fieldName}来获取要验证的字段变量名，那是否可以用${fieldValue}来得到验证字段的值呢？查看代码后发现这种办法行不通。那么是否可以用${${fieldName}}来获得字段变量的值呢？查看代码发现验证失败后会调用Validator.getMessage()方法，追踪代码来到TextParseUtil.translateVariables()方法中，找到代码：</p>

<pre><code>while (start != -1 &amp;&amp; x &lt; length &amp;&amp; count != 0) {    // 该部分代码负责查找变量，即${}包围的字符串
    c = expression.charAt(x++);
    if (c == '{') {
        count++;
    } else if (c == '}') {
        count--;
    }
}
end = x - 1;

if ((start != -1) &amp;&amp; (end != -1) &amp;&amp; (count == 0)) {
    String var = expression.substring(start + 2, end);

    Object o = stack.findValue(var, asType);    // 此处就是获取变量值的地方

    String left = expression.substring(0, start);
    String right = expression.substring(end + 1);
</code></pre>

<p>由上面的代码可以看出WebWork只处理了最外围的${}，所以要让它处理像${${}}这样的格式就需要在获取变量前再次处理变量。修改后的代码如下：</p>

<pre><code>if ((start != -1) &amp;&amp; (end != -1) &amp;&amp; (count == 0)) {
    String nestedExpression = expression.substring(start + 2, end);
    String var = translateVariables(nestedExpression, stack);
    //String var = expression.substring(start + 2, end);

    Object o = stack.findValue(var, asType);

    String left = expression.substring(0, start);
    String right = expression.substring(end + 1);
</code></pre>

<p>现在就可以处理资源文件中的多重嵌套变量了。接着把修改验证文件和资源文件修改一下就可以了。</p>

<pre><code>&lt;field name="username"&gt;
    &lt;field-validator type="stringlength" short-circuit="true"&gt;
        &lt;param name="minLength"&gt;5&lt;/param&gt;
        &lt;param name="maxLength"&gt;15&lt;/param&gt;
        &lt;message key="errors.range" /&gt;
    &lt;/field-validator&gt;
&lt;/field&gt;

&lt;field name="password"&gt;
    &lt;field-validator type="stringlength" short-circuit="true"&gt;
        &lt;param name="minLength"&gt;5&lt;/param&gt;
        &lt;param name="maxLength"&gt;15&lt;/param&gt;
        &lt;message key="errors.range" /&gt;
    &lt;/field-validator&gt;
&lt;/field&gt;
</code></pre>

<pre><code>errors.range=${${fieldName}} is not in the range ${minLength} through ${maxLength}.
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[让Struts-Menu能访问WebWork的ResourceBundle]]></title>
    <link href="http://codemany.com/blog/allow-struts-menu-to-access-resourcebundle-of-webwork/"/>
    <updated>2006-03-12T07:01:48+08:00</updated>
    <id>http://codemany.com/blog/allow-struts-menu-to-access-resourcebundle-of-webwork</id>
    <content type="html"><![CDATA[<p>Struts-Menu默认是通过JSTL或者Struts来读取ResourceBundle的，这就需要在web.xml中配置要读取的properties文件（JSTL方式）或在struts-config.xml中配置（Struts方式）。
WebWork也有自己的ResourceBundle配置方式，而且Struts-Menu也不支持访问WebWork的ResourceBundle的功能。所以参考着DisplayTag的实现对Struts-Menu进行了一番手术，实现了可访问WebWork的ResourceBundle的功能。</p>

<p>下面是修改步骤：</p>

<ul>
<li>在Struts-Menu项目中增加net/sf/navigator/localization目录，将org.displaytag.localization中的*.java移到该目录中；</li>
<li>将org.displaytag下的Message.java和messages.properties移到net/sf/navigator目录下；</li>
<li>给MenuDisplayerMapping添加两个属性localeResover和ResourceProvider；</li>
<li>在struts-menu.xml的Displayer标签下添加：</li>
</ul>


<pre><code>&lt;setProperty property="localeResover" value="net.sf.navigator.localization.I18nWebworkAdapter" /&gt;
&lt;setProperty property="resourceProvider" value="net.sf.navigator.localization.I18nWebworkAdapter" /&gt;
</code></pre>

<ul>
<li>在MenuDisplayer中添加以下四个接口方法，并在AbstractMenuDisplayer里实现它们：</li>
</ul>


<pre><code>public LocaleResolver getLocaleResolver();
public void setLocaleResolver(LocaleResolver localeResolver);
public I18nResourceProvider getResourceProvider();
public void setResourceProvider(I18nResourceProvider resourceProvider);
</code></pre>

<ul>
<li>在AbstractMenuDisplayer里添加protected的PageContext对象，并在init方法里初始化它；</li>
<li>重写MessageResourcesMenuDisplayer.getMessage方法，代码如下：</li>
</ul>


<pre><code>public String getMessage(String key) {
    String message = null;

    if (resourceProvider != null) {
        message = resourceProvider.getResource(key, "???", null, pageContext);
    }
    if (message == null) {
        message = key;
    }

    return message;
}
</code></pre>

<ul>
<li>在UseMenuDisplayerTag文件里添加代码（+后的代码是增加的）：</li>
</ul>


<pre><code>  // get an instance of the menu displayer
  MenuDisplayer displayerInstance = null;
+ LocaleResolver localeResolver = null;
+ I18nResourceProvider resourceProvider = null;

  // default to use the config on the mapping
  if (displayerMapping.getConfig() != null) {
      // this value (config) is set on the displayer below
      setConfig(displayerMapping.getConfig());
  }
+ localeResolver =
+         (LocaleResolver) Class.forName(displayerMapping.getLocaleResover()).newInstance();
+ resourceProvider =
+         (I18nResourceProvider) Class.forName(displayerMapping.getLocaleProvider()).newInstance();

  displayerInstance.setConfig(config);
+ displayerInstance.setResourceProvider(resourceProvider);
+ displayerInstance.setLocaleResolver(localeResolver);
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WebWork中如何实现i18n]]></title>
    <link href="http://codemany.com/blog/how-to-implement-i18n-in-webwork/"/>
    <updated>2005-11-17T13:57:14+08:00</updated>
    <id>http://codemany.com/blog/how-to-implement-i18n-in-webwork</id>
    <content type="html"><![CDATA[<p>ognl-2.6.5.jar + oscore-2.2.4.jar + webwork-2.1.7.jar + xwork-1.0.5.jar</p>

<p>web.xml配置文件的内容：</p>

<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE web-app PUBLIC
    "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
    "http://java.sun.com/dtd/web-app_2_3.dtd"&gt;

&lt;web-app&gt;
    &lt;display-name&gt;i18n&lt;/display-name&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;action&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.opensymphony.webwork.dispatcher.ServletDispatcher&lt;/servlet-class&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;action&lt;/servlet-name&gt;
        &lt;url-pattern&gt;*.html&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;taglib&gt;
        &lt;taglib-uri&gt;webwork&lt;/taglib-uri&gt;
        &lt;taglib-location&gt;/WEB-INF/webwork.tld&lt;/taglib-location&gt;
    &lt;/taglib&gt;
&lt;/web-app&gt;
</code></pre>

<p>webwork.properties配置文件：</p>

<pre><code>### This can be used to set your locale and encoding scheme
#webwork.locale=en_US    &lt;- 这行一定要注释掉，因为WebWork首先判断webwork.locale有没有被设置，
                            如有则始终以该locale为准，忽略浏览器的locale
webwork.i18n.encoding=utf-8

### Load custom default resource bundles
webwork.custom.i18n.resources=ApplicationResources
</code></pre>

<p>xwork.xml配置文件的内容：</p>

<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE xwork PUBLIC
    "-//OpenSymphony Group//XWork 1.0//EN"
    "http://www.opensymphony.com/xwork/xwork-1.0.dtd"&gt;

&lt;xwork&gt;
    &lt;include file="webwork-default.xml" /&gt;

    &lt;package name="default" extends="webwork-default"&gt;
        &lt;action name="hello" class="com.example.i18n.action.HelloAction"&gt;
            &lt;result name="success" type="dispatcher"&gt;/i18n.jsp&lt;/result&gt;
        &lt;/action&gt;
    &lt;/package&gt;
&lt;/xwork&gt;
</code></pre>

<p>HelloAction.java实现代码：</p>

<pre><code>import com.opensymphony.xwork.ActionSupport;

public class HelloAction extends ActionSupport {

    public String execute() throws Exception {
        return SUCCESS;
    }
}
</code></pre>

<p>i18n.jsp的代码：</p>

<pre><code>&lt;%@ page pageEncoding="utf-8" contentType="text/html; charset=utf-8" %&gt;

&lt;%@ taglib uri="webwork" prefix="ww" %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;ww:property value="getText('i18n.value')" /&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>ApplicationResources_zh_CN.properties的内容：</p>

<pre><code>i18n.value=国际化
</code></pre>

<p>ApplicationResources_en_US.properties的内容：</p>

<pre><code>i18n.value=internationalization
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一步一步整合WebWork和Spring]]></title>
    <link href="http://codemany.com/blog/webwork-and-spring-integration-step-by-step/"/>
    <updated>2005-09-26T10:50:27+08:00</updated>
    <id>http://codemany.com/blog/webwork-and-spring-integration-step-by-step</id>
    <content type="html"><![CDATA[<p>拷贝webwork-2.1.7.jar、spring-1.2.1.jar以及webwork2-srping.jar到WEB-INF/lib目录下。</p>

<p>添加以下内容到web.xml文件中：</p>

<pre><code>&lt;listener&gt;
    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;

&lt;listener&gt;
    &lt;listener-class&gt;com.atlassian.xwork.ext.ResolverSetupServletContextListener&lt;/listener-class&gt;
&lt;/listener&gt;
</code></pre>

<p>applicationContext.xml中的内容如下：</p>

<pre><code>&lt;beans&gt;
    &lt;bean id="dataSource" class="org.springframework.jdbc.datasource.SingleConnectionDataSource"&gt;
        &lt;property name="driverClassName" value="${driver}" /&gt;
        &lt;property name="url" value="${url}" /&gt;
        &lt;property name="username" value="${username}" /&gt;
        &lt;property name="password" value="${password}" /&gt;
    &lt;/bean&gt;

    &lt;bean id="sqlMapClient" class="org.springframework.orm.ibatis.SqlMapClientFactoryBean"&gt;
        &lt;property name="configLocation" value="/WEB-INF/sql-map-config.xml" /&gt;
        &lt;property name="dataSource" ref="dataSource" /&gt;
    &lt;/bean&gt;

    &lt;bean id="userManager" class="com.example.netlink.service.impl.UserManagerImpl" singleton="true"&gt;
        &lt;property name="sqlMapClient" ref="sqlMapClient" /&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<p>配置文件sql-map-config.xml中的内容如下：</p>

<pre><code>&lt;sqlMapConfig&gt;
    &lt;sqlMap resource="com/example/netlink/dao/impl/User.xml" /&gt;
&lt;/sqlMapConfig&gt;
</code></pre>

<p>在xwork.xml中添加以下内容：</p>

<pre><code>&lt;package name="default" extends="webwork-default"
        externalReferenceResolver="com.atlassian.xwork.ext.SpringServletContextReferenceResolver"&gt;

    &lt;interceptors&gt;
        &lt;interceptor name="reference-resolver"
                class="com.opensymphony.xwork.interceptor.ExternalReferencesInterceptor" /&gt;

        &lt;interceptor-stack name="interceptors"&gt;
            &lt;interceptor-ref name="params" /&gt;
            &lt;interceptor-ref name="reference-resolver" /&gt;
        &lt;/interceptor-stack&gt;
    &lt;/interceptors&gt;

    &lt;default-interceptor-ref name="default-interceptor" /&gt;

    &lt;action name="login" class="com.example.netlink.action.LoginAction"&gt;
        &lt;external-ref name="userManager"&gt;userManager&lt;/external-ref&gt;
        &lt;result name="success" type="dispatcher"&gt;/success.jsp&lt;/result&gt;
        &lt;result name="error" type="dispatcher"&gt;/error.jsp&lt;/result&gt;
    &lt;/action&gt;
&lt;/package&gt;
</code></pre>

<p>在LoginAction.java中添加代码：</p>

<pre><code>private UserManager userManager = null;

public void setUserManager(UserManager userManager) {
    this.userManager = userManager;
</code></pre>

<p>建立UserManager.java接口文件：</p>

<pre><code>public interface UserManager {
    public User login(String username, String password) throws UserLoginException;
}
</code></pre>

<p>UserManagerImpl.java实现代码：</p>

<pre><code>public class UserManagerImpl extends SqlMapClientDaoSupport implements UserManager {

    public User login(String username, String password) throws UserLoginException {
        // do something
    }
}
</code></pre>
]]></content>
  </entry>
  
</feed>
