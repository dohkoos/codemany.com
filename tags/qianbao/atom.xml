<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Qianbao | 乐者为王]]></title>
  <link href="http://codemany.com/tags/qianbao/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2015-03-22T21:22:24+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[用Rails 3.2打造简单记账应用]]></title>
    <link href="http://codemany.com/blog/using-rails-32-to-create-a-simple-accounting-application/"/>
    <updated>2012-04-18T07:49:27+08:00</updated>
    <id>http://codemany.com/blog/using-rails-32-to-create-a-simple-accounting-application</id>
    <content type="html"><![CDATA[<p>Rails已经到3.2版本了，和以前的2.3版本有了很大的不同，决定把原来老版本的记账应用重新写一遍，更新部分插件。</p>

<p>首先是创建项目：</p>

<pre><code>rails new qianbao
cd qianbao
rails g scaffold entry amount:decimal tags:string comment:text effective_date:date
rails g controller home index
</code></pre>

<p>删除public/index.html，在config/routes.rb中添加根路由：</p>

<pre><code>root :to =&gt; 'home#index'
</code></pre>

<p>现在要给应用加上一个认证系统（注册、激活、登录、登出），这次使用<a href="https://github.com/plataformatec/devise">devise</a>插件实现。</p>

<p>在Gemfile中添加：</p>

<pre><code>gem 'devise'
</code></pre>

<p>然后执行下列命令：</p>

<pre><code>bundle install
rails g devise:install
rails g devise user
rails g devise:views
</code></pre>

<p>创建一个迁移任务，把User和Entry模型关联起来：</p>

<pre><code>class AddUserIdToEntries &lt; ActiveRecord::Migration
  def change
    add_column :entries, :user_id, :integer

    add_index :entries, :user_id
  end
end
</code></pre>

<p>修改Entry和User模型：</p>

<pre><code>class Entry &lt; ActiveRecord::Base
  validates :effective_date, :presence =&gt; true
  validates :amount,         :presence =&gt; true,
                             :numericality =&gt; { :greater_than =&gt; 0.0 },
                             :format =&gt; { :with =&gt; /^\d+??(?:\.\d{0,2})?$/ }
  validates :tags,           :presence =&gt; true,
                             :length =&gt; { :within =&gt; 1..255 }

  belongs_to :user
</code></pre>

<pre><code>class User &lt; ActiveRecord::Base
  has_many :entries
</code></pre>

<p>修改app/views/layouts/application.html.erb文件：</p>

<pre><code>&lt;body&gt;
  &lt;% if user_signed_in? %&gt;
    &lt;p&gt;
      &lt;strong&gt;&lt;%= link_to current_user.email, edit_user_registration_path %&gt;&lt;/strong&gt;
      &lt;%= link_to 'Logout', destroy_user_session_path, :method =&gt; :delete %&gt;
    &lt;/p&gt;
    &lt;%= link_to "All Entries", entries_path %&gt;
  &lt;% else %&gt;
    &lt;p&gt;
      &lt;strong&gt;You are currently not logged in.&lt;/strong&gt;
      &lt;%= link_to 'Sign in', new_user_session_path %&gt; or
      &lt;%= link_to 'Sign up', new_user_registration_path %&gt;
    &lt;/p&gt;
  &lt;% end %&gt;

  &lt;%= yield %&gt;
&lt;/body&gt;
</code></pre>

<p>修改app/controller/entries_controller.rb：</p>

<pre><code>class EntriesController &lt; ApplicationController
  before_filter :authenticate_user!

  # GET /entries
  # GET /entries.json
  def index
    @entries = current_user.entries

    respond_to do |format|
      format.html # index.html.erb
      format.json { render json: @entries }
    end
  end

  # GET /entries/1
  # GET /entries/1.json
  def show
    @entry = current_user.entries.find(params[:id])

    respond_to do |format|
      format.html # show.html.erb
      format.json { render json: @entry }
    end
  end

  # GET /entries/new
  # GET /entries/new.json
  def new
    @entry = Entry.new

    respond_to do |format|
      format.html # new.html.erb
      format.json { render json: @entry }
    end
  end

  # GET /entries/1/edit
  def edit
    @entry = current_user.entries.find(params[:id])
  end

  # POST /entries
  # POST /entries.json
  def create
    @entry = Entry.new(params[:entry])
    @entry.user = current_user

    respond_to do |format|
      if @entry.save
        format.html { redirect_to @entry, notice: 'Entry was successfully created.' }
        format.json { render json: @entry, status: :created, location: @entry }
      else
        format.html { render action: "new" }
        format.json { render json: @entry.errors, status: :unprocessable_entity }
      end
    end
  end

  # PUT /entries/1
  # PUT /entries/1.json
  def update
    @entry = current_user.entries.find(params[:id])

    respond_to do |format|
      if @entry.update_attributes(params[:entry])
        format.html { redirect_to @entry, notice: 'Entry was successfully updated.' }
        format.json { head :no_content }
      else
        format.html { render action: "edit" }
        format.json { render json: @entry.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /entries/1
  # DELETE /entries/1.json
  def destroy
    @entry = current_user.entries.find(params[:id])
    @entry.destroy

    respond_to do |format|
      format.html { redirect_to entries_url }
      format.json { head :no_content }
    end
  end
end
</code></pre>

<p>执行以下命令启动应用：</p>

<pre><code>rake db:migrate
rails s
</code></pre>

<p>以前的版本用的CSS框架是<a href="http://blueprintcss.org/">Blueprint</a>，这次使用比它更方便快捷的<a href="https://github.com/twitter/bootstrap">Bootstrap</a>。Bootstrap建立在Less上，有个<a href="https://github.com/metaskills/less-rails-bootstrap">less-rails-bootstrap</a>，不过在安装libv8时竟然要提示缺少Python，拜托！我用的是Ruby，要我装Python，啥意思啊！还是找个Sass版的Bootstrap吧。</p>

<p>下载<a href="https://github.com/jlong/sass-twitter-bootstrap">sass-twitter-bootstrap</a>：</p>

<pre><code>git clone https://github.com/jlong/sass-twitter-bootstrap.git
</code></pre>

<p>将sass-twitter-bootstrap/lib中的文件拷贝到app/assets/stylesheets/twitter目录下。然后将app/assets/stylesheets/application.css中的</p>

<pre><code>*= require_tree .
</code></pre>

<p>修改为</p>

<pre><code>*= require twitter/bootstrap
</code></pre>

<p>再在文件末尾添加：</p>

<pre><code>body { padding-top: 60px; }
</code></pre>

<p>现在就可以使用Bootstrap来布局美化应用了。</p>

<p>代码下载：<a href="https://github.com/dohkoos/qianbao32">https://github.com/dohkoos/qianbao32</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Rails 2.3打造简单记账软件（12）]]></title>
    <link href="http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part12/"/>
    <updated>2010-01-08T08:31:28+08:00</updated>
    <id>http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part12</id>
    <content type="html"><![CDATA[<p>在这以前我们把tags作为Entry模型的一个字段来实现，这样做有很大的局限性，而且还有好多插件可以实现这个功能，现在我们就来把它替换用插件<a href="https://github.com/jviney/acts_as_taggable_on_steroids">acts_as_taggable_on_steroids</a>实现。</p>

<p>安装插件</p>

<pre><code>script/plugin install git://github.com/jviney/acts_as_taggable_on_steroids.git
script/generate acts_as_taggable_migration
rake db:migrate
</code></pre>

<p>在Entry模型中添加一句代码：</p>

<pre><code>class Entry &lt; ActiveRecord::Base
  acts_as_taggable
</code></pre>

<p>还要将所有视图中原来的tags字段替换成tag_list字段。</p>

<pre><code># index.html.erb
&lt;%=h entry.tag_list %&gt;
</code></pre>

<pre><code># edit.html.erb
&lt;%= f.text_field :tag_list %&gt;
</code></pre>

<pre><code># new.html.erb
&lt;%= f.text_field :tag_list %&gt;
</code></pre>

<p>还要将Entry模型中的验证字段tags改成tag_list。做完这些插件也就安装完成了。</p>

<p>既然用了插件，那么原来的tags字段就不需要了，写个迁移任务把它处理掉吧！</p>

<pre><code>script/generate migration remove_tags_from_entries
</code></pre>

<p>迁移代码如下：</p>

<pre><code>class RemoveTagsFromEntries &lt; ActiveRecord::Migration
  def self.up
    remove_column :entries, :tags
  end

  def self.down
    add_column :entries, :tags, :string
  end
end
</code></pre>

<p>代码下载：<a href="https://github.com/dohkoos/qianbao">https://github.com/dohkoos/qianbao</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Rails 2.3打造简单记账软件（11）]]></title>
    <link href="http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part11/"/>
    <updated>2010-01-05T20:43:29+08:00</updated>
    <id>http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part11</id>
    <content type="html"><![CDATA[<p>当网站出现问题时，让它发送一份错误报告到你的邮箱是件挺不错的事，这样你就不必再担心不能及时发现问题了。</p>

<p><a href="https://github.com/rails/exception_notification">exception_notification</a>插件的功能就是当你的Rails应用出错时，它会向指定的邮箱地址发送错误日志。</p>

<p>使用很简单，安装插件后配置一下邮件接受者就可以了。</p>

<pre><code>script/plugin install git://github.com/rails/exception_notification.git
</code></pre>

<p>在config/environment.rb中的最后添加邮件接收者的地址：</p>

<pre><code>ExceptionNotifier.exception_recipients = %w(yourname@example.com)
</code></pre>

<p>然后告诉exception_notification哪些controller出错才发送日志，当然是全部啦：</p>

<pre><code>class ApplicationController &lt; ActionController::Base
  include ExceptionNotifiable
</code></pre>

<p>exception_notification采用ActionMailer发送邮件，所以使用的前提是确保ActionMailer可以正常发送邮件。还有就是exception_notification默认只在production环境下才会生效，如果想要在development下也生效，需要将config/environments/development.rb文件中的：</p>

<pre><code>config.action_mailer.raise_delivery_errors = false
</code></pre>

<p>修改为</p>

<pre><code>config.action_mailer.raise_delivery_errors = true
# Let exception_notification generate email notifications
config.action_controller.consider_all_requests_local = false
</code></pre>

<p>代码下载：<a href="https://github.com/dohkoos/qianbao">https://github.com/dohkoos/qianbao</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Rails 2.3打造简单记账软件（10）]]></title>
    <link href="http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part10/"/>
    <updated>2010-01-04T20:34:41+08:00</updated>
    <id>http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part10</id>
    <content type="html"><![CDATA[<p>从2.2版本起Rails开始内置支持i18n，因此以后实现国际化/本地化就可以不再需要各种各样的插件了。</p>

<p>Rails默认的Locale文件夹是config/locales，假设你要支持中文和英文，那么你需要在这个文件夹下放置zh.yml和en.yml两个文件。</p>

<p>相应的入门教程网上有不少，我也就不多讲了。这里主要说一下如何在记账应用中实现可以让用户指定语言的i18n实现，即当用户选择English，那么界面就切换成英文界面，并且以后打开的页面也是以英文出现，反之亦如此。</p>

<p>首先在header区添加以下代码：</p>

<pre><code>&lt;%= link_to 'Chinese', :locale =&gt; 'zh' %&gt;
&lt;%= link_to 'English', :locale =&gt; 'en' %&gt;
</code></pre>

<p>点击其中某个链接后，浏览器就会传递对应的参数zh或en到后台。</p>

<p>然后在app/controllers/application_controller.rb中添加以下代码：</p>

<pre><code>before_filter :set_locale

protected
  def set_locale
    I18n.locale = params[:locale]
  end
</code></pre>

<p>不过这里有个问题就是url中必须得带着参数，不然的话用户的选择就会失效。要想使选择达到持续的效果，可以考虑把这些信息保存在session中，改进后的代码如下：</p>

<pre><code>def set_locale
  I18n.locale = params[:locale] || session[:locale]
  session[:locale] = I18n.locale
end
</code></pre>

<p>现在这样就基本上差不多了。剩下的就是处理第一次访问时的语言，这个可以从request的ACCEPT_LANGUAGE参数中获取。最终实现的代码：</p>

<pre><code>def set_locale
  accept_lang = request.env['HTTP_ACCEPT_LANGUAGE'].scan(/^[a-z]{2}/).first
  I18n.locale = params[:locale] || session[:locale] || accept_lang || 'zh'
  session[:locale] = I18n.locale
end
</code></pre>

<p>不过当用户选择中文后，在新建记录时会报以下错误：</p>

<pre><code>can't convert Symbol into String

Extracted source (around line #8):

    6:   &lt;p&gt;
    7:     &lt;%= t(:effective_date) %&gt;&lt;br /&gt;
    8:     &lt;%= f.date_select :effective_date %&gt;
</code></pre>

<p>查找资料后发现可以通过在date_select中加入order来解决，不过日期下拉列表中的月份还有问题，出现的是一些随机数，不是正常月份。这个也可以通过添加month_names参数解决。</p>

<p>&#8220;`</p>

<p><p>
  &lt;%= t(:effective_date) %><br />
  &lt;%= f.date_select :effective_date, :order => [:year, :month, :day] %>
</p>
&#8220;`</p>

<p>更好的办法是把它们放到对应的Locale文件里：</p>

<pre><code># en.yml
en:
  date:
    month_names: [~, January, February, ..., November, December]
    order: [:year, :month, :day]
</code></pre>

<pre><code># zh.yml
zh:
  date:
    month_names: [~, 一月, 二月, ..., 十一月, 十二月]
    order: [:year, :month, :day]
</code></pre>

<p>代码下载：<a href="https://github.com/dohkoos/qianbao">https://github.com/dohkoos/qianbao</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Rails 2.3打造简单记账软件（9）]]></title>
    <link href="http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part9/"/>
    <updated>2009-12-20T20:45:19+08:00</updated>
    <id>http://codemany.com/blog/using-rails-23-to-create-a-simple-accounting-app-part9</id>
    <content type="html"><![CDATA[<p>没啥多说的，继续开始干活。</p>

<p>修改app/views/entries/index.html.erb为：</p>

<p>&#8220;`</p>

<h1>Listing entries</h1>




<table>
  <thead>
    <tr>
      <th class="center">Date</th>
      <th class="center">Amount</th>
      <th class="center">Tags</th>
      <th class="center">Comment</th>
      <th class="center">Action</th>
    </tr>
  </thead>

  <tbody>
    <% @entries.each do |entry| %>
    <tr class="<%= cycle('odd', 'even') %>&#8221;>
      <td class="center"><%=h entry.effective_date %></td>
      <td class="right"><%=h number_to_currency(entry.amount) %></td>
      <td><%=h entry.tags %></td>
      <td><%=h entry.comment %></td>
      <td class="center">
        <%= link_to 'Edit', edit_entry_path(entry) %>
        <%= link_to 'Destroy', entry, :confirm => &#8216;Are you sure?&#8217;, :method => :delete %>
      </td>
    </tr>
    <% end %>
  </tbody>
</table>


<p>&lt;%= link_to &lsquo;New entry&rsquo;, new_entry_path %>
&#8220;`</p>

<p>修改app/views/layouts/application.html.erb文件的内容为：</p>

<pre><code>&lt;!DOCTYPE html PUBLIC
  "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"&gt;
&lt;head&gt;
  &lt;meta http-equiv="content-type" content="text/html; charset=utf-8" /&gt;
  &lt;title&gt;Qianbao: &lt;%= controller.action_name %&gt;&lt;/title&gt;
  &lt;%= stylesheet_link_tag 'scaffold' %&gt;
  &lt;%= stylesheet_link_tag 'qianbao' %&gt;
  &lt;%= stylesheet_link_tag 'table' %&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id="container"&gt;
    &lt;%= render :partial =&gt; 'layouts/header' %&gt;

    &lt;div id="content"&gt;
      &lt;p style="color: green"&gt;&lt;%= flash[:notice] %&gt;&lt;/p&gt;

      &lt;%= yield %&gt;
    &lt;/div&gt;

    &lt;%= render :partial =&gt; 'layouts/footer' %&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>新建app/views/layouts/_header.html.erb文件：</p>

<p>&#8220;`</p>

<div id="header">
  <%= link_to 'Home', root_path %>
  <% if logged_in? %>
    <%= link_to 'All entries', entries_path %>
    <strong>You are logged in as <%= current_user.login %></strong>
    <%= link_to 'Logout', logout_path %>
  <% else %>
    <%= link_to 'Login', login_path %>
    <%= link_to 'Sign Up', signup_path %>
  <% end %>
</div>


<pre><code>
新建app/views/layouts/_footer.html.erb文件：
</code></pre>

<div id="footer">&copy; 2009</div>


<pre><code>
在public/stylesheets/qianbao.css的末尾添加：
</code></pre>

<p>.center {
  text-align: center;
}</p>

<p>.right {
  text-align: right;
}
&#8220;`</p>

<p>新建public/stylesheets/table.css，内容为：</p>

<pre><code>table {
  border-collapse: collapse;
  text-align: left;
  width: 90%;
}

thead {
  height: 30px;
}

thead th {
  padding: 5px;
  background: #efefef;
}

tbody td {
  padding: 5px;
}

th, td {
  border: 1px solid #e6e6e6;
}

tr.odd {
  background: #fff;
}

tr.even {
  background: #f9f9f9;
}
</code></pre>

<p>代码下载：<a href="https://github.com/dohkoos/qianbao">https://github.com/dohkoos/qianbao</a></p>
]]></content>
  </entry>
  
</feed>
