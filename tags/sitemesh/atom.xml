<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: SiteMesh | 乐者为王]]></title>
  <link href="http://codemany.com/tags/sitemesh/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2014-08-24T18:55:48+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[如何解决含有中文的页面末尾内容会被SiteMesh截掉的问题]]></title>
    <link href="http://codemany.com/blog/2005/07/22/how-to-solve-sitemesh-truncate-the-page-containing-chinese-character/"/>
    <updated>2005-07-22T14:33:59+08:00</updated>
    <id>http://codemany.com/blog/2005/07/22/how-to-solve-sitemesh-truncate-the-page-containing-chinese-character</id>
    <content type="html"><![CDATA[<p>首先我们先要了解一下ServletResponse.setContentLength(int len)的含义。setContentLength是设置返回内容体长度的方法，len是内容体的长度。由于网络上传输内容是以字节（byte）为单位的，所以len就是指内容体有多少个字节。假设现在有长度为100个字节的数据，在输出数据到客户端前我们用setContentLength(90)设置内容体的长度为90个字节。那么在客户端接收到的数据长度就是90个字节而不是100。下面我们来做个试验：</p>

<p>```
public class PageTruncateFilter implements Filter {</p>

<pre><code>public void init(FilterConfig config) throws ServletException {
}

public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
                    throws IOException, ServletException {
    HttpServletRequest request = (HttpServletRequest)req;
    HttpServletResponse response = (HttpServletResponse)res;

    String content = "&lt;html&gt;&lt;head&gt;&lt;title&gt;Truncated Page&lt;/title&gt;&lt;/head&gt;";
           content += "&lt;body&gt;这个页面的内容will be truncated.&lt;/body&gt;&lt;/html&gt;";
    response.setCharacterEncoding("gbk");
    response.setContentLength(content.length());
    PrintWriter out = response.getWriter();
    out.println(content);
    out.close();
}

public void destroy() {
}
</code></pre>

<p>}
```</p>

<p>由于content字符串含有两个中文字符，每一个中文字符又是由两个字节组成，所以content.length()的值比content的字节数要少2。在客户端显示的内容也会因此少2个字节，即缺少“l>”这两个字符。</p>

<p>现在我们来浏览SiteMesh的源码找出问题的原因。首先从PageFilter.java的doFilter方法开始。由于页面没有在decorators.xml中注册修饰，所以writeOriginal方法会被调用。下面是writeOriginal方法的源代码：</p>

<p>```
/<em>* Write the original page data to the response. </em>/
private void writeOriginal(HttpServletRequest request, HttpServletResponse response,</p>

<pre><code>                      Page page) throws IOException {
response.setContentLength(page.getContentLength());

if (request.getAttribute(USING_STREAM).equals(Boolean.TRUE)) {
    PrintWriter writer = new PrintWriter(response.getOutputStream());
    page.writePage(writer);
    // flush writer to underlying outputStream
    writer.flush();
    response.getOutputStream().flush();
} else {
    page.writePage(response.getWriter());
    response.getWriter().flush();
}
</code></pre>

<p>}
```</p>

<p>首行代码就是设置内容体长度的，让我们追到page.getContentLength()里面去看看（Page接口的getContentLength方法是由AbstractPage.java实现的）：</p>

<p>```
public int getContentLength() {</p>

<pre><code>return pageData.length;
</code></pre>

<p>}
```</p>

<p>它返回pageData数组的长度。但是pageData数组是char类型的，假如pageData中有中文内容时，设置的内容体长度就会小于pageData的字节数。这时就会出现输出到客户端的数据截掉的问题。所以只要修改getContentLength方法返回的值就可以了，下面是修改后的getContentLength方法：</p>

<p>```
public int getContentLength() {</p>

<pre><code>String content = new String(pageData);
return content.getBytes().length;
</code></pre>

<p>}
```</p>
]]></content>
  </entry>
  
</feed>
