<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: PostgreSQL | 乐者为王]]></title>
  <link href="http://codemany.com/tags/postgresql/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2014-08-25T10:23:13+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[部署Qianbao到Heroku时遇到的一些问题]]></title>
    <link href="http://codemany.com/blog/2013/05/19/some-problems-when-deploying-qianbao-to-heroku/"/>
    <updated>2013-05-19T06:25:33+08:00</updated>
    <id>http://codemany.com/blog/2013/05/19/some-problems-when-deploying-qianbao-to-heroku</id>
    <content type="html"><![CDATA[<p>Heroku现在已经是纯粹的只读PaaS了，也就是说以前还支持的SQlite现在也不能使用了。因此部署到Heroku上的Rails应用需要把使用的数据库改成PostgreSQL，并且要关闭assets的预编译功能。</p>

<p>修改Gemfile，将SQLite换成PostgreSQL：
```</p>

<h1>gem 'sqlite3'</h1>

<p>gem 'pg'
```</p>

<p>在config/application.rb中添加：
<code>
config.assets.initialize_on_precompile = false
</code></p>

<p>股票功能需要导入交割单文件。因为导入后的文本文件不再使用，所以可以把上传路径由public/uploads改为tmp。这样就避免了不能写文件到public目录的问题。</p>

<p>应用上传后运行时出现异常，使用heroku logs -t命令查看日志发现有如下错误：
<code>
Error: column "stocks.share_name" must appear in the GROUP BY clause or be used in an aggregate function
</code></p>

<p>这是因为在controller中有这么一行代码：
<code>
current_user.stocks.select("share_code, share_name, sum(actual_amount) as amount").group("share_code")
</code></p>

<p>在PostgreSQL中这会有问题。比如下面的数据表：
<img src="/uploads/qianbao-stocks-table.png" title="qianbao-stocks-table" ></p>

<p>执行上面的SQL语句后，share_name的值到底是取Ruby呢还是ST Ruby？解决这个问题的方法是使用aggregate函数。
<code>
current_user.stocks.select("share_code, max(share_name) as share_name, sum(actual_amount) as amount").group("share_code")
</code></p>

<p>PostgreSQL还有个问题，就是decimal类型的字段，取出来的值是字符串类型。例如：
<code>
if stock.amount &lt; 0
</code></p>

<p>它会报以下错误：
<code>
ArgumentError (comparison of String with 0 failed)
</code></p>

<p>这个可以通过to_f函数解决：
<code>
if stock.amount.to_f &lt; 0
</code></p>
]]></content>
  </entry>
  
</feed>
