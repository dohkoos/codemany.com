<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: DOM4j | 乐者为王]]></title>
  <link href="http://codemany.com/tags/dom4j/atom.xml" rel="self"/>
  <link href="http://codemany.com/"/>
  <updated>2014-08-03T22:17:08+08:00</updated>
  <id>http://codemany.com/</id>
  <author>
    <name><![CDATA[dohkoos]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[将Nokia 6670的短信导入Hero]]></title>
    <link href="http://codemany.com/blog/2011/06/21/nokia-6670-sms-into-the-hero/"/>
    <updated>2011-06-21T08:43:10+08:00</updated>
    <id>http://codemany.com/blog/2011/06/21/nokia-6670-sms-into-the-hero</id>
    <content type="html"><![CDATA[<p><p>这事本该N久前就该干了（09年末把手机从Nokia 6670换到HTC Hero），却一直拖着没有做，今天终于把这事作了一个了结。</p>

<p><p>Nokia下导出的短信是如Messages_Nokia 6670_20091215.xml这样的一个XML文件，文件内容的编码是unicode，格式就像下面这样：<br />
[code lang=&ldquo;xml&rdquo;]
&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;unicode&rdquo;?>
<SMS PhoneModel="Nokia 6670">
  <Message DateTime="2006-09-07 09:32:22"></p>

<pre><code>&lt;Sender&gt;牛金星&lt;/Sender&gt;
&lt;PhoneNumber&gt;+8613988888888&lt;/PhoneNumber&gt;
</code></pre>

<p>   <Location>Inbox</Location></p>

<pre><code>&lt;Text&gt;This is a test!&lt;/Text&gt;
</code></pre>

<p>  </Message>
  &hellip;<br />
  <Message DateTime="2006-09-07 09:32:22"></p>

<pre><code>&lt;Sender&gt;马尔科&lt;/Sender&gt;
&lt;PhoneNumber&gt;+8613966666666&lt;/PhoneNumber&gt;
&lt;Location&gt;Outbox&lt;/Location&gt;
&lt;Text&gt;Hello, world!&lt;/Text&gt;
</code></pre>

<p>  </Message>
</SMS>
```</p>

<p><p>本来是想写个Android app来直接导入这些备份短信的，不过在实现的过程中发现了SMS Backup&amp;Restore到备份文件和Nokia的备份文件类似产生了做个将Nokia备份文件转换成SMS Backup&amp;Restore的备份文件，又在网上发现了nicholashan的教程<a href="http://bbs.hiapk.com/thread-140564-1-1.html">《将Nokia的短信导入Hero(可能适用所有Android机型)》</a>，坚定了我的这个想法。</p>

<p><p>分析了一下SMS Backup&amp;Restore备份文件的格式，文件内容的编码是utf-8的：<br />
[code lang=&ldquo;xml&rdquo;]
&lt;?xml version=&lsquo;1.0&rsquo; encoding=&lsquo;utf-8&rsquo; standalone=&lsquo;yes&rsquo; ?>
<smses count="1138">
  <sms protocol="0" address="10658601" date="1260675608871"<br /></p>

<pre><code>type="1" subject="null" body="This is a test!" toa="null"&lt;br /&gt;
sc_toa="null" service_center="+8613800510543" read="1"&lt;br /&gt;
status="-1" locked="0" /&gt;
</code></pre>

<p>  <sms protocol="0" address="13566666666" date="1260887183844"<br /></p>

<pre><code>type="2" subject="null" body="Hello, Hero." toa="null"&lt;br /&gt;
sc_toa="null" service_center="null" read="1"&lt;br /&gt;
status="-1" locked="0" /&gt;
</code></pre>

<p>  <sms protocol="0" address="+8613588888888" date="1260887553000"<br /></p>

<pre><code>type="1" subject="null" body="ooops!" toa="null"&lt;br /&gt;
sc_toa="null" service_center="null" read="1"&lt;br /&gt;
status="-1" locked="0" /&gt;
</code></pre>

<p></smses>
```</p>

<p><p>与转换相关的就address、date、type和body四个属性。address是发信人的号码；date是短信发送日期的timestamp。这点nicholashan的确说错了，后面不需要加什么0的（实际上nicholashan自己也怀疑自己的说法）；type等于1表示别人发给你的短信，如果是2的话就是你发给其他人的短信；<br />
body就是短信内容了。</p>

<p><p>将Nokia中的时间转换到SMS Backup&amp;Restore的时间可以使用下面的代码：<br />
```
DateFormat dt = new SimpleDateFormat(&ldquo;yyyy-MM-dd HH:mm:ss&rdquo;);<br />
long value = 1355296332000L; // 2012-12-12 12:12:12<br />
Element e = &hellip;<br />
Attribute attr = e.attribute(&ldquo;DateTime&rdquo;);<br />
try {<br /></p>

<pre><code>value = dt.parse(attr.getValue()).getTime();&lt;br /&gt;
</code></pre>

<p>} catch (ParseException ex) {<br />
}
```</p>

<p><p>完整的代码如下（使用dom4j实现XML解析）：<br />
```
package com.codemany.n6670conv;</p>

<p><p>import java.io.File;<br />
import java.io.FileWriter;<br />
import java.io.IOException;<br />
import java.text.DateFormat;<br />
import java.text.ParseException;<br />
import java.text.SimpleDateFormat;<br />
import java.util.Iterator;<br />
import java.util.List;</p>

<p><p>import org.dom4j.Attribute;<br />
import org.dom4j.Document;<br />
import org.dom4j.DocumentException;<br />
import org.dom4j.DocumentHelper;<br />
import org.dom4j.Element;<br />
import org.dom4j.Node;<br />
import org.dom4j.io.SAXReader;<br />
import org.dom4j.io.XMLWriter;</p>

<p><p>public class Main {</p>

<p><p>    public static void main(String[] args) {<br /></p>

<pre><code>    try {&lt;br /&gt;
        SAXReader sr = new SAXReader();&lt;br /&gt;
        Document doc = sr.read(new File(args[0]));
</code></pre>

<p><p>            generateDocument(doc);<br /></p>

<pre><code>    } catch (DocumentException e) {&lt;br /&gt;
        e.printStackTrace();&lt;br /&gt;
    }&lt;br /&gt;
}
</code></pre>

<p><p>    private static void generateDocument(Document doc) {<br /></p>

<pre><code>    List list = doc.selectNodes("//Message");
</code></pre>

<p><p>        Document document = DocumentHelper.createDocument();<br /></p>

<pre><code>    Element smses = document.addElement("smses");&lt;br /&gt;
    smses.addAttribute("count", String.valueOf(list.size()));
</code></pre>

<p><p>        DateFormat dt = new SimpleDateFormat(&ldquo;yyyy-MM-dd HH:mm:ss&rdquo;);<br /></p>

<pre><code>    long value = 1355296332000L; // 2012-12-12 12:12:12&lt;br /&gt;
    Iterator iter = list.iterator();&lt;br /&gt;
    while (iter.hasNext()) {&lt;br /&gt;
        Element e = (Element)iter.next();&lt;br /&gt;
        Attribute attr = e.attribute("DateTime");&lt;br /&gt;
        try {&lt;br /&gt;
            value = dt.parse(attr.getValue()).getTime();&lt;br /&gt;
        } catch (ParseException ex) {&lt;br /&gt;
        }&lt;br /&gt;
        Node phone = e.selectSingleNode("PhoneNumber");&lt;br /&gt;
        Node location = e.selectSingleNode("Location");&lt;br /&gt;
        Node text = e.selectSingleNode("Text");
</code></pre>

<p><p>            Element sms = smses.addElement(&ldquo;sms&rdquo;);<br /></p>

<pre><code>        sms.addAttribute("protocol", "0");&lt;br /&gt;
        sms.addAttribute("address", phone.getText());&lt;br /&gt;
        sms.addAttribute("date", String.valueOf(value));&lt;br /&gt;
        if ("Inbox".equals(location.getText())) {&lt;br /&gt;
            sms.addAttribute("type", "1");&lt;br /&gt;
        } else if ("Outbox".equals(location.getText())) {&lt;br /&gt;
            sms.addAttribute("type", "2");&lt;br /&gt;
        }&lt;br /&gt;
        sms.addAttribute("subject", "null");&lt;br /&gt;
        sms.addAttribute("body", text.getText());&lt;br /&gt;
        sms.addAttribute("toa", "null");&lt;br /&gt;
        sms.addAttribute("sc_toa", "null");&lt;br /&gt;
        sms.addAttribute("service_center", "null");&lt;br /&gt;
        sms.addAttribute("read", "1");&lt;br /&gt;
        sms.addAttribute("status", "-1");&lt;br /&gt;
        sms.addAttribute("locked", "0");&lt;br /&gt;
    }&lt;br /&gt;
    try {&lt;br /&gt;
        File f = new File("output.xml");&lt;br /&gt;
        XMLWriter output = new XMLWriter(new FileWriter(f));&lt;br /&gt;
        output.write(document);&lt;br /&gt;
        output.close();&lt;br /&gt;
    } catch (IOException e) {&lt;br /&gt;
        System.out.println(e.getMessage());&lt;br /&gt;
    }&lt;br /&gt;
}&lt;br /&gt;
</code></pre>

<p>}
```</p>

<p><p>代码下载：<a href="https://github.com/dohkoos/N6670Conv"><a href="https://github.com/dohkoos/N6670Conv">https://github.com/dohkoos/N6670Conv</a></a></p></p>
]]></content>
  </entry>
  
</feed>
